(globalThis.webpackChunksignal_desktop=globalThis.webpackChunksignal_desktop||[]).push([[2295],{"./ts/Bytes.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{k:()=>byteLength,mV:()=>concatenate,Gh:()=>fromBase64,H_:()=>fromHex,mL:()=>fromString,s3:()=>toBase64});var buffer=__webpack_require__("./node_modules/buffer/index.js");function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var _window$SignalContext,Bytes=function(){function Bytes(){!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,Bytes)}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(Bytes,[{key:"fromBase64",value:function fromBase64(value){return buffer.lW.from(value,"base64")}},{key:"fromHex",value:function fromHex(value){return buffer.lW.from(value,"hex")}},{key:"fromBinary",value:function fromBinary(value){return buffer.lW.from(value,"binary")}},{key:"fromString",value:function fromString(value){return buffer.lW.from(value)}},{key:"toBase64",value:function toBase64(data){return buffer.lW.from(data).toString("base64")}},{key:"toHex",value:function toHex(data){return buffer.lW.from(data).toString("hex")}},{key:"toBinary",value:function toBinary(data){return buffer.lW.from(data).toString("binary")}},{key:"toString",value:function toString(data){return buffer.lW.from(data).toString()}},{key:"byteLength",value:function byteLength(value){return buffer.lW.byteLength(value)}},{key:"concatenate",value:function concatenate(list){return buffer.lW.concat(list)}},{key:"isEmpty",value:function isEmpty(data){return!data||0===data.length}},{key:"isNotEmpty",value:function isNotEmpty(data){return!this.isEmpty(data)}},{key:"areEqual",value:function areEqual(a,b){return a&&b?0===buffer.lW.compare(a,b):!a&&!b}}]),Bytes}(),bytes=(null===(_window$SignalContext=window.SignalContext)||void 0===_window$SignalContext?void 0:_window$SignalContext.bytes)||new Bytes;function fromBase64(value){return bytes.fromBase64(value)}function fromHex(value){return bytes.fromHex(value)}function fromString(value){return bytes.fromString(value)}function toBase64(data){return bytes.toBase64(data)}function byteLength(value){return bytes.byteLength(value)}function concatenate(list){return bytes.concatenate(list)}},"./ts/badges/BadgeCategory.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{L:()=>parseBadgeCategory,Q:()=>BadgeCategory});var BadgeCategory,_util_enum__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./ts/util/enum.ts");!function(BadgeCategory){BadgeCategory.Donor="donor",BadgeCategory.Other="other"}(BadgeCategory||(BadgeCategory={}));var parseBadgeCategory=(0,_util_enum__WEBPACK_IMPORTED_MODULE_0__.m)(BadgeCategory,BadgeCategory.Other)},"./ts/components/CompositionTextArea.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{n:()=>CompositionTextArea});var lodash_noop__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/lodash/noop.js"),lodash_noop__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(lodash_noop__WEBPACK_IMPORTED_MODULE_0__),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/index.js"),_util_shouldNeverBeCalled__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./ts/util/shouldNeverBeCalled.ts"),_CompositionInput__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./ts/components/CompositionInput.tsx"),_emoji_EmojiButton__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./ts/components/emoji/EmojiButton.tsx"),_util_grapheme__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./ts/util/grapheme.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./node_modules/react/jsx-runtime.js");function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function CompositionTextArea(_ref){var bodyRanges=_ref.bodyRanges,draftText=_ref.draftText,getPreferredBadge=_ref.getPreferredBadge,i18n=_ref.i18n,isFormattingEnabled=_ref.isFormattingEnabled,isFormattingSpoilersEnabled=_ref.isFormattingSpoilersEnabled,maxLength=_ref.maxLength,onChange=_ref.onChange,onPickEmoji=_ref.onPickEmoji,onScroll=_ref.onScroll,onSetSkinTone=_ref.onSetSkinTone,onSubmit=_ref.onSubmit,onTextTooLong=_ref.onTextTooLong,placeholder=_ref.placeholder,recentEmojis=_ref.recentEmojis,scrollerRef=_ref.scrollerRef,skinTone=_ref.skinTone,theme=_ref.theme,_ref$whenToShowRemain=_ref.whenToShowRemainingCount,whenToShowRemainingCount=void 0===_ref$whenToShowRemain?1/0:_ref$whenToShowRemain,inputApiRef=react__WEBPACK_IMPORTED_MODULE_1__.useRef(),_React$useState2=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_1__.useState(_util_grapheme__WEBPACK_IMPORTED_MODULE_5__.QX(draftText)),2),characterCount=_React$useState2[0],setCharacterCount=_React$useState2[1],insertEmoji=react__WEBPACK_IMPORTED_MODULE_1__.useCallback((function(e){inputApiRef.current&&(inputApiRef.current.insertEmoji(e),onPickEmoji(e))}),[inputApiRef,onPickEmoji]),focusTextEditInput=react__WEBPACK_IMPORTED_MODULE_1__.useCallback((function(){inputApiRef.current&&inputApiRef.current.focus()}),[inputApiRef]),handleChange=react__WEBPACK_IMPORTED_MODULE_1__.useCallback((function(_ref2){var updatedBodyRanges=_ref2.bodyRanges,caretLocation=_ref2.caretLocation,newValue=_ref2.messageText,inputEl=inputApiRef.current;if(inputEl){var _grapheme$truncateAnd2=_slicedToArray(_util_grapheme__WEBPACK_IMPORTED_MODULE_5__.Rc(newValue,maxLength),2),newValueSized=_grapheme$truncateAnd2[0],newCharacterCount=_grapheme$truncateAnd2[1];void 0!==maxLength&&newValueSized.length<newValue.length&&inputEl.setContents(newValueSized,updatedBodyRanges,!0),setCharacterCount(newCharacterCount),onChange(newValue,updatedBodyRanges,caretLocation)}}),[maxLength,onChange]);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsxs)("div",{className:"CompositionTextArea",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(_CompositionInput__WEBPACK_IMPORTED_MODULE_3__.D,{clearQuotedMessage:_util_shouldNeverBeCalled__WEBPACK_IMPORTED_MODULE_2__.U,draftBodyRanges:bodyRanges,draftText,getPreferredBadge,getQuotedMessage:lodash_noop__WEBPACK_IMPORTED_MODULE_0___default(),i18n,isFormattingEnabled,isFormattingSpoilersEnabled,inputApi:inputApiRef,large:!0,moduleClassName:"CompositionTextArea__input",onEditorStateChange:handleChange,onPickEmoji,onScroll,onSubmit,onTextTooLong,placeholder,scrollerRef,sendCounter:0,theme}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)("div",{className:"CompositionTextArea__emoji",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(_emoji_EmojiButton__WEBPACK_IMPORTED_MODULE_4__.K,{i18n,onClose:focusTextEditInput,onPickEmoji:insertEmoji,onSetSkinTone,recentEmojis,skinTone})}),void 0!==maxLength&&characterCount>=whenToShowRemainingCount&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)("div",{className:"CompositionTextArea__remaining-character-count",children:maxLength-characterCount})]})}CompositionTextArea.displayName="CompositionTextArea"},"./ts/components/ForwardMessagesModal.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ASticker:()=>ASticker,AnnouncementOnlyGroupsNonAdmin:()=>AnnouncementOnlyGroupsNonAdmin,LinkPreview:()=>ForwardMessagesModal_stories_LinkPreview,MediaAttachments:()=>MediaAttachments,Modal:()=>Modal,WithAContact:()=>WithAContact,WithText:()=>WithText,__namedExportsOrder:()=>__namedExportsOrder,default:()=>ForwardMessagesModal_stories});var react=__webpack_require__("./node_modules/react/index.js"),esm=__webpack_require__("./node_modules/@storybook/addon-actions/dist/esm/index.js"),dist=__webpack_require__("./node_modules/@storybook/addon-knobs/dist/index.js"),messages=__webpack_require__("./_locales/en/messages.json"),index_esm=__webpack_require__("./node_modules/react-measure/dist/index.esm.js"),react_spring_web_esm=__webpack_require__("./node_modules/@react-spring/web/dist/react-spring-web.esm.js"),classnames=__webpack_require__("./node_modules/classnames/index.js"),classnames_default=__webpack_require__.n(classnames),AttachmentList=__webpack_require__("./ts/components/conversation/AttachmentList.tsx"),Button=__webpack_require__("./ts/components/Button.tsx"),ConfirmationDialog=__webpack_require__("./ts/components/ConfirmationDialog.tsx"),ContactCheckbox=__webpack_require__("./ts/components/conversationList/ContactCheckbox.tsx"),ConversationList=__webpack_require__("./ts/components/ConversationList.tsx"),ModalHost=__webpack_require__("./ts/components/ModalHost.tsx"),SearchInput=__webpack_require__("./ts/components/SearchInput.tsx"),StagedLinkPreview=__webpack_require__("./ts/components/conversation/StagedLinkPreview.tsx"),filterAndSortConversations=__webpack_require__("./ts/util/filterAndSortConversations.ts"),useAnimated=__webpack_require__("./ts/hooks/useAnimated.tsx"),shouldNeverBeCalled=__webpack_require__("./ts/util/shouldNeverBeCalled.ts"),Attachment=(__webpack_require__("./node_modules/lodash/orderBy.js"),__webpack_require__("./ts/types/Attachment.ts")),logging_log=__webpack_require__("./ts/logging/log.ts"),p_queue_dist=(__webpack_require__("./ts/components/SafetyNumberChangeDialog.tsx"),__webpack_require__("./node_modules/p-queue/dist/index.js")),durations=__webpack_require__("./ts/util/durations/index.ts");var helpers=__webpack_require__("./ts/messages/helpers.ts"),whatTypeOfConversation=__webpack_require__("./ts/util/whatTypeOfConversation.ts");var omit=__webpack_require__("./node_modules/lodash/omit.js"),omit_default=__webpack_require__.n(omit),debounce=__webpack_require__("./node_modules/lodash/debounce.js"),debounce_default=__webpack_require__.n(debounce),errors=__webpack_require__("./ts/types/errors.ts"),ts_Bytes=__webpack_require__("./ts/Bytes.ts"),types_LinkPreview=__webpack_require__("./ts/types/LinkPreview.ts"),values=__webpack_require__("./node_modules/lodash/values.js"),values_default=__webpack_require__.n(values),groupBy=__webpack_require__("./node_modules/lodash/groupBy.js"),groupBy_default=__webpack_require__.n(groupBy),reject=__webpack_require__("./node_modules/lodash/reject.js"),reject_default=__webpack_require__.n(reject),pick=__webpack_require__("./node_modules/lodash/pick.js"),pick_default=__webpack_require__.n(pick),isNumber=__webpack_require__("./node_modules/lodash/isNumber.js"),isNumber_default=__webpack_require__.n(isNumber),p_map=__webpack_require__("./node_modules/p-map/index.js"),p_map_default=__webpack_require__.n(p_map),assert=__webpack_require__("./ts/util/assert.ts");function dropNull_dropNull(value){if(null!==value)return value}var Crypto_HashType,Crypto_CipherType,util_url=__webpack_require__("./ts/util/url.ts"),buffer=__webpack_require__("./node_modules/buffer/index.js"),libsignal_client_=(__webpack_require__("./node_modules/long/src/long.js"),__webpack_require__("@signalapp/libsignal-client"));!function(HashType){HashType.size256="sha256",HashType.size512="sha512"}(Crypto_HashType||(Crypto_HashType={})),function(CipherType){CipherType.AES256CBC="aes-256-cbc",CipherType.AES256CTR="aes-256-ctr",CipherType.AES256GCM="aes-256-gcm"}(Crypto_CipherType||(Crypto_CipherType={}));var types_UUID=__webpack_require__("./ts/types/UUID.ts");__webpack_require__("./node_modules/lodash/chunk.js");function Crypto_slicedToArray(arr,i){return function Crypto_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function Crypto_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function Crypto_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return Crypto_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Crypto_arrayLikeToArray(o,minLen)}(arr,i)||function Crypto_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Crypto_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function deriveSecrets(input,salt,info){var output=libsignal_client_.HKDF.new(3).deriveSecrets(96,buffer.lW.from(input),buffer.lW.from(info),buffer.lW.from(salt));return[output.slice(0,32),output.slice(32,64),output.slice(64,96)]}function hmacSha256(key,plaintext){return function sign(key,data){return Crypto_crypto.sign(key,data)}(key,plaintext)}function decryptAes256CbcPkcsPadding(key,ciphertext,iv){return decrypt(Crypto_CipherType.AES256CBC,{key,ciphertext,iv})}function sha256(data){return Crypto_hash(Crypto_HashType.size256,data)}function getZeroes(n){return new Uint8Array(n)}function decryptAttachment(encryptedBin,keys,theirDigest){if(64!==keys.byteLength)throw new Error("Got invalid length attachment keys");if(encryptedBin.byteLength<48)throw new Error("Got invalid length attachment");var aesKey=keys.slice(0,32),macKey=keys.slice(32,64),iv=encryptedBin.slice(0,16),ciphertext=encryptedBin.slice(16,encryptedBin.byteLength-32);return function verifyHmacSha256(plaintext,key,theirMac,length){var ourMac=hmacSha256(key,plaintext);if(theirMac.byteLength!==length||ourMac.byteLength<length)throw new Error("Bad MAC length");for(var result=0,i=0;i<theirMac.byteLength;i+=1)result|=ourMac[i]^theirMac[i];if(0!==result)throw new Error("Bad MAC")}(encryptedBin.slice(0,encryptedBin.byteLength-32),macKey,encryptedBin.slice(encryptedBin.byteLength-32,encryptedBin.byteLength),32),theirDigest&&function verifyDigest(data,theirDigest){for(var ourDigest=sha256(data),result=0,i=0;i<theirDigest.byteLength;i+=1)result|=ourDigest[i]^theirDigest[i];if(0!==result)throw new Error("Bad digest")}(encryptedBin,theirDigest),decryptAes256CbcPkcsPadding(aesKey,ciphertext,iv)}var Crypto_crypto=window.SignalContext.crypto;function Crypto_hash(type,data){return Crypto_crypto.hash(type,data)}function decrypt(){return Crypto_crypto.decrypt.apply(Crypto_crypto,arguments)}var MIME=__webpack_require__("./ts/types/MIME.ts");var TYPES=[{mimeType:MIME.Oh,bytePattern:new Uint8Array([0,0,1,0])},{mimeType:MIME.Oh,bytePattern:new Uint8Array([0,0,2,0])},{mimeType:MIME.UG,bytePattern:new Uint8Array([66,77])},{mimeType:MIME.dB,bytePattern:new Uint8Array([71,73,70,56,55,97])},{mimeType:MIME.dB,bytePattern:new Uint8Array([71,73,70,56,57,97])},{mimeType:MIME.to,bytePattern:new Uint8Array([82,73,70,70,0,0,0,0,87,69,66,80,86,80]),patternMask:new Uint8Array([255,255,255,255,0,0,0,0,255,255,255,255,255,255])},{mimeType:MIME.Ih,bytePattern:new Uint8Array([137,80,78,71,13,10,26,10])},{mimeType:MIME._l,bytePattern:new Uint8Array([255,216,255])}];function matchesType(input,type){if(input.byteLength<type.bytePattern.byteLength)return!1;for(var p=0;p<type.bytePattern.length;p+=1){var mask=type.patternMask?type.patternMask[p]:255;if((input[p]&mask)!==type.bytePattern[p])return!1}return!0}var toPairs=__webpack_require__("./node_modules/lodash/toPairs.js"),toPairs_default=__webpack_require__.n(toPairs),map=__webpack_require__("./node_modules/lodash/map.js"),map_default=__webpack_require__.n(map),last=__webpack_require__("./node_modules/lodash/last.js"),last_default=__webpack_require__.n(last),isTypedArray=__webpack_require__("./node_modules/lodash/isTypedArray.js"),isTypedArray_default=__webpack_require__.n(isTypedArray),isFunction=__webpack_require__("./node_modules/lodash/isFunction.js"),isFunction_default=__webpack_require__.n(isFunction),fromPairs=__webpack_require__("./node_modules/lodash/fromPairs.js"),fromPairs_default=__webpack_require__.n(fromPairs),compact=__webpack_require__("./node_modules/lodash/compact.js"),compact_default=__webpack_require__.n(compact),external_electron_=__webpack_require__("electron"),lib=__webpack_require__("./node_modules/fs-extra/lib/index.js"),lib_default=__webpack_require__.n(lib),pify=__webpack_require__("./node_modules/pify/index.js"),pify_default=__webpack_require__.n(pify);function buildAvatarUpdater(_ref){var field=_ref.field;return async function(conversation,data,_ref2){var deleteAttachmentData=_ref2.deleteAttachmentData,doesAttachmentExist=_ref2.doesAttachmentExist,writeNewAttachmentData=_ref2.writeNewAttachmentData;if(!conversation)return conversation;var avatar=conversation[field],newHash=function computeHash(data){return ts_Bytes.s3(Crypto_hash(Crypto_HashType.size512,data))}(data);if(!avatar||!avatar.hash)return Object.assign({},conversation,{[field]:{hash:newHash,path:await writeNewAttachmentData(data)}});var hash=avatar.hash,path=avatar.path,exists=await doesAttachmentExist(path);return exists||window.SignalContext.log.warn(`Conversation.buildAvatarUpdater: attachment ${path} did not exist`),exists&&hash===newHash?conversation:(await deleteAttachmentData(path),Object.assign({},conversation,{[field]:{hash:newHash,path:await writeNewAttachmentData(data)}}))}}buildAvatarUpdater({field:"avatar"}),buildAvatarUpdater({field:"profileAvatar"});var clearTimeoutIfNecessary=__webpack_require__("./ts/util/clearTimeoutIfNecessary.ts"),sleep=__webpack_require__("./ts/util/sleep.ts");function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var FTSOptimizer=function(){function FTSOptimizer(){!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,FTSOptimizer),this.isRunning=!1}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(FTSOptimizer,[{key:"run",value:async function run(){if(!this.isRunning){var state;this.isRunning=!0,logging_log.info("ftsOptimizer: starting");var start=Date.now();try{do{var _state;void 0!==state&&await(0,sleep._)(50),state=await Client.optimizeFTS(state)}while(null===(_state=state)||void 0===_state||!_state.done)}finally{this.isRunning=!1}var duration=Date.now()-start;state?logging_log.info(`ftsOptimizer: took ${duration}ms and ${state.steps} steps`):logging_log.warn("ftsOptimizer: no final state")}}}]),FTSOptimizer}(),optimizer=new FTSOptimizer,scheduleOptimizeFTS=debounce_default()((function(){optimizer.run()}),durations.sh,{maxWait:5*durations.sh});function expiringMessagesDeletion_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var ExpiringMessagesDeletionService=function(){function ExpiringMessagesDeletionService(){!function expiringMessagesDeletion_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ExpiringMessagesDeletionService),this.update=debounce_default()(this.checkExpiringMessages,1e3)}return function expiringMessagesDeletion_createClass(Constructor,protoProps,staticProps){return protoProps&&expiringMessagesDeletion_defineProperties(Constructor.prototype,protoProps),staticProps&&expiringMessagesDeletion_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(ExpiringMessagesDeletionService,[{key:"destroyExpiredMessages",value:async function destroyExpiredMessages(){try{window.SignalContext.log.info("destroyExpiredMessages: Loading messages...");var messages=await window.Signal.Data.getExpiredMessages();window.SignalContext.log.info(`destroyExpiredMessages: found ${messages.length} messages to expire`);var messageIds=[],inMemoryMessages=[],messageCleanup=[];messages.forEach((function(dbMessage){var message=window.MessageController.register(dbMessage.id,dbMessage);messageIds.push(message.id),inMemoryMessages.push(message),messageCleanup.push(message.cleanup())})),await window.Signal.Data.removeMessages(messageIds),await Promise.all(messageCleanup),inMemoryMessages.forEach((function(message){window.SignalContext.log.info("Message expired",{sentAt:message.get("sent_at")});var conversation=message.getConversation();message.trigger("expired"),window.reduxActions.conversations.messageExpired(message.id),conversation&&conversation.decrementMessageCount()})),messages.length>0&&scheduleOptimizeFTS()}catch(error){window.SignalContext.log.error("destroyExpiredMessages: Error deleting expired messages",errors.G(error)),window.SignalContext.log.info("destroyExpiredMessages: Waiting 30 seconds before trying again"),await(0,sleep._)(30*durations.sh)}window.SignalContext.log.info("destroyExpiredMessages: done, scheduling another check"),this.update()}},{key:"checkExpiringMessages",value:async function checkExpiringMessages(){window.SignalContext.log.info("checkExpiringMessages: checking for expiring messages");var soonestExpiry=await window.Signal.Data.getSoonestMessageExpiry();if(soonestExpiry){var wait=soonestExpiry-Date.now();wait<0&&(wait=0),wait>2147483647&&(wait=2147483647),window.SignalContext.log.info(`checkExpiringMessages: next message expires ${new Date(soonestExpiry).toISOString()}; waiting ${wait} ms before clearing`),(0,clearTimeoutIfNecessary.S)(this.timeout),this.timeout=setTimeout(this.destroyExpiredMessages.bind(this),wait)}else window.SignalContext.log.info("checkExpiringMessages: found no messages to expire")}}]),ExpiringMessagesDeletionService}(),expiringMessagesDeletionService=new ExpiringMessagesDeletionService;function tapToViewMessagesDeletionService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var TapToViewMessagesDeletionService=function(){function TapToViewMessagesDeletionService(){!function tapToViewMessagesDeletionService_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,TapToViewMessagesDeletionService),this.update=debounce_default()(this.checkTapToViewMessages,1e3)}return function tapToViewMessagesDeletionService_createClass(Constructor,protoProps,staticProps){return protoProps&&tapToViewMessagesDeletionService_defineProperties(Constructor.prototype,protoProps),staticProps&&tapToViewMessagesDeletionService_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(TapToViewMessagesDeletionService,[{key:"checkTapToViewMessages",value:async function checkTapToViewMessages(){var _this=this,receivedAt=await window.Signal.Data.getNextTapToViewMessageTimestampToAgeOut();if(receivedAt){var nextCheck=receivedAt+30*durations.x4;window.SignalContext.log.info("checkTapToViewMessages: next check at",new Date(nextCheck).toISOString());var wait=nextCheck-Date.now();wait<0&&(wait=0),wait>2147483647&&(wait=2147483647),(0,clearTimeoutIfNecessary.S)(this.timeout),this.timeout=setTimeout((async function(){await async function eraseTapToViewMessages(){try{window.SignalContext.log.info("eraseTapToViewMessages: Loading messages...");var messages=await window.Signal.Data.getTapToViewMessagesNeedingErase();await Promise.all(messages.map((async function(fromDB){var message=window.MessageController.register(fromDB.id,fromDB);window.SignalContext.log.info("eraseTapToViewMessages: erasing message contents",message.idForLogging()),message.trigger("expired"),window.reduxActions.conversations.messageExpired(message.id),await message.eraseContents()})))}catch(error){window.SignalContext.log.error("eraseTapToViewMessages: Error erasing messages",errors.G(error))}window.SignalContext.log.info("eraseTapToViewMessages: complete")}(),_this.update()}),wait)}}}]),TapToViewMessagesDeletionService}(),tapToViewMessagesDeletionService=new TapToViewMessagesDeletionService;window.batchers=[],window.waitForAllBatchers=async function(){logging_log.info("batcher#waitForAllBatchers");try{await Promise.all(window.batchers.map((function(item){return item.flushAndWait()})))}catch(error){logging_log.error("waitForAllBatchers: error flushing all",errors.G(error))}};var util_explodePromise=__webpack_require__("./ts/util/explodePromise.ts"),set=__webpack_require__("./node_modules/lodash/set.js"),set_default=__webpack_require__.n(set),get=__webpack_require__("./node_modules/lodash/get.js"),get_default=__webpack_require__.n(get),cloneDeep=__webpack_require__("./node_modules/lodash/cloneDeep.js"),cloneDeep_default=__webpack_require__.n(cloneDeep);function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function mapObjectWithSpec_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return mapObjectWithSpec_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return mapObjectWithSpec_arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function mapObjectWithSpec_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function mapObjectWithSpec(spec,data,map){var target=arguments.length>3&&void 0!==arguments[3]?arguments[3]:cloneDeep_default()(data);if(!data)return target;if("string"==typeof spec){var _value=get_default()(data,spec);return _value&&set_default()(target,spec,map(_value)),target}if("isMap"in spec){for(var _i=0,_Object$keys=Object.keys(data);_i<_Object$keys.length;_i++){var key=_Object$keys[_i];target[key]=mapObjectWithSpec(spec.valueSpec,data[key],map,target[key])}return target}if("key"in spec)return target[spec.key]=mapObjectWithSpec(spec.valueSpec,data[spec.key],map,target[spec.key]),target;var _step,_iterator=_createForOfIteratorHelper(spec);try{for(_iterator.s();!(_step=_iterator.n()).done;){var _key=_step.value;mapObjectWithSpec(_key,data,map,target)}}catch(err){_iterator.e(err)}finally{_iterator.f()}return target}var isPlainObject=__webpack_require__("./node_modules/lodash/isPlainObject.js"),isPlainObject_default=__webpack_require__.n(isPlainObject),iterables=__webpack_require__("./ts/util/iterables.ts");function cleanDataForIpc_slicedToArray(arr,i){return function cleanDataForIpc_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function cleanDataForIpc_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||cleanDataForIpc_unsupportedIterableToArray(arr,i)||function cleanDataForIpc_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function cleanDataForIpc_unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return cleanDataForIpc_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?cleanDataForIpc_arrayLikeToArray(o,minLen):void 0}}function cleanDataForIpc_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function cleanDataForIpc(data){var pathsChanged=[];return{cleaned:cleanDataInner(data,"root",pathsChanged,0),pathsChanged}}function cleanDataInner(data,path,pathsChanged,depth){if(depth>10)return logging_log.error(`cleanDataInner: Reached maximum depth ${depth}; path is ${path}`),{cleaned:data,pathsChanged};switch(typeof data){case"undefined":case"boolean":case"number":case"string":return data;case"bigint":return pathsChanged.push(path),data.toString();case"function":return;case"object":if(null===data)return null;if(Array.isArray(data)){var _result=[];return data.forEach((function(item,index){var indexPath=`${path}.${index}`;null==item?pathsChanged.push(indexPath):_result.push(cleanDataInner(item,indexPath,pathsChanged,depth+1))})),_result}if(data instanceof Map){var _result2={};return pathsChanged.push(path),data.forEach((function(value,key){"string"==typeof key?_result2[key]=cleanDataInner(value,`${path}.<map value at ${key}>`,pathsChanged,depth+1):pathsChanged.push(`${path}.<map key ${String(key)}>`)})),_result2}if(data instanceof Date)return pathsChanged.push(path),Number.isNaN(data.valueOf())?void 0:data.toISOString();if(data instanceof ArrayBuffer)return void pathsChanged.push(path);if(data instanceof Uint8Array)return data;var dataAsRecord=data;if("toNumber"in dataAsRecord&&"function"==typeof dataAsRecord.toNumber)return cleanDataInner(dataAsRecord.toNumber(),path,pathsChanged,depth+1);if((0,iterables.TW)(dataAsRecord)){var _result3=[],index=0;pathsChanged.push(path);var _step,_iterator=function cleanDataForIpc_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=cleanDataForIpc_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}(dataAsRecord);try{for(_iterator.s();!(_step=_iterator.n()).done;){var value=_step.value;_result3.push(cleanDataInner(value,`${path}.<iterator index ${index}>`,pathsChanged,depth+1)),index+=1}}catch(err){_iterator.e(err)}finally{_iterator.f()}return _result3}isPlainObject_default()(data)||pathsChanged.push(path);var result={};return Object.entries(dataAsRecord).forEach((function(_ref){var _ref2=cleanDataForIpc_slicedToArray(_ref,2),key=_ref2[0],value=_ref2[1];result[key]=cleanDataInner(value,`${path}.${key}`,pathsChanged,depth+1)})),result;default:return void pathsChanged.push(path)}}var tasks=new Set,shouldStartTimers=!0;function createTaskWithTimeout(task,id){var options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},timeout=options.timeout||30*durations.EB,timeoutError=new Error(`${id||""} task did not complete in time.`);return async function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];var timer,result,complete=!1,_explodePromise=(0,util_explodePromise.R)(),timerPromise=_explodePromise.promise,reject=_explodePromise.reject,startTimer=function(){stopTimer(),complete||(entry.startedAt=Date.now(),timer=setTimeout((function(){complete?logging_log.warn(`TaskWithTimeout: ${id} task timed out, but was already complete`):(complete=!0,tasks.delete(entry),logging_log.error((0,errors.G)(timeoutError)),reject(timeoutError))}),timeout))},stopTimer=function(){(0,clearTimeoutIfNecessary.S)(timer),timer=void 0},entry={id,startedAt:void 0,suspend:function(){logging_log.warn(`TaskWithTimeout: ${id} task suspended`),stopTimer()},resume:function(){logging_log.warn(`TaskWithTimeout: ${id} task resumed`),startTimer()}};tasks.add(entry),shouldStartTimers&&startTimer();var run=async function(){result=await task.apply(void 0,args)};try{return await Promise.race([run(),timerPromise]),result}finally{complete=!0,tasks.delete(entry),stopTimer()}}}async function cleanupMessage(message){var _window$reduxActions,_parentConversation$d,id=message.id,conversationId=message.conversationId;null===(_window$reduxActions=window.reduxActions)||void 0===_window$reduxActions||_window$reduxActions.conversations.messageDeleted(id,conversationId);var parentConversation=window.ConversationController.get(conversationId);null==parentConversation||null===(_parentConversation$d=parentConversation.debouncedUpdateLastMessage)||void 0===_parentConversation$d||_parentConversation$d.call(parentConversation),window.MessageController.unregister(id),await async function deleteMessageData(message){if(await window.Signal.Migrations.deleteExternalMessageFiles(message),(0,helpers.zK)(message)){var id=message.id,conversationId=message.conversationId,parentConversation=window.ConversationController.get(conversationId),isGroupConversation=Boolean(parentConversation&&!(0,whatTypeOfConversation.C$)(parentConversation.attributes));await cleanupStoryReplies(conversationId,id,isGroupConversation)}var sticker=message.sticker;if(!sticker)return;var packId=sticker.packId;packId&&await deletePackReference(message.id,packId)}(message);var isGroupConversation=Boolean(parentConversation&&!(0,whatTypeOfConversation.C$)(parentConversation.attributes));(0,helpers.zK)(message)&&await cleanupStoryReplies(conversationId,id,isGroupConversation)}async function cleanupStoryReplies(conversationId,storyId,isGroupConversation,pagination){var _ref=pagination||{},messageId=_ref.messageId,receivedAt=_ref.receivedAt,replies=await window.Signal.Data.getOlderMessagesByConversation({conversationId,includeStoryReplies:!1,messageId,receivedAt,storyId});if(replies.length){var lastMessage=replies[replies.length-1],lastMessageId=lastMessage.id,lastReceivedAt=lastMessage.received_at;if(messageId!==lastMessageId)return isGroupConversation?await Promise.all(replies.map((function(reply){return window.MessageController.register(reply.id,reply).eraseContents()}))):replies.forEach((function(reply){var model=window.MessageController.register(reply.id,reply);model.unset("storyReplyContext"),model.hydrateStoryContext()})),cleanupStoryReplies(conversationId,storyId,isGroupConversation,{messageId:lastMessageId,receivedAt:lastReceivedAt})}}var mapValues=__webpack_require__("./node_modules/lodash/mapValues.js"),mapValues_default=__webpack_require__.n(mapValues),isString=__webpack_require__("./node_modules/lodash/isString.js"),isString_default=__webpack_require__.n(isString),isNil=__webpack_require__("./node_modules/lodash/isNil.js"),isNil_default=__webpack_require__.n(isNil),isBoolean=__webpack_require__("./node_modules/lodash/isBoolean.js"),isBoolean_default=__webpack_require__.n(isBoolean),forEach=__webpack_require__("./node_modules/lodash/forEach.js"),forEach_default=__webpack_require__.n(forEach),external_fs_=__webpack_require__("fs"),path=__webpack_require__("./node_modules/path/path.js"),path_default=__webpack_require__.n(path),rimraf=__webpack_require__("./node_modules/rimraf/rimraf.js"),rimraf_default=__webpack_require__.n(rimraf),crypto_ignored_=__webpack_require__("?0667"),better_sqlite3_=__webpack_require__("@signalapp/better-sqlite3"),better_sqlite3_default=__webpack_require__.n(better_sqlite3_),p_props=__webpack_require__("./node_modules/p-props/index.js"),p_props_default=__webpack_require__.n(p_props),MessageReadStatus=__webpack_require__("./ts/messages/MessageReadStatus.ts"),STORAGE_UI_KEYS=(__webpack_require__("./node_modules/zod/lib/index.mjs").z.enum(["system","light","dark"]),["always-relay-calls","audio-notification","auto-download-update","badge-count-muted-conversations","call-ringtone-notification","call-system-notification","customColors","defaultConversationColor","hide-menu-bar","incoming-call-notification","notification-draw-attention","notification-setting","pinnedConversationIds","preferred-audio-input-device","preferred-audio-output-device","preferred-video-input-device","preferredLeftPaneWidth","preferredReactionEmoji","previousAudioDeviceModule","showStickerPickerHint","showStickersIntroduction","skinTone","spell-check","system-tray-setting","theme-setting","zoomFactor"]);function combineNames_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function combineNames_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return combineNames_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return combineNames_arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function combineNames_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var CJK_Compatibility=/[\u3300-\u33FF]/,CJK_Compatibility_Forms=/[\uFE30-\uFE4F]/,CJK_Compatibility_Ideographs=/[\uF900-\uFAFF]/,CJK_Compatibility_Ideographs_Supplement=/\uD87E[\uDC00-\uDE1F]/,CJK_Radicals_Supplement=/[\u2E80-\u2EFF]/,CJK_Strokes=/[\u31C0-\u31EF]/,CJK_Symbols_And_Punctuation=/[\u3000-\u303F]/,CJK_Unified_Ideographs=/[\u4E00-\u9FFF]/,CJK_Unified_Ideographs_Extension_A=/[\u3400-\u4DBF]/,CJK_Unified_Ideographs_Extension_B=/[\uD840-\uD868][\uDC00-\uDFFF]|\uD869[\uDC00-\uDEDF]/,CJK_Unified_Ideographs_Extension_C=/\uD869[\uDF00-\uDFFF]|[\uD86A-\uD86C][\uDC00-\uDFFF]|\uD86D[\uDC00-\uDF3F]/,CJK_Unified_Ideographs_Extension_D=/\uD86D[\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1F]/,CJK_Unified_Ideographs_Extension_E=/\uD86E[\uDC20-\uDFFF]|[\uD86F-\uD872][\uDC00-\uDFFF]|\uD873[\uDC00-\uDEAF]/,Enclosed_CJK_Letters_And_Months=/[\u3200-\u32FF]/,Kangxi_Radicals=/[\u2F00-\u2FDF]/,Ideographic_Description_Characters=/[\u2FF0-\u2FFF]/,Hiragana=/[\u3040-\u309F]/,Katakana=/[\u30A0-\u30FF]/,Katakana_Phonetic_Extensions=/[\u31F0-\u31FF]/,Hangul_Compatibility_Jamo=/[\u3130-\u318F]/,Hangul_Jamo=/[\u1100-\u11FF]/,Hangul_Jamo_Extended_A=/[\uA960-\uA97F]/,Hangul_Jamo_Extended_B=/[\uD7B0-\uD7FF]/,Hangul_Syllables=/[\uAC00-\uD7AF]/,isIdeographic=/[\u3006\u3007\u3021-\u3029\u3038-\u303A\u3400-\u4DB5\u4E00-\u9FEF\uF900-\uFA6D\uFA70-\uFAD9]|[\uD81C-\uD820\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879][\uDC00-\uDFFF]|\uD821[\uDC00-\uDFF7]|\uD822[\uDC00-\uDEF2]|\uD82C[\uDD70-\uDEFB]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]/;function combineNames(given,family){if(given)return family?isAllCKJV(family)&&isAllCKJV(given)?`${family}${given}`:`${given} ${family}`:given}function isAllCKJV(name){var _step,_iterator=combineNames_createForOfIteratorHelper(name);try{for(_iterator.s();!(_step=_iterator.n()).done;){if(!isCKJV(_step.value))return!1}}catch(err){_iterator.e(err)}finally{_iterator.f()}return!0}function isCKJV(codePoint){return" "===codePoint||(CJK_Compatibility.test(codePoint)||CJK_Compatibility_Forms.test(codePoint)||CJK_Compatibility_Ideographs.test(codePoint)||CJK_Compatibility_Ideographs_Supplement.test(codePoint)||CJK_Radicals_Supplement.test(codePoint)||CJK_Strokes.test(codePoint)||CJK_Symbols_And_Punctuation.test(codePoint)||CJK_Unified_Ideographs.test(codePoint)||CJK_Unified_Ideographs_Extension_A.test(codePoint)||CJK_Unified_Ideographs_Extension_B.test(codePoint)||CJK_Unified_Ideographs_Extension_C.test(codePoint)||CJK_Unified_Ideographs_Extension_D.test(codePoint)||CJK_Unified_Ideographs_Extension_E.test(codePoint)||Enclosed_CJK_Letters_And_Months.test(codePoint)||Kangxi_Radicals.test(codePoint)||Ideographic_Description_Characters.test(codePoint)||Hiragana.test(codePoint)||Katakana.test(codePoint)||Katakana_Phonetic_Extensions.test(codePoint)||Hangul_Compatibility_Jamo.test(codePoint)||Hangul_Jamo.test(codePoint)||Hangul_Jamo_Extended_A.test(codePoint)||Hangul_Jamo_Extended_B.test(codePoint)||Hangul_Syllables.test(codePoint)||isIdeographic.test(codePoint))}var consoleLogger={fatal:function(){var _console;(_console=console).error.apply(_console,arguments)},error:function(){var _console2;(_console2=console).error.apply(_console2,arguments)},warn:function(){var _console3;(_console3=console).warn.apply(_console3,arguments)},info:function(){var _console4;(_console4=console).info.apply(_console4,arguments)},debug:function(){var _console5;(_console5=console).debug.apply(_console5,arguments)},trace:function(){var _console6;(_console6=console).log.apply(_console6,arguments)}};function isNormalNumber(value){return"number"==typeof value&&!Number.isNaN(value)&&Number.isFinite(value)}var RemoveAllConfiguration,util_isNotNil=__webpack_require__("./ts/util/isNotNil.ts"),missingCaseError=__webpack_require__("./ts/util/missingCaseError.ts"),util_parseIntOrThrow=__webpack_require__("./ts/util/parseIntOrThrow.ts"),formatCountForLogging=function(count){return 0===count||Number.isNaN(count)?String(count):`at least ${10**Math.floor(Math.log10(count))}`};!function(RemoveAllConfiguration){RemoveAllConfiguration.Full="Full",RemoveAllConfiguration.Soft="Soft"}(RemoveAllConfiguration||(RemoveAllConfiguration={}));var BadgeCategory=__webpack_require__("./ts/badges/BadgeCategory.ts"),BadgeImageTheme=__webpack_require__("./ts/badges/BadgeImageTheme.ts");function util_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function util_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function util_toConsumableArray(arr){return function util_arrayWithoutHoles(arr){if(Array.isArray(arr))return util_arrayLikeToArray(arr)}(arr)||function util_iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||util_unsupportedIterableToArray(arr)||function util_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function util_slicedToArray(arr,i){return function util_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function util_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||util_unsupportedIterableToArray(arr,i)||function util_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function util_unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return util_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?util_arrayLikeToArray(o,minLen):void 0}}function util_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function objectToJSON(data){return JSON.stringify(data)}function jsonToObject(json){return JSON.parse(json)}function sqlFragment(strings){for(var _len=arguments.length,values=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)values[_key-1]=arguments[_key];var query="",params=[];return strings.forEach((function(string,index){var value=values[index];if(query+=string,index<values.length)if(Array.isArray(value)){var _value=util_slicedToArray(value,2),fragment=_value[0].fragment,fragmentParams=_value[1];query+=fragment,params.push.apply(params,util_toConsumableArray(fragmentParams))}else query+="?",params.push(value)})),[{fragment:query},params]}function sql(strings){for(var _len2=arguments.length,values=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)values[_key2-1]=arguments[_key2];var _sqlFragment=sqlFragment.apply(void 0,[strings].concat(values)),_sqlFragment2=util_slicedToArray(_sqlFragment,2),fragment=_sqlFragment2[0].fragment,params=_sqlFragment2[1];return[fragment,params]}function getSchemaVersion(db){return db.pragma("schema_version",{simple:!0})}function getUserVersion(db){return db.pragma("user_version",{simple:!0})}function batchMultiVarQuery(db,values,query){if(values.length>100){var _result=[];return db.transaction((function(){for(var i=0;i<values.length;i+=100){var _batch=values.slice(i,i+100),batchResult=query(_batch);Array.isArray(batchResult)&&_result.push.apply(_result,util_toConsumableArray(batchResult))}}))(),_result}var result=query(values);return Array.isArray(result)?result:[]}function createOrUpdate(db,table,data){var id=data.id;if(!id)throw new Error("createOrUpdate: Provided data did not have a truthy id");db.prepare(`\n    INSERT OR REPLACE INTO ${table} (\n      id,\n      json\n    ) values (\n      $id,\n      $json\n    )\n    `).run({id,json:objectToJSON(data)})}function bulkAdd(db,table,array){db.transaction((function(){var _step,_iterator=function util_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=util_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}(array);try{for(_iterator.s();!(_step=_iterator.n()).done;){var data=_step.value;createOrUpdate(db,table,data)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}))()}function getById(db,table,id){var row=db.prepare(`\n      SELECT *\n      FROM ${table}\n      WHERE id = $id;\n      `).get({id});if(row)return jsonToObject(row.json)}function removeById(db,table,id){if(Array.isArray(id)){if(!id.length)throw new Error("removeById: No ids to delete!");batchMultiVarQuery(db,id,(function(ids){db.prepare(`\n      DELETE FROM ${table}\n      WHERE id IN ( ${id.map((function(){return"?"})).join(", ")} );\n      `).run(ids)}))}else db.prepare(`\n      DELETE FROM ${table}\n      WHERE id = $id;\n      `).run({id})}function removeAllFromTable(db,table){db.prepare(`DELETE FROM ${table};`).run()}function getAllFromTable(db,table){return db.prepare(`SELECT json FROM ${table};`).all().map((function(row){return jsonToObject(row.json)}))}function getCountFromTable(db,table){var result=db.prepare(`SELECT count(*) from ${table};`).pluck(!0).get();if(isNumber_default()(result))return result;throw new Error(`getCountFromTable: Unable to get count from table ${table}`)}var TableIterator=function(_Symbol$iterator){function TableIterator(db,table){var pageSize=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500;util_classCallCheck(this,TableIterator),this.db=db,this.table=table,this.pageSize=pageSize}return function util_createClass(Constructor,protoProps,staticProps){return protoProps&&util_defineProperties(Constructor.prototype,protoProps),staticProps&&util_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(TableIterator,[{key:Symbol.iterator,value:function*(){for(var fetchObject=this.db.prepare(`\n        SELECT json FROM ${this.table}\n        WHERE id > $id\n        ORDER BY id ASC\n        LIMIT $pageSize;\n      `),complete=!1,id="";!complete;){var messages=fetchObject.all({id,pageSize:this.pageSize}).map((function(row){return jsonToObject(row.json)}));yield*messages;var lastMessage=last_default()(messages);lastMessage&&(id=lastMessage.id),complete=messages.length<this.pageSize}}}]),TableIterator}(),keyBy=__webpack_require__("./node_modules/lodash/keyBy.js"),keyBy_default=__webpack_require__.n(keyBy),arrayBuffer=new ArrayBuffer(0),uint8Array=new Uint8Array,StaticArrayBufferProto=arrayBuffer.__proto__,StaticUint8ArrayProto=uint8Array.__proto__;function getString(thing){if(thing===Object(thing)){if(thing.__proto__===StaticUint8ArrayProto)return String.fromCharCode.apply(null,thing);if(thing.__proto__===StaticArrayBufferProto)return getString(new Uint8Array(thing))}return thing}function ensureStringed(thing){if(function getStringable(thing){return"string"==typeof thing||"number"==typeof thing||"boolean"==typeof thing||thing===Object(thing)&&(thing.__proto__===StaticArrayBufferProto||thing.__proto__===StaticUint8ArrayProto)}(thing))return getString(thing);if(thing instanceof Array){for(var res=[],i=0;i<thing.length;i+=1)res[i]=ensureStringed(thing[i]);return res}if(thing===Object(thing)){var _res={};for(var key in thing)_res[key]=ensureStringed(thing[key]);return _res}if(null==thing)return null;throw new Error("unsure of how to jsonify object of type "+typeof thing)}const Helpers={getString,isNumberSane:function(number){return"+"===number[0]&&/^[0-9]+$/.test(number.substring(1))},jsonThing:function(thing){return JSON.stringify(ensureStringed(thing))},unencodeNumber:function(number){return number.split(".")}};function _41_uuid_keys_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_41_uuid_keys_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _41_uuid_keys_slicedToArray(arr,i){return function _41_uuid_keys_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _41_uuid_keys_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||_41_uuid_keys_unsupportedIterableToArray(arr,i)||function _41_uuid_keys_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _41_uuid_keys_unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _41_uuid_keys_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_41_uuid_keys_arrayLikeToArray(o,minLen):void 0}}function _41_uuid_keys_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function getOurUuid(db){var row=db.prepare("SELECT json FROM items WHERE id = $id;").get({id:"uuid_id"});if(row){var value=JSON.parse(row.json).value;return _41_uuid_keys_slicedToArray(Helpers.unencodeNumber(String(value).toLowerCase()),1)[0]}}function _43_gv2_uuid_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function _43_gv2_uuid_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _43_gv2_uuid_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _43_gv2_uuid_arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _43_gv2_uuid_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var SeenStatus,isRecord=function(value){return"object"==typeof value&&!Array.isArray(value)&&null!=value};function _53_gv2_banned_members_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function _53_gv2_banned_members_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _53_gv2_banned_members_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _53_gv2_banned_members_arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _53_gv2_banned_members_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}!function(SeenStatus){SeenStatus[SeenStatus.NotApplicable=0]="NotApplicable",SeenStatus[SeenStatus.Unseen=1]="Unseen",SeenStatus[SeenStatus.Seen=2]="Seen"}(SeenStatus||(SeenStatus={}));SeenStatus.NotApplicable,SeenStatus.Unseen,SeenStatus.Seen;function _78_merge_receipt_jobs_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function _78_merge_receipt_jobs_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _78_merge_receipt_jobs_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _78_merge_receipt_jobs_arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _78_merge_receipt_jobs_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function migrations_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function migrations_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return migrations_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return migrations_arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function migrations_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var SCHEMA_VERSIONS=[function updateToSchemaVersion1(currentVersion,db,logger){currentVersion>=1||(logger.info("updateToSchemaVersion1: starting..."),db.transaction((function(){db.exec("\n      CREATE TABLE messages(\n        id STRING PRIMARY KEY ASC,\n        json TEXT,\n\n        unread INTEGER,\n        expires_at INTEGER,\n        sent_at INTEGER,\n        schemaVersion INTEGER,\n        conversationId STRING,\n        received_at INTEGER,\n        source STRING,\n        sourceDevice STRING,\n        hasAttachments INTEGER,\n        hasFileAttachments INTEGER,\n        hasVisualMediaAttachments INTEGER\n      );\n      CREATE INDEX messages_unread ON messages (\n        unread\n      );\n      CREATE INDEX messages_expires_at ON messages (\n        expires_at\n      );\n      CREATE INDEX messages_receipt ON messages (\n        sent_at\n      );\n      CREATE INDEX messages_schemaVersion ON messages (\n        schemaVersion\n      );\n      CREATE INDEX messages_conversation ON messages (\n        conversationId,\n        received_at\n      );\n      CREATE INDEX messages_duplicate_check ON messages (\n        source,\n        sourceDevice,\n        sent_at\n      );\n      CREATE INDEX messages_hasAttachments ON messages (\n        conversationId,\n        hasAttachments,\n        received_at\n      );\n      CREATE INDEX messages_hasFileAttachments ON messages (\n        conversationId,\n        hasFileAttachments,\n        received_at\n      );\n      CREATE INDEX messages_hasVisualMediaAttachments ON messages (\n        conversationId,\n        hasVisualMediaAttachments,\n        received_at\n      );\n      CREATE TABLE unprocessed(\n        id STRING,\n        timestamp INTEGER,\n        json TEXT\n      );\n      CREATE INDEX unprocessed_id ON unprocessed (\n        id\n      );\n      CREATE INDEX unprocessed_timestamp ON unprocessed (\n        timestamp\n      );\n    "),db.pragma("user_version = 1")}))(),logger.info("updateToSchemaVersion1: success!"))},function updateToSchemaVersion2(currentVersion,db,logger){currentVersion>=2||(logger.info("updateToSchemaVersion2: starting..."),db.transaction((function(){db.exec("\n      ALTER TABLE messages\n        ADD COLUMN expireTimer INTEGER;\n\n      ALTER TABLE messages\n        ADD COLUMN expirationStartTimestamp INTEGER;\n\n      ALTER TABLE messages\n        ADD COLUMN type STRING;\n\n      CREATE INDEX messages_expiring ON messages (\n        expireTimer,\n        expirationStartTimestamp,\n        expires_at\n      );\n\n      UPDATE messages SET\n        expirationStartTimestamp = json_extract(json, '$.expirationStartTimestamp'),\n        expireTimer = json_extract(json, '$.expireTimer'),\n        type = json_extract(json, '$.type');\n    "),db.pragma("user_version = 2")}))(),logger.info("updateToSchemaVersion2: success!"))},function updateToSchemaVersion3(currentVersion,db,logger){currentVersion>=3||(logger.info("updateToSchemaVersion3: starting..."),db.transaction((function(){db.exec("\n      DROP INDEX messages_expiring;\n      DROP INDEX messages_unread;\n\n      CREATE INDEX messages_without_timer ON messages (\n        expireTimer,\n        expires_at,\n        type\n      ) WHERE expires_at IS NULL AND expireTimer IS NOT NULL;\n\n      CREATE INDEX messages_unread ON messages (\n        conversationId,\n        unread\n      ) WHERE unread IS NOT NULL;\n\n      ANALYZE;\n    "),db.pragma("user_version = 3")}))(),logger.info("updateToSchemaVersion3: success!"))},function updateToSchemaVersion4(currentVersion,db,logger){currentVersion>=4||(logger.info("updateToSchemaVersion4: starting..."),db.transaction((function(){db.exec("\n      CREATE TABLE conversations(\n        id STRING PRIMARY KEY ASC,\n        json TEXT,\n\n        active_at INTEGER,\n        type STRING,\n        members TEXT,\n        name TEXT,\n        profileName TEXT\n      );\n      CREATE INDEX conversations_active ON conversations (\n        active_at\n      ) WHERE active_at IS NOT NULL;\n\n      CREATE INDEX conversations_type ON conversations (\n        type\n      ) WHERE type IS NOT NULL;\n    "),db.pragma("user_version = 4")}))(),logger.info("updateToSchemaVersion4: success!"))},function(_v,_i,_l){},function updateToSchemaVersion6(currentVersion,db,logger){currentVersion>=6||(logger.info("updateToSchemaVersion6: starting..."),db.transaction((function(){db.exec("\n      -- key-value, ids are strings, one extra column\n      CREATE TABLE sessions(\n        id STRING PRIMARY KEY ASC,\n        number STRING,\n        json TEXT\n      );\n      CREATE INDEX sessions_number ON sessions (\n        number\n      ) WHERE number IS NOT NULL;\n      -- key-value, ids are strings\n      CREATE TABLE groups(\n        id STRING PRIMARY KEY ASC,\n        json TEXT\n      );\n      CREATE TABLE identityKeys(\n        id STRING PRIMARY KEY ASC,\n        json TEXT\n      );\n      CREATE TABLE items(\n        id STRING PRIMARY KEY ASC,\n        json TEXT\n      );\n      -- key-value, ids are integers\n      CREATE TABLE preKeys(\n        id INTEGER PRIMARY KEY ASC,\n        json TEXT\n      );\n      CREATE TABLE signedPreKeys(\n        id INTEGER PRIMARY KEY ASC,\n        json TEXT\n      );\n    "),db.pragma("user_version = 6")}))(),logger.info("updateToSchemaVersion6: success!"))},function updateToSchemaVersion7(currentVersion,db,logger){currentVersion>=7||(logger.info("updateToSchemaVersion7: starting..."),db.transaction((function(){db.exec("\n      -- SQLite has been coercing our STRINGs into numbers, so we force it with TEXT\n      -- We create a new table then copy the data into it, since we can't modify columns\n      DROP INDEX sessions_number;\n      ALTER TABLE sessions RENAME TO sessions_old;\n\n      CREATE TABLE sessions(\n        id TEXT PRIMARY KEY,\n        number TEXT,\n        json TEXT\n      );\n      CREATE INDEX sessions_number ON sessions (\n        number\n      ) WHERE number IS NOT NULL;\n      INSERT INTO sessions(id, number, json)\n        SELECT '+' || id, number, json FROM sessions_old;\n      DROP TABLE sessions_old;\n    "),db.pragma("user_version = 7")}))(),logger.info("updateToSchemaVersion7: success!"))},function updateToSchemaVersion8(currentVersion,db,logger){currentVersion>=8||(logger.info("updateToSchemaVersion8: starting..."),db.transaction((function(){db.exec("\n      -- First, we pull a new body field out of the message table's json blob\n      ALTER TABLE messages\n        ADD COLUMN body TEXT;\n      UPDATE messages SET body = json_extract(json, '$.body');\n\n      -- Then we create our full-text search table and populate it\n      CREATE VIRTUAL TABLE messages_fts\n        USING fts5(id UNINDEXED, body);\n\n      INSERT INTO messages_fts(id, body)\n        SELECT id, body FROM messages;\n\n      -- Then we set up triggers to keep the full-text search table up to date\n      CREATE TRIGGER messages_on_insert AFTER INSERT ON messages BEGIN\n        INSERT INTO messages_fts (\n          id,\n          body\n        ) VALUES (\n          new.id,\n          new.body\n        );\n      END;\n      CREATE TRIGGER messages_on_delete AFTER DELETE ON messages BEGIN\n        DELETE FROM messages_fts WHERE id = old.id;\n      END;\n      CREATE TRIGGER messages_on_update AFTER UPDATE ON messages BEGIN\n        DELETE FROM messages_fts WHERE id = old.id;\n        INSERT INTO messages_fts(\n          id,\n          body\n        ) VALUES (\n          new.id,\n          new.body\n        );\n      END;\n    "),db.pragma("user_version = 8")}))(),logger.info("updateToSchemaVersion8: success!"))},function updateToSchemaVersion9(currentVersion,db,logger){currentVersion>=9||(logger.info("updateToSchemaVersion9: starting..."),db.transaction((function(){db.exec("\n      CREATE TABLE attachment_downloads(\n        id STRING primary key,\n        timestamp INTEGER,\n        pending INTEGER,\n        json TEXT\n      );\n\n      CREATE INDEX attachment_downloads_timestamp\n        ON attachment_downloads (\n          timestamp\n      ) WHERE pending = 0;\n      CREATE INDEX attachment_downloads_pending\n        ON attachment_downloads (\n          pending\n      ) WHERE pending != 0;\n    "),db.pragma("user_version = 9")}))(),logger.info("updateToSchemaVersion9: success!"))},function updateToSchemaVersion10(currentVersion,db,logger){currentVersion>=10||(logger.info("updateToSchemaVersion10: starting..."),db.transaction((function(){db.exec("\n      DROP INDEX unprocessed_id;\n      DROP INDEX unprocessed_timestamp;\n      ALTER TABLE unprocessed RENAME TO unprocessed_old;\n\n      CREATE TABLE unprocessed(\n        id STRING,\n        timestamp INTEGER,\n        version INTEGER,\n        attempts INTEGER,\n        envelope TEXT,\n        decrypted TEXT,\n        source TEXT,\n        sourceDevice TEXT,\n        serverTimestamp INTEGER\n      );\n\n      CREATE INDEX unprocessed_id ON unprocessed (\n        id\n      );\n      CREATE INDEX unprocessed_timestamp ON unprocessed (\n        timestamp\n      );\n\n      INSERT INTO unprocessed (\n        id,\n        timestamp,\n        version,\n        attempts,\n        envelope,\n        decrypted,\n        source,\n        sourceDevice,\n        serverTimestamp\n      ) SELECT\n        id,\n        timestamp,\n        json_extract(json, '$.version'),\n        json_extract(json, '$.attempts'),\n        json_extract(json, '$.envelope'),\n        json_extract(json, '$.decrypted'),\n        json_extract(json, '$.source'),\n        json_extract(json, '$.sourceDevice'),\n        json_extract(json, '$.serverTimestamp')\n      FROM unprocessed_old;\n\n      DROP TABLE unprocessed_old;\n    "),db.pragma("user_version = 10")}))(),logger.info("updateToSchemaVersion10: success!"))},function updateToSchemaVersion11(currentVersion,db,logger){currentVersion>=11||(logger.info("updateToSchemaVersion11: starting..."),db.transaction((function(){db.exec("\n      DROP TABLE groups;\n    "),db.pragma("user_version = 11")}))(),logger.info("updateToSchemaVersion11: success!"))},function updateToSchemaVersion12(currentVersion,db,logger){currentVersion>=12||(logger.info("updateToSchemaVersion12: starting..."),db.transaction((function(){db.exec("\n      CREATE TABLE sticker_packs(\n        id TEXT PRIMARY KEY,\n        key TEXT NOT NULL,\n\n        author STRING,\n        coverStickerId INTEGER,\n        createdAt INTEGER,\n        downloadAttempts INTEGER,\n        installedAt INTEGER,\n        lastUsed INTEGER,\n        status STRING,\n        stickerCount INTEGER,\n        title STRING\n      );\n\n      CREATE TABLE stickers(\n        id INTEGER NOT NULL,\n        packId TEXT NOT NULL,\n\n        emoji STRING,\n        height INTEGER,\n        isCoverOnly INTEGER,\n        lastUsed INTEGER,\n        path STRING,\n        width INTEGER,\n\n        PRIMARY KEY (id, packId),\n        CONSTRAINT stickers_fk\n          FOREIGN KEY (packId)\n          REFERENCES sticker_packs(id)\n          ON DELETE CASCADE\n      );\n\n      CREATE INDEX stickers_recents\n        ON stickers (\n          lastUsed\n      ) WHERE lastUsed IS NOT NULL;\n\n      CREATE TABLE sticker_references(\n        messageId STRING,\n        packId TEXT,\n        CONSTRAINT sticker_references_fk\n          FOREIGN KEY(packId)\n          REFERENCES sticker_packs(id)\n          ON DELETE CASCADE\n      );\n    "),db.pragma("user_version = 12")}))(),logger.info("updateToSchemaVersion12: success!"))},function updateToSchemaVersion13(currentVersion,db,logger){currentVersion>=13||(logger.info("updateToSchemaVersion13: starting..."),db.transaction((function(){db.exec("\n      ALTER TABLE sticker_packs ADD COLUMN attemptedStatus STRING;\n    "),db.pragma("user_version = 13")}))(),logger.info("updateToSchemaVersion13: success!"))},function updateToSchemaVersion14(currentVersion,db,logger){currentVersion>=14||(logger.info("updateToSchemaVersion14: starting..."),db.transaction((function(){db.exec("\n      CREATE TABLE emojis(\n        shortName STRING PRIMARY KEY,\n        lastUsage INTEGER\n      );\n\n      CREATE INDEX emojis_lastUsage\n        ON emojis (\n          lastUsage\n      );\n    "),db.pragma("user_version = 14")}))(),logger.info("updateToSchemaVersion14: success!"))},function updateToSchemaVersion15(currentVersion,db,logger){currentVersion>=15||(logger.info("updateToSchemaVersion15: starting..."),db.transaction((function(){db.exec("\n      -- SQLite has again coerced our STRINGs into numbers, so we force it with TEXT\n      -- We create a new table then copy the data into it, since we can't modify columns\n\n      DROP INDEX emojis_lastUsage;\n      ALTER TABLE emojis RENAME TO emojis_old;\n\n      CREATE TABLE emojis(\n        shortName TEXT PRIMARY KEY,\n        lastUsage INTEGER\n      );\n      CREATE INDEX emojis_lastUsage\n        ON emojis (\n          lastUsage\n      );\n\n      DELETE FROM emojis WHERE shortName = 1;\n      INSERT INTO emojis(shortName, lastUsage)\n        SELECT shortName, lastUsage FROM emojis_old;\n\n      DROP TABLE emojis_old;\n    "),db.pragma("user_version = 15")}))(),logger.info("updateToSchemaVersion15: success!"))},function updateToSchemaVersion16(currentVersion,db,logger){currentVersion>=16||(logger.info("updateToSchemaVersion16: starting..."),db.transaction((function(){db.exec("\n      ALTER TABLE messages\n      ADD COLUMN messageTimer INTEGER;\n      ALTER TABLE messages\n      ADD COLUMN messageTimerStart INTEGER;\n      ALTER TABLE messages\n      ADD COLUMN messageTimerExpiresAt INTEGER;\n      ALTER TABLE messages\n      ADD COLUMN isErased INTEGER;\n\n      CREATE INDEX messages_message_timer ON messages (\n        messageTimer,\n        messageTimerStart,\n        messageTimerExpiresAt,\n        isErased\n      ) WHERE messageTimer IS NOT NULL;\n\n      -- Updating full-text triggers to avoid anything with a messageTimer set\n\n      DROP TRIGGER messages_on_insert;\n      DROP TRIGGER messages_on_delete;\n      DROP TRIGGER messages_on_update;\n\n      CREATE TRIGGER messages_on_insert AFTER INSERT ON messages\n      WHEN new.messageTimer IS NULL\n      BEGIN\n        INSERT INTO messages_fts (\n          id,\n          body\n        ) VALUES (\n          new.id,\n          new.body\n        );\n      END;\n      CREATE TRIGGER messages_on_delete AFTER DELETE ON messages BEGIN\n        DELETE FROM messages_fts WHERE id = old.id;\n      END;\n      CREATE TRIGGER messages_on_update AFTER UPDATE ON messages\n      WHEN new.messageTimer IS NULL\n      BEGIN\n        DELETE FROM messages_fts WHERE id = old.id;\n        INSERT INTO messages_fts(\n          id,\n          body\n        ) VALUES (\n          new.id,\n          new.body\n        );\n      END;\n    "),db.pragma("user_version = 16")}))(),logger.info("updateToSchemaVersion16: success!"))},function updateToSchemaVersion17(currentVersion,db,logger){currentVersion>=17||(logger.info("updateToSchemaVersion17: starting..."),db.transaction((function(){try{db.exec("\n        ALTER TABLE messages\n        ADD COLUMN isViewOnce INTEGER;\n\n        DROP INDEX messages_message_timer;\n      ")}catch(error){logger.info("updateToSchemaVersion17: Message table already had isViewOnce column")}try{db.exec("DROP INDEX messages_view_once;")}catch(error){logger.info("updateToSchemaVersion17: Index messages_view_once did not already exist")}db.exec("\n      CREATE INDEX messages_view_once ON messages (\n        isErased\n      ) WHERE isViewOnce = 1;\n\n      -- Updating full-text triggers to avoid anything with isViewOnce = 1\n\n      DROP TRIGGER messages_on_insert;\n      DROP TRIGGER messages_on_update;\n\n      CREATE TRIGGER messages_on_insert AFTER INSERT ON messages\n      WHEN new.isViewOnce != 1\n      BEGIN\n        INSERT INTO messages_fts (\n          id,\n          body\n        ) VALUES (\n          new.id,\n          new.body\n        );\n      END;\n      CREATE TRIGGER messages_on_update AFTER UPDATE ON messages\n      WHEN new.isViewOnce != 1\n      BEGIN\n        DELETE FROM messages_fts WHERE id = old.id;\n        INSERT INTO messages_fts(\n          id,\n          body\n        ) VALUES (\n          new.id,\n          new.body\n        );\n      END;\n    "),db.pragma("user_version = 17")}))(),logger.info("updateToSchemaVersion17: success!"))},function updateToSchemaVersion18(currentVersion,db,logger){currentVersion>=18||(logger.info("updateToSchemaVersion18: starting..."),db.transaction((function(){db.exec("\n      -- Delete and rebuild full-text search index to capture everything\n\n      DELETE FROM messages_fts;\n      INSERT INTO messages_fts(messages_fts) VALUES('rebuild');\n\n      INSERT INTO messages_fts(id, body)\n      SELECT id, body FROM messages WHERE isViewOnce IS NULL OR isViewOnce != 1;\n\n      -- Fixing full-text triggers\n\n      DROP TRIGGER messages_on_insert;\n      DROP TRIGGER messages_on_update;\n\n      CREATE TRIGGER messages_on_insert AFTER INSERT ON messages\n      WHEN new.isViewOnce IS NULL OR new.isViewOnce != 1\n      BEGIN\n        INSERT INTO messages_fts (\n          id,\n          body\n        ) VALUES (\n          new.id,\n          new.body\n        );\n      END;\n      CREATE TRIGGER messages_on_update AFTER UPDATE ON messages\n      WHEN new.isViewOnce IS NULL OR new.isViewOnce != 1\n      BEGIN\n        DELETE FROM messages_fts WHERE id = old.id;\n        INSERT INTO messages_fts(\n          id,\n          body\n        ) VALUES (\n          new.id,\n          new.body\n        );\n      END;\n    "),db.pragma("user_version = 18")}))(),logger.info("updateToSchemaVersion18: success!"))},function updateToSchemaVersion19(currentVersion,db,logger){currentVersion>=19||(logger.info("updateToSchemaVersion19: starting..."),db.transaction((function(){db.exec("\n      ALTER TABLE conversations\n      ADD COLUMN profileFamilyName TEXT;\n      ALTER TABLE conversations\n      ADD COLUMN profileFullName TEXT;\n\n      -- Preload new field with the profileName we already have\n      UPDATE conversations SET profileFullName = profileName;\n    "),db.pragma("user_version = 19")}))(),logger.info("updateToSchemaVersion19: success!"))},function updateToSchemaVersion20(currentVersion,db,logger){currentVersion>=20||(logger.info("updateToSchemaVersion20: starting..."),db.transaction((function(){var _step,triggers=db.prepare("SELECT * FROM sqlite_master WHERE type = 'trigger' AND tbl_name = 'messages'").all(),_iterator=migrations_createForOfIteratorHelper(triggers);try{for(_iterator.s();!(_step=_iterator.n()).done;){var trigger=_step.value;db.exec(`DROP TRIGGER ${trigger.name}`)}}catch(err){_iterator.e(err)}finally{_iterator.f()}db.exec("\n      ALTER TABLE conversations ADD COLUMN e164 TEXT;\n      ALTER TABLE conversations ADD COLUMN uuid TEXT;\n      ALTER TABLE conversations ADD COLUMN groupId TEXT;\n      ALTER TABLE messages ADD COLUMN sourceUuid TEXT;\n      ALTER TABLE sessions RENAME COLUMN number TO conversationId;\n      CREATE INDEX conversations_e164 ON conversations(e164);\n      CREATE INDEX conversations_uuid ON conversations(uuid);\n      CREATE INDEX conversations_groupId ON conversations(groupId);\n      CREATE INDEX messages_sourceUuid on messages(sourceUuid);\n\n      -- Migrate existing IDs\n      UPDATE conversations SET e164 = '+' || id WHERE type = 'private';\n      UPDATE conversations SET groupId = id WHERE type = 'group';\n    ");var _step2,_iterator2=migrations_createForOfIteratorHelper(db.prepare("SELECT * FROM conversations WHERE type = 'group' AND members IS NULL;").all());try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var group=_step2.value,json=JSON.parse(group.json);json.members&&json.members.length||(db.prepare("DELETE FROM conversations WHERE id = $id;").run({id:json.id}),db.prepare("DELETE FROM messages WHERE conversationId = $id;").run({id:json.id}))}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var _step3,allConversations=db.prepare("SELECT * FROM conversations;").all(),allConversationsByOldId=keyBy_default()(allConversations,"id"),_iterator3=migrations_createForOfIteratorHelper(allConversations);try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var row=_step3.value,oldId=row.id,newId=types_UUID.hb.generate().toString();allConversationsByOldId[oldId].id=newId;var patchObj={id:newId};"private"===row.type?patchObj.e164=`+${oldId}`:"group"===row.type&&(patchObj.groupId=oldId);var patch=JSON.stringify(patchObj);db.prepare("\n        UPDATE conversations\n        SET id = $newId, json = JSON_PATCH(json, $patch)\n        WHERE id = $oldId\n        ").run({newId,oldId,patch});var messagePatch=JSON.stringify({conversationId:newId});db.prepare("\n        UPDATE messages\n        SET conversationId = $newId, json = JSON_PATCH(json, $patch)\n        WHERE conversationId = $oldId\n        ").run({newId,oldId,patch:messagePatch})}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}db.prepare("\n        SELECT id, members, json FROM conversations WHERE type = 'group';\n        ").all().forEach((function(groupRow){var _step4,newMembers=[],_iterator4=migrations_createForOfIteratorHelper(groupRow.members.split(/\s?\+/).filter(Boolean));try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var m=_step4.value,memberRow=allConversationsByOldId[m];if(memberRow)newMembers.push(memberRow.id);else{var id=types_UUID.hb.generate().toString(),updatedConversation={id,e164:m,type:"private",version:2,unreadCount:0,verified:0,inbox_position:0,isPinned:!1,lastMessageDeletedForEveryone:!1,markedUnread:!1,messageCount:0,sentMessageCount:0,profileSharing:!1};db.prepare("\n            UPDATE conversations\n            SET\n              json = $json,\n              e164 = $e164,\n              type = $type\n            WHERE\n              id = $id;\n            ").run({id:updatedConversation.id,json:objectToJSON(updatedConversation),e164:updatedConversation.e164,type:updatedConversation.type}),newMembers.push(id)}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}var json=Object.assign({},jsonToObject(groupRow.json),{members:newMembers}),newMembersValue=newMembers.join(" ");db.prepare("\n        UPDATE conversations\n        SET members = $newMembersValue, json = $newJsonValue\n        WHERE id = $id\n        ").run({id:groupRow.id,newMembersValue,newJsonValue:objectToJSON(json)})}));var _step5,_iterator5=migrations_createForOfIteratorHelper(db.prepare("SELECT * FROM sessions;").all());try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var session=_step5.value,newJson=JSON.parse(session.json),conversation=allConversationsByOldId[newJson.number.substr(1)];conversation&&(newJson.conversationId=conversation.id,newJson.id=`${newJson.conversationId}.${newJson.deviceId}`),delete newJson.number,db.prepare("\n        UPDATE sessions\n        SET id = $newId, json = $newJson, conversationId = $newConversationId\n        WHERE id = $oldId\n        ").run({newId:newJson.id,newJson:objectToJSON(newJson),oldId:session.id,newConversationId:newJson.conversationId})}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}var _step6,_iterator6=migrations_createForOfIteratorHelper(db.prepare("SELECT * FROM identityKeys;").all());try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var identityKey=_step6.value,_newJson=JSON.parse(identityKey.json);_newJson.id=allConversationsByOldId[_newJson.id],db.prepare("\n        UPDATE identityKeys\n        SET id = $newId, json = $newJson\n        WHERE id = $oldId\n        ").run({newId:_newJson.id,newJson:objectToJSON(_newJson),oldId:identityKey.id})}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}var _step7,_iterator7=migrations_createForOfIteratorHelper(triggers);try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var _trigger=_step7.value;db.exec(_trigger.sql)}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}db.pragma("user_version = 20")}))(),logger.info("updateToSchemaVersion20: success!"))},function updateToSchemaVersion21(currentVersion,db,logger){currentVersion>=21||(db.transaction((function(){db.exec("\n      UPDATE conversations\n      SET json = json_set(\n        json,\n        '$.messageCount',\n        (SELECT count(*) FROM messages WHERE messages.conversationId = conversations.id)\n      );\n      UPDATE conversations\n      SET json = json_set(\n        json,\n        '$.sentMessageCount',\n        (SELECT count(*) FROM messages WHERE messages.conversationId = conversations.id AND messages.type = 'outgoing')\n      );\n    "),db.pragma("user_version = 21")}))(),logger.info("updateToSchemaVersion21: success!"))},function updateToSchemaVersion22(currentVersion,db,logger){currentVersion>=22||(db.transaction((function(){db.exec("\n      ALTER TABLE unprocessed\n        ADD COLUMN sourceUuid STRING;\n    "),db.pragma("user_version = 22")}))(),logger.info("updateToSchemaVersion22: success!"))},function updateToSchemaVersion23(currentVersion,db,logger){currentVersion>=23||(db.transaction((function(){db.exec("\n      -- Remove triggers which keep full-text search up to date\n      DROP TRIGGER messages_on_insert;\n      DROP TRIGGER messages_on_update;\n      DROP TRIGGER messages_on_delete;\n    "),db.pragma("user_version = 23")}))(),logger.info("updateToSchemaVersion23: success!"))},function updateToSchemaVersion24(currentVersion,db,logger){currentVersion>=24||(db.transaction((function(){db.exec("\n      ALTER TABLE conversations\n      ADD COLUMN profileLastFetchedAt INTEGER;\n    "),db.pragma("user_version = 24")}))(),logger.info("updateToSchemaVersion24: success!"))},function updateToSchemaVersion25(currentVersion,db,logger){currentVersion>=25||(db.transaction((function(){db.exec("\n      ALTER TABLE messages\n      RENAME TO old_messages\n    ");for(var _i2=0,_indicesToDrop=["messages_expires_at","messages_receipt","messages_schemaVersion","messages_conversation","messages_duplicate_check","messages_hasAttachments","messages_hasFileAttachments","messages_hasVisualMediaAttachments","messages_without_timer","messages_unread","messages_view_once","messages_sourceUuid"];_i2<_indicesToDrop.length;_i2++){var index=_indicesToDrop[_i2];db.exec(`DROP INDEX IF EXISTS ${index};`)}db.exec("\n      --\n      -- Create a new table with a different primary key\n      --\n\n      CREATE TABLE messages(\n        rowid INTEGER PRIMARY KEY ASC,\n        id STRING UNIQUE,\n        json TEXT,\n        unread INTEGER,\n        expires_at INTEGER,\n        sent_at INTEGER,\n        schemaVersion INTEGER,\n        conversationId STRING,\n        received_at INTEGER,\n        source STRING,\n        sourceDevice STRING,\n        hasAttachments INTEGER,\n        hasFileAttachments INTEGER,\n        hasVisualMediaAttachments INTEGER,\n        expireTimer INTEGER,\n        expirationStartTimestamp INTEGER,\n        type STRING,\n        body TEXT,\n        messageTimer INTEGER,\n        messageTimerStart INTEGER,\n        messageTimerExpiresAt INTEGER,\n        isErased INTEGER,\n        isViewOnce INTEGER,\n        sourceUuid TEXT);\n\n      -- Create index in lieu of old PRIMARY KEY\n      CREATE INDEX messages_id ON messages (id ASC);\n\n      --\n      -- Recreate indices\n      --\n\n      CREATE INDEX messages_expires_at ON messages (expires_at);\n\n      CREATE INDEX messages_receipt ON messages (sent_at);\n\n      CREATE INDEX messages_schemaVersion ON messages (schemaVersion);\n\n      CREATE INDEX messages_conversation ON messages\n        (conversationId, received_at);\n\n      CREATE INDEX messages_duplicate_check ON messages\n        (source, sourceDevice, sent_at);\n\n      CREATE INDEX messages_hasAttachments ON messages\n        (conversationId, hasAttachments, received_at);\n\n      CREATE INDEX messages_hasFileAttachments ON messages\n        (conversationId, hasFileAttachments, received_at);\n\n      CREATE INDEX messages_hasVisualMediaAttachments ON messages\n        (conversationId, hasVisualMediaAttachments, received_at);\n\n      CREATE INDEX messages_without_timer ON messages\n        (expireTimer, expires_at, type)\n        WHERE expires_at IS NULL AND expireTimer IS NOT NULL;\n\n      CREATE INDEX messages_unread ON messages\n        (conversationId, unread) WHERE unread IS NOT NULL;\n\n      CREATE INDEX messages_view_once ON messages\n        (isErased) WHERE isViewOnce = 1;\n\n      CREATE INDEX messages_sourceUuid on messages(sourceUuid);\n\n      -- New index for searchMessages\n      CREATE INDEX messages_searchOrder on messages(received_at, sent_at);\n\n      --\n      -- Re-create messages_fts and add triggers\n      --\n\n      DROP TABLE messages_fts;\n\n      CREATE VIRTUAL TABLE messages_fts USING fts5(body);\n\n      CREATE TRIGGER messages_on_insert AFTER INSERT ON messages\n      WHEN new.isViewOnce IS NULL OR new.isViewOnce != 1\n      BEGIN\n        INSERT INTO messages_fts\n        (rowid, body)\n        VALUES\n        (new.rowid, new.body);\n      END;\n\n      CREATE TRIGGER messages_on_delete AFTER DELETE ON messages BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n      END;\n\n      CREATE TRIGGER messages_on_update AFTER UPDATE ON messages\n      WHEN new.isViewOnce IS NULL OR new.isViewOnce != 1\n      BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n        INSERT INTO messages_fts\n        (rowid, body)\n        VALUES\n        (new.rowid, new.body);\n      END;\n\n      --\n      -- Copy data over\n      --\n\n      INSERT INTO messages\n      (\n        id, json, unread, expires_at, sent_at, schemaVersion, conversationId,\n        received_at, source, sourceDevice, hasAttachments, hasFileAttachments,\n        hasVisualMediaAttachments, expireTimer, expirationStartTimestamp, type,\n        body, messageTimer, messageTimerStart, messageTimerExpiresAt, isErased,\n        isViewOnce, sourceUuid\n      )\n      SELECT\n        id, json, unread, expires_at, sent_at, schemaVersion, conversationId,\n        received_at, source, sourceDevice, hasAttachments, hasFileAttachments,\n        hasVisualMediaAttachments, expireTimer, expirationStartTimestamp, type,\n        body, messageTimer, messageTimerStart, messageTimerExpiresAt, isErased,\n        isViewOnce, sourceUuid\n      FROM old_messages;\n\n      -- Drop old database\n      DROP TABLE old_messages;\n    "),db.pragma("user_version = 25")}))(),logger.info("updateToSchemaVersion25: success!"))},function updateToSchemaVersion26(currentVersion,db,logger){currentVersion>=26||(db.transaction((function(){db.exec("\n      DROP TRIGGER messages_on_insert;\n      DROP TRIGGER messages_on_update;\n\n      CREATE TRIGGER messages_on_insert AFTER INSERT ON messages\n      WHEN new.isViewOnce IS NULL OR new.isViewOnce != 1\n      BEGIN\n        INSERT INTO messages_fts\n        (rowid, body)\n        VALUES\n        (new.rowid, new.body);\n      END;\n\n      CREATE TRIGGER messages_on_update AFTER UPDATE ON messages\n      WHEN new.body != old.body AND\n        (new.isViewOnce IS NULL OR new.isViewOnce != 1)\n      BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n        INSERT INTO messages_fts\n        (rowid, body)\n        VALUES\n        (new.rowid, new.body);\n      END;\n    "),db.pragma("user_version = 26")}))(),logger.info("updateToSchemaVersion26: success!"))},function updateToSchemaVersion27(currentVersion,db,logger){currentVersion>=27||(db.transaction((function(){db.exec("\n      DELETE FROM messages_fts WHERE rowid IN\n        (SELECT rowid FROM messages WHERE body IS NULL);\n\n      DROP TRIGGER messages_on_update;\n\n      CREATE TRIGGER messages_on_update AFTER UPDATE ON messages\n      WHEN\n        new.body IS NULL OR\n        ((old.body IS NULL OR new.body != old.body) AND\n         (new.isViewOnce IS NULL OR new.isViewOnce != 1))\n      BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n        INSERT INTO messages_fts\n        (rowid, body)\n        VALUES\n        (new.rowid, new.body);\n      END;\n\n      CREATE TRIGGER messages_on_view_once_update AFTER UPDATE ON messages\n      WHEN\n        new.body IS NOT NULL AND new.isViewOnce = 1\n      BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n      END;\n    "),db.pragma("user_version = 27")}))(),logger.info("updateToSchemaVersion27: success!"))},function updateToSchemaVersion28(currentVersion,db,logger){currentVersion>=28||(db.transaction((function(){db.exec("\n      CREATE TABLE jobs(\n        id TEXT PRIMARY KEY,\n        queueType TEXT STRING NOT NULL,\n        timestamp INTEGER NOT NULL,\n        data STRING TEXT\n      );\n\n      CREATE INDEX jobs_timestamp ON jobs (timestamp);\n    "),db.pragma("user_version = 28")}))(),logger.info("updateToSchemaVersion28: success!"))},function updateToSchemaVersion29(currentVersion,db,logger){currentVersion>=29||(db.transaction((function(){db.exec("\n      CREATE TABLE reactions(\n        conversationId STRING,\n        emoji STRING,\n        fromId STRING,\n        messageReceivedAt INTEGER,\n        targetAuthorUuid STRING,\n        targetTimestamp INTEGER,\n        unread INTEGER\n      );\n\n      CREATE INDEX reactions_unread ON reactions (\n        unread,\n        conversationId\n      );\n\n      CREATE INDEX reaction_identifier ON reactions (\n        emoji,\n        targetAuthorUuid,\n        targetTimestamp\n      );\n    "),db.pragma("user_version = 29")}))(),logger.info("updateToSchemaVersion29: success!"))},function updateToSchemaVersion30(currentVersion,db,logger){currentVersion>=30||(db.transaction((function(){db.exec("\n      CREATE TABLE senderKeys(\n        id TEXT PRIMARY KEY NOT NULL,\n        senderId TEXT NOT NULL,\n        distributionId TEXT NOT NULL,\n        data BLOB NOT NULL,\n        lastUpdatedDate NUMBER NOT NULL\n      );\n    "),db.pragma("user_version = 30")}))(),logger.info("updateToSchemaVersion30: success!"))},function updateToSchemaVersion31(currentVersion,db,logger){currentVersion>=31||(logger.info("updateToSchemaVersion31: starting..."),db.transaction((function(){db.exec("\n      DROP INDEX unprocessed_id;\n      DROP INDEX unprocessed_timestamp;\n      ALTER TABLE unprocessed RENAME TO unprocessed_old;\n\n      CREATE TABLE unprocessed(\n        id STRING PRIMARY KEY ASC,\n        timestamp INTEGER,\n        version INTEGER,\n        attempts INTEGER,\n        envelope TEXT,\n        decrypted TEXT,\n        source TEXT,\n        sourceDevice TEXT,\n        serverTimestamp INTEGER,\n        sourceUuid STRING\n      );\n\n      CREATE INDEX unprocessed_timestamp ON unprocessed (\n        timestamp\n      );\n\n      INSERT OR REPLACE INTO unprocessed\n        (id, timestamp, version, attempts, envelope, decrypted, source,\n         sourceDevice, serverTimestamp, sourceUuid)\n      SELECT\n        id, timestamp, version, attempts, envelope, decrypted, source,\n         sourceDevice, serverTimestamp, sourceUuid\n      FROM unprocessed_old;\n\n      DROP TABLE unprocessed_old;\n    "),db.pragma("user_version = 31")}))(),logger.info("updateToSchemaVersion31: success!"))},function updateToSchemaVersion32(currentVersion,db,logger){currentVersion>=32||(db.transaction((function(){db.exec("\n      ALTER TABLE messages\n      ADD COLUMN serverGuid STRING NULL;\n\n      ALTER TABLE unprocessed\n      ADD COLUMN serverGuid STRING NULL;\n    "),db.pragma("user_version = 32")}))(),logger.info("updateToSchemaVersion32: success!"))},function updateToSchemaVersion33(currentVersion,db,logger){currentVersion>=33||(db.transaction((function(){db.exec('\n      -- These indexes should exist, but we add "IF EXISTS" for safety.\n      DROP INDEX IF EXISTS messages_expires_at;\n      DROP INDEX IF EXISTS messages_without_timer;\n\n      ALTER TABLE messages\n      ADD COLUMN\n      expiresAt INT\n      GENERATED ALWAYS\n      AS (expirationStartTimestamp + (expireTimer * 1000));\n\n      CREATE INDEX message_expires_at ON messages (\n        expiresAt\n      );\n\n      CREATE INDEX outgoing_messages_without_expiration_start_timestamp ON messages (\n        expireTimer, expirationStartTimestamp, type\n      )\n      WHERE expireTimer IS NOT NULL AND expirationStartTimestamp IS NULL;\n    '),db.pragma("user_version = 33")}))(),logger.info("updateToSchemaVersion33: success!"))},function updateToSchemaVersion34(currentVersion,db,logger){currentVersion>=34||(db.transaction((function(){db.exec('\n      -- This index should exist, but we add "IF EXISTS" for safety.\n      DROP INDEX IF EXISTS outgoing_messages_without_expiration_start_timestamp;\n\n      CREATE INDEX messages_unexpectedly_missing_expiration_start_timestamp ON messages (\n        expireTimer, expirationStartTimestamp, type\n      )\n      WHERE expireTimer IS NOT NULL AND expirationStartTimestamp IS NULL;\n    '),db.pragma("user_version = 34")}))(),logger.info("updateToSchemaVersion34: success!"))},function updateToSchemaVersion35(currentVersion,db,logger){currentVersion>=35||(db.transaction((function(){db.exec("\n      CREATE INDEX expiring_message_by_conversation_and_received_at\n      ON messages\n      (\n        expirationStartTimestamp,\n        expireTimer,\n        conversationId,\n        received_at\n      );\n    "),db.pragma("user_version = 35")}))(),logger.info("updateToSchemaVersion35: success!"))},function updateToSchemaVersion36(currentVersion,db,logger){currentVersion>=36||(db.pragma("user_version = 36"),logger.info("updateToSchemaVersion36: success!"))},function updateToSchemaVersion37(currentVersion,db,logger){currentVersion>=37||(db.transaction((function(){db.exec("\n      -- Create send log primary table\n\n      CREATE TABLE sendLogPayloads(\n        id INTEGER PRIMARY KEY ASC,\n\n        timestamp INTEGER NOT NULL,\n        contentHint INTEGER NOT NULL,\n        proto BLOB NOT NULL\n      );\n\n      CREATE INDEX sendLogPayloadsByTimestamp ON sendLogPayloads (timestamp);\n\n      -- Create send log recipients table with foreign key relationship to payloads\n\n      CREATE TABLE sendLogRecipients(\n        payloadId INTEGER NOT NULL,\n\n        recipientUuid STRING NOT NULL,\n        deviceId INTEGER NOT NULL,\n\n        PRIMARY KEY (payloadId, recipientUuid, deviceId),\n\n        CONSTRAINT sendLogRecipientsForeignKey\n          FOREIGN KEY (payloadId)\n          REFERENCES sendLogPayloads(id)\n          ON DELETE CASCADE\n      );\n\n      CREATE INDEX sendLogRecipientsByRecipient\n        ON sendLogRecipients (recipientUuid, deviceId);\n\n      -- Create send log messages table with foreign key relationship to payloads\n\n      CREATE TABLE sendLogMessageIds(\n        payloadId INTEGER NOT NULL,\n\n        messageId STRING NOT NULL,\n\n        PRIMARY KEY (payloadId, messageId),\n\n        CONSTRAINT sendLogMessageIdsForeignKey\n          FOREIGN KEY (payloadId)\n          REFERENCES sendLogPayloads(id)\n          ON DELETE CASCADE\n      );\n\n      CREATE INDEX sendLogMessageIdsByMessage\n        ON sendLogMessageIds (messageId);\n\n      -- Recreate messages table delete trigger with send log support\n\n      DROP TRIGGER messages_on_delete;\n\n      CREATE TRIGGER messages_on_delete AFTER DELETE ON messages BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n        DELETE FROM sendLogPayloads WHERE id IN (\n          SELECT payloadId FROM sendLogMessageIds\n          WHERE messageId = old.id\n        );\n      END;\n\n      --- Add messageId column to reactions table to properly track proto associations\n\n      ALTER TABLE reactions ADD column messageId STRING;\n    "),db.pragma("user_version = 37")}))(),logger.info("updateToSchemaVersion37: success!"))},function updateToSchemaVersion38(currentVersion,db,logger){currentVersion>=38||(db.transaction((function(){db.exec("\n      DROP INDEX IF EXISTS messages_duplicate_check;\n\n      ALTER TABLE messages\n        RENAME COLUMN sourceDevice TO deprecatedSourceDevice;\n      ALTER TABLE messages\n        ADD COLUMN sourceDevice INTEGER;\n\n      UPDATE messages\n      SET\n        sourceDevice = CAST(deprecatedSourceDevice AS INTEGER),\n        deprecatedSourceDevice = NULL;\n\n      ALTER TABLE unprocessed\n        RENAME COLUMN sourceDevice TO deprecatedSourceDevice;\n      ALTER TABLE unprocessed\n        ADD COLUMN sourceDevice INTEGER;\n\n      UPDATE unprocessed\n      SET\n        sourceDevice = CAST(deprecatedSourceDevice AS INTEGER),\n        deprecatedSourceDevice = NULL;\n    "),db.pragma("user_version = 38")}))(),logger.info("updateToSchemaVersion38: success!"))},function updateToSchemaVersion39(currentVersion,db,logger){currentVersion>=39||(db.transaction((function(){db.exec("ALTER TABLE messages RENAME COLUMN unread TO readStatus;"),db.pragma("user_version = 39")}))(),logger.info("updateToSchemaVersion39: success!"))},function updateToSchemaVersion40(currentVersion,db,logger){currentVersion>=40||(db.transaction((function(){db.exec("\n      CREATE TABLE groupCallRings(\n        ringId INTEGER PRIMARY KEY,\n        isActive INTEGER NOT NULL,\n        createdAt INTEGER NOT NULL\n      );\n      "),db.pragma("user_version = 40")}))(),logger.info("updateToSchemaVersion40: success!"))},function updateToSchemaVersion41(currentVersion,db,logger){if(!(currentVersion>=41)){var getConversationUuid=db.prepare("\n      SELECT uuid\n      FROM\n        conversations\n      WHERE\n        id = $conversationId\n      ").pluck(),getConversationStats=db.prepare("\n      SELECT uuid, e164, active_at\n      FROM\n        conversations\n      WHERE\n        id = $conversationId\n    "),compareConvoRecency=function(a,b){var aStats=getConversationStats.get({conversationId:a}),bStats=getConversationStats.get({conversationId:b}),isAComplete=Boolean((null==aStats?void 0:aStats.uuid)&&(null==aStats?void 0:aStats.e164)),isBComplete=Boolean((null==bStats?void 0:bStats.uuid)&&(null==bStats?void 0:bStats.e164));return isAComplete||isBComplete?isAComplete?isBComplete?aStats.active_at-bStats.active_at:1:-1:0};db.transaction((function(){db.exec("\n      -- Change type of 'id' column from INTEGER to STRING\n\n      ALTER TABLE preKeys\n      RENAME TO old_preKeys;\n\n      ALTER TABLE signedPreKeys\n      RENAME TO old_signedPreKeys;\n\n      CREATE TABLE preKeys(\n        id STRING PRIMARY KEY ASC,\n        json TEXT\n      );\n      CREATE TABLE signedPreKeys(\n        id STRING PRIMARY KEY ASC,\n        json TEXT\n      );\n\n      -- sqlite handles the type conversion\n      INSERT INTO preKeys SELECT * FROM old_preKeys;\n      INSERT INTO signedPreKeys SELECT * FROM old_signedPreKeys;\n\n      DROP TABLE old_preKeys;\n      DROP TABLE old_signedPreKeys;\n\n      -- Alter sessions\n\n      ALTER TABLE sessions\n        ADD COLUMN ourUuid STRING;\n\n      ALTER TABLE sessions\n        ADD COLUMN uuid STRING;\n      ");var keyCount,ourUuid=getOurUuid(db);if(!(0,types_UUID.TP)(ourUuid)){var deleteCount=(keyCount=[db.prepare("DELETE FROM senderKeys").run().changes,db.prepare("DELETE FROM sessions").run().changes,db.prepare("DELETE FROM signedPreKeys").run().changes,db.prepare("DELETE FROM preKeys").run().changes].reduce((function(a,b){return a+b})),(0,assert.UU)(removeById(db,"items","identityKey")),(0,assert.UU)(removeById(db,"items","registrationId")),keyCount);return deleteCount>0&&logger.error(`updateToSchemaVersion41: no uuid is available, erased ${deleteCount} sessions/keys`),void db.pragma("user_version = 41")}!function(ourUuid){for(var _i2=0,_arr2=["signedPreKeys","preKeys"];_i2<_arr2.length;_i2++){var table=_arr2[_i2];db.prepare(`\n        UPDATE ${table}\n        SET\n          id = $ourUuid || ':' || id,\n          json = json_set(\n            json,\n            '$.id',\n            $ourUuid || ':' || json_extract(json, '$.id'),\n            '$.keyId',\n            json_extract(json, '$.id'),\n            '$.ourUuid',\n            $ourUuid\n          )\n        `).run({ourUuid})}}(ourUuid),function(ourUuid){var senderKeys=db.prepare("SELECT id, senderId, lastUpdatedDate FROM senderKeys").all();logger.info(`Updating ${senderKeys.length} sender keys`);var _step,updateSenderKey=db.prepare("\n      UPDATE senderKeys\n      SET\n        id = $newId,\n        senderId = $newSenderId\n      WHERE\n        id = $id\n      "),deleteSenderKey=db.prepare("DELETE FROM senderKeys WHERE id = $id"),pastKeys=new Map,updated=0,deleted=0,skipped=0,_iterator=_41_uuid_keys_createForOfIteratorHelper(senderKeys);try{for(_iterator.s();!(_step=_iterator.n()).done;){var _ref=_step.value,id=_ref.id,senderId=_ref.senderId,lastUpdatedDate=_ref.lastUpdatedDate,conversationId=_41_uuid_keys_slicedToArray(Helpers.unencodeNumber(senderId),1)[0],uuid=getConversationUuid.get({conversationId});if(uuid){var newId=`${ourUuid}:${id.replace(conversationId,uuid)}`,existing=pastKeys.get(newId);existing?skipped+=1:updated+=1,existing&&(lastUpdatedDate<existing.lastUpdatedDate||compareConvoRecency(conversationId,existing.conversationId)<0)?deleteSenderKey.run({id}):(existing&&deleteSenderKey.run({id:newId}),pastKeys.set(newId,{conversationId,lastUpdatedDate}),updateSenderKey.run({id,newId,newSenderId:`${senderId.replace(conversationId,uuid)}`}))}else deleted+=1,deleteSenderKey.run({id})}}catch(err){_iterator.e(err)}finally{_iterator.f()}logger.info(`Updated ${senderKeys.length} sender keys: updated: ${updated}, deleted: ${deleted}, skipped: ${skipped}`)}(ourUuid),function(ourUuid){var allSessions=db.prepare("SELECT id, conversationId FROM SESSIONS").all();logger.info(`Updating ${allSessions.length} sessions`);var _step2,updateSession=db.prepare("\n      UPDATE sessions\n      SET\n        id = $newId,\n        ourUuid = $ourUuid,\n        uuid = $uuid,\n        json = json_set(\n          sessions.json,\n          '$.id',\n          $newId,\n          '$.uuid',\n          $uuid,\n          '$.ourUuid',\n          $ourUuid\n        )\n      WHERE\n        id = $id\n      "),deleteSession=db.prepare("DELETE FROM sessions WHERE id = $id"),pastSessions=new Map,updated=0,deleted=0,skipped=0,_iterator2=_41_uuid_keys_createForOfIteratorHelper(allSessions);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _ref2=_step2.value,id=_ref2.id,conversationId=_ref2.conversationId,uuid=getConversationUuid.get({conversationId});if(uuid){var newId=`${ourUuid}:${id.replace(conversationId,uuid)}`,existing=pastSessions.get(newId);existing?skipped+=1:updated+=1,existing&&compareConvoRecency(conversationId,existing.conversationId)<0?deleteSession.run({id}):(existing&&deleteSession.run({id:newId}),pastSessions.set(newId,{conversationId}),updateSession.run({id,newId,uuid,ourUuid}))}else deleted+=1,deleteSession.run({id})}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}logger.info(`Updated ${allSessions.length} sessions: updated: ${updated}, deleted: ${deleted}, skipped: ${skipped}`)}(ourUuid),function(ourUuid){var identityKey=(0,assert.UU)(getById(db,"items","identityKey")),registrationId=(0,assert.UU)(getById(db,"items","registrationId"));identityKey&&(0,assert.UU)(createOrUpdate(db,"items",{id:"identityKeyMap",value:{[ourUuid]:identityKey.value}})),registrationId&&(0,assert.UU)(createOrUpdate(db,"items",{id:"registrationIdMap",value:{[ourUuid]:registrationId.value}})),db.exec("\n      DELETE FROM items WHERE id = 'identityKey' OR id = 'registrationId';\n      ")}(ourUuid),function(){var identityKeys=db.prepare("SELECT id FROM identityKeys").all();logger.info(`Updating ${identityKeys.length} identity keys`);var _step3,updateIdentityKey=db.prepare("\n      UPDATE OR REPLACE identityKeys\n      SET\n        id = $newId,\n        json = json_set(\n          identityKeys.json,\n          '$.id',\n          $newId\n        )\n      WHERE\n        id = $id\n      "),migrated=0,_iterator3=_41_uuid_keys_createForOfIteratorHelper(identityKeys);try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var id=_step3.value.id,uuid=getConversationUuid.get({conversationId:id}),newId=void 0;uuid?(migrated+=1,newId=uuid):newId=`conversation:${id}`,updateIdentityKey.run({id,newId})}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}logger.info(`Migrated ${migrated} identity keys`)}(),db.pragma("user_version = 41")}))(),logger.info("updateToSchemaVersion41: success!")}},function updateToSchemaVersion42(currentVersion,db,logger){currentVersion>=42||(db.transaction((function(){db.exec("\n      DROP TRIGGER messages_on_delete;\n\n      CREATE TRIGGER messages_on_delete AFTER DELETE ON messages BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n        DELETE FROM sendLogPayloads WHERE id IN (\n          SELECT payloadId FROM sendLogMessageIds\n          WHERE messageId = old.id\n        );\n        DELETE FROM reactions WHERE rowid IN (\n          SELECT rowid FROM reactions\n          WHERE messageId = old.id\n        );\n      END;\n    ");var messageIdList=db.prepare("SELECT id FROM messages ORDER BY id ASC;").pluck().all(),allReactions=db.prepare("SELECT rowid, messageId FROM reactions;").all(),messageIds=new Set(messageIdList),reactionsToDelete=[];allReactions.forEach((function(reaction){messageIds.has(reaction.messageId)||reactionsToDelete.push(reaction.rowid)})),reactionsToDelete.length>0&&(logger.info(`Deleting ${reactionsToDelete.length} orphaned reactions`),batchMultiVarQuery(db,reactionsToDelete,(function deleteReactions(rowids){db.prepare(`\n        DELETE FROM reactions\n        WHERE rowid IN ( ${rowids.map((function(){return"?"})).join(", ")} );\n        `).run(rowids)}))),db.pragma("user_version = 42")}))(),logger.info("updateToSchemaVersion42: success!"))},function updateToSchemaVersion43(currentVersion,db,logger){if(!(currentVersion>=43)){var getConversationUuid=db.prepare("\n      SELECT uuid\n      FROM\n        conversations\n      WHERE\n        id = $conversationId\n      ").pluck(),updateConversationStmt=db.prepare("\n    UPDATE conversations SET\n      json = $json,\n      members = $members\n    WHERE id = $id;\n    "),updateMessageStmt=db.prepare("\n    UPDATE messages SET\n      json = $json,\n      sourceUuid = $sourceUuid\n    WHERE id = $id;\n    "),upgradeConversation=function(convo){for(var dbMembers,legacy=convo,result=convo,logId=`(${legacy.id}) groupv2(${legacy.groupId})`,_loop=function(key){var oldValue=legacy[key];if(!Array.isArray(oldValue))return"continue";var addedByCount=0,newValue=oldValue.map((function(member){var uuid=getConversationUuid.get({conversationId:member.conversationId});if(uuid){var updated=Object.assign({},omit_default()(member,"conversationId"),{uuid});if(!("addedByUserId"in member)||!member.addedByUserId)return updated;var addedByUserId=getConversationUuid.get({conversationId:member.addedByUserId});return addedByUserId?(addedByCount+=1,Object.assign({},updated,{addedByUserId})):updated}logger.warn(`updateToSchemaVersion43: ${logId}.${key} UUID not found for ${member.conversationId}`)})).filter(util_isNotNil.D);result=Object.assign({},result,{[key]:newValue}),0!==oldValue.length&&logger.info(`updateToSchemaVersion43: migrated ${oldValue.length} ${key} entries to ${newValue.length} for ${logId}`),addedByCount>0&&logger.info(`updateToSchemaVersion43: migrated ${addedByCount} addedByUserId in ${key} for ${logId}`)},_i=0,_memberKeys=["membersV2","pendingMembersV2","pendingAdminApprovalV2"];_i<_memberKeys.length;_i++)_loop(_memberKeys[_i]);result!==convo&&(dbMembers=result.membersV2?result.membersV2.map((function(item){return item.uuid})).join(" "):result.members?result.members.join(" "):null,updateConversationStmt.run({id:result.id,json:objectToJSON(result),members:dbMembers}))},upgradeMessage=function(message){var _result$sourceUuid,_ref=message,id=_ref.id,groupV2Change=_ref.groupV2Change,sourceUuid=_ref.sourceUuid,invitedGV2Members=_ref.invitedGV2Members,result=message;if(groupV2Change){(0,assert.q8)(result.groupV2Change,"Pacify typescript");var from=getConversationUuid.get({conversationId:groupV2Change.from});result=from?Object.assign({},result,{groupV2Change:Object.assign({},result.groupV2Change,{from})}):Object.assign({},result,{groupV2Change:omit_default()(result.groupV2Change,["from"])});var changedDetails=!1,details=groupV2Change.details.map((function(legacyDetail,i){var _result$groupV2Change,oldDetail=null===(_result$groupV2Change=result.groupV2Change)||void 0===_result$groupV2Change?void 0:_result$groupV2Change.details[i];(0,assert.q8)(oldDetail,"Pacify typescript");for(var newDetail=oldDetail,_i2=0,_arr=["conversationId","inviter"];_i2<_arr.length;_i2++){var key=_arr[_i2],oldValue=legacyDetail[key],newKey="conversationId"===key?"uuid":key;if(void 0!==oldValue){changedDetails=!0;var newValue=getConversationUuid.get({conversationId:oldValue});if("inviter"!==key||newValue){if(!newValue)return void logger.warn(`updateToSchemaVersion43: ${id}.groupV2Change.details.${key} UUID not found for ${oldValue}`);(0,assert.q8)(newDetail.type===legacyDetail.type,"Pacify typescript"),newDetail=Object.assign({},omit_default()(newDetail,key),{[newKey]:newValue})}}}return newDetail})).filter(util_isNotNil.D);changedDetails&&(result=Object.assign({},result,{groupV2Change:Object.assign({},result.groupV2Change,{details})}))}if(sourceUuid){var newValue=getConversationUuid.get({conversationId:sourceUuid});newValue&&(result=Object.assign({},result,{sourceUuid:newValue}))}if(invitedGV2Members){var newMembers=invitedGV2Members.map((function(_ref2,i){var addedByUserId=_ref2.addedByUserId,conversationId=_ref2.conversationId,uuid=getConversationUuid.get({conversationId}),oldMember=result.invitedGV2Members&&result.invitedGV2Members[i];if((0,assert.q8)(void 0!==oldMember,"Pacify typescript"),uuid){var newMember=Object.assign({},omit_default()(oldMember,["conversationId"]),{uuid});if(!addedByUserId)return newMember;var newAddedBy=getConversationUuid.get({conversationId:addedByUserId});return newAddedBy?Object.assign({},newMember,{addedByUserId:newAddedBy}):newMember}logger.warn(`updateToSchemaVersion43: ${id}.invitedGV2Members UUID not found for ${conversationId}`)})).filter(util_isNotNil.D);result=Object.assign({},result,{invitedGV2Members:newMembers})}return result!==message&&(updateMessageStmt.run({id:result.id,json:JSON.stringify(result),sourceUuid:null!==(_result$sourceUuid=result.sourceUuid)&&void 0!==_result$sourceUuid?_result$sourceUuid:null}),!0)};db.transaction((function(){var allConversations=db.prepare("\n      SELECT json, profileLastFetchedAt\n      FROM conversations\n      ORDER BY id ASC;\n      ").all().map((function(_ref3){return jsonToObject(_ref3.json)}));logger.info(`updateToSchemaVersion43: About to iterate through ${allConversations.length} conversations`);var _step,_iterator=_43_gv2_uuid_createForOfIteratorHelper(allConversations);try{for(_iterator.s();!(_step=_iterator.n()).done;){var convo=_step.value;upgradeConversation(convo)}}catch(err){_iterator.e(err)}finally{_iterator.f()}var messageCount=getCountFromTable(db,"messages");logger.info(`updateToSchemaVersion43: About to iterate through ${messageCount} messages`);var _step2,updatedCount=0,_iterator2=_43_gv2_uuid_createForOfIteratorHelper(new TableIterator(db,"messages"));try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var message=_step2.value;upgradeMessage(message)&&(updatedCount+=1)}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}logger.info(`updateToSchemaVersion43: Updated ${updatedCount} messages`),db.pragma("user_version = 43")}))(),logger.info("updateToSchemaVersion43: success!")}},function updateToSchemaVersion44(currentVersion,db,logger){currentVersion>=44||(db.transaction((function(){db.exec("\n      CREATE TABLE badges(\n        id TEXT PRIMARY KEY,\n        category TEXT NOT NULL,\n        name TEXT NOT NULL,\n        descriptionTemplate TEXT NOT NULL\n      );\n\n      CREATE TABLE badgeImageFiles(\n        badgeId TEXT REFERENCES badges(id)\n          ON DELETE CASCADE\n          ON UPDATE CASCADE,\n        'order' INTEGER NOT NULL,\n        url TEXT NOT NULL,\n        localPath TEXT,\n        theme TEXT NOT NULL\n      );\n      "),db.pragma("user_version = 44")}))(),logger.info("updateToSchemaVersion44: success!"))},function updateToSchemaVersion45(currentVersion,db,logger){currentVersion>=45||(db.transaction((function(){db.exec("\n      --- Add column to messages table\n\n      ALTER TABLE messages ADD COLUMN storyId STRING;\n\n      --- Update important message indices\n\n      DROP INDEX   messages_conversation;\n      CREATE INDEX messages_conversation ON messages\n        (conversationId, type, storyId, received_at);\n\n      DROP INDEX   messages_unread;\n      CREATE INDEX messages_unread ON messages\n        (conversationId, readStatus, type, storyId) WHERE readStatus IS NOT NULL;\n\n      --- Update attachment indices for All Media views\n\n      DROP INDEX   messages_hasAttachments;\n      CREATE INDEX messages_hasAttachments\n        ON messages (conversationId, hasAttachments, received_at)\n        WHERE type IS NOT 'story' AND storyId IS NULL;\n\n      DROP INDEX   messages_hasFileAttachments;\n      CREATE INDEX messages_hasFileAttachments\n        ON messages (conversationId, hasFileAttachments, received_at)\n        WHERE type IS NOT 'story' AND storyId IS NULL;\n\n      DROP INDEX   messages_hasVisualMediaAttachments;\n      CREATE INDEX messages_hasVisualMediaAttachments\n        ON messages (conversationId, hasVisualMediaAttachments, received_at)\n        WHERE type IS NOT 'story' AND storyId IS NULL;\n\n      --- Message insert/update triggers to exclude stories and story replies\n\n      DROP   TRIGGER messages_on_insert;\n      CREATE TRIGGER messages_on_insert AFTER INSERT ON messages\n      WHEN new.isViewOnce IS NOT 1 AND new.storyId IS NULL\n      BEGIN\n        INSERT INTO messages_fts\n          (rowid, body)\n        VALUES\n          (new.rowid, new.body);\n      END;\n\n      DROP   TRIGGER messages_on_update;\n      CREATE TRIGGER messages_on_update AFTER UPDATE ON messages\n      WHEN\n        (new.body IS NULL OR old.body IS NOT new.body) AND\n         new.isViewOnce IS NOT 1 AND new.storyId IS NULL\n      BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n        INSERT INTO messages_fts\n          (rowid, body)\n        VALUES\n          (new.rowid, new.body);\n      END;\n\n      --- Update delete trigger to remove storyReads\n\n      DROP   TRIGGER messages_on_delete;\n      CREATE TRIGGER messages_on_delete AFTER DELETE ON messages BEGIN\n        DELETE FROM messages_fts WHERE rowid = old.rowid;\n        DELETE FROM sendLogPayloads WHERE id IN (\n          SELECT payloadId FROM sendLogMessageIds\n          WHERE messageId = old.id\n        );\n        DELETE FROM reactions WHERE rowid IN (\n          SELECT rowid FROM reactions\n          WHERE messageId = old.id\n        );\n        DELETE FROM storyReads WHERE storyId = old.storyId;\n      END;\n\n      --- Story Read History\n\n      CREATE TABLE storyReads (\n        authorId STRING NOT NULL,\n        conversationId STRING NOT NULL,\n        storyId STRING NOT NULL,\n        storyReadDate NUMBER NOT NULL,\n\n        PRIMARY KEY (authorId, storyId)\n      );\n\n      CREATE INDEX storyReads_data ON storyReads (\n        storyReadDate, authorId, conversationId\n      );\n\n      --- Story Distribution Lists\n\n      CREATE TABLE storyDistributions(\n        id STRING PRIMARY KEY NOT NULL,\n        name TEXT,\n\n        avatarUrlPath TEXT,\n        avatarKey BLOB,\n        senderKeyInfoJson STRING\n      );\n\n      CREATE TABLE storyDistributionMembers(\n        listId STRING NOT NULL REFERENCES storyDistributions(id)\n          ON DELETE CASCADE\n          ON UPDATE CASCADE,\n        uuid STRING NOT NULL,\n\n        PRIMARY KEY (listId, uuid)\n      )\n      "),db.pragma("user_version = 45")}))(),logger.info("updateToSchemaVersion45: success!"))},function updateToSchemaVersion46(currentVersion,db,logger){currentVersion>=46||(db.transaction((function(){db.exec("\n      --- Add column to messages table\n\n      ALTER TABLE messages\n      ADD COLUMN\n      isStory INTEGER\n      GENERATED ALWAYS\n      AS (type = 'story');\n\n      --- Update important message indices\n\n      DROP INDEX   messages_conversation;\n      CREATE INDEX messages_conversation ON messages\n        (conversationId, isStory, storyId, received_at, sent_at);\n      "),db.pragma("user_version = 46")}))(),logger.info("updateToSchemaVersion46: success!"))},function updateToSchemaVersion47(currentVersion,db,logger){currentVersion>=47||(db.transaction((function(){db.exec("\n      DROP INDEX   messages_conversation;\n\n      ALTER TABLE messages\n        DROP COLUMN isStory;\n      ALTER TABLE messages\n        ADD COLUMN isStory INTEGER\n        GENERATED ALWAYS AS (type IS 'story');\n\n      ALTER TABLE messages\n        ADD COLUMN isChangeCreatedByUs INTEGER NOT NULL DEFAULT 0;\n\n      ALTER TABLE messages\n        ADD COLUMN shouldAffectActivity INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'group-v1-migration',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change',\n\n            'keychange'\n          )\n        );\n\n      ALTER TABLE messages\n        ADD COLUMN shouldAffectPreview INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'group-v1-migration',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      ALTER TABLE messages\n        ADD COLUMN isUserInitiatedMessage INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'group-v1-migration',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change',\n\n            'group-v2-change',\n            'keychange'\n          )\n        );\n\n      ALTER TABLE messages\n        ADD COLUMN isTimerChangeFromSync INTEGER\n        GENERATED ALWAYS AS (\n          json_extract(json, '$.expirationTimerUpdate.fromSync') IS 1\n        );\n\n      ALTER TABLE messages\n        ADD COLUMN isGroupLeaveEvent INTEGER\n        GENERATED ALWAYS AS (\n          type IS 'group-v2-change' AND\n          json_array_length(json_extract(json, '$.groupV2Change.details')) IS 1 AND\n          json_extract(json, '$.groupV2Change.details[0].type') IS 'member-remove' AND\n          json_extract(json, '$.groupV2Change.from') IS NOT NULL AND\n          json_extract(json, '$.groupV2Change.from') IS json_extract(json, '$.groupV2Change.details[0].uuid')\n        );\n\n      ALTER TABLE messages\n        ADD COLUMN isGroupLeaveEventFromOther INTEGER\n        GENERATED ALWAYS AS (\n          isGroupLeaveEvent IS 1\n          AND\n          isChangeCreatedByUs IS 0\n        );\n\n      CREATE INDEX messages_conversation ON messages\n        (conversationId, isStory, storyId, received_at, sent_at);\n\n      CREATE INDEX messages_preview ON messages\n        (conversationId, shouldAffectPreview, isGroupLeaveEventFromOther, expiresAt, received_at, sent_at);\n\n      CREATE INDEX messages_activity ON messages\n        (conversationId, shouldAffectActivity, isTimerChangeFromSync, isGroupLeaveEventFromOther, received_at, sent_at);\n\n      CREATE INDEX message_user_initiated ON messages (isUserInitiatedMessage);\n      ");var ourUuid=getOurUuid(db);ourUuid?db.prepare("\n        UPDATE messages SET\n          isChangeCreatedByUs = json_extract(json, '$.groupV2Change.from') IS $ourUuid;\n        ").run({ourUuid}):logger.warn("updateToSchemaVersion47: our UUID not found"),db.pragma("user_version = 47")}))(),logger.info("updateToSchemaVersion47: success!"))},function updateToSchemaVersion48(currentVersion,db,logger){currentVersion>=48||(db.transaction((function(){db.exec("\n      DROP INDEX   message_user_initiated;\n\n      CREATE INDEX message_user_initiated ON messages (conversationId, isUserInitiatedMessage);\n      "),db.pragma("user_version = 48")}))(),logger.info("updateToSchemaVersion48: success!"))},function updateToSchemaVersion49(currentVersion,db,logger){currentVersion>=49||(db.transaction((function(){db.exec("\n      DROP INDEX messages_preview;\n\n      -- Note the omitted 'expiresAt' column in the index. If it is present\n      -- sqlite can't ORDER BY received_at, sent_at using this index.\n      CREATE INDEX messages_preview ON messages\n        (conversationId, shouldAffectPreview, isGroupLeaveEventFromOther, received_at, sent_at);\n      "),db.pragma("user_version = 49")}))(),logger.info("updateToSchemaVersion49: success!"))},function updateToSchemaVersion50(currentVersion,db,logger){currentVersion>=50||(db.transaction((function(){db.exec("\n      DROP INDEX messages_unread;\n\n      -- Note: here we move to the modern isStory/storyId fields and add received_at/sent_at.\n      CREATE INDEX messages_unread ON messages\n        (conversationId, readStatus, isStory, storyId, received_at, sent_at) WHERE readStatus IS NOT NULL;\n      "),db.pragma("user_version = 50")}))(),logger.info("updateToSchemaVersion50: success!"))},function updateToSchemaVersion51(currentVersion,db,logger){currentVersion>=51||(db.transaction((function(){var deleteJobsInQueue=db.prepare("DELETE FROM jobs WHERE queueType = $queueType"),reactionsJobs=getJobsInQueueSync(db,"reactions");deleteJobsInQueue.run({queueType:"reactions"}),reactionsJobs.forEach((function(job){var data=job.data,id=job.id;if(isRecord(data)){var messageId=data.messageId;if("string"==typeof messageId){var message=getMessageByIdSync(db,messageId);if(message){var conversationId=message.conversationId;if("string"==typeof conversationId){var newJob=Object.assign({},job,{queueType:"conversation",data:Object.assign({},data,{type:"Reaction",conversationId})});insertJobSync(db,newJob)}else logger.warn(`updateToSchemaVersion51: reactions queue job ${id} had a non-string conversationId`)}else logger.warn(`updateToSchemaVersion51: Unable to find message for reaction job ${id}`)}else logger.warn(`updateToSchemaVersion51: reactions queue job ${id} had a non-string messageId`)}else logger.warn(`updateToSchemaVersion51: reactions queue job ${id} was missing valid data`)}));var normalSendJobs=getJobsInQueueSync(db,"normal send");deleteJobsInQueue.run({queueType:"normal send"}),normalSendJobs.forEach((function(job){var data=job.data,id=job.id;if(isRecord(data)){var newJob=Object.assign({},job,{queueType:"conversation",data:Object.assign({},data,{type:"NormalMessage"})});insertJobSync(db,newJob)}else logger.warn(`updateToSchemaVersion51: normal send queue job ${id} was missing valid data`)})),db.pragma("user_version = 51")}))(),logger.info("updateToSchemaVersion51: success!"))},function updateToSchemaVersion52(currentVersion,db,logger){currentVersion>=52||(db.transaction((function(){db.exec("\n      -- Create indices that don't have storyId in them so that\n      -- '_storyIdPredicate' could be optimized.\n\n      -- See migration 47\n      CREATE INDEX messages_conversation_no_story_id ON messages\n        (conversationId, isStory, received_at, sent_at);\n\n      -- See migration 50\n      CREATE INDEX messages_unread_no_story_id ON messages\n        (conversationId, readStatus, isStory, received_at, sent_at)\n        WHERE readStatus IS NOT NULL;\n      "),db.pragma("user_version = 52")}))(),logger.info("updateToSchemaVersion52: success!"))},function updateToSchemaVersion53(currentVersion,db,logger){if(!(currentVersion>=53)){var updateConversationStmt=db.prepare("\n      UPDATE conversations SET\n        json = json_patch(json, $jsonPatch)\n      WHERE id = $id;\n    "),upgradeConversation=function(convo){var _legacy$bannedMembers,legacy=convo,logId=`(${legacy.id}) groupv2(${legacy.groupId})`;if(null===(_legacy$bannedMembers=legacy.bannedMembersV2)||void 0===_legacy$bannedMembers||!_legacy$bannedMembers.length)return!1;var jsonPatch={bannedMembersV2:legacy.bannedMembersV2.map((function(uuid){return{uuid,timestamp:0}}))};return logger.info(`updateToSchemaVersion53: Updating ${logId} with ${legacy.bannedMembersV2.length} banned members`),updateConversationStmt.run({id:legacy.id,jsonPatch:JSON.stringify(jsonPatch)}),!0};db.transaction((function(){var allConversations=db.prepare("\n          SELECT json, profileLastFetchedAt\n          FROM conversations\n          WHERE type = 'group'\n          ORDER BY id ASC;\n        ").all().map((function(_ref){return jsonToObject(_ref.json)}));logger.info(`updateToSchemaVersion53: About to iterate through ${allConversations.length} conversations`);var _step,updated=0,_iterator=_53_gv2_banned_members_createForOfIteratorHelper(allConversations);try{for(_iterator.s();!(_step=_iterator.n()).done;){var convo=_step.value;updated+=upgradeConversation(convo)?1:0}}catch(err){_iterator.e(err)}finally{_iterator.f()}logger.info(`updateToSchemaVersion53: Updated ${updated} conversations`),db.pragma("user_version = 53")}))(),logger.info("updateToSchemaVersion53: success!")}},function updateToSchemaVersion54(currentVersion,db,logger){currentVersion>=54||(db.transaction((function(){db.exec("\n        ALTER TABLE unprocessed ADD COLUMN receivedAtCounter INTEGER;\n      "),db.pragma("user_version = 54")}))(),logger.info("updateToSchemaVersion54: success!"))},function updateToSchemaVersion55(currentVersion,db,logger){currentVersion>=55||(db.transaction((function(){var deleteJobsInQueue=db.prepare("DELETE FROM jobs WHERE queueType = $queueType"),reportSpamJobs=getJobsInQueueSync(db,"report spam");deleteJobsInQueue.run({queueType:"report spam"}),reportSpamJobs.forEach((function(job){var data=job.data,id=job.id;if(isRecord(data)){var e164=data.e164,serverGuids=data.serverGuids;if("string"==typeof e164)if((0,iterables.TW)(serverGuids)){var newJob=Object.assign({},job,{queueType:"report spam",data:{uuid:e164,serverGuids}});insertJobSync(db,newJob)}else logger.warn(`updateToSchemaVersion55: report spam queue job ${id} had a non-iterable serverGuids`);else logger.warn(`updateToSchemaVersion55: report spam queue job ${id} had a non-string e164`)}else logger.warn(`updateToSchemaVersion55: report spam queue job ${id} was missing valid data`)})),db.pragma("user_version = 55")}))(),logger.info("updateToSchemaVersion55: success!"))},function updateToSchemaVersion56(currentVersion,db,logger){currentVersion>=56||(db.transaction((function(){db.exec(`\n      --- Add column to messages table\n\n      ALTER TABLE messages ADD COLUMN seenStatus NUMBER default 0;\n\n      --- Add index to make searching on this field easy\n\n      CREATE INDEX messages_unseen_no_story ON messages\n        (conversationId, seenStatus, isStory, received_at, sent_at)\n        WHERE\n          seenStatus IS NOT NULL;\n\n      CREATE INDEX messages_unseen_with_story ON messages\n        (conversationId, seenStatus, isStory, storyId, received_at, sent_at)\n        WHERE\n          seenStatus IS NOT NULL;\n\n      --- Update seenStatus to UnseenStatus.Unseen for certain messages\n      --- (NULL included because 'timer-notification' in 1:1 convos had type = NULL)\n\n      UPDATE messages\n        SET\n          seenStatus = ${SeenStatus.Unseen}\n        WHERE\n          readStatus = ${MessageReadStatus.N.Unread} AND\n          (\n            type IS NULL\n            OR\n            type IN (\n              'call-history',\n              'change-number-notification',\n              'chat-session-refreshed',\n              'delivery-issue',\n              'group',\n              'incoming',\n              'keychange',\n              'timer-notification',\n              'verified-change'\n            )\n          );\n\n      --- Set readStatus to ReadStatus.Read for all other message types\n\n      UPDATE messages\n        SET\n          readStatus = ${MessageReadStatus.N.Read}\n        WHERE\n          readStatus = ${MessageReadStatus.N.Unread} AND\n          type IS NOT NULL AND\n          type NOT IN (\n            'call-history',\n            'change-number-notification',\n            'chat-session-refreshed',\n            'delivery-issue',\n            'group',\n            'incoming',\n            'keychange',\n            'timer-notification',\n            'verified-change'\n          );\n      `),db.pragma("user_version = 56")}))(),logger.info("updateToSchemaVersion56: success!"))},function updateToSchemaVersion57(currentVersion,db,logger){currentVersion>=57||(db.transaction((function(){db.exec("\n      DELETE FROM messages\n      WHERE type IS 'message-history-unsynced';\n      "),db.pragma("user_version = 57")}))(),logger.info("updateToSchemaVersion57: success!"))},function updateToSchemaVersion58(currentVersion,db,logger){currentVersion>=58||(db.transaction((function(){db.exec(`\n      --- Promote unread status in JSON to SQL column\n\n      -- NOTE: This was disabled because the 'unread' json field was deprecated\n      -- in b0750e5f4e1f79f0f177b17cbe06d688431f948d, but the old value was kept\n      -- in the messages created before the release of that commit.\n      --\n      -- UPDATE messages\n      --   SET\n      --     readStatus = ${MessageReadStatus.N.Unread},\n      --     seenStatus = ${SeenStatus.Unseen}\n      --   WHERE\n      --     json_extract(json, '$.unread') IS true OR\n      --     json_extract(json, '$.unread') IS 1;\n\n      --- Clean up all old messages that still have a null read status\n      ---   Note: we don't need to update seenStatus, because that was defaulted to zero\n\n      UPDATE messages\n        SET\n          readStatus = ${MessageReadStatus.N.Read}\n        WHERE\n          readStatus IS NULL;\n\n      --- Re-run unseen/unread queries from migration 56\n\n      UPDATE messages\n        SET\n          seenStatus = ${SeenStatus.Unseen}\n        WHERE\n          readStatus = ${MessageReadStatus.N.Unread} AND\n          (\n            type IS NULL\n            OR\n            type IN (\n              'call-history',\n              'change-number-notification',\n              'chat-session-refreshed',\n              'delivery-issue',\n              'group',\n              'incoming',\n              'keychange',\n              'timer-notification',\n              'verified-change'\n            )\n          );\n\n      UPDATE messages\n        SET\n          readStatus = ${MessageReadStatus.N.Read}\n        WHERE\n          readStatus = ${MessageReadStatus.N.Unread} AND\n          type IS NOT NULL AND\n          type NOT IN (\n            'call-history',\n            'change-number-notification',\n            'chat-session-refreshed',\n            'delivery-issue',\n            'group',\n            'incoming',\n            'keychange',\n            'timer-notification',\n            'verified-change'\n          );\n\n      --- (new) Ensure these message types are not unread, just unseen\n\n      UPDATE messages\n        SET\n          readStatus = ${MessageReadStatus.N.Read}\n        WHERE\n          readStatus = ${MessageReadStatus.N.Unread} AND\n          (\n            type IN (\n              'change-number-notification',\n              'keychange'\n            )\n          );\n\n      --- (new) Ensure that these message types are neither unseen nor unread\n\n      UPDATE messages\n        SET\n          readStatus = ${MessageReadStatus.N.Read},\n          seenStatus = ${SeenStatus.Seen}\n        WHERE\n          type IN (\n            'group-v1-migration',\n            'message-history-unsynced',\n            'outgoing',\n            'profile-change',\n            'universal-timer-notification'\n          );\n\n      --- Make sure JSON reflects SQL columns\n\n      UPDATE messages\n        SET\n          json = json_patch(\n            json,\n            json_object(\n              'readStatus', readStatus,\n              'seenStatus', seenStatus\n            )\n          )\n        WHERE\n          readStatus IS NOT NULL OR\n          seenStatus IS NOT 0;\n      `),db.pragma("user_version = 58")}))(),logger.info("updateToSchemaVersion58: success!"))},function updateToSchemaVersion59(currentVersion,db,logger){currentVersion>=59||(db.transaction((function(){db.exec("\n        CREATE INDEX unprocessed_byReceivedAtCounter ON unprocessed\n          (receivedAtCounter)\n      "),db.pragma("user_version = 59")}))(),logger.info("updateToSchemaVersion59: success!"))},function updateToSchemaVersion60(currentVersion,db,logger){currentVersion>=60||(db.transaction((function(){db.exec("\n      DROP INDEX expiring_message_by_conversation_and_received_at;\n\n      CREATE INDEX expiring_message_by_conversation_and_received_at\n        ON messages\n        (\n          conversationId,\n          storyId,\n          expirationStartTimestamp,\n          expireTimer,\n          received_at\n        )\n        WHERE isStory IS 0 AND type IS 'incoming';\n      "),db.pragma("user_version = 60")}))(),logger.info("updateToSchemaVersion60: success!"))},function updateToSchemaVersion61(currentVersion,db,logger){currentVersion>=61||(db.transaction((function(){db.exec("\n      ALTER TABLE storyDistributions DROP COLUMN avatarKey;\n      ALTER TABLE storyDistributions DROP COLUMN avatarUrlPath;\n\n      ALTER TABLE storyDistributions ADD COLUMN deletedAtTimestamp INTEGER;\n      ALTER TABLE storyDistributions ADD COLUMN allowsReplies INTEGER;\n      ALTER TABLE storyDistributions ADD COLUMN isBlockList INTEGER;\n\n      ALTER TABLE storyDistributions ADD COLUMN storageID STRING;\n      ALTER TABLE storyDistributions ADD COLUMN storageVersion INTEGER;\n      ALTER TABLE storyDistributions ADD COLUMN storageUnknownFields BLOB;\n      ALTER TABLE storyDistributions ADD COLUMN storageNeedsSync INTEGER;\n\n      ALTER TABLE messages ADD COLUMN storyDistributionListId STRING;\n\n      CREATE INDEX messages_by_distribution_list\n        ON messages(storyDistributionListId, received_at)\n        WHERE storyDistributionListId IS NOT NULL;\n      "),db.pragma("user_version = 61")}))(),logger.info("updateToSchemaVersion61: success!"))},function updateToSchemaVersion62(currentVersion,db,logger){currentVersion>=62||(db.transaction((function(){db.exec("\n      ALTER TABLE sendLogPayloads ADD COLUMN urgent INTEGER;\n      "),db.pragma("user_version = 62")}))(),logger.info("updateToSchemaVersion62: success!"))},function updateToSchemaVersion63(currentVersion,db,logger){currentVersion>=63||(db.transaction((function(){db.exec("\n      ALTER TABLE unprocessed ADD COLUMN urgent INTEGER;\n      "),db.pragma("user_version = 63")}))(),logger.info("updateToSchemaVersion63: success!"))},function updateToSchemaVersion64(currentVersion,db,logger){currentVersion>=64||(db.transaction((function(){db.exec("\n      ALTER TABLE preKeys\n        ADD COLUMN ourUuid STRING\n        GENERATED ALWAYS AS (json_extract(json, '$.ourUuid'));\n\n      CREATE INDEX preKeys_ourUuid ON preKeys (ourUuid);\n\n      ALTER TABLE signedPreKeys\n        ADD COLUMN ourUuid STRING\n        GENERATED ALWAYS AS (json_extract(json, '$.ourUuid'));\n\n      CREATE INDEX signedPreKeys_ourUuid ON signedPreKeys (ourUuid);\n      "),db.pragma("user_version = 64")}))(),logger.info("updateToSchemaVersion64: success!"))},function updateToSchemaVersion65(currentVersion,db,logger){currentVersion>=65||(db.transaction((function(){db.exec("\n      ALTER TABLE sticker_packs ADD COLUMN position INTEGER DEFAULT 0 NOT NULL;\n      ALTER TABLE sticker_packs ADD COLUMN storageID STRING;\n      ALTER TABLE sticker_packs ADD COLUMN storageVersion INTEGER;\n      ALTER TABLE sticker_packs ADD COLUMN storageUnknownFields BLOB;\n      ALTER TABLE sticker_packs\n      ADD COLUMN storageNeedsSync\n      INTEGER DEFAULT 0 NOT NULL;\n\n      CREATE TABLE uninstalled_sticker_packs (\n        id STRING NOT NULL PRIMARY KEY,\n        uninstalledAt NUMBER NOT NULL,\n        storageID STRING,\n        storageVersion NUMBER,\n        storageUnknownFields BLOB,\n        storageNeedsSync INTEGER NOT NULL\n      );\n\n      -- Set initial position\n\n      UPDATE sticker_packs\n      SET\n        position = (row_number - 1),\n        storageNeedsSync = 1\n      FROM (\n        SELECT id, row_number() OVER (ORDER BY lastUsed DESC) as row_number\n        FROM sticker_packs\n      ) as ordered_pairs\n      WHERE sticker_packs.id IS ordered_pairs.id;\n\n      -- See: getAllStickerPacks\n\n      CREATE INDEX sticker_packs_by_position_and_id ON sticker_packs (\n        position ASC,\n        id ASC\n      );\n      "),db.pragma("user_version = 65")}))(),logger.info("updateToSchemaVersion65: success!"))},function updateToSchemaVersion66(currentVersion,db,logger){currentVersion>=66||(db.transaction((function(){db.exec("\n      ALTER TABLE sendLogPayloads\n      ADD COLUMN hasPniSignatureMessage INTEGER DEFAULT 0 NOT NULL;\n      "),db.pragma("user_version = 66")}))(),logger.info("updateToSchemaVersion66: success!"))},function updateToSchemaVersion67(currentVersion,db,logger){currentVersion>=67||(db.transaction((function(){db.exec("\n      ALTER TABLE unprocessed ADD COLUMN story INTEGER;\n      "),db.pragma("user_version = 67")}))(),logger.info("updateToSchemaVersion67: success!"))},function updateToSchemaVersion68(currentVersion,db,logger){currentVersion>=68||(db.transaction((function(){db.exec("\n      ALTER TABLE messages\n        DROP COLUMN deprecatedSourceDevice;\n      ALTER TABLE unprocessed\n        DROP COLUMN deprecatedSourceDevice;\n      "),db.pragma("user_version = 68")}))(),logger.info("updateToSchemaVersion68: success!"))},function updateToSchemaVersion69(currentVersion,db,logger){currentVersion>=69||(db.transaction((function(){db.exec("\n      DROP TABLE IF EXISTS groupCallRings;\n\n      CREATE TABLE groupCallRingCancellations(\n        ringId INTEGER PRIMARY KEY,\n        createdAt INTEGER NOT NULL\n      );\n      "),db.pragma("user_version = 69")}))(),logger.info("updateToSchemaVersion69: success!"))},function updateToSchemaVersion70(currentVersion,db,logger){currentVersion>=70||(db.transaction((function(){db.exec("\n      CREATE INDEX messages_by_storyId ON messages (storyId);\n      "),db.pragma("user_version = 70")}))(),logger.info("updateToSchemaVersion70: success!"))},function updateToSchemaVersion71(currentVersion,db,logger){currentVersion>=71||(db.transaction((function(){db.exec("\n      --- These will be re-added below\n      DROP INDEX messages_preview;\n      DROP INDEX messages_activity;\n      DROP INDEX message_user_initiated;\n\n      --- These will also be re-added below\n      ALTER TABLE messages DROP COLUMN shouldAffectActivity;\n      ALTER TABLE messages DROP COLUMN shouldAffectPreview;\n      ALTER TABLE messages DROP COLUMN isUserInitiatedMessage;\n\n      --- Note: These generated columns were originally introduced in migration 47, and\n      ---       are mostly the same\n      \n      --- Based on the current list (model-types.ts), the types which DO affect activity:\n      ---   NULL (old, malformed data)\n      ---   call-history\n      ---   chat-session-refreshed (deprecated)\n      ---   delivery-issue\n      ---   group (deprecated)\n      ---   group-v2-change\n      ---   incoming\n      ---   outgoing\n      ---   timer-notification\n\n      --- (change: added conversation-merge, keychange, and phone-number-discovery)\n      ALTER TABLE messages\n        ADD COLUMN shouldAffectActivity INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'keychange',\n            'message-history-unsynced',\n            'phone-number-discovery',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      --- (change: added conversation-merge and phone-number-discovery\n      ---    (now matches the above list)\n      ALTER TABLE messages\n        ADD COLUMN shouldAffectPreview INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'keychange',\n            'message-history-unsynced',\n            'phone-number-discovery',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      --- Note: This list only differs from the above on these types:\n      ---   group-v2-change\n\n      --- (change: added conversation-merge and phone-number-discovery\n      ALTER TABLE messages\n        ADD COLUMN isUserInitiatedMessage INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'group-v2-change',\n            'keychange',\n            'message-history-unsynced',\n            'phone-number-discovery',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      CREATE INDEX messages_preview ON messages\n        (conversationId, shouldAffectPreview, isGroupLeaveEventFromOther, expiresAt, received_at, sent_at);\n\n      CREATE INDEX messages_activity ON messages\n        (conversationId, shouldAffectActivity, isTimerChangeFromSync, isGroupLeaveEventFromOther, received_at, sent_at);\n\n      CREATE INDEX message_user_initiated ON messages (isUserInitiatedMessage);\n      "),db.pragma("user_version = 71")}))(),logger.info("updateToSchemaVersion71: success!"))},function updateToSchemaVersion72(currentVersion,db,logger){currentVersion>=72||(db.transaction((function(){db.exec("\n      ALTER TABLE messages\n        ADD COLUMN callId TEXT\n        GENERATED ALWAYS AS (\n          json_extract(json, '$.callHistoryDetails.callId')\n        );\n      ALTER TABLE messages\n        ADD COLUMN callMode TEXT\n        GENERATED ALWAYS AS (\n          json_extract(json, '$.callHistoryDetails.callMode')\n        );\n      CREATE INDEX messages_call ON messages\n        (conversationId, type, callMode, callId);\n      "),db.pragma("user_version = 72")}))(),logger.info("updateToSchemaVersion72: success!"))},function updateToSchemaVersion73(currentVersion,db,logger){currentVersion>=73||(db.transaction((function(){db.exec("\n      --- Delete deprecated notifications\n      DELETE FROM messages WHERE type IS 'phone-number-discovery';\n\n      --- These will be re-added below\n      DROP INDEX messages_preview;\n      DROP INDEX messages_activity;\n      DROP INDEX message_user_initiated;\n\n      --- These will also be re-added below\n      ALTER TABLE messages DROP COLUMN shouldAffectActivity;\n      ALTER TABLE messages DROP COLUMN shouldAffectPreview;\n      ALTER TABLE messages DROP COLUMN isUserInitiatedMessage;\n\n      --- Note: These generated columns were originally introduced in migration 71, and\n      ---       are mostly the same\n\n      --- (change: removed phone-number-discovery)\n      ALTER TABLE messages\n        ADD COLUMN shouldAffectActivity INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'keychange',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      --- (change: removed phone-number-discovery\n      ---    (now matches the above list)\n      ALTER TABLE messages\n        ADD COLUMN shouldAffectPreview INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'keychange',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      --- Note: This list only differs from the above on these types:\n      ---   group-v2-change\n\n      --- (change: removed phone-number-discovery\n      ALTER TABLE messages\n        ADD COLUMN isUserInitiatedMessage INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'group-v2-change',\n            'keychange',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      CREATE INDEX messages_preview ON messages\n        (conversationId, shouldAffectPreview, isGroupLeaveEventFromOther, expiresAt, received_at, sent_at);\n\n      CREATE INDEX messages_activity ON messages\n        (conversationId, shouldAffectActivity, isTimerChangeFromSync, isGroupLeaveEventFromOther, received_at, sent_at);\n\n      CREATE INDEX message_user_initiated ON messages (isUserInitiatedMessage);\n      "),db.pragma("user_version = 73")}))(),logger.info("updateToSchemaVersion73: success!"))},function updateToSchemaVersion74(currentVersion,db,logger){currentVersion>=74||(db.transaction((function(){db.exec("\n      -- Previously: (isUserInitiatedMessage)\n      DROP INDEX message_user_initiated;\n\n      CREATE INDEX message_user_initiated ON messages (conversationId, isUserInitiatedMessage);\n\n      -- Previously: (unread, conversationId)\n      DROP INDEX reactions_unread;\n\n      CREATE INDEX reactions_unread ON reactions (\n        conversationId,\n        unread\n      );\n      "),db.pragma("user_version = 74")}))(),logger.info("updateToSchemaVersion74: success!"))},function updateToSchemaVersion75(currentVersion,db,logger){currentVersion>=75||(db.transaction((function(){db.pragma("user_version = 75")}))(),logger.info("updateToSchemaVersion75: success!"))},function updateToSchemaVersion76(currentVersion,db,logger){currentVersion>=76||(db.transaction((function(){db.exec(`\n      -- Re-created below\n      DROP INDEX IF EXISTS message_expires_at;\n      DROP INDEX IF EXISTS messages_preview;\n\n      -- Create non-null expiresAt column\n      ALTER TABLE messages\n        DROP COLUMN expiresAt;\n\n      ALTER TABLE messages\n        ADD COLUMN\n        expiresAt INT\n        GENERATED ALWAYS\n        AS (ifnull(\n          expirationStartTimestamp + (expireTimer * 1000),\n          ${Number.MAX_SAFE_INTEGER}\n        ));\n\n      -- Re-create indexes\n      -- Note the "s" at the end of "messages"\n      CREATE INDEX messages_expires_at ON messages (\n        expiresAt\n      );\n\n      -- Note that expiresAt is intentionally dropped from the index since\n      -- expiresAt > $now is likely to be true so we just try selecting it\n      -- *after* ordering by received_at/sent_at.\n      CREATE INDEX messages_preview ON messages\n        (conversationId, shouldAffectPreview, isGroupLeaveEventFromOther,\n         received_at, sent_at);\n      CREATE INDEX messages_preview_without_story ON messages\n        (conversationId, shouldAffectPreview, isGroupLeaveEventFromOther,\n         received_at, sent_at) WHERE storyId IS NULL;\n      `),db.pragma("user_version = 76")}))(),logger.info("updateToSchemaVersion76: success!"))},function updateToSchemaVersion77(currentVersion,db,logger){currentVersion>=77||(db.transaction((function(){db.exec("\n      -- Create FTS table with custom tokenizer from\n      -- @signalapp/better-sqlite3.\n\n      DROP TABLE messages_fts;\n\n      CREATE VIRTUAL TABLE messages_fts USING fts5(\n        body,\n        tokenize = 'signal_tokenizer'\n      );\n\n      -- Reindex messages\n      -- Based on messages_on_insert trigger from migrations/45-stories.ts\n\n      INSERT INTO messages_fts (rowid, body)\n      SELECT rowid, body\n      FROM messages\n      WHERE isViewOnce IS NOT 1 AND storyId IS NULL;\n      "),db.pragma("user_version = 77")}))(),logger.info("updateToSchemaVersion77: success!"))},function updateToSchemaVersion78(currentVersion,db,logger){currentVersion>=78||(db.transaction((function(){for(var deleteJobsInQueue=db.prepare("DELETE FROM jobs WHERE queueType = $queueType"),_loop=function(queue){var prevJobs=getJobsInQueueSync(db,queue.queueType);deleteJobsInQueue.run({queueType:queue.queueType}),prevJobs.forEach((function(job){var data=job.data,id=job.id;if(isRecord(data)){var messageId=data.messageId;if("string"==typeof messageId){var message=getMessageByIdSync(db,messageId);if(message){var conversationId=message.conversationId;if("string"==typeof conversationId){var oldReceipts=queue.jobDataIsArray?data[queue.jobDataKey]:[data[queue.jobDataKey]];if(Array.isArray(oldReceipts)){var _step,newReceipts=[],_iterator=_78_merge_receipt_jobs_createForOfIteratorHelper(oldReceipts);try{for(_iterator.s();!(_step=_iterator.n()).done;){var receipt=_step.value;isRecord(receipt)?newReceipts.push(Object.assign({},receipt,{conversationId})):logger.warn(`updateToSchemaVersion78: ${queue.queueType} queue job ${id} had a non-record receipt`)}}catch(err){_iterator.e(err)}finally{_iterator.f()}var newJob=Object.assign({},job,{queueType:"conversation",data:{type:"Receipts",conversationId,receiptsType:queue.newReceiptsType,receipts:newReceipts}});insertJobSync(db,newJob)}else logger.warn(`updateToSchemaVersion78: ${queue.queueType} queue job ${id} had a non-array ${queue.jobDataKey}`)}else logger.warn(`updateToSchemaVersion78: ${queue.queueType} queue job ${id} had a non-string conversationId`)}else logger.warn(`updateToSchemaVersion78: Unable to find message for ${queue.queueType} job ${id}`)}else logger.warn(`updateToSchemaVersion78: ${queue.queueType} queue job ${id} had a non-string messageId`)}else logger.warn(`updateToSchemaVersion78: ${queue.queueType} queue job ${id} was missing valid data`)}))},_i=0,_queues=[{queueType:"delivery receipts",jobDataKey:"deliveryReceipts",jobDataIsArray:!0,newReceiptsType:"deliveryReceipt"},{queueType:"read receipts",jobDataKey:"readReceipts",jobDataIsArray:!0,newReceiptsType:"readReceipt"},{queueType:"viewed receipts",jobDataKey:"viewedReceipt",jobDataIsArray:!1,newReceiptsType:"viewedReceipt"}];_i<_queues.length;_i++){_loop(_queues[_i])}db.pragma("user_version = 78")}))(),logger.info("updateToSchemaVersion78: success!"))},function updateToSchemaVersion79(currentVersion,db,logger){currentVersion>=79||(db.transaction((function(){db.exec("\n      DROP INDEX   messages_hasVisualMediaAttachments;\n      CREATE INDEX messages_hasVisualMediaAttachments\n        ON messages (\n          conversationId, isStory, storyId,\n          hasVisualMediaAttachments, received_at, sent_at\n        )\n        WHERE hasVisualMediaAttachments IS 1;\n    "),db.pragma("user_version = 79")}))(),logger.info("updateToSchemaVersion79: success!"))},function updateToSchemaVersion80(currentVersion,db,logger){currentVersion>=80||(db.transaction((function(){db.exec("\n      CREATE TABLE edited_messages(\n        fromId STRING,\n        messageId STRING REFERENCES messages(id)\n          ON DELETE CASCADE,\n        sentAt INTEGER,\n        readStatus INTEGER\n      );\n\n      CREATE INDEX edited_messages_sent_at ON edited_messages (sentAt);\n    "),db.pragma("user_version = 80")}))(),logger.info("updateToSchemaVersion80: success!"))},function updateToSchemaVersion81(currentVersion,db,logger){currentVersion>=81||(db.transaction((function(){db.exec("\n      --- These will be re-added below\n      DROP INDEX messages_preview;\n      DROP INDEX messages_preview_without_story;\n      DROP INDEX messages_activity;\n      DROP INDEX message_user_initiated;\n\n      --- These will also be re-added below\n      ALTER TABLE messages DROP COLUMN shouldAffectActivity;\n      ALTER TABLE messages DROP COLUMN shouldAffectPreview;\n      ALTER TABLE messages DROP COLUMN isUserInitiatedMessage;\n\n      --- Note: These generated columns were previously modified in\n      ---       migration 73, and are mostly the same\n\n      --- (change: added contact-removed-notification)\n      ALTER TABLE messages\n        ADD COLUMN shouldAffectActivity INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'contact-removed-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'keychange',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      --- (change: added contact-removed-notification)\n      ALTER TABLE messages\n        ADD COLUMN shouldAffectPreview INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'contact-removed-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'keychange',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      --- (change: added contact-removed-notification)\n      ALTER TABLE messages\n        ADD COLUMN isUserInitiatedMessage INTEGER\n        GENERATED ALWAYS AS (\n          type IS NULL\n          OR\n          type NOT IN (\n            'change-number-notification',\n            'contact-removed-notification',\n            'conversation-merge',\n            'group-v1-migration',\n            'group-v2-change',\n            'keychange',\n            'message-history-unsynced',\n            'profile-change',\n            'story',\n            'universal-timer-notification',\n            'verified-change'\n          )\n        );\n\n      --- From migration 76\n      CREATE INDEX messages_preview ON messages\n        (conversationId, shouldAffectPreview, isGroupLeaveEventFromOther,\n         received_at, sent_at);\n\n      --- From migration 76\n      CREATE INDEX messages_preview_without_story ON messages\n        (conversationId, shouldAffectPreview, isGroupLeaveEventFromOther,\n         received_at, sent_at) WHERE storyId IS NULL;\n\n      --- From migration 73\n      CREATE INDEX messages_activity ON messages\n        (conversationId, shouldAffectActivity, isTimerChangeFromSync, isGroupLeaveEventFromOther, received_at, sent_at);\n\n      --- From migration 74\n      CREATE INDEX message_user_initiated ON messages (conversationId, isUserInitiatedMessage);\n      "),db.pragma("user_version = 81")}))(),logger.info("updateToSchemaVersion81: success!"))}];var process=__webpack_require__("./node_modules/process/browser.js");function Server_toConsumableArray(arr){return function Server_arrayWithoutHoles(arr){if(Array.isArray(arr))return Server_arrayLikeToArray(arr)}(arr)||function Server_iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||Server_unsupportedIterableToArray(arr)||function Server_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Server_slicedToArray(arr,i){return function Server_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function Server_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||Server_unsupportedIterableToArray(arr,i)||function Server_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Server_createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=Server_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(e){didErr=!0,err=e},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function Server_unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return Server_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Server_arrayLikeToArray(o,minLen):void 0}}function Server_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var dataInterface={close:async function Server_close(){for(var _i=0,_arr=[globalInstanceRenderer,globalInstance];_i<_arr.length;_i++){var dbRef=_arr[_i];null==dbRef||dbRef.pragma("optimize"),null==dbRef||dbRef.close()}globalInstance=void 0,globalInstanceRenderer=void 0},removeDB:async function removeDB(){if(globalInstance){try{globalInstance.close()}catch(error){logger.error("removeDB: Failed to close database:",error.stack)}globalInstance=void 0}if(!databaseFilePath)throw new Error("removeDB: Cannot erase database without a databaseFilePath!");logger.warn("removeDB: Removing all database files"),rimraf_default().sync(databaseFilePath),rimraf_default().sync(`${databaseFilePath}-shm`),rimraf_default().sync(`${databaseFilePath}-wal`)},removeIndexedDBFiles:async function removeIndexedDBFiles(){if(!indexedDBPath)throw new Error("removeIndexedDBFiles: Need to initialize and set indexedDBPath first!");var pattern=(0,path.join)(indexedDBPath,"*.leveldb");rimraf_default().sync(pattern),indexedDBPath=void 0},createOrUpdateIdentityKey:async function createOrUpdateIdentityKey(data){return createOrUpdate(getInstance(),"identityKeys",data)},getIdentityKeyById:async function getIdentityKeyById(id){return getById(getInstance(),"identityKeys",id)},bulkAddIdentityKeys:async function bulkAddIdentityKeys(array){return bulkAdd(getInstance(),"identityKeys",array)},removeIdentityKeyById:async function removeIdentityKeyById(id){return removeById(getInstance(),"identityKeys",id)},removeAllIdentityKeys:async function removeAllIdentityKeys(){return removeAllFromTable(getInstance(),"identityKeys")},getAllIdentityKeys:async function getAllIdentityKeys(){return getAllFromTable(getInstance(),"identityKeys")},createOrUpdatePreKey:async function createOrUpdatePreKey(data){return createOrUpdate(getInstance(),"preKeys",data)},getPreKeyById:async function getPreKeyById(id){return getById(getInstance(),"preKeys",id)},bulkAddPreKeys:async function bulkAddPreKeys(array){return bulkAdd(getInstance(),"preKeys",array)},removePreKeyById:async function removePreKeyById(id){return removeById(getInstance(),"preKeys",id)},removePreKeysByUuid:async function removePreKeysByUuid(uuid){getInstance().prepare("DELETE FROM preKeys WHERE ourUuid IS $uuid;").run({uuid})},removeAllPreKeys:async function removeAllPreKeys(){return removeAllFromTable(getInstance(),"preKeys")},getAllPreKeys:async function getAllPreKeys(){return getAllFromTable(getInstance(),"preKeys")},createOrUpdateSignedPreKey:async function createOrUpdateSignedPreKey(data){return createOrUpdate(getInstance(),"signedPreKeys",data)},getSignedPreKeyById:async function getSignedPreKeyById(id){return getById(getInstance(),"signedPreKeys",id)},bulkAddSignedPreKeys:async function bulkAddSignedPreKeys(array){return bulkAdd(getInstance(),"signedPreKeys",array)},removeSignedPreKeyById:async function removeSignedPreKeyById(id){return removeById(getInstance(),"signedPreKeys",id)},removeSignedPreKeysByUuid:async function removeSignedPreKeysByUuid(uuid){getInstance().prepare("DELETE FROM signedPreKeys WHERE ourUuid IS $uuid;").run({uuid})},removeAllSignedPreKeys:async function removeAllSignedPreKeys(){return removeAllFromTable(getInstance(),"signedPreKeys")},getAllSignedPreKeys:async function getAllSignedPreKeys(){return getInstance().prepare("\n      SELECT json\n      FROM signedPreKeys\n      ORDER BY id ASC;\n      ").all().map((function(row){return jsonToObject(row.json)}))},createOrUpdateItem:async function createOrUpdateItem(data){return createOrUpdate(getInstance(),"items",data)},getItemById:async function getItemById(id){return getById(getInstance(),"items",id)},removeItemById:async function removeItemById(id){return removeById(getInstance(),"items",id)},removeAllItems:async function removeAllItems(){return removeAllFromTable(getInstance(),"items")},getAllItems:async function getAllItems(){var _step,items=getInstance().prepare("SELECT json FROM items ORDER BY id ASC;").all().map((function(row){return jsonToObject(row.json)})),result=Object.create(null),_iterator=Server_createForOfIteratorHelper(items);try{for(_iterator.s();!(_step=_iterator.n()).done;){var _ref5=_step.value,id=_ref5.id,value=_ref5.value;result[id]=value}}catch(err){_iterator.e(err)}finally{_iterator.f()}return result},createOrUpdateSenderKey:async function createOrUpdateSenderKey(key){createOrUpdateSenderKeySync(key)},getSenderKeyById:async function getSenderKeyById(id){return prepare(getInstance(),"SELECT * FROM senderKeys WHERE id = $id").get({id})},removeAllSenderKeys:async function removeAllSenderKeys(){prepare(getInstance(),"DELETE FROM senderKeys").run()},getAllSenderKeys:async function getAllSenderKeys(){return prepare(getInstance(),"SELECT * FROM senderKeys").all()},removeSenderKeyById:async function removeSenderKeyById(id){prepare(getInstance(),"DELETE FROM senderKeys WHERE id = $id").run({id})},insertSentProto:async function insertSentProto(proto,options){var db=getInstance(),recipients=options.recipients,messageIds=options.messageIds;return db.transaction((function(){for(var info=prepare(db,"\n      INSERT INTO sendLogPayloads (\n        contentHint,\n        proto,\n        timestamp,\n        urgent,\n        hasPniSignatureMessage\n      ) VALUES (\n        $contentHint,\n        $proto,\n        $timestamp,\n        $urgent,\n        $hasPniSignatureMessage\n      );\n      ").run(Object.assign({},proto,{urgent:proto.urgent?1:0,hasPniSignatureMessage:proto.hasPniSignatureMessage?1:0})),id=(0,util_parseIntOrThrow.Q)(info.lastInsertRowid,"insertSentProto/lastInsertRowid"),recipientStatement=prepare(db,"\n      INSERT INTO sendLogRecipients (\n        payloadId,\n        recipientUuid,\n        deviceId\n      ) VALUES (\n        $id,\n        $recipientUuid,\n        $deviceId\n      );\n      "),_i2=0,_recipientUuids=Object.keys(recipients);_i2<_recipientUuids.length;_i2++){var _step2,recipientUuid=_recipientUuids[_i2],_iterator2=Server_createForOfIteratorHelper(recipients[recipientUuid]);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var deviceId=_step2.value;recipientStatement.run({id,recipientUuid,deviceId})}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}var _step3,messageStatement=prepare(db,"\n      INSERT INTO sendLogMessageIds (\n        payloadId,\n        messageId\n      ) VALUES (\n        $id,\n        $messageId\n      );\n      "),_iterator3=Server_createForOfIteratorHelper(new Set(messageIds));try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var messageId=_step3.value;messageStatement.run({id,messageId})}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return id}))()},deleteSentProtosOlderThan,deleteSentProtoByMessageId:async function deleteSentProtoByMessageId(messageId){prepare(getInstance(),"\n    DELETE FROM sendLogPayloads WHERE id IN (\n      SELECT payloadId FROM sendLogMessageIds\n      WHERE messageId = $messageId\n    );\n    ").run({messageId})},insertProtoRecipients:async function insertProtoRecipients(_ref6){var id=_ref6.id,recipientUuid=_ref6.recipientUuid,deviceIds=_ref6.deviceIds,db=getInstance();db.transaction((function(){var _step4,statement=prepare(db,"\n      INSERT INTO sendLogRecipients (\n        payloadId,\n        recipientUuid,\n        deviceId\n      ) VALUES (\n        $id,\n        $recipientUuid,\n        $deviceId\n      );\n      "),_iterator4=Server_createForOfIteratorHelper(deviceIds);try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var deviceId=_step4.value;statement.run({id,recipientUuid,deviceId})}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}))()},deleteSentProtoRecipient:async function deleteSentProtoRecipient(options){var db=getInstance(),items=Array.isArray(options)?options:[options];return db.transaction((function(){var _step5,successfulPhoneNumberShares=new Array,_iterator5=Server_createForOfIteratorHelper(items);try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var item=_step5.value,timestamp=item.timestamp,recipientUuid=item.recipientUuid,deviceId=item.deviceId,rows=prepare(db,"\n        SELECT sendLogPayloads.id, sendLogPayloads.hasPniSignatureMessage\n        FROM sendLogPayloads\n        INNER JOIN sendLogRecipients\n          ON sendLogRecipients.payloadId = sendLogPayloads.id\n        WHERE\n          sendLogPayloads.timestamp = $timestamp AND\n          sendLogRecipients.recipientUuid = $recipientUuid AND\n          sendLogRecipients.deviceId = $deviceId;\n       ").all({timestamp,recipientUuid,deviceId});if(rows.length){rows.length>1&&logger.warn(`deleteSentProtoRecipient: More than one payload matches recipient and timestamp ${timestamp}. Using the first.`);var _rows$=rows[0],id=_rows$.id,hasPniSignatureMessage=_rows$.hasPniSignatureMessage;prepare(db,"\n        DELETE FROM sendLogRecipients\n        WHERE\n          payloadId = $id AND\n          recipientUuid = $recipientUuid AND\n          deviceId = $deviceId;\n        ").run({id,recipientUuid,deviceId});var remainingDevices=prepare(db,"\n        SELECT count(1) FROM sendLogRecipients\n        WHERE payloadId = $id AND recipientUuid = $recipientUuid;\n        ",{pluck:!0}).get({id,recipientUuid});0===remainingDevices&&hasPniSignatureMessage&&(logger.info(`deleteSentProtoRecipient: Successfully shared phone number with ${recipientUuid} through message ${timestamp}`),successfulPhoneNumberShares.push(recipientUuid)),(0,assert.Yj)(isNumber_default()(remainingDevices),"deleteSentProtoRecipient: select count() returned non-number!");var remainingTotal=prepare(db,"SELECT count(1) FROM sendLogRecipients WHERE payloadId = $id;",{pluck:!0}).get({id});(0,assert.Yj)(isNumber_default()(remainingTotal),"deleteSentProtoRecipient: select count() returned non-number!"),remainingTotal>0||(logger.info(`deleteSentProtoRecipient: Deleting proto payload for timestamp ${timestamp}`),prepare(db,"DELETE FROM sendLogPayloads WHERE id = $id;").run({id}))}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}return{successfulPhoneNumberShares}}))()},getSentProtoByRecipient:async function getSentProtoByRecipient(_ref7){var now=_ref7.now,recipientUuid=_ref7.recipientUuid,timestamp=_ref7.timestamp,db=getInstance(),oneDayAgo=now-864e5;await deleteSentProtosOlderThan(oneDayAgo);var row=prepare(db,"\n    SELECT\n      sendLogPayloads.*,\n      GROUP_CONCAT(DISTINCT sendLogMessageIds.messageId) AS messageIds\n    FROM sendLogPayloads\n    INNER JOIN sendLogRecipients ON sendLogRecipients.payloadId = sendLogPayloads.id\n    LEFT JOIN sendLogMessageIds ON sendLogMessageIds.payloadId = sendLogPayloads.id\n    WHERE\n      sendLogPayloads.timestamp = $timestamp AND\n      sendLogRecipients.recipientUuid = $recipientUuid\n    GROUP BY sendLogPayloads.id;\n    ").get({timestamp,recipientUuid});if(!row)return;var messageIds=row.messageIds;return Object.assign({},row,{urgent:!isNumber_default()(row.urgent)||Boolean(row.urgent),hasPniSignatureMessage:!isNumber_default()(row.hasPniSignatureMessage)||Boolean(row.hasPniSignatureMessage),messageIds:messageIds?messageIds.split(","):[]})},removeAllSentProtos:async function removeAllSentProtos(){prepare(getInstance(),"DELETE FROM sendLogPayloads;").run()},getAllSentProtos:async function getAllSentProtos(){return prepare(getInstance(),"SELECT * FROM sendLogPayloads;").all().map((function(row){return Object.assign({},row,{urgent:!isNumber_default()(row.urgent)||Boolean(row.urgent),hasPniSignatureMessage:!isNumber_default()(row.hasPniSignatureMessage)||Boolean(row.hasPniSignatureMessage)})}))},_getAllSentProtoRecipients:async function _getAllSentProtoRecipients(){return prepare(getInstance(),"SELECT * FROM sendLogRecipients;").all()},_getAllSentProtoMessageIds:async function _getAllSentProtoMessageIds(){return prepare(getInstance(),"SELECT * FROM sendLogMessageIds;").all()},createOrUpdateSession:async function createOrUpdateSession(data){return createOrUpdateSessionSync(data)},createOrUpdateSessions:async function createOrUpdateSessions(array){getInstance().transaction((function(){var _step6,_iterator6=Server_createForOfIteratorHelper(array);try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var item=_step6.value;(0,assert.UU)(createOrUpdateSessionSync(item))}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}))()},commitDecryptResult:async function commitDecryptResult(_ref8){var senderKeys=_ref8.senderKeys,sessions=_ref8.sessions,unprocessed=_ref8.unprocessed;getInstance().transaction((function(){var _step7,_iterator7=Server_createForOfIteratorHelper(senderKeys);try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var item=_step7.value;(0,assert.UU)(createOrUpdateSenderKeySync(item))}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}var _step8,_iterator8=Server_createForOfIteratorHelper(sessions);try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var _item=_step8.value;(0,assert.UU)(createOrUpdateSessionSync(_item))}}catch(err){_iterator8.e(err)}finally{_iterator8.f()}var _step9,_iterator9=Server_createForOfIteratorHelper(unprocessed);try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var _item2=_step9.value;(0,assert.UU)(saveUnprocessedSync(_item2))}}catch(err){_iterator9.e(err)}finally{_iterator9.f()}}))()},bulkAddSessions:async function bulkAddSessions(array){return bulkAdd(getInstance(),"sessions",array)},removeSessionById:async function removeSessionById(id){return removeById(getInstance(),"sessions",id)},removeSessionsByConversation:async function removeSessionsByConversation(conversationId){getInstance().prepare("\n    DELETE FROM sessions\n    WHERE conversationId = $conversationId;\n    ").run({conversationId})},removeSessionsByUUID:async function removeSessionsByUUID(uuid){getInstance().prepare("\n    DELETE FROM sessions\n    WHERE uuid = $uuid;\n    ").run({uuid})},removeAllSessions:async function removeAllSessions(){return removeAllFromTable(getInstance(),"sessions")},getAllSessions:async function getAllSessions(){return getAllFromTable(getInstance(),"sessions")},eraseStorageServiceStateFromConversations:async function eraseStorageServiceStateFromConversations(){getInstance().prepare("\n    UPDATE conversations\n    SET\n      json = json_remove(json, '$.storageID', '$.needsStorageServiceSync', '$.unknownFields', '$.storageProfileKey');\n    ").run()},getConversationCount,saveConversation:async function saveConversation(data){var db=arguments.length>1&&void 0!==arguments[1]?arguments[1]:getInstance();return saveConversationSync(data,db)},saveConversations:async function saveConversations(arrayOfConversations){getInstance().transaction((function(){var _step10,_iterator10=Server_createForOfIteratorHelper(arrayOfConversations);try{for(_iterator10.s();!(_step10=_iterator10.n()).done;){var conversation=_step10.value;(0,assert.UU)(saveConversationSync(conversation))}}catch(err){_iterator10.e(err)}finally{_iterator10.f()}}))()},getConversationById:async function getConversationById(id){var row=getInstance().prepare("SELECT json FROM conversations WHERE id = $id;").get({id});if(!row)return;return jsonToObject(row.json)},updateConversation:async function updateConversation(data){return updateConversationSync(data)},updateConversations:async function updateConversations(array){getInstance().transaction((function(){var _step11,_iterator11=Server_createForOfIteratorHelper(array);try{for(_iterator11.s();!(_step11=_iterator11.n()).done;){var item=_step11.value;(0,assert.UU)(updateConversationSync(item))}}catch(err){_iterator11.e(err)}finally{_iterator11.f()}}))()},removeConversation:async function removeConversation(id){var db=getInstance();if(!Array.isArray(id))return void db.prepare("DELETE FROM conversations WHERE id = $id;").run({id});if(!id.length)throw new Error("removeConversation: No ids to delete!");batchMultiVarQuery(db,id,removeConversationsSync)},_removeAllConversations:async function _removeAllConversations(){getInstance().prepare("DELETE from conversations;").run()},updateAllConversationColors:async function updateAllConversationColors(conversationColor,customColorData){getInstance().prepare("\n    UPDATE conversations\n    SET json = JSON_PATCH(json, $patch);\n    ").run({patch:JSON.stringify({conversationColor:conversationColor||null,customColor:(null==customColorData?void 0:customColorData.value)||null,customColorId:(null==customColorData?void 0:customColorData.id)||null})})},removeAllProfileKeyCredentials:async function removeAllProfileKeyCredentials(){getInstance().exec("\n    UPDATE conversations\n    SET\n      json = json_remove(json, '$.profileKeyCredential')\n    ")},getAllConversations:async function getAllConversations(){return function getAllConversationsSync(){var db=arguments.length>0&&void 0!==arguments[0]?arguments[0]:getInstance();return db.prepare("\n      SELECT json, profileLastFetchedAt\n      FROM conversations\n      ORDER BY id ASC;\n      ").all().map((function(row){return rowToConversation(row)}))}()},getAllConversationIds:async function getAllConversationIds(){return getInstance().prepare("\n      SELECT id FROM conversations ORDER BY id ASC;\n      ").all().map((function(row){return row.id}))},getAllGroupsInvolvingUuid:async function getAllGroupsInvolvingUuid(uuid){return getInstance().prepare("\n      SELECT json, profileLastFetchedAt\n      FROM conversations WHERE\n        type = 'group' AND\n        members LIKE $uuid\n      ORDER BY id ASC;\n      ").all({uuid:`%${uuid}%`}).map((function(row){return rowToConversation(row)}))},searchMessages,searchMessagesInConversation:async function searchMessagesInConversation(query,conversationId){var _ref10=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},_ref10$limit=_ref10.limit,limit=void 0===_ref10$limit?100:_ref10$limit;return searchMessages(query,{conversationId,limit})},getMessageCount,getStoryCount:async function getStoryCount(conversationId){return getInstance().prepare("\n        SELECT count(1)\n        FROM messages\n        WHERE conversationId = $conversationId AND isStory = 1;\n        ").pluck().get({conversationId})},saveMessage:async function saveMessage(data,options){return saveMessageSync(data,options)},saveMessages:async function saveMessages(arrayOfMessages,options){getInstance().transaction((function(){var _step12,_iterator12=Server_createForOfIteratorHelper(arrayOfMessages);try{for(_iterator12.s();!(_step12=_iterator12.n()).done;){var message=_step12.value;(0,assert.UU)(saveMessageSync(message,Object.assign({},options,{alreadyInTransaction:!0})))}}catch(err){_iterator12.e(err)}finally{_iterator12.f()}}))()},removeMessage:async function removeMessage(id){getInstance().prepare("DELETE FROM messages WHERE id = $id;").run({id})},removeMessages:async function removeMessages(ids){batchMultiVarQuery(getInstance(),ids,removeMessagesSync)},getUnreadByConversationAndMarkRead:async function getUnreadByConversationAndMarkRead(_ref12){var conversationId=_ref12.conversationId,includeStoryReplies=_ref12.includeStoryReplies,newestUnreadAt=_ref12.newestUnreadAt,storyId=_ref12.storyId,readAt=_ref12.readAt,_ref12$now=_ref12.now,now=void 0===_ref12$now?Date.now():_ref12$now,db=getInstance();return db.transaction((function(){var expirationStartTimestamp=Math.min(now,null!=readAt?readAt:1/0),_ref14=Server_slicedToArray(sql`
      UPDATE messages
      INDEXED BY expiring_message_by_conversation_and_received_at
      SET
        expirationStartTimestamp = ${expirationStartTimestamp},
        json = json_patch(json, ${JSON.stringify({expirationStartTimestamp})})
      WHERE
        conversationId = ${conversationId} AND
        (${_storyIdPredicate(storyId,includeStoryReplies)}) AND
        isStory IS 0 AND
        type IS 'incoming' AND
        (
          expirationStartTimestamp IS NULL OR
          expirationStartTimestamp > ${expirationStartTimestamp}
        ) AND
        expireTimer > 0 AND
        received_at <= ${newestUnreadAt};
    `,2),updateExpirationQuery=_ref14[0],updateExpirationParams=_ref14[1];db.prepare(updateExpirationQuery).run(updateExpirationParams);var _ref16=Server_slicedToArray(sql`
      SELECT id, json FROM messages
        WHERE
          conversationId = ${conversationId} AND
          seenStatus = ${SeenStatus.Unseen} AND
          isStory = 0 AND
          (${_storyIdPredicate(storyId,includeStoryReplies)}) AND
          received_at <= ${newestUnreadAt}
        ORDER BY received_at DESC, sent_at DESC;
    `,2),selectQuery=_ref16[0],selectParams=_ref16[1],rows=db.prepare(selectQuery).all(selectParams),statusJsonPatch=JSON.stringify({readStatus:MessageReadStatus.N.Read,seenStatus:SeenStatus.Seen}),_ref18=Server_slicedToArray(sql`
      UPDATE messages
        SET
          readStatus = ${MessageReadStatus.N.Read},
          seenStatus = ${SeenStatus.Seen},
          json = json_patch(json, ${statusJsonPatch})
        WHERE
          conversationId = ${conversationId} AND
          seenStatus = ${SeenStatus.Unseen} AND
          isStory = 0 AND
          (${_storyIdPredicate(storyId,includeStoryReplies)}) AND
          received_at <= ${newestUnreadAt};
    `,2),updateStatusQuery=_ref18[0],updateStatusParams=_ref18[1];return db.prepare(updateStatusQuery).run(updateStatusParams),rows.map((function(row){var json=jsonToObject(row.json);return Object.assign({originalReadStatus:json.readStatus,readStatus:MessageReadStatus.N.Read,seenStatus:SeenStatus.Seen},pick_default()(json,["expirationStartTimestamp","id","sent_at","source","sourceUuid","type"]))}))}))()},getUnreadReactionsAndMarkRead:async function getUnreadReactionsAndMarkRead(_ref19){var conversationId=_ref19.conversationId,newestUnreadAt=_ref19.newestUnreadAt,storyId=_ref19.storyId,db=getInstance();return db.transaction((function(){var unreadMessages=db.prepare("\n        SELECT reactions.rowid, targetAuthorUuid, targetTimestamp, messageId\n        FROM reactions\n        INDEXED BY reactions_unread\n        JOIN messages on messages.id IS reactions.messageId\n        WHERE\n          reactions.conversationId IS $conversationId AND\n          reactions.unread > 0 AND\n          messages.received_at <= $newestUnreadAt AND\n          messages.storyId IS $storyId\n        ORDER BY messageReceivedAt DESC;\n      ").all({conversationId,newestUnreadAt,storyId:storyId||null}),idsToUpdate=unreadMessages.map((function(item){return item.rowid}));return batchMultiVarQuery(db,idsToUpdate,(function(ids){db.prepare(`\n        UPDATE reactions\n        SET unread = 0\n        WHERE rowid IN ( ${ids.map((function(){return"?"})).join(", ")} );\n        `).run(ids)})),unreadMessages}))()},markReactionAsRead:async function markReactionAsRead(targetAuthorUuid,targetTimestamp){var db=getInstance();return db.transaction((function(){var readReaction=db.prepare("\n          SELECT *\n          FROM reactions\n          WHERE\n            targetAuthorUuid = $targetAuthorUuid AND\n            targetTimestamp = $targetTimestamp AND\n            unread = 1\n          ORDER BY rowId DESC\n          LIMIT 1;\n        ").get({targetAuthorUuid,targetTimestamp});return db.prepare("\n        UPDATE reactions SET\n        unread = 0 WHERE\n        targetAuthorUuid = $targetAuthorUuid AND\n        targetTimestamp = $targetTimestamp;\n      ").run({targetAuthorUuid,targetTimestamp}),readReaction}))()},addReaction:async function addReaction(_ref20){var conversationId=_ref20.conversationId,emoji=_ref20.emoji,fromId=_ref20.fromId,messageId=_ref20.messageId,messageReceivedAt=_ref20.messageReceivedAt,targetAuthorUuid=_ref20.targetAuthorUuid,targetTimestamp=_ref20.targetTimestamp,db=getInstance();await db.prepare("INSERT INTO reactions (\n      conversationId,\n      emoji,\n      fromId,\n      messageId,\n      messageReceivedAt,\n      targetAuthorUuid,\n      targetTimestamp,\n      unread\n    ) VALUES (\n      $conversationId,\n      $emoji,\n      $fromId,\n      $messageId,\n      $messageReceivedAt,\n      $targetAuthorUuid,\n      $targetTimestamp,\n      $unread\n    );").run({conversationId,emoji,fromId,messageId,messageReceivedAt,targetAuthorUuid,targetTimestamp,unread:1})},removeReactionFromConversation:async function removeReactionFromConversation(_ref21){var emoji=_ref21.emoji,fromId=_ref21.fromId,targetAuthorUuid=_ref21.targetAuthorUuid,targetTimestamp=_ref21.targetTimestamp,db=getInstance();await db.prepare("DELETE FROM reactions WHERE\n      emoji = $emoji AND\n      fromId = $fromId AND\n      targetAuthorUuid = $targetAuthorUuid AND\n      targetTimestamp = $targetTimestamp;").run({emoji,fromId,targetAuthorUuid,targetTimestamp})},_getAllReactions:async function _getAllReactions(){return getInstance().prepare("SELECT * from reactions;").all()},_removeAllReactions:async function _removeAllReactions(){getInstance().prepare("DELETE from reactions;").run()},getMessageBySender:async function getMessageBySender(_ref11){var source=_ref11.source,sourceUuid=_ref11.sourceUuid,sourceDevice=_ref11.sourceDevice,sent_at=_ref11.sent_at,rows=prepare(getInstance(),"\n    SELECT json FROM messages WHERE\n      (source = $source OR sourceUuid = $sourceUuid) AND\n      sourceDevice = $sourceDevice AND\n      sent_at = $sent_at\n    LIMIT 2;\n    ").all({source:source||null,sourceUuid:sourceUuid||null,sourceDevice:sourceDevice||null,sent_at});rows.length>1&&logging_log.warn("getMessageBySender: More than one message found for",{sent_at,source,sourceUuid,sourceDevice});if(rows.length<1)return;return jsonToObject(rows[0].json)},getMessageById:async function getMessageById(id){return getMessageByIdSync(getInstance(),id)},getMessagesById:async function getMessagesById(messageIds){var db=getInstance();return batchMultiVarQuery(db,messageIds,(function(batch){return db.prepare(`SELECT json FROM messages WHERE id IN (${Array(batch.length).fill("?").join(",")});`).all(batch).map((function(row){return jsonToObject(row.json)}))}))},_getAllMessages:async function _getAllMessages(){return getInstance().prepare("SELECT json FROM messages ORDER BY id ASC;").all().map((function(row){return jsonToObject(row.json)}))},_getAllEditedMessages:async function _getAllEditedMessages(){return getInstance().prepare("\n      SELECT * FROM edited_messages;\n      ").all({})},_removeAllMessages:async function _removeAllMessages(){getInstance().exec("\n    DELETE FROM messages;\n    INSERT INTO messages_fts(messages_fts) VALUES('optimize');\n  ")},getAllMessageIds:async function getAllMessageIds(){return getInstance().prepare("SELECT id FROM messages ORDER BY id ASC;").all().map((function(row){return row.id}))},getMessagesBySentAt:async function getMessagesBySentAt(sentAt){var db=getInstance(),_ref51=Server_slicedToArray(sql`
      SELECT messages.json, received_at, sent_at FROM edited_messages
      INNER JOIN messages ON
        messages.id = edited_messages.messageId
      WHERE edited_messages.sentAt = ${sentAt}
      UNION
      SELECT json, received_at, sent_at FROM messages
      WHERE sent_at = ${sentAt}
      ORDER BY messages.received_at DESC, messages.sent_at DESC;
    `,2),query=_ref51[0],params=_ref51[1];return db.prepare(query).all(params).map((function(row){return jsonToObject(row.json)}))},getUnreadEditedMessagesAndMarkRead:async function getUnreadEditedMessagesAndMarkRead(_ref72){var fromId=_ref72.fromId,newestUnreadAt=_ref72.newestUnreadAt,db=getInstance();return db.transaction((function(){var _ref74=Server_slicedToArray(sql`
      SELECT
        messages.id,
        messages.json,
        edited_messages.sentAt,
        edited_messages.readStatus
      FROM edited_messages
      JOIN messages
        ON messages.id = edited_messages.messageId
      WHERE
        edited_messages.readStatus = ${MessageReadStatus.N.Unread} AND
        edited_messages.fromId = ${fromId} AND
        received_at <= ${newestUnreadAt}
      ORDER BY messages.received_at DESC, messages.sent_at DESC;
    `,2),selectQuery=_ref74[0],selectParams=_ref74[1],rows=db.prepare(selectQuery).all(selectParams);if(rows.length){var newestSentAt=rows[0].sentAt,_ref76=Server_slicedToArray(sql`
        UPDATE edited_messages
          SET
            readStatus = ${MessageReadStatus.N.Read}
          WHERE
            readStatus = ${MessageReadStatus.N.Unread} AND
            fromId = ${fromId} AND
            sentAt <= ${newestSentAt};
      `,2),updateStatusQuery=_ref76[0],updateStatusParams=_ref76[1];db.prepare(updateStatusQuery).run(updateStatusParams)}return rows.map((function(row){var json=jsonToObject(row.json);return Object.assign({originalReadStatus:row.readStatus,readStatus:MessageReadStatus.N.Read,seenStatus:SeenStatus.Seen},pick_default()(json,["expirationStartTimestamp","id","sent_at","source","sourceUuid","type"]),{sent_at:row.sentAt})}))}))()},getExpiredMessages:async function getExpiredMessages(){var db=getInstance(),now=Date.now();return db.prepare("\n      SELECT json FROM messages WHERE\n        expiresAt <= $now\n      ORDER BY expiresAt ASC;\n      ").all({now}).map((function(row){return jsonToObject(row.json)}))},getMessagesUnexpectedlyMissingExpirationStartTimestamp:async function getMessagesUnexpectedlyMissingExpirationStartTimestamp(){return getInstance().prepare(`\n      SELECT json FROM messages\n      INDEXED BY messages_unexpectedly_missing_expiration_start_timestamp\n      WHERE\n        expireTimer > 0 AND\n        expirationStartTimestamp IS NULL AND\n        (\n          type IS 'outgoing' OR\n          (type IS 'incoming' AND (\n            readStatus = ${MessageReadStatus.N.Read} OR\n            readStatus = ${MessageReadStatus.N.Viewed} OR\n            readStatus IS NULL\n          ))\n        );\n      `).all().map((function(row){return jsonToObject(row.json)}))},getSoonestMessageExpiry:async function getSoonestMessageExpiry(){var result=getInstance().prepare("\n      SELECT MIN(expiresAt)\n      FROM messages;\n      ").pluck(!0).get();if(null!=result&&result>=Number.MAX_SAFE_INTEGER)return;return result||void 0},getNextTapToViewMessageTimestampToAgeOut:async function getNextTapToViewMessageTimestampToAgeOut(){var row=getInstance().prepare("\n      SELECT json FROM messages\n      WHERE\n        isViewOnce = 1\n        AND (isErased IS NULL OR isErased != 1)\n      ORDER BY received_at ASC, sent_at ASC\n      LIMIT 1;\n      ").get();if(!row)return;var data=jsonToObject(row.json),result=data.received_at_ms||data.received_at;return isNormalNumber(result)?result:void 0},getTapToViewMessagesNeedingErase:async function getTapToViewMessagesNeedingErase(){var db=getInstance(),THIRTY_DAYS_AGO=Date.now()-2592e6;return db.prepare("\n      SELECT json\n      FROM messages\n      WHERE\n        isViewOnce = 1\n        AND (isErased IS NULL OR isErased != 1)\n        AND received_at <= $THIRTY_DAYS_AGO\n      ORDER BY received_at ASC, sent_at ASC;\n      ").all({THIRTY_DAYS_AGO}).map((function(row){return jsonToObject(row.json)}))},getOlderMessagesByConversation:async function getOlderMessagesByConversation(options){return getAdjacentMessagesByConversationSync(AdjacentDirection.Older,options)},getAllStories:async function getAllStories(_ref25){var conversationId=_ref25.conversationId,sourceUuid=_ref25.sourceUuid;return getInstance().prepare("\n      SELECT\n        json,\n        (SELECT EXISTS(\n          SELECT 1\n          FROM messages as replies\n          WHERE replies.storyId IS messages.id\n        )) as hasReplies,\n        (SELECT EXISTS(\n          SELECT 1\n          FROM messages AS selfReplies\n          WHERE\n            selfReplies.storyId IS messages.id AND\n            selfReplies.type IS 'outgoing'\n        )) as hasRepliesFromSelf\n      FROM messages\n      WHERE\n        type IS 'story' AND\n        ($conversationId IS NULL OR conversationId IS $conversationId) AND\n        ($sourceUuid IS NULL OR sourceUuid IS $sourceUuid)\n      ORDER BY received_at ASC, sent_at ASC;\n      ").all({conversationId:conversationId||null,sourceUuid:sourceUuid||null}).map((function(row){return Object.assign({},jsonToObject(row.json),{hasReplies:0!==row.hasReplies,hasRepliesFromSelf:0!==row.hasRepliesFromSelf})}))},getNewerMessagesByConversation:async function getNewerMessagesByConversation(options){return getAdjacentMessagesByConversationSync(AdjacentDirection.Newer,options)},getTotalUnreadForConversation:async function getTotalUnreadForConversation(conversationId,options){return function getTotalUnreadForConversationSync(conversationId,_ref44){var storyId=_ref44.storyId,includeStoryReplies=_ref44.includeStoryReplies,db=getInstance(),_ref45=sql`
    SELECT count(1)
    FROM messages
    WHERE
      conversationId = ${conversationId} AND
      readStatus = ${MessageReadStatus.N.Unread} AND
      isStory IS 0 AND
      (${_storyIdPredicate(storyId,includeStoryReplies)})
  `,_ref46=Server_slicedToArray(_ref45,2),query=_ref46[0],params=_ref46[1];return db.prepare(query).pluck().get(params)}(conversationId,options)},getMessageMetricsForConversation:async function getMessageMetricsForConversation(options){return getMessageMetricsForConversationSync(options)},getConversationRangeCenteredOnMessage:async function getConversationRangeCenteredOnMessage(options){return getInstance().transaction((function(){return{older:getAdjacentMessagesByConversationSync(AdjacentDirection.Older,options),newer:getAdjacentMessagesByConversationSync(AdjacentDirection.Newer,options),metrics:getMessageMetricsForConversationSync(options)}}))()},getConversationMessageStats:async function getConversationMessageStats(_ref39){var conversationId=_ref39.conversationId,includeStoryReplies=_ref39.includeStoryReplies,ourUuid=_ref39.ourUuid;return getInstance().transaction((function(){return{activity:getLastConversationActivity({conversationId,includeStoryReplies,ourUuid}),preview:getLastConversationPreview({conversationId,includeStoryReplies}),hasUserInitiatedMessages:hasUserInitiatedMessages(conversationId)}}))()},getLastConversationMessage:async function getLastConversationMessage(_ref40){var conversationId=_ref40.conversationId,row=getInstance().prepare("\n      SELECT json FROM messages WHERE\n        conversationId = $conversationId\n      ORDER BY received_at DESC, sent_at DESC\n      LIMIT 1;\n      ").get({conversationId});if(!row)return;return jsonToObject(row.json)},getCallHistoryMessageByCallId:async function getCallHistoryMessageByCallId(conversationId,callId){return getInstance().prepare("\n      SELECT id\n      FROM messages\n      WHERE conversationId = $conversationId\n        AND type = 'call-history'\n        AND callMode = 'Direct'\n        AND callId = $callId\n    ").pluck().get({conversationId,callId})},hasGroupCallHistoryMessage:async function hasGroupCallHistoryMessage(conversationId,eraId){return 0!==getInstance().prepare("\n      SELECT EXISTS(\n        SELECT 1 FROM messages\n        WHERE conversationId = $conversationId\n        AND type = 'call-history'\n        AND json_extract(json, '$.callHistoryDetails.callMode') = 'Group'\n        AND json_extract(json, '$.callHistoryDetails.eraId') = $eraId\n      );\n      ").pluck().get({conversationId,eraId})},migrateConversationMessages:async function migrateConversationMessages(obsoleteId,currentId){getInstance().prepare("\n    UPDATE messages SET\n      conversationId = $currentId,\n      json = json_set(json, '$.conversationId', $currentId)\n    WHERE conversationId = $obsoleteId;\n    ").run({obsoleteId,currentId})},getMessagesBetween:async function getMessagesBetween(conversationId,options){var db=getInstance(),after=options.after,before=options.before,includeStoryReplies=options.includeStoryReplies,_ref33=Server_slicedToArray(sql`
    SELECT id
    FROM messages
    WHERE
      conversationId = ${conversationId} AND
      (${_storyIdPredicate(undefined,includeStoryReplies)}) AND
      isStory IS 0 AND
      (
        received_at > ${after.received_at}
        OR (received_at = ${after.received_at} AND sent_at > ${after.sent_at})
      ) AND (
        received_at < ${before.received_at}
        OR (received_at = ${before.received_at} AND sent_at < ${before.sent_at})
      )
    ORDER BY received_at ASC, sent_at ASC;
  `,2),query=_ref33[0],params=_ref33[1];return db.prepare(query).all(params).map((function(row){return row.id}))},getNearbyMessageFromDeletedSet:async function getNearbyMessageFromDeletedSet(_ref34){var conversationId=_ref34.conversationId,lastSelectedMessage=_ref34.lastSelectedMessage,deletedMessageIds=_ref34.deletedMessageIds,storyId=_ref34.storyId,includeStoryReplies=_ref34.includeStoryReplies,db=getInstance();function runQuery(after){var dir=after?sqlFragment`ASC`:sqlFragment`DESC`,compare=after?sqlFragment`>`:sqlFragment`<`,received_at=lastSelectedMessage.received_at,sent_at=lastSelectedMessage.sent_at,_ref35=sql`
      SELECT id FROM messages WHERE
        conversationId = ${conversationId} AND
        (${_storyIdPredicate(storyId,includeStoryReplies)}) AND
        isStory IS 0 AND
        id NOT IN (${function sqlJoin(items,separator){var query="",params=[];return items.forEach((function(item,index){var _ref2=util_slicedToArray(sqlFragment`${item}`,2),fragment=_ref2[0].fragment,fragmentParams=_ref2[1];query+=fragment,params.push.apply(params,util_toConsumableArray(fragmentParams)),index<items.length-1&&(query+=separator)})),[{fragment:query},params]}(deletedMessageIds,", ")}) AND
        type IN ('incoming', 'outgoing')
        AND (
          (received_at = ${received_at} AND sent_at ${compare} ${sent_at}) OR
          received_at ${compare} ${received_at}
        )
      ORDER BY received_at ${dir}, sent_at ${dir}
      LIMIT 1
    `,_ref36=Server_slicedToArray(_ref35,2),query=_ref36[0],params=_ref36[1];return db.prepare(query).pluck().get(params)}var after=runQuery(!0);if(null!=after)return after;var before=runQuery(!1);if(null!=before)return before;return null},saveEditedMessage:async function saveEditedMessage(mainMessage,ourUuid,_ref69){var fromId=_ref69.fromId,messageId=_ref69.messageId,readStatus=_ref69.readStatus,sentAt=_ref69.sentAt,db=getInstance();db.transaction((function(){(0,assert.UU)(saveMessageSync(mainMessage,{ourUuid,alreadyInTransaction:!0}));var _ref71=Server_slicedToArray(sql`
      INSERT INTO edited_messages (
        fromId,
        messageId,
        sentAt,
        readStatus
      ) VALUES (
        ${fromId},
        ${messageId},
        ${sentAt},
        ${readStatus}
      );
    `,2),query=_ref71[0],params=_ref71[1];db.prepare(query).run(params)}))()},getUnprocessedCount:async function getUnprocessedCount(){return getCountFromTable(getInstance(),"unprocessed")},getUnprocessedByIdsAndIncrementAttempts:async function getUnprocessedByIdsAndIncrementAttempts(ids){logging_log.info("getUnprocessedByIdsAndIncrementAttempts",{totalIds:ids.length});var db=getInstance();return batchMultiVarQuery(db,ids,(function(batch){return db.prepare(`\n          UPDATE unprocessed\n          SET attempts = attempts + 1\n          WHERE id IN (${batch.map((function(){return"?"})).join(", ")})\n        `).run(batch)})),batchMultiVarQuery(db,ids,(function(batch){return db.prepare(`\n          SELECT *\n          FROM unprocessed\n          WHERE id IN (${batch.map((function(){return"?"})).join(", ")})\n          ORDER BY receivedAtCounter ASC;\n        `).all(batch).map((function(row){return Object.assign({},row,{urgent:!isNumber_default()(row.urgent)||Boolean(row.urgent),story:Boolean(row.story)})}))}))},getAllUnprocessedIds:async function getAllUnprocessedIds(){logging_log.info("getAllUnprocessedIds");var db=getInstance();return db.transaction((function(){var deletedStaleCount=db.prepare("DELETE FROM unprocessed WHERE timestamp < $monthAgo").run({monthAgo:Date.now()-durations.vc}).changes;0!==deletedStaleCount&&logger.warn(`getAllUnprocessedAndIncrementAttempts: deleting ${deletedStaleCount} old unprocessed envelopes`);var deletedInvalidCount=db.prepare("\n          DELETE FROM unprocessed\n          WHERE attempts >= $MAX_UNPROCESSED_ATTEMPTS\n        ").run({MAX_UNPROCESSED_ATTEMPTS:3}).changes;return 0!==deletedInvalidCount&&logger.warn(`getAllUnprocessedAndIncrementAttempts: deleting ${deletedInvalidCount} invalid unprocessed envelopes`),db.prepare("\n          SELECT id\n          FROM unprocessed\n          ORDER BY receivedAtCounter ASC\n        ").pluck().all()}))()},updateUnprocessedWithData:async function updateUnprocessedWithData(id,data){return updateUnprocessedWithDataSync(id,data)},updateUnprocessedsWithData:async function updateUnprocessedsWithData(arrayOfUnprocessed){getInstance().transaction((function(){var _step13,_iterator13=Server_createForOfIteratorHelper(arrayOfUnprocessed);try{for(_iterator13.s();!(_step13=_iterator13.n()).done;){var _ref52=_step13.value,id=_ref52.id,data=_ref52.data;(0,assert.UU)(updateUnprocessedWithDataSync(id,data))}}catch(err){_iterator13.e(err)}finally{_iterator13.f()}}))()},getUnprocessedById:async function getUnprocessedById(id){var row=getInstance().prepare("SELECT * FROM unprocessed WHERE id = $id;").get({id});return Object.assign({},row,{urgent:!isNumber_default()(row.urgent)||Boolean(row.urgent),story:Boolean(row.story)})},removeUnprocessed:async function removeUnprocessed(id){!function removeUnprocessedSync(id){logging_log.info("removeUnprocessedSync",{id});var db=getInstance();if(!Array.isArray(id))return void prepare(db,"DELETE FROM unprocessed WHERE id = $id;").run({id});if(!id.length)return;(0,assert.UU)(batchMultiVarQuery(db,id,removeUnprocessedsSync))}(id)},removeAllUnprocessed:async function removeAllUnprocessed(){getInstance().prepare("DELETE FROM unprocessed;").run()},getAttachmentDownloadJobById:async function getAttachmentDownloadJobById(id){return getById(getInstance(),"attachment_downloads",id)},getNextAttachmentDownloadJobs:async function getNextAttachmentDownloadJobs(limit){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},db=getInstance(),timestamp=options&&options.timestamp?options.timestamp:Date.now(),rows=db.prepare("\n      SELECT id, json\n      FROM attachment_downloads\n      WHERE pending = 0 AND timestamp <= $timestamp\n      ORDER BY timestamp DESC\n      LIMIT $limit;\n      ").all({limit:limit||3,timestamp}),INNER_ERROR="jsonToObject error";try{return rows.map((function(row){try{return jsonToObject(row.json)}catch(error){throw logger.error(`getNextAttachmentDownloadJobs: Error with job '${row.id}', deleting. JSON: '${row.json}' Error: ${errors.G(error)}`),removeAttachmentDownloadJobSync(row.id),new Error(INNER_ERROR)}}))}catch(error){if("message"in error&&error.message===INNER_ERROR)return getNextAttachmentDownloadJobs(limit,{timestamp});throw error}},saveAttachmentDownloadJob:async function saveAttachmentDownloadJob(job){var db=getInstance(),id=job.id,pending=job.pending,timestamp=job.timestamp;if(!id)throw new Error("saveAttachmentDownloadJob: Provided job did not have a truthy id");db.prepare("\n    INSERT OR REPLACE INTO attachment_downloads (\n      id,\n      pending,\n      timestamp,\n      json\n    ) values (\n      $id,\n      $pending,\n      $timestamp,\n      $json\n    )\n    ").run({id,pending,timestamp,json:objectToJSON(job)})},resetAttachmentDownloadPending:async function resetAttachmentDownloadPending(){getInstance().prepare("\n    UPDATE attachment_downloads\n    SET pending = 0\n    WHERE pending != 0;\n    ").run()},setAttachmentDownloadJobPending:async function setAttachmentDownloadJobPending(id,pending){getInstance().prepare("\n    UPDATE attachment_downloads\n    SET pending = $pending\n    WHERE id = $id;\n    ").run({id,pending:pending?1:0})},removeAttachmentDownloadJob:async function removeAttachmentDownloadJob(id){return removeAttachmentDownloadJobSync(id)},removeAllAttachmentDownloadJobs:async function removeAllAttachmentDownloadJobs(){return removeAllFromTable(getInstance(),"attachment_downloads")},createOrUpdateStickerPack:async function createOrUpdateStickerPack(pack){var _position,db=getInstance(),attemptedStatus=pack.attemptedStatus,author=pack.author,coverStickerId=pack.coverStickerId,createdAt=pack.createdAt,downloadAttempts=pack.downloadAttempts,id=pack.id,installedAt=pack.installedAt,key=pack.key,lastUsed=pack.lastUsed,status=pack.status,stickerCount=pack.stickerCount,title=pack.title,storageID=pack.storageID,storageVersion=pack.storageVersion,storageUnknownFields=pack.storageUnknownFields,storageNeedsSync=pack.storageNeedsSync;if(!id)throw new Error("createOrUpdateStickerPack: Provided data did not have a truthy id");var position=pack.position;isNumber_default()(position)||(position=db.prepare("\n        SELECT IFNULL(MAX(position) + 1, 0)\n        FROM sticker_packs\n        ").pluck().get());var row=db.prepare("\n      SELECT id\n      FROM sticker_packs\n      WHERE id = $id;\n      ").get({id}),payload={attemptedStatus:null!=attemptedStatus?attemptedStatus:null,author,coverStickerId,createdAt:createdAt||Date.now(),downloadAttempts:downloadAttempts||1,id,installedAt:null!=installedAt?installedAt:null,key,lastUsed:lastUsed||null,status,stickerCount,title,position:null!==(_position=position)&&void 0!==_position?_position:0,storageID:null!=storageID?storageID:null,storageVersion:null!=storageVersion?storageVersion:null,storageUnknownFields:null!=storageUnknownFields?storageUnknownFields:null,storageNeedsSync:storageNeedsSync?1:0};if(row)return void db.prepare("\n      UPDATE sticker_packs SET\n        attemptedStatus = $attemptedStatus,\n        author = $author,\n        coverStickerId = $coverStickerId,\n        createdAt = $createdAt,\n        downloadAttempts = $downloadAttempts,\n        installedAt = $installedAt,\n        key = $key,\n        lastUsed = $lastUsed,\n        status = $status,\n        stickerCount = $stickerCount,\n        title = $title,\n        position = $position,\n        storageID = $storageID,\n        storageVersion = $storageVersion,\n        storageUnknownFields = $storageUnknownFields,\n        storageNeedsSync = $storageNeedsSync\n      WHERE id = $id;\n      ").run(payload);db.prepare("\n    INSERT INTO sticker_packs (\n      attemptedStatus,\n      author,\n      coverStickerId,\n      createdAt,\n      downloadAttempts,\n      id,\n      installedAt,\n      key,\n      lastUsed,\n      status,\n      stickerCount,\n      title,\n      position,\n      storageID,\n      storageVersion,\n      storageUnknownFields,\n      storageNeedsSync\n    ) values (\n      $attemptedStatus,\n      $author,\n      $coverStickerId,\n      $createdAt,\n      $downloadAttempts,\n      $id,\n      $installedAt,\n      $key,\n      $lastUsed,\n      $status,\n      $stickerCount,\n      $title,\n      $position,\n      $storageID,\n      $storageVersion,\n      $storageUnknownFields,\n      $storageNeedsSync\n    )\n    ").run(payload)},updateStickerPackStatus:async function updateStickerPackStatus(id,status,options){return updateStickerPackStatusSync(id,status,options)},updateStickerPackInfo:async function updateStickerPackInfo(_ref53){var id=_ref53.id,storageID=_ref53.storageID,storageVersion=_ref53.storageVersion,storageUnknownFields=_ref53.storageUnknownFields,storageNeedsSync=_ref53.storageNeedsSync,uninstalledAt=_ref53.uninstalledAt,db=getInstance();uninstalledAt?db.prepare("\n      UPDATE uninstalled_sticker_packs\n      SET\n        storageID = $storageID,\n        storageVersion = $storageVersion,\n        storageUnknownFields = $storageUnknownFields,\n        storageNeedsSync = $storageNeedsSync\n      WHERE id = $id;\n      ").run({id,storageID:null!=storageID?storageID:null,storageVersion:null!=storageVersion?storageVersion:null,storageUnknownFields:null!=storageUnknownFields?storageUnknownFields:null,storageNeedsSync:storageNeedsSync?1:0}):db.prepare("\n      UPDATE sticker_packs\n      SET\n        storageID = $storageID,\n        storageVersion = $storageVersion,\n        storageUnknownFields = $storageUnknownFields,\n        storageNeedsSync = $storageNeedsSync\n      WHERE id = $id;\n      ").run({id,storageID:null!=storageID?storageID:null,storageVersion:null!=storageVersion?storageVersion:null,storageUnknownFields:null!=storageUnknownFields?storageUnknownFields:null,storageNeedsSync:storageNeedsSync?1:0})},createOrUpdateSticker:async function createOrUpdateSticker(sticker){var db=getInstance(),emoji=sticker.emoji,height=sticker.height,id=sticker.id,isCoverOnly=sticker.isCoverOnly,lastUsed=sticker.lastUsed,packId=sticker.packId,path=sticker.path,width=sticker.width;if(!isNumber_default()(id))throw new Error("createOrUpdateSticker: Provided data did not have a numeric id");if(!packId)throw new Error("createOrUpdateSticker: Provided data did not have a truthy id");db.prepare("\n    INSERT OR REPLACE INTO stickers (\n      emoji,\n      height,\n      id,\n      isCoverOnly,\n      lastUsed,\n      packId,\n      path,\n      width\n    ) values (\n      $emoji,\n      $height,\n      $id,\n      $isCoverOnly,\n      $lastUsed,\n      $packId,\n      $path,\n      $width\n    )\n    ").run({emoji:null!=emoji?emoji:null,height,id,isCoverOnly:isCoverOnly?1:0,lastUsed:lastUsed||null,packId,path,width})},updateStickerLastUsed:async function updateStickerLastUsed(packId,stickerId,lastUsed){var db=getInstance();db.prepare("\n    UPDATE stickers\n    SET lastUsed = $lastUsed\n    WHERE id = $id AND packId = $packId;\n    ").run({id:stickerId,packId,lastUsed}),db.prepare("\n    UPDATE sticker_packs\n    SET lastUsed = $lastUsed\n    WHERE id = $id;\n    ").run({id:packId,lastUsed})},addStickerPackReference:async function addStickerPackReference(messageId,packId){var db=getInstance();if(!messageId)throw new Error("addStickerPackReference: Provided data did not have a truthy messageId");if(!packId)throw new Error("addStickerPackReference: Provided data did not have a truthy packId");db.prepare("\n    INSERT OR REPLACE INTO sticker_references (\n      messageId,\n      packId\n    ) values (\n      $messageId,\n      $packId\n    )\n    ").run({messageId,packId})},deleteStickerPackReference:async function deleteStickerPackReference(messageId,packId){var db=getInstance();if(!messageId)throw new Error("addStickerPackReference: Provided data did not have a truthy messageId");if(!packId)throw new Error("addStickerPackReference: Provided data did not have a truthy packId");return db.transaction((function(){if(db.prepare("\n        DELETE FROM sticker_references\n        WHERE messageId = $messageId AND packId = $packId;\n        ").run({messageId,packId}),!(db.prepare("\n          SELECT count(1) FROM sticker_references\n          WHERE packId = $packId;\n          ").pluck().get({packId})>0)){var packRow=db.prepare("\n          SELECT status FROM sticker_packs\n          WHERE id = $packId;\n          ").get({packId});if(packRow){if("installed"!==packRow.status){var stickerPathRows=db.prepare("\n          SELECT path FROM stickers\n          WHERE packId = $packId;\n          ").all({packId});return db.prepare("\n        DELETE FROM sticker_packs\n        WHERE id = $packId;\n        ").run({packId}),(stickerPathRows||[]).map((function(row){return row.path}))}}else logger.warn("deleteStickerPackReference: did not find referenced pack")}})).immediate()},getStickerCount,deleteStickerPack:async function deleteStickerPack(packId){var db=getInstance();if(!packId)throw new Error("deleteStickerPack: Provided data did not have a truthy packId");return db.transaction((function(){var stickerPathRows=db.prepare("\n          SELECT path FROM stickers\n          WHERE packId = $packId;\n          ").all({packId});return db.prepare("\n        DELETE FROM sticker_packs\n        WHERE id = $packId;\n        ").run({packId}),(stickerPathRows||[]).map((function(row){return row.path}))})).immediate()},getAllStickerPacks:async function getAllStickerPacks(){return getInstance().prepare("\n      SELECT * FROM sticker_packs\n      ORDER BY position ASC, id ASC\n      ").all()||[]},addUninstalledStickerPack:async function addUninstalledStickerPack(pack){return addUninstalledStickerPackSync(pack)},removeUninstalledStickerPack:async function removeUninstalledStickerPack(packId){return removeUninstalledStickerPackSync(packId)},getInstalledStickerPacks:async function getInstalledStickerPacks(){return getInstance().prepare("\n      SELECT *\n      FROM sticker_packs\n      WHERE\n        status IS 'installed' OR\n        storageID IS NOT NULL\n      ORDER BY id ASC\n      ").all()||[]},getUninstalledStickerPacks:async function getUninstalledStickerPacks(){return getInstance().prepare("SELECT * FROM uninstalled_sticker_packs ORDER BY id ASC").all()||[]},installStickerPack:async function installStickerPack(packId,timestamp){return getInstance().transaction((function(){updateStickerPackStatusSync(packId,"installed",{timestamp}),removeUninstalledStickerPackSync(packId)}))()},uninstallStickerPack:async function uninstallStickerPack(packId,timestamp){var db=getInstance();return db.transaction((function(){updateStickerPackStatusSync(packId,"downloaded"),db.prepare("\n      UPDATE sticker_packs SET\n        storageID = NULL,\n        storageVersion = NULL,\n        storageUnknownFields = NULL,\n        storageNeedsSync = 0\n      WHERE id = $packId;\n      ").run({packId}),addUninstalledStickerPackSync({id:packId,uninstalledAt:timestamp,storageNeedsSync:!0})}))()},getStickerPackInfo:async function getStickerPackInfo(packId){var db=getInstance();return db.transaction((function(){var uninstalled=db.prepare("\n        SELECT * FROM uninstalled_sticker_packs\n        WHERE id IS $packId\n        ").get({packId});if(uninstalled)return uninstalled;var installed=db.prepare("\n        SELECT\n          id, key, position, storageID, storageVersion, storageUnknownFields\n        FROM sticker_packs\n        WHERE id IS $packId\n        ").get({packId});return installed||void 0}))()},getAllStickers:async function getAllStickers(){return(getInstance().prepare("\n      SELECT * FROM stickers\n      ORDER BY packId ASC, id ASC\n      ").all()||[]).map((function(row){return rowToSticker(row)}))},getRecentStickers:async function getRecentStickers(){var _ref54=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},limit=_ref54.limit,db=getInstance(),rows=db.prepare("\n      SELECT stickers.* FROM stickers\n      JOIN sticker_packs on stickers.packId = sticker_packs.id\n      WHERE stickers.lastUsed > 0 AND sticker_packs.status = 'installed'\n      ORDER BY stickers.lastUsed DESC\n      LIMIT $limit\n      ").all({limit:limit||24});return(rows||[]).map((function(row){return rowToSticker(row)}))},clearAllErrorStickerPackAttempts:async function clearAllErrorStickerPackAttempts(){getInstance().prepare("\n    UPDATE sticker_packs\n    SET downloadAttempts = 0\n    WHERE status = 'error';\n    ").run()},updateEmojiUsage:async function updateEmojiUsage(shortName){var timeUsed=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now(),db=getInstance();db.transaction((function(){db.prepare("\n        SELECT * FROM emojis\n        WHERE shortName = $shortName;\n        ").get({shortName})?db.prepare("\n        UPDATE emojis\n        SET lastUsage = $timeUsed\n        WHERE shortName = $shortName;\n        ").run({shortName,timeUsed}):db.prepare("\n        INSERT INTO emojis(shortName, lastUsage)\n        VALUES ($shortName, $timeUsed);\n        ").run({shortName,timeUsed})}))()},getRecentEmojis:async function getRecentEmojis(){var limit=arguments.length>0&&void 0!==arguments[0]?arguments[0]:32,db=getInstance(),rows=db.prepare("\n      SELECT *\n      FROM emojis\n      ORDER BY lastUsage DESC\n      LIMIT $limit;\n      ").all({limit});return rows||[]},getAllBadges:async function getAllBadges(){var _step14,db=getInstance(),_db$transaction2=Server_slicedToArray(db.transaction((function(){return[db.prepare("SELECT * FROM badges").all(),db.prepare("SELECT * FROM badgeImageFiles").all()]}))(),2),badgeRows=_db$transaction2[0],badgeImageFileRows=_db$transaction2[1],badgeImagesByBadge=new Map,_iterator14=Server_createForOfIteratorHelper(badgeImageFileRows);try{for(_iterator14.s();!(_step14=_iterator14.n()).done;){var badgeImageFileRow=_step14.value,badgeId=badgeImageFileRow.badgeId,order=badgeImageFileRow.order,localPath=badgeImageFileRow.localPath,url=badgeImageFileRow.url,theme=badgeImageFileRow.theme,badgeImages=badgeImagesByBadge.get(badgeId)||[];badgeImages[order]=Object.assign({},badgeImages[order]||{},{[(0,BadgeImageTheme.t)(theme)]:{localPath:dropNull_dropNull(localPath),url}}),badgeImagesByBadge.set(badgeId,badgeImages)}}catch(err){_iterator14.e(err)}finally{_iterator14.f()}return badgeRows.map((function(badgeRow){return{id:badgeRow.id,category:(0,BadgeCategory.L)(badgeRow.category),name:badgeRow.name,descriptionTemplate:badgeRow.descriptionTemplate,images:(badgeImagesByBadge.get(badgeRow.id)||[]).filter(util_isNotNil.D)}}))},updateOrCreateBadges:async function updateOrCreateBadges(badges){var db=getInstance(),insertBadge=prepare(db,"\n    INSERT OR REPLACE INTO badges (\n      id,\n      category,\n      name,\n      descriptionTemplate\n    ) VALUES (\n      $id,\n      $category,\n      $name,\n      $descriptionTemplate\n    );\n    "),getImageFilesForBadge=prepare(db,"SELECT url, localPath FROM badgeImageFiles WHERE badgeId = $badgeId"),insertBadgeImageFile=prepare(db,"\n    INSERT INTO badgeImageFiles (\n      badgeId,\n      'order',\n      url,\n      localPath,\n      theme\n    ) VALUES (\n      $badgeId,\n      $order,\n      $url,\n      $localPath,\n      $theme\n    );\n    ");db.transaction((function(){badges.forEach((function(badge){var _step15,badgeId=badge.id,oldLocalPaths=new Map,_iterator15=Server_createForOfIteratorHelper(getImageFilesForBadge.all({badgeId}));try{for(_iterator15.s();!(_step15=_iterator15.n()).done;){var _ref55=_step15.value,url=_ref55.url,localPath=_ref55.localPath;localPath&&oldLocalPaths.set(url,localPath)}}catch(err){_iterator15.e(err)}finally{_iterator15.f()}insertBadge.run({id:badgeId,category:badge.category,name:badge.name,descriptionTemplate:badge.descriptionTemplate});var _step16,_iterator16=Server_createForOfIteratorHelper(badge.images.entries());try{for(_iterator16.s();!(_step16=_iterator16.n()).done;)for(var _ref57=Server_slicedToArray(_step16.value,2),order=_ref57[0],image=_ref57[1],_i3=0,_Object$entries=Object.entries(image);_i3<_Object$entries.length;_i3++){var _ref59=Server_slicedToArray(_Object$entries[_i3],2),theme=_ref59[0],imageFile=_ref59[1];insertBadgeImageFile.run({badgeId,localPath:imageFile.localPath||oldLocalPaths.get(imageFile.url)||null,order,theme,url:imageFile.url})}}catch(err){_iterator16.e(err)}finally{_iterator16.f()}}))}))()},badgeImageFileDownloaded:async function badgeImageFileDownloaded(url,localPath){prepare(getInstance(),"UPDATE badgeImageFiles SET localPath = $localPath WHERE url = $url").run({url,localPath})},_getAllStoryDistributions,_getAllStoryDistributionMembers,_deleteAllStoryDistributions:async function _deleteAllStoryDistributions(){getInstance().prepare("DELETE FROM storyDistributions;").run()},createNewStoryDistribution:async function createNewStoryDistribution(distribution){(0,assert.Yj)(distribution.name,"Distribution list does not have a valid name");var db=getInstance();db.transaction((function(){var payload=freezeStoryDistribution(distribution);prepare(db,"\n      INSERT INTO storyDistributions(\n        id,\n        name,\n        deletedAtTimestamp,\n        allowsReplies,\n        isBlockList,\n        senderKeyInfoJson,\n        storageID,\n        storageVersion,\n        storageUnknownFields,\n        storageNeedsSync\n      ) VALUES (\n        $id,\n        $name,\n        $deletedAtTimestamp,\n        $allowsReplies,\n        $isBlockList,\n        $senderKeyInfoJson,\n        $storageID,\n        $storageVersion,\n        $storageUnknownFields,\n        $storageNeedsSync\n      );\n      ").run(payload);var _step17,listId=distribution.id,members=distribution.members,memberInsertStatement=prepare(db,"\n      INSERT OR REPLACE INTO storyDistributionMembers (\n        listId,\n        uuid\n      ) VALUES (\n        $listId,\n        $uuid\n      );\n      "),_iterator17=Server_createForOfIteratorHelper(members);try{for(_iterator17.s();!(_step17=_iterator17.n()).done;){var uuid=_step17.value;memberInsertStatement.run({listId,uuid})}}catch(err){_iterator17.e(err)}finally{_iterator17.f()}}))()},getAllStoryDistributionsWithMembers:async function getAllStoryDistributionsWithMembers(){var allDistributions=await _getAllStoryDistributions(),allMembers=await _getAllStoryDistributionMembers(),byListId=groupBy_default()(allMembers,(function(member){return member.listId}));return allDistributions.map((function(list){return Object.assign({},list,{members:(byListId[list.id]||[]).map((function(member){return member.uuid}))})}))},getStoryDistributionWithMembers:async function getStoryDistributionWithMembers(id){var db=getInstance(),storyDistribution=prepare(db,"SELECT * FROM storyDistributions WHERE id = $id;").get({id});if(!storyDistribution)return;var members=prepare(db,"SELECT * FROM storyDistributionMembers WHERE listId = $id;").all({id});return Object.assign({},hydrateStoryDistribution(storyDistribution),{members:members.map((function(_ref60){return _ref60.uuid}))})},modifyStoryDistribution:async function modifyStoryDistribution(distribution){var payload=freezeStoryDistribution(distribution);modifyStoryDistributionSync(getInstance(),payload)},modifyStoryDistributionMembers:async function modifyStoryDistributionMembers(listId,_ref63){var toAdd=_ref63.toAdd,toRemove=_ref63.toRemove,db=getInstance();db.transaction((function(){modifyStoryDistributionMembersSync(db,listId,{toAdd,toRemove})}))()},modifyStoryDistributionWithMembers:async function modifyStoryDistributionWithMembers(distribution,_ref62){var toAdd=_ref62.toAdd,toRemove=_ref62.toRemove,payload=freezeStoryDistribution(distribution),db=getInstance();toAdd.length||toRemove.length?db.transaction((function(){modifyStoryDistributionSync(db,payload),modifyStoryDistributionMembersSync(db,payload.id,{toAdd,toRemove})}))():modifyStoryDistributionSync(db,payload)},deleteStoryDistribution:async function deleteStoryDistribution(id){getInstance().prepare("DELETE FROM storyDistributions WHERE id = $id;").run({id})},_getAllStoryReads:async function _getAllStoryReads(){return getInstance().prepare("SELECT * FROM storyReads;").all()},_deleteAllStoryReads:async function _deleteAllStoryReads(){getInstance().prepare("DELETE FROM storyReads;").run()},addNewStoryRead:async function addNewStoryRead(read){prepare(getInstance(),"\n    INSERT OR REPLACE INTO storyReads(\n      authorId,\n      conversationId,\n      storyId,\n      storyReadDate\n    ) VALUES (\n      $authorId,\n      $conversationId,\n      $storyId,\n      $storyReadDate\n    );\n    ").run(read)},getLastStoryReadsForAuthor:async function getLastStoryReadsForAuthor(_ref64){var authorId=_ref64.authorId,conversationId=_ref64.conversationId,limit=_ref64.limit||5;return getInstance().prepare("\n      SELECT * FROM storyReads\n      WHERE\n        authorId = $authorId AND\n        ($conversationId IS NULL OR conversationId = $conversationId)\n      ORDER BY storyReadDate DESC\n      LIMIT $limit;\n      ").all({authorId,conversationId:conversationId||null,limit})},countStoryReadsByConversation:async function countStoryReadsByConversation(conversationId){return getInstance().prepare("\n      SELECT count(1) FROM storyReads\n      WHERE conversationId = $conversationId;\n      ").pluck().get({conversationId})},removeAll:async function removeAll(){var db=getInstance();db.transaction((function(){db.exec("\n      DELETE FROM attachment_downloads;\n      DELETE FROM badgeImageFiles;\n      DELETE FROM badges;\n      DELETE FROM conversations;\n      DELETE FROM emojis;\n      DELETE FROM groupCallRingCancellations;\n      DELETE FROM identityKeys;\n      DELETE FROM items;\n      DELETE FROM jobs;\n      DELETE FROM messages_fts;\n      DELETE FROM messages;\n      DELETE FROM preKeys;\n      DELETE FROM reactions;\n      DELETE FROM senderKeys;\n      DELETE FROM sendLogMessageIds;\n      DELETE FROM sendLogPayloads;\n      DELETE FROM sendLogRecipients;\n      DELETE FROM sessions;\n      DELETE FROM signedPreKeys;\n      DELETE FROM sticker_packs;\n      DELETE FROM sticker_references;\n      DELETE FROM stickers;\n      DELETE FROM storyDistributionMembers;\n      DELETE FROM storyDistributions;\n      DELETE FROM storyReads;\n      DELETE FROM unprocessed;\n      DELETE FROM uninstalled_sticker_packs;\n\n      INSERT INTO messages_fts(messages_fts) VALUES('optimize');\n    ")}))()},removeAllConfiguration:async function removeAllConfiguration(){var mode=arguments.length>0&&void 0!==arguments[0]?arguments[0]:RemoveAllConfiguration.Full,db=getInstance();db.transaction((function(){if(db.exec("\n      DELETE FROM identityKeys;\n      DELETE FROM jobs;\n      DELETE FROM preKeys;\n      DELETE FROM senderKeys;\n      DELETE FROM sendLogMessageIds;\n      DELETE FROM sendLogPayloads;\n      DELETE FROM sendLogRecipients;\n      DELETE FROM sessions;\n      DELETE FROM signedPreKeys;\n      DELETE FROM unprocessed;\n      "),mode===RemoveAllConfiguration.Full)db.exec("\n        DELETE FROM items;\n        ");else{if(mode!==RemoveAllConfiguration.Soft)throw(0,missingCaseError.b)(mode);var _step19,itemIds=db.prepare("SELECT id FROM items").pluck(!0).all(),allowedSet=new Set(STORAGE_UI_KEYS),_iterator19=Server_createForOfIteratorHelper(itemIds);try{for(_iterator19.s();!(_step19=_iterator19.n()).done;){var id=_step19.value;allowedSet.has(id)||removeById(db,"items",id)}}catch(err){_iterator19.e(err)}finally{_iterator19.f()}}db.exec("UPDATE conversations SET json = json_remove(json, '$.senderKeyInfo');")}))()},getMessagesNeedingUpgrade:async function getMessagesNeedingUpgrade(limit,_ref65){var maxVersion=_ref65.maxVersion;return getInstance().prepare("\n      SELECT json\n      FROM messages\n      WHERE\n        (schemaVersion IS NULL OR schemaVersion < $maxVersion) AND\n        IFNULL(\n          json_extract(json, '$.schemaMigrationAttempts'),\n          0\n        ) < $maxAttempts\n      LIMIT $limit;\n      ").all({maxVersion,maxAttempts:5,limit}).map((function(row){return jsonToObject(row.json)}))},getMessagesWithVisualMediaAttachments:async function getMessagesWithVisualMediaAttachments(conversationId,_ref66){var limit=_ref66.limit;return getInstance().prepare("\n      SELECT json FROM messages\n      INDEXED BY messages_hasVisualMediaAttachments\n      WHERE\n        isStory IS 0 AND\n        storyId IS NULL AND\n        conversationId = $conversationId AND\n        -- Note that this check has to use 'IS' to utilize\n        -- 'messages_hasVisualMediaAttachments' INDEX\n        hasVisualMediaAttachments IS 1\n      ORDER BY received_at DESC, sent_at DESC\n      LIMIT $limit;\n      ").all({conversationId,limit}).map((function(row){return jsonToObject(row.json)}))},getMessagesWithFileAttachments:async function getMessagesWithFileAttachments(conversationId,_ref67){var limit=_ref67.limit,rows=getInstance().prepare("\n      SELECT json FROM messages WHERE\n        isStory IS 0 AND\n        storyId IS NULL AND\n        conversationId = $conversationId AND\n        hasFileAttachments = 1\n      ORDER BY received_at DESC, sent_at DESC\n      LIMIT $limit;\n      ").all({conversationId,limit});return map_default()(rows,(function(row){return jsonToObject(row.json)}))},getMessageServerGuidsForSpam:async function getMessageServerGuidsForSpam(conversationId){return getInstance().prepare("\n      SELECT serverGuid\n      FROM messages\n      WHERE conversationId = $conversationId\n      AND type = 'incoming'\n      AND serverGuid IS NOT NULL\n      ORDER BY received_at DESC, sent_at DESC\n      LIMIT 3;\n      ").pluck(!0).all({conversationId})},getJobsInQueue:async function getJobsInQueue(queueType){return getJobsInQueueSync(getInstance(),queueType)},insertJob:async function insertJob(job){return insertJobSync(getInstance(),job)},deleteJob:async function deleteJob(id){getInstance().prepare("DELETE FROM jobs WHERE id = $id").run({id})},wasGroupCallRingPreviouslyCanceled:async function wasGroupCallRingPreviouslyCanceled(ringId){return getInstance().prepare("\n      SELECT EXISTS (\n        SELECT 1 FROM groupCallRingCancellations\n        WHERE ringId = $ringId\n        AND createdAt >= $ringsOlderThanThisAreIgnored\n      );\n      ").pluck().get({ringId,ringsOlderThanThisAreIgnored:Date.now()-MAX_GROUP_CALL_RING_AGE})},processGroupCallRingCancellation:async function processGroupCallRingCancellation(ringId){getInstance().prepare("\n    INSERT INTO groupCallRingCancellations (ringId, createdAt)\n    VALUES ($ringId, $createdAt)\n    ON CONFLICT (ringId) DO NOTHING;\n    ").run({ringId,createdAt:Date.now()})},cleanExpiredGroupCallRingCancellations:async function cleanExpiredGroupCallRingCancellations(){getInstance().prepare("\n    DELETE FROM groupCallRingCancellations\n    WHERE createdAt < $expiredRingTime;\n    ").run({expiredRingTime:Date.now()-MAX_GROUP_CALL_RING_AGE})},getMaxMessageCounter:async function getMaxMessageCounter(){return getInstance().prepare("\n    SELECT MAX(counter)\n    FROM\n      (\n        SELECT MAX(received_at) AS counter FROM messages\n        UNION\n        SELECT MAX(timestamp) AS counter FROM unprocessed\n      )\n    ").pluck().get()},getStatisticsForLogging:async function getStatisticsForLogging(){var db=getInstance(),counts=await p_props_default()({messageCount:getMessageCount(),conversationCount:getConversationCount(),sessionCount:getCountFromTable(db,"sessions"),senderKeyCount:getCountFromTable(db,"senderKeys")});return mapValues_default()(counts,formatCountForLogging)},optimizeFTS:async function Server_optimizeFTS(state){var _state$steps,pageCount=64;void 0===state&&(pageCount=-pageCount);var db=getInstance(),getChanges=prepare(db,"SELECT total_changes() as changes;",{pluck:!0}),changeDifference=db.transaction((function(){var before=getChanges.get({});return prepare(db,"\n        INSERT INTO messages_fts(messages_fts, rank) VALUES ('merge', $pageCount);\n      ").run({pageCount}),getChanges.get({})-before}))(),nextSteps=(null!==(_state$steps=null==state?void 0:state.steps)&&void 0!==_state$steps?_state$steps:0)+1;return{steps:nextSteps,done:changeDifference<2}},initialize:async function initialize(_ref3){var configDir=_ref3.configDir,key=_ref3.key,suppliedLogger=_ref3.logger;if(globalInstance)throw new Error("Cannot initialize more than once!");if(!isString_default()(configDir))throw new Error("initialize: configDir is required!");if(!isString_default()(key))throw new Error("initialize: key is required!");logger=suppliedLogger,indexedDBPath=(0,path.join)(configDir,"IndexedDB");var db,dbDir=(0,path.join)(configDir,"sql");(0,external_fs_.mkdirSync)(dbDir,{recursive:!0}),databaseFilePath=(0,path.join)(dbDir,"db.sqlite");try{(function updateSchema(db,logger){var sqliteVersion=function getSQLiteVersion(db){return db.prepare("select sqlite_version() AS sqlite_version").get().sqlite_version}(db),sqlcipherVersion=function getSQLCipherVersion(db){return db.pragma("cipher_version",{simple:!0})}(db),userVersion=getUserVersion(db),maxUserVersion=SCHEMA_VERSIONS.length,schemaVersion=getSchemaVersion(db);if(logger.info("updateSchema:\n",` Current user_version: ${userVersion};\n`,` Most recent db schema: ${maxUserVersion};\n`,` SQLite version: ${sqliteVersion};\n`,` SQLCipher version: ${sqlcipherVersion};\n`,` (deprecated) schema_version: ${schemaVersion};\n`),userVersion>maxUserVersion)throw new Error(`SQL: User version is ${userVersion} but the expected maximum version is ${maxUserVersion}. Did you try to start an old version of Signal?`);for(var index=0;index<maxUserVersion;index+=1)(0,SCHEMA_VERSIONS[index])(userVersion,db,logger);if(userVersion!==maxUserVersion){var start=Date.now();db.pragma("optimize");var duration=Date.now()-start;logger.info(`updateSchema: optimize took ${duration}ms`)}})(db=openAndSetUpSQLCipher(databaseFilePath,{key}),logger),globalInstance=db,getMessageCountSync()}catch(error){throw logger.error("Database startup error:",error.stack),db&&db.close(),error}},initializeRenderer:async function initializeRenderer(_ref4){var configDir=_ref4.configDir,key=_ref4.key;if(!isRenderer())throw new Error("Cannot call from main process.");if(globalInstanceRenderer)throw new Error("Cannot initialize more than once!");if(!isString_default()(configDir))throw new Error("initialize: configDir is required!");if(!isString_default()(key))throw new Error("initialize: key is required!");indexedDBPath||(indexedDBPath=(0,path.join)(configDir,"IndexedDB"));var promisified,dbDir=(0,path.join)(configDir,"sql");databaseFilePath||(databaseFilePath=(0,path.join)(dbDir,"db.sqlite"));try{promisified=openAndSetUpSQLCipher(databaseFilePath,{key}),globalInstanceRenderer=promisified,getMessageCountSync()}catch(error){throw logging_log.error("Database startup error:",error.stack),error}},getKnownMessageAttachments:async function getKnownMessageAttachments(cursor){var db=getInstance(),result=new Set;return db.transaction((function(){var _cursor$count,runId,count=null!==(_cursor$count=null==cursor?void 0:cursor.count)&&void 0!==_cursor$count?_cursor$count:0;if((0,assert.Yj)(!(null!=cursor&&cursor.done),"getKnownMessageAttachments: iteration cannot be restarted"),void 0===cursor){runId=(0,crypto_ignored_.randomBytes)(8).toString("hex");var total=getMessageCountSync();logger.info(`getKnownMessageAttachments(${runId}): Starting iteration through ${total} messages`),db.exec(`\n        CREATE TEMP TABLE tmp_${runId}_updated_messages\n          (rowid INTEGER PRIMARY KEY ASC);\n\n        INSERT INTO tmp_${runId}_updated_messages (rowid)\n        SELECT rowid FROM messages;\n\n        CREATE TEMP TRIGGER tmp_${runId}_message_updates\n        UPDATE OF json ON messages\n        BEGIN\n          INSERT OR IGNORE INTO tmp_${runId}_updated_messages (rowid)\n          VALUES (NEW.rowid);\n        END;\n\n        CREATE TEMP TRIGGER tmp_${runId}_message_inserts\n        AFTER INSERT ON messages\n        BEGIN\n          INSERT OR IGNORE INTO tmp_${runId}_updated_messages (rowid)\n          VALUES (NEW.rowid);\n        END;\n        `)}else runId=cursor.runId;var _step20,rowids=db.prepare(`\n      DELETE FROM tmp_${runId}_updated_messages\n      RETURNING rowid\n      LIMIT $chunkSize;\n      `).pluck().all({chunkSize:1e3}),_iterator20=Server_createForOfIteratorHelper(batchMultiVarQuery(db,rowids,(function(batch){return db.prepare(`SELECT json FROM messages WHERE rowid IN (${Array(batch.length).fill("?").join(",")});`).all(batch).map((function(row){return jsonToObject(row.json)}))})));try{for(_iterator20.s();!(_step20=_iterator20.n()).done;){var externalFiles=getExternalFilesForMessage(_step20.value);forEach_default()(externalFiles,(function(file){return result.add(file)})),count+=1}}catch(err){_iterator20.e(err)}finally{_iterator20.f()}var done=rowids.length<1e3;return{attachments:Array.from(result),cursor:{runId,count,done}}}))()},finishGetKnownMessageAttachments:async function finishGetKnownMessageAttachments(_ref68){var runId=_ref68.runId,count=_ref68.count,done=_ref68.done,db=getInstance(),logId=`finishGetKnownMessageAttachments(${runId})`;done||logger.warn(`${logId}: iteration not finished`);logger.info(`${logId}: reached the end after processing ${count} messages`),db.exec(`\n    DROP TABLE tmp_${runId}_updated_messages;\n    DROP TRIGGER tmp_${runId}_message_updates;\n    DROP TRIGGER tmp_${runId}_message_inserts;\n  `)},getKnownConversationAttachments:async function getKnownConversationAttachments(){var db=getInstance(),result=new Set,complete=!1,id="",conversationTotal=await getConversationCount();logger.info(`getKnownConversationAttachments: About to iterate through ${conversationTotal}`);var fetchConversations=db.prepare("\n      SELECT json FROM conversations\n      WHERE id > $id\n      ORDER BY id ASC\n      LIMIT $chunkSize;\n    ");for(;!complete;){var rows=fetchConversations.all({id,chunkSize:500}),conversations=map_default()(rows,(function(row){return jsonToObject(row.json)}));conversations.forEach((function(conversation){getExternalFilesForConversation(conversation).forEach((function(file){return result.add(file)}))}));var lastMessage=last_default()(conversations);lastMessage&&(id=lastMessage.id),complete=conversations.length<500}return logger.info("getKnownConversationAttachments: Done processing"),Array.from(result)},removeKnownStickers:async function removeKnownStickers(allStickers){var db=getInstance(),lookup=fromPairs_default()(map_default()(allStickers,(function(file){return[file,!0]}))),total=await getStickerCount();logger.info(`removeKnownStickers: About to iterate through ${total} stickers`);var count=0,complete=!1,rowid=0;for(;!complete;){var rows=db.prepare("\n        SELECT rowid, path FROM stickers\n        WHERE rowid > $rowid\n        ORDER BY rowid ASC\n        LIMIT $chunkSize;\n        ").all({rowid,chunkSize:50});rows.map((function(row){return row.path})).forEach((function(file){delete lookup[file]}));var lastSticker=last_default()(rows);lastSticker&&(rowid=lastSticker.rowid),complete=rows.length<50,count+=rows.length}return logger.info(`removeKnownStickers: Done processing ${count} stickers`),Object.keys(lookup)},removeKnownDraftAttachments:async function removeKnownDraftAttachments(allStickers){var db=getInstance(),lookup=fromPairs_default()(map_default()(allStickers,(function(file){return[file,!0]}))),total=await getConversationCount();logger.info(`removeKnownDraftAttachments: About to iterate through ${total} conversations`);var complete=!1,count=0,id=0;for(;!complete;){var conversations=db.prepare("\n        SELECT json FROM conversations\n        WHERE id > $id\n        ORDER BY id ASC\n        LIMIT $chunkSize;\n        ").all({id,chunkSize:50}).map((function(row){return jsonToObject(row.json)}));conversations.forEach((function(conversation){getExternalDraftFilesForConversation(conversation).forEach((function(file){delete lookup[file]}))}));var lastMessage=last_default()(conversations);lastMessage&&(id=lastMessage.id),complete=conversations.length<50,count+=conversations.length}return logger.info(`removeKnownDraftAttachments: Done processing ${count} conversations`),Object.keys(lookup)},getAllBadgeImageFileLocalPaths:async function getAllBadgeImageFileLocalPaths(){var localPaths=getInstance().prepare("SELECT localPath FROM badgeImageFiles WHERE localPath IS NOT NULL").pluck().all();return new Set(localPaths)}};const Server=dataInterface;var statementCache=new WeakMap;function prepare(db,query){var _ref=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},_ref$pluck=_ref.pluck,pluck=void 0!==_ref$pluck&&_ref$pluck,dbCache=statementCache.get(db);dbCache||(dbCache=new Map,statementCache.set(db,dbCache));var cacheKey=`${pluck}:${query}`,result=dbCache.get(cacheKey);return result||(result=db.prepare(query),!0===pluck&&result.pluck(),dbCache.set(cacheKey,result)),result}function rowToConversation(row){var profileLastFetchedAt,parsedJson=JSON.parse(row.json);return isNormalNumber(row.profileLastFetchedAt)?profileLastFetchedAt=row.profileLastFetchedAt:((0,assert.q8)(isNil_default()(row.profileLastFetchedAt),"profileLastFetchedAt contained invalid data; defaulting to undefined"),profileLastFetchedAt=void 0),Object.assign({},parsedJson,{profileLastFetchedAt})}function rowToSticker(row){return Object.assign({},row,{isCoverOnly:Boolean(row.isCoverOnly),emoji:dropNull_dropNull(row.emoji)})}function isRenderer(){return void 0===process||!process||"renderer"===process.type}function keyDatabase(db,key){db.pragma(`key = "x'${key}'"`)}function switchToWAL(db){db.pragma("journal_mode = WAL"),db.pragma("synchronous = FULL")}function migrateSchemaVersion(db){if(!(getUserVersion(db)>0)){var schemaVersion=getSchemaVersion(db),newUserVersion=schemaVersion>18?16:schemaVersion;logger.info(`migrateSchemaVersion: Migrating from schema_version ${schemaVersion} to user_version ${newUserVersion}`),function setUserVersion(db,version){if(!isNumber_default()(version))throw new Error(`setUserVersion: version ${version} is not a number`);db.pragma(`user_version = ${version}`)}(db,newUserVersion)}}var globalInstance,INVALID_KEY=/[^0-9A-Fa-f]/;function openAndSetUpSQLCipher(filePath,_ref2){var key=_ref2.key;if(INVALID_KEY.exec(key))throw new Error(`setupSQLCipher: key '${key}' is not valid`);var db=function openAndMigrateDatabase(filePath,key){var db;try{return keyDatabase(db=new(better_sqlite3_default())(filePath),key),switchToWAL(db),migrateSchemaVersion(db),db}catch(error){db&&db.close(),logger.info("migrateDatabase: Migration without cipher change failed")}return keyDatabase(db=new(better_sqlite3_default())(filePath),key),db.pragma("cipher_compatibility = 3"),migrateSchemaVersion(db),db.close(),keyDatabase(db=new(better_sqlite3_default())(filePath),key),db.pragma("cipher_migrate"),switchToWAL(db),db}(filePath,key);return db.pragma("foreign_keys = ON"),db}var globalInstanceRenderer,databaseFilePath,indexedDBPath,logger=consoleLogger;function getInstance(){if(isRenderer()){if(!globalInstanceRenderer)throw new Error("getInstance: globalInstanceRenderer not set!");return globalInstanceRenderer}if(!globalInstance)throw new Error("getInstance: globalInstance not set!");return globalInstance}better_sqlite3_default().setLogHandler((function(code,value){logger.warn(`Database log code=${code}: ${value}`)}));function createOrUpdateSenderKeySync(key){prepare(getInstance(),"\n    INSERT OR REPLACE INTO senderKeys (\n      id,\n      senderId,\n      distributionId,\n      data,\n      lastUpdatedDate\n    ) values (\n      $id,\n      $senderId,\n      $distributionId,\n      $data,\n      $lastUpdatedDate\n    )\n    ").run(key)}async function deleteSentProtosOlderThan(timestamp){prepare(getInstance(),"\n    DELETE FROM sendLogPayloads\n    WHERE\n      timestamp IS NULL OR\n      timestamp < $timestamp;\n    ").run({timestamp})}var AdjacentDirection;function createOrUpdateSessionSync(data){var db=getInstance(),id=data.id,conversationId=data.conversationId,ourUuid=data.ourUuid,uuid=data.uuid;if(!id)throw new Error("createOrUpdateSession: Provided data did not have a truthy id");if(!conversationId)throw new Error("createOrUpdateSession: Provided data did not have a truthy conversationId");prepare(db,"\n    INSERT OR REPLACE INTO sessions (\n      id,\n      conversationId,\n      ourUuid,\n      uuid,\n      json\n    ) values (\n      $id,\n      $conversationId,\n      $ourUuid,\n      $uuid,\n      $json\n    )\n    ").run({id,conversationId,ourUuid,uuid,json:objectToJSON(data)})}async function getConversationCount(){return getCountFromTable(getInstance(),"conversations")}function getConversationMembersList(_ref9){var members=_ref9.members,membersV2=_ref9.membersV2;return membersV2?membersV2.map((function(item){return item.uuid})).join(" "):members?members.join(" "):null}function saveConversationSync(data){var db=arguments.length>1&&void 0!==arguments[1]?arguments[1]:getInstance(),active_at=data.active_at,e164=data.e164,groupId=data.groupId,id=data.id,name=data.name,profileFamilyName=data.profileFamilyName,profileName=data.profileName,profileLastFetchedAt=data.profileLastFetchedAt,type=data.type,uuid=data.uuid,membersList=getConversationMembersList(data);db.prepare("\n    INSERT INTO conversations (\n      id,\n      json,\n\n      e164,\n      uuid,\n      groupId,\n\n      active_at,\n      type,\n      members,\n      name,\n      profileName,\n      profileFamilyName,\n      profileFullName,\n      profileLastFetchedAt\n    ) values (\n      $id,\n      $json,\n\n      $e164,\n      $uuid,\n      $groupId,\n\n      $active_at,\n      $type,\n      $members,\n      $name,\n      $profileName,\n      $profileFamilyName,\n      $profileFullName,\n      $profileLastFetchedAt\n    );\n    ").run({id,json:objectToJSON(omit_default()(data,["profileLastFetchedAt","unblurredAvatarPath"])),e164:e164||null,uuid:uuid||null,groupId:groupId||null,active_at:active_at||null,type,members:membersList,name:name||null,profileName:profileName||null,profileFamilyName:profileFamilyName||null,profileFullName:combineNames(profileName,profileFamilyName)||null,profileLastFetchedAt:profileLastFetchedAt||null})}function updateConversationSync(data){var db=arguments.length>1&&void 0!==arguments[1]?arguments[1]:getInstance(),id=data.id,active_at=data.active_at,type=data.type,name=data.name,profileName=data.profileName,profileFamilyName=data.profileFamilyName,profileLastFetchedAt=data.profileLastFetchedAt,e164=data.e164,uuid=data.uuid,membersList=getConversationMembersList(data);db.prepare("\n    UPDATE conversations SET\n      json = $json,\n\n      e164 = $e164,\n      uuid = $uuid,\n\n      active_at = $active_at,\n      type = $type,\n      members = $members,\n      name = $name,\n      profileName = $profileName,\n      profileFamilyName = $profileFamilyName,\n      profileFullName = $profileFullName,\n      profileLastFetchedAt = $profileLastFetchedAt\n    WHERE id = $id;\n    ").run({id,json:objectToJSON(omit_default()(data,["profileLastFetchedAt","unblurredAvatarPath"])),e164:e164||null,uuid:uuid||null,active_at:active_at||null,type,members:membersList,name:name||null,profileName:profileName||null,profileFamilyName:profileFamilyName||null,profileFullName:combineNames(profileName,profileFamilyName)||null,profileLastFetchedAt:profileLastFetchedAt||null})}function removeConversationsSync(ids){getInstance().prepare(`\n    DELETE FROM conversations\n    WHERE id IN ( ${ids.map((function(){return"?"})).join(", ")} );\n    `).run(ids)}async function searchMessages(query){var params=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_params$limit=params.limit,limit=void 0===_params$limit?500:_params$limit,conversationId=params.conversationId,db=getInstance();return db.transaction((function(){db.exec("\n      CREATE TEMP TABLE tmp_results(rowid INTEGER PRIMARY KEY ASC);\n      CREATE TEMP TABLE tmp_filtered_results(rowid INTEGER PRIMARY KEY ASC);\n      "),db.prepare("\n        INSERT INTO tmp_results (rowid)\n        SELECT\n          rowid\n        FROM\n          messages_fts\n        WHERE\n          messages_fts.body MATCH $query;\n      ").run({query}),void 0===conversationId?db.prepare("\n          INSERT INTO tmp_filtered_results (rowid)\n          SELECT\n            tmp_results.rowid\n          FROM\n            tmp_results\n          INNER JOIN\n            messages ON messages.rowid = tmp_results.rowid\n          ORDER BY messages.received_at DESC, messages.sent_at DESC\n          LIMIT $limit;\n        ").run({limit}):db.prepare("\n          INSERT INTO tmp_filtered_results (rowid)\n          SELECT\n            tmp_results.rowid\n          FROM\n            tmp_results\n          INNER JOIN\n            messages ON messages.rowid = tmp_results.rowid\n          WHERE\n            messages.conversationId = $conversationId\n          ORDER BY messages.received_at DESC, messages.sent_at DESC\n          LIMIT $limit;\n        ").run({conversationId,limit});var result=db.prepare("\n        SELECT\n          messages.json,\n          snippet(messages_fts, -1, '<<left>>', '<<right>>', '<<truncation>>', 10)\n            AS snippet\n        FROM tmp_filtered_results\n        INNER JOIN messages_fts\n          ON messages_fts.rowid = tmp_filtered_results.rowid\n        INNER JOIN messages\n          ON messages.rowid = tmp_filtered_results.rowid\n        WHERE\n          messages_fts.body MATCH $query\n        ORDER BY messages.received_at DESC, messages.sent_at DESC;\n        ").all({query});return db.exec("\n      DROP TABLE tmp_results;\n      DROP TABLE tmp_filtered_results;\n      "),result}))()}function getMessageCountSync(conversationId){var db=arguments.length>1&&void 0!==arguments[1]?arguments[1]:getInstance();if(void 0===conversationId)return getCountFromTable(db,"messages");var count=db.prepare("\n        SELECT count(1)\n        FROM messages\n        WHERE conversationId = $conversationId;\n        ").pluck().get({conversationId});return count}async function getMessageCount(conversationId){return getMessageCountSync(conversationId)}function hasUserInitiatedMessages(conversationId){return 0!==getInstance().prepare("\n      SELECT EXISTS(\n        SELECT 1 FROM messages\n        INDEXED BY message_user_initiated\n        WHERE\n          conversationId IS $conversationId AND\n          isUserInitiatedMessage IS 1\n      );\n      ").pluck().get({conversationId})}function saveMessageSync(data,options){var _seenStatus,alreadyInTransaction=options.alreadyInTransaction,_options$db=options.db,db=void 0===_options$db?getInstance():_options$db,forceSave=options.forceSave,jobToInsert=options.jobToInsert,ourUuid=options.ourUuid;if(!alreadyInTransaction)return db.transaction((function(){return(0,assert.UU)(saveMessageSync(data,Object.assign({},options,{alreadyInTransaction:!0})))}))();var _data=data,body=_data.body,conversationId=_data.conversationId,groupV2Change=_data.groupV2Change,hasAttachments=_data.hasAttachments,hasFileAttachments=_data.hasFileAttachments,hasVisualMediaAttachments=_data.hasVisualMediaAttachments,id=_data.id,isErased=_data.isErased,isViewOnce=_data.isViewOnce,received_at=_data.received_at,schemaVersion=_data.schemaVersion,sent_at=_data.sent_at,serverGuid=_data.serverGuid,source=_data.source,sourceUuid=_data.sourceUuid,sourceDevice=_data.sourceDevice,storyId=_data.storyId,type=_data.type,readStatus=_data.readStatus,expireTimer=_data.expireTimer,expirationStartTimestamp=_data.expirationStartTimestamp,attachments=_data.attachments,seenStatus=data.seenStatus;attachments&&(0,assert.Yj)(attachments.every((function(attachment){return!attachment.data})),"Attempting to save a hydrated message"),readStatus===MessageReadStatus.N.Unread&&seenStatus!==SeenStatus.Unseen&&(logging_log.warn(`saveMessage: Message ${id}/${type} is unread but had seenStatus=${seenStatus}. Forcing to UnseenStatus.Unseen.`),data=Object.assign({},data,{seenStatus:SeenStatus.Unseen}),seenStatus=SeenStatus.Unseen);var payload={id,json:objectToJSON(data),body:body||null,conversationId,expirationStartTimestamp:expirationStartTimestamp||null,expireTimer:expireTimer||null,hasAttachments:hasAttachments?1:0,hasFileAttachments:hasFileAttachments?1:0,hasVisualMediaAttachments:hasVisualMediaAttachments?1:0,isChangeCreatedByUs:(null==groupV2Change?void 0:groupV2Change.from)===ourUuid?1:0,isErased:isErased?1:0,isViewOnce:isViewOnce?1:0,received_at:received_at||null,schemaVersion:schemaVersion||0,serverGuid:serverGuid||null,sent_at:sent_at||null,source:source||null,sourceUuid:sourceUuid||null,sourceDevice:sourceDevice||null,storyId:storyId||null,type:type||null,readStatus:null!=readStatus?readStatus:null,seenStatus:null!==(_seenStatus=seenStatus)&&void 0!==_seenStatus?_seenStatus:SeenStatus.NotApplicable};if(id&&!forceSave)return prepare(db,"\n      UPDATE messages SET\n        id = $id,\n        json = $json,\n\n        body = $body,\n        conversationId = $conversationId,\n        expirationStartTimestamp = $expirationStartTimestamp,\n        expireTimer = $expireTimer,\n        hasAttachments = $hasAttachments,\n        hasFileAttachments = $hasFileAttachments,\n        hasVisualMediaAttachments = $hasVisualMediaAttachments,\n        isChangeCreatedByUs = $isChangeCreatedByUs,\n        isErased = $isErased,\n        isViewOnce = $isViewOnce,\n        received_at = $received_at,\n        schemaVersion = $schemaVersion,\n        serverGuid = $serverGuid,\n        sent_at = $sent_at,\n        source = $source,\n        sourceUuid = $sourceUuid,\n        sourceDevice = $sourceDevice,\n        storyId = $storyId,\n        type = $type,\n        readStatus = $readStatus,\n        seenStatus = $seenStatus\n      WHERE id = $id;\n      ").run(payload),jobToInsert&&insertJobSync(db,jobToInsert),id;var toCreate=Object.assign({},data,{id:id||types_UUID.hb.generate().toString()});return prepare(db,"\n    INSERT INTO messages (\n      id,\n      json,\n\n      body,\n      conversationId,\n      expirationStartTimestamp,\n      expireTimer,\n      hasAttachments,\n      hasFileAttachments,\n      hasVisualMediaAttachments,\n      isChangeCreatedByUs,\n      isErased,\n      isViewOnce,\n      received_at,\n      schemaVersion,\n      serverGuid,\n      sent_at,\n      source,\n      sourceUuid,\n      sourceDevice,\n      storyId,\n      type,\n      readStatus,\n      seenStatus\n    ) values (\n      $id,\n      $json,\n\n      $body,\n      $conversationId,\n      $expirationStartTimestamp,\n      $expireTimer,\n      $hasAttachments,\n      $hasFileAttachments,\n      $hasVisualMediaAttachments,\n      $isChangeCreatedByUs,\n      $isErased,\n      $isViewOnce,\n      $received_at,\n      $schemaVersion,\n      $serverGuid,\n      $sent_at,\n      $source,\n      $sourceUuid,\n      $sourceDevice,\n      $storyId,\n      $type,\n      $readStatus,\n      $seenStatus\n    );\n    ").run(Object.assign({},payload,{id:toCreate.id,json:objectToJSON(toCreate)})),jobToInsert&&insertJobSync(db,jobToInsert),toCreate.id}function removeMessagesSync(ids){getInstance().prepare(`\n    DELETE FROM messages\n    WHERE id IN ( ${ids.map((function(){return"?"})).join(", ")} );\n    `).run(ids)}function getMessageByIdSync(db,id){var row=db.prepare("SELECT json FROM messages WHERE id = $id;").get({id});if(row)return jsonToObject(row.json)}function _storyIdPredicate(storyId,includeStoryReplies){return includeStoryReplies&&void 0===storyId?sqlFragment`${storyId} IS NULL`:sqlFragment`storyId IS ${storyId}`}function getAdjacentMessagesByConversationSync(direction,_ref22){var conversationId=_ref22.conversationId,includeStoryReplies=_ref22.includeStoryReplies,_ref22$limit=_ref22.limit,limit=void 0===_ref22$limit?100:_ref22$limit,messageId=_ref22.messageId,_ref22$receivedAt=_ref22.receivedAt,receivedAt=void 0===_ref22$receivedAt?direction===AdjacentDirection.Older?Number.MAX_VALUE:0:_ref22$receivedAt,_ref22$sentAt=_ref22.sentAt,sentAt=void 0===_ref22$sentAt?direction===AdjacentDirection.Older?Number.MAX_VALUE:0:_ref22$sentAt,requireVisualMediaAttachments=_ref22.requireVisualMediaAttachments,storyId=_ref22.storyId,db=getInstance(),timeFilter=direction===AdjacentDirection.Older?sqlFragment`
        (received_at = ${receivedAt} AND sent_at < ${sentAt}) OR
        received_at < ${receivedAt}
      `:sqlFragment`
        (received_at = ${receivedAt} AND sent_at > ${sentAt}) OR
        received_at > ${receivedAt}
      `,timeOrder=direction===AdjacentDirection.Older?sqlFragment`DESC`:sqlFragment`ASC`,template=sqlFragment`
    SELECT json FROM messages WHERE
      conversationId = ${conversationId} AND
      ${direction===AdjacentDirection.Older||requireVisualMediaAttachments?sqlFragment`(${messageId} IS NULL OR id IS NOT ${messageId}) AND`:sqlFragment``}
      ${requireVisualMediaAttachments?sqlFragment`hasVisualMediaAttachments IS 1 AND`:sqlFragment``}
      isStory IS 0 AND
      (${_storyIdPredicate(storyId,includeStoryReplies)}) AND
      (
        ${timeFilter}
      )
    ORDER BY received_at ${timeOrder}, sent_at ${timeOrder}
  `,_ref24=Server_slicedToArray(sql`${template=requireVisualMediaAttachments?sqlFragment`
      SELECT json
      FROM (${template}) as messages
      WHERE
        (
          SELECT COUNT(*)
          FROM json_each(messages.json ->> 'attachments') AS attachment
          WHERE
            attachment.value ->> 'thumbnail' IS NOT NULL AND
            attachment.value ->> 'pending' IS NOT 1 AND
            attachment.value ->> 'error' IS NULL
        ) > 0
      LIMIT ${limit};
    `:sqlFragment`${template} LIMIT ${limit}`}`,2),query=_ref24[0],params=_ref24[1],results=db.prepare(query).all(params);return direction===AdjacentDirection.Older&&results.reverse(),results}function getLastConversationActivity(_ref37){var conversationId=_ref37.conversationId,includeStoryReplies=_ref37.includeStoryReplies,ourUuid=_ref37.ourUuid,row=prepare(getInstance(),`\n      SELECT json FROM messages\n      INDEXED BY messages_activity\n      WHERE\n        conversationId IS $conversationId AND\n        shouldAffectActivity IS 1 AND\n        isTimerChangeFromSync IS 0 AND\n        ${includeStoryReplies?"":"storyId IS NULL AND"}\n        isGroupLeaveEventFromOther IS 0\n      ORDER BY received_at DESC, sent_at DESC\n      LIMIT 1;\n      `).get({conversationId,ourUuid});if(row)return jsonToObject(row.json)}function getLastConversationPreview(_ref38){var conversationId=_ref38.conversationId,includeStoryReplies=_ref38.includeStoryReplies,row=prepare(getInstance(),`\n      SELECT json FROM (\n        SELECT json, expiresAt FROM messages\n        INDEXED BY ${includeStoryReplies?"messages_preview":"messages_preview_without_story"}\n        WHERE\n          conversationId IS $conversationId AND\n          shouldAffectPreview IS 1 AND\n          isGroupLeaveEventFromOther IS 0\n          ${includeStoryReplies?"":"AND storyId IS NULL"}\n        ORDER BY received_at DESC, sent_at DESC\n      )\n      WHERE likely(expiresAt > $now)\n      LIMIT 1\n    `).get({conversationId,now:Date.now()});return row?jsonToObject(row.json):void 0}function getMessageMetricsForConversationSync(options){var conversationId=options.conversationId,oldest=function getOldestMessageForConversation(conversationId,_ref26){var storyId=_ref26.storyId,includeStoryReplies=_ref26.includeStoryReplies,db=getInstance(),_ref28=Server_slicedToArray(sql`
    SELECT received_at, sent_at, id FROM messages WHERE
        conversationId = ${conversationId} AND
        isStory IS 0 AND
        (${_storyIdPredicate(storyId,includeStoryReplies)})
      ORDER BY received_at ASC, sent_at ASC
      LIMIT 1;
  `,2),query=_ref28[0],params=_ref28[1],row=db.prepare(query).get(params);if(row)return row}(conversationId,options),newest=function getNewestMessageForConversation(conversationId,_ref29){var storyId=_ref29.storyId,includeStoryReplies=_ref29.includeStoryReplies,db=getInstance(),_ref31=Server_slicedToArray(sql`
    SELECT received_at, sent_at, id FROM messages WHERE
        conversationId = ${conversationId} AND
        isStory IS 0 AND
        (${_storyIdPredicate(storyId,includeStoryReplies)})
      ORDER BY received_at DESC, sent_at DESC
      LIMIT 1;
  `,2),query=_ref31[0],params=_ref31[1],row=db.prepare(query).get(params);if(row)return row}(conversationId,options),oldestUnseen=function getOldestUnseenMessageForConversation(conversationId,_ref41){var storyId=_ref41.storyId,includeStoryReplies=_ref41.includeStoryReplies,db=getInstance(),_ref43=Server_slicedToArray(sql`
    SELECT received_at, sent_at, id FROM messages WHERE
      conversationId = ${conversationId} AND
      seenStatus = ${SeenStatus.Unseen} AND
      isStory IS 0 AND
      (${_storyIdPredicate(storyId,includeStoryReplies)})
    ORDER BY received_at ASC, sent_at ASC
    LIMIT 1;
  `,2),query=_ref43[0],params=_ref43[1],row=db.prepare(query).get(params);if(row)return row}(conversationId,options),totalUnseen=function getTotalUnseenForConversationSync(conversationId,_ref47){var storyId=_ref47.storyId,includeStoryReplies=_ref47.includeStoryReplies,db=getInstance(),_ref49=Server_slicedToArray(sql`
    SELECT count(1)
      FROM messages
      WHERE
        conversationId = ${conversationId} AND
        seenStatus = ${SeenStatus.Unseen} AND
        isStory IS 0 AND
        (${_storyIdPredicate(storyId,includeStoryReplies)})
  `,2),query=_ref49[0],params=_ref49[1];return db.prepare(query).pluck().get(params)}(conversationId,options);return{oldest:oldest?pick_default()(oldest,["received_at","sent_at","id"]):void 0,newest:newest?pick_default()(newest,["received_at","sent_at","id"]):void 0,oldestUnseen:oldestUnseen?pick_default()(oldestUnseen,["received_at","sent_at","id"]):void 0,totalUnseen}}!function(AdjacentDirection){AdjacentDirection.Older="Older",AdjacentDirection.Newer="Newer"}(AdjacentDirection||(AdjacentDirection={}));function saveUnprocessedSync(data){var db=getInstance(),id=data.id,timestamp=data.timestamp,receivedAtCounter=data.receivedAtCounter,version=data.version,attempts=data.attempts,envelope=data.envelope,source=data.source,sourceUuid=data.sourceUuid,sourceDevice=data.sourceDevice,serverGuid=data.serverGuid,serverTimestamp=data.serverTimestamp,decrypted=data.decrypted,urgent=data.urgent,story=data.story;if(!id)throw new Error("saveUnprocessedSync: id was falsey");return prepare(db,"\n    INSERT OR REPLACE INTO unprocessed (\n      id,\n      timestamp,\n      receivedAtCounter,\n      version,\n      attempts,\n      envelope,\n      source,\n      sourceUuid,\n      sourceDevice,\n      serverGuid,\n      serverTimestamp,\n      decrypted,\n      urgent,\n      story\n    ) values (\n      $id,\n      $timestamp,\n      $receivedAtCounter,\n      $version,\n      $attempts,\n      $envelope,\n      $source,\n      $sourceUuid,\n      $sourceDevice,\n      $serverGuid,\n      $serverTimestamp,\n      $decrypted,\n      $urgent,\n      $story\n    );\n    ").run({id,timestamp,receivedAtCounter:null!=receivedAtCounter?receivedAtCounter:null,version,attempts,envelope:envelope||null,source:source||null,sourceUuid:sourceUuid||null,sourceDevice:sourceDevice||null,serverGuid:serverGuid||null,serverTimestamp:serverTimestamp||null,decrypted:decrypted||null,urgent:urgent||!isBoolean_default()(urgent)?1:0,story:story?1:0}),id}function updateUnprocessedWithDataSync(id,data){var db=getInstance(),source=data.source,sourceUuid=data.sourceUuid,sourceDevice=data.sourceDevice,serverGuid=data.serverGuid,serverTimestamp=data.serverTimestamp,decrypted=data.decrypted;prepare(db,"\n    UPDATE unprocessed SET\n      source = $source,\n      sourceUuid = $sourceUuid,\n      sourceDevice = $sourceDevice,\n      serverGuid = $serverGuid,\n      serverTimestamp = $serverTimestamp,\n      decrypted = $decrypted\n    WHERE id = $id;\n    ").run({id,source:source||null,sourceUuid:sourceUuid||null,sourceDevice:sourceDevice||null,serverGuid:serverGuid||null,serverTimestamp:serverTimestamp||null,decrypted:decrypted||null})}function removeUnprocessedsSync(ids){logging_log.info("removeUnprocessedsSync",{totalIds:ids.length}),getInstance().prepare(`\n    DELETE FROM unprocessed\n    WHERE id IN ( ${ids.map((function(){return"?"})).join(", ")} );\n    `).run(ids)}function removeAttachmentDownloadJobSync(id){return removeById(getInstance(),"attachment_downloads",id)}function updateStickerPackStatusSync(id,status,options){var db=getInstance(),timestamp=options&&options.timestamp||Date.now(),installedAt="installed"===status?timestamp:null;db.prepare("\n    UPDATE sticker_packs\n    SET status = $status, installedAt = $installedAt\n    WHERE id = $id;\n    ").run({id,status,installedAt})}async function getStickerCount(){return getCountFromTable(getInstance(),"stickers")}function addUninstalledStickerPackSync(pack){var _pack$storageID,_pack$storageVersion,_pack$storageUnknownF;getInstance().prepare("\n        INSERT OR REPLACE INTO uninstalled_sticker_packs\n        (\n          id, uninstalledAt, storageID, storageVersion, storageUnknownFields,\n          storageNeedsSync\n        )\n        VALUES\n        (\n          $id, $uninstalledAt, $storageID, $storageVersion, $unknownFields,\n          $storageNeedsSync\n        )\n      ").run({id:pack.id,uninstalledAt:pack.uninstalledAt,storageID:null!==(_pack$storageID=pack.storageID)&&void 0!==_pack$storageID?_pack$storageID:null,storageVersion:null!==(_pack$storageVersion=pack.storageVersion)&&void 0!==_pack$storageVersion?_pack$storageVersion:null,unknownFields:null!==(_pack$storageUnknownF=pack.storageUnknownFields)&&void 0!==_pack$storageUnknownF?_pack$storageUnknownF:null,storageNeedsSync:pack.storageNeedsSync?1:0})}function removeUninstalledStickerPackSync(packId){getInstance().prepare("DELETE FROM uninstalled_sticker_packs WHERE id IS $id").run({id:packId})}function hydrateStoryDistribution(fromDatabase){return Object.assign({},omit_default()(fromDatabase,"senderKeyInfoJson"),{allowsReplies:Boolean(fromDatabase.allowsReplies),deletedAtTimestamp:fromDatabase.deletedAtTimestamp||void 0,isBlockList:Boolean(fromDatabase.isBlockList),senderKeyInfo:fromDatabase.senderKeyInfoJson?JSON.parse(fromDatabase.senderKeyInfoJson):void 0,storageID:fromDatabase.storageID||void 0,storageVersion:fromDatabase.storageVersion||void 0,storageNeedsSync:Boolean(fromDatabase.storageNeedsSync),storageUnknownFields:fromDatabase.storageUnknownFields||void 0})}function freezeStoryDistribution(story){return Object.assign({},omit_default()(story,"senderKeyInfo"),{allowsReplies:story.allowsReplies?1:0,deletedAtTimestamp:story.deletedAtTimestamp||null,isBlockList:story.isBlockList?1:0,senderKeyInfoJson:story.senderKeyInfo?JSON.stringify(story.senderKeyInfo):null,storageID:story.storageID||null,storageVersion:story.storageVersion||null,storageNeedsSync:story.storageNeedsSync?1:0,storageUnknownFields:story.storageUnknownFields||null})}async function _getAllStoryDistributions(){return getInstance().prepare("SELECT * FROM storyDistributions;").all().map(hydrateStoryDistribution)}async function _getAllStoryDistributionMembers(){return getInstance().prepare("SELECT * FROM storyDistributionMembers;").all()}function modifyStoryDistributionSync(db,payload){payload.deletedAtTimestamp?(0,assert.Yj)(!payload.name,"Attempt to delete distribution list but still has a name"):(0,assert.Yj)(payload.name,"Cannot clear distribution list name without deletedAtTimestamp set"),prepare(db,"\n    UPDATE storyDistributions\n    SET\n      name = $name,\n      deletedAtTimestamp = $deletedAtTimestamp,\n      allowsReplies = $allowsReplies,\n      isBlockList = $isBlockList,\n      senderKeyInfoJson = $senderKeyInfoJson,\n      storageID = $storageID,\n      storageVersion = $storageVersion,\n      storageUnknownFields = $storageUnknownFields,\n      storageNeedsSync = $storageNeedsSync\n    WHERE id = $id\n    ").run(payload)}function modifyStoryDistributionMembersSync(db,listId,_ref61){var _step18,toAdd=_ref61.toAdd,toRemove=_ref61.toRemove,memberInsertStatement=prepare(db,"\n    INSERT OR REPLACE INTO storyDistributionMembers (\n      listId,\n      uuid\n    ) VALUES (\n      $listId,\n      $uuid\n    );\n    "),_iterator18=Server_createForOfIteratorHelper(toAdd);try{for(_iterator18.s();!(_step18=_iterator18.n()).done;){var uuid=_step18.value;memberInsertStatement.run({listId,uuid})}}catch(err){_iterator18.e(err)}finally{_iterator18.f()}batchMultiVarQuery(db,toRemove,(function(uuids){db.prepare(`\n      DELETE FROM storyDistributionMembers\n      WHERE listId = ? AND uuid IN ( ${uuids.map((function(){return"?"})).join(", ")} );\n      `).run([listId].concat(Server_toConsumableArray(uuids)))}))}function getExternalFilesForMessage(message){var attachments=message.attachments,contact=message.contact,quote=message.quote,preview=message.preview,sticker=message.sticker,files=[];return forEach_default()(attachments,(function(attachment){var file=attachment.path,thumbnail=attachment.thumbnail,screenshot=attachment.screenshot;file&&files.push(file),thumbnail&&thumbnail.path&&files.push(thumbnail.path),screenshot&&screenshot.path&&files.push(screenshot.path)})),quote&&quote.attachments&&quote.attachments.length&&forEach_default()(quote.attachments,(function(attachment){var thumbnail=attachment.thumbnail;thumbnail&&thumbnail.path&&files.push(thumbnail.path)})),contact&&contact.length&&forEach_default()(contact,(function(item){var avatar=item.avatar;avatar&&avatar.avatar&&avatar.avatar.path&&files.push(avatar.avatar.path)})),preview&&preview.length&&forEach_default()(preview,(function(item){var image=item.image;image&&image.path&&files.push(image.path)})),sticker&&sticker.data&&sticker.data.path&&(files.push(sticker.data.path),sticker.data.thumbnail&&sticker.data.thumbnail.path&&files.push(sticker.data.thumbnail.path)),files}function getExternalFilesForConversation(conversation){var avatar=conversation.avatar,profileAvatar=conversation.profileAvatar,files=[];return avatar&&avatar.path&&files.push(avatar.path),profileAvatar&&profileAvatar.path&&files.push(profileAvatar.path),files}function getExternalDraftFilesForConversation(conversation){var draftAttachments=conversation.draftAttachments||[],files=[];return forEach_default()(draftAttachments,(function(attachment){if(!attachment.pending){var file=attachment.path,screenshotPath=attachment.screenshotPath;file&&files.push(file),screenshotPath&&files.push(screenshotPath)}})),files}function getJobsInQueueSync(db,queueType){return db.prepare("\n      SELECT id, timestamp, data\n      FROM jobs\n      WHERE queueType = $queueType\n      ORDER BY timestamp;\n      ").all({queueType}).map((function(row){return{id:row.id,queueType,timestamp:row.timestamp,data:(0,util_isNotNil.D)(row.data)?JSON.parse(row.data):void 0}}))}function insertJobSync(db,job){db.prepare("\n      INSERT INTO jobs\n      (id, queueType, timestamp, data)\n      VALUES\n      ($id, $queueType, $timestamp, $data);\n    ").run({id:job.id,queueType:job.queueType,timestamp:job.timestamp,data:(0,util_isNotNil.D)(job.data)?JSON.stringify(job.data):null})}var SqliteErrorKind,receivedAtCounter,MAX_GROUP_CALL_RING_AGE=30*durations.EB;function parseSqliteError(error){var message=null==error?void 0:error.message;return message?message.includes("SQLITE_CORRUPT")||message.includes("database disk image is malformed")||message.includes("file is not a database")?SqliteErrorKind.Corrupted:message.includes("SQLITE_READONLY")||message.includes("attempt to write a readonly database")?SqliteErrorKind.Readonly:SqliteErrorKind.Unknown:SqliteErrorKind.Unknown}!function(SqliteErrorKind){SqliteErrorKind[SqliteErrorKind.Corrupted=0]="Corrupted",SqliteErrorKind[SqliteErrorKind.Readonly=1]="Readonly",SqliteErrorKind[SqliteErrorKind.Unknown=2]="Unknown"}(SqliteErrorKind||(SqliteErrorKind={}));var debouncedUpdateLastReceivedAt=debounce_default()((function(){localStorage.setItem("lastReceivedAtCounter",String(receivedAtCounter))}),25,{maxWait:25});function Client_slicedToArray(arr,i){return function Client_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function Client_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function Client_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return Client_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Client_arrayLikeToArray(o,minLen)}(arr,i)||function Client_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Client_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var RendererState,getRealPath=pify_default()(lib_default().realpath),SQL_CHANNEL_KEY="sql-channel";!function(RendererState){RendererState.InMain="InMain",RendererState.Opening="Opening",RendererState.InRenderer="InRenderer",RendererState.Closing="Closing"}(RendererState||(RendererState={}));var resolveShutdown,activeJobCount=0,shutdownPromise=null,state=RendererState.InMain,startupQueries=new Map;var channels=fromPairs_default()(compact_default()(map_default()(toPairs_default()(Server),(function(_ref5){var fnName,_ref6=Client_slicedToArray(_ref5,2),name=_ref6[0],value=_ref6[1];return isFunction_default()(value)?[name,(fnName=name,async function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];if(state===RendererState.InRenderer){var serverFnName=fnName,serverFn=Server[serverFnName],start=Date.now();try{return await serverFn.apply(void 0,args)}catch(error){var sqliteErrorKind=parseSqliteError(error);throw sqliteErrorKind===SqliteErrorKind.Corrupted?(logging_log.error(`Detected sql corruption in renderer process. Restarting the application immediately. Error: ${error.message}`),null===external_electron_.ipcRenderer||void 0===external_electron_.ipcRenderer||external_electron_.ipcRenderer.send("database-error",error.stack)):sqliteErrorKind===SqliteErrorKind.Readonly&&(logging_log.error(`Detected readonly sql database: ${error.message}`),null===external_electron_.ipcRenderer||void 0===external_electron_.ipcRenderer||external_electron_.ipcRenderer.send("database-readonly")),logging_log.error(`Renderer SQL channel job (${fnName}) error ${error.message}`),error}finally{var duration=Date.now()-start;startupQueries.set(serverFnName,(startupQueries.get(serverFnName)||0)+duration),duration>10&&logging_log.info(`Renderer SQL channel job (${fnName}) completed in ${duration}ms`)}}if(shutdownPromise&&"close"!==fnName)throw new Error(`Rejecting SQL channel job (${fnName}); application is shutting down`);return activeJobCount+=1,createTaskWithTimeout((async function(){try{return await external_electron_.ipcRenderer.invoke.apply(external_electron_.ipcRenderer,[SQL_CHANNEL_KEY,fnName].concat(args))}finally{var _resolveShutdown;if(0===(activeJobCount-=1))null===(_resolveShutdown=resolveShutdown)||void 0===_resolveShutdown||_resolveShutdown()}}),`SQL channel call (${fnName})`)()})]:null})))),exclusiveInterface={createOrUpdateIdentityKey:async function Client_createOrUpdateIdentityKey(data){var updated=specFromBytes(IDENTITY_KEY_SPEC,data);await channels.createOrUpdateIdentityKey(updated)},getIdentityKeyById:async function Client_getIdentityKeyById(id){var data=await channels.getIdentityKeyById(id);return specToBytes(IDENTITY_KEY_SPEC,data)},bulkAddIdentityKeys:async function Client_bulkAddIdentityKeys(array){var updated=map_default()(array,(function(data){return specFromBytes(IDENTITY_KEY_SPEC,data)}));await channels.bulkAddIdentityKeys(updated)},getAllIdentityKeys:async function Client_getAllIdentityKeys(){return(await channels.getAllIdentityKeys()).map((function(key){return specToBytes(IDENTITY_KEY_SPEC,key)}))},createOrUpdatePreKey:async function Client_createOrUpdatePreKey(data){var updated=specFromBytes(PRE_KEY_SPEC,data);await channels.createOrUpdatePreKey(updated)},getPreKeyById:async function Client_getPreKeyById(id){var data=await channels.getPreKeyById(id);return specToBytes(PRE_KEY_SPEC,data)},bulkAddPreKeys:async function Client_bulkAddPreKeys(array){var updated=map_default()(array,(function(data){return specFromBytes(PRE_KEY_SPEC,data)}));await channels.bulkAddPreKeys(updated)},getAllPreKeys:async function Client_getAllPreKeys(){return(await channels.getAllPreKeys()).map((function(key){return specToBytes(PRE_KEY_SPEC,key)}))},createOrUpdateSignedPreKey:async function Client_createOrUpdateSignedPreKey(data){var updated=specFromBytes(PRE_KEY_SPEC,data);await channels.createOrUpdateSignedPreKey(updated)},getSignedPreKeyById:async function Client_getSignedPreKeyById(id){var data=await channels.getSignedPreKeyById(id);return specToBytes(PRE_KEY_SPEC,data)},bulkAddSignedPreKeys:async function Client_bulkAddSignedPreKeys(array){var updated=map_default()(array,(function(data){return specFromBytes(PRE_KEY_SPEC,data)}));await channels.bulkAddSignedPreKeys(updated)},getAllSignedPreKeys:async function Client_getAllSignedPreKeys(){return(await channels.getAllSignedPreKeys()).map((function(key){return specToBytes(PRE_KEY_SPEC,key)}))},createOrUpdateItem:async function Client_createOrUpdateItem(data){var id=data.id;if(!id)throw new Error("createOrUpdateItem: Provided data did not have a truthy id");var spec=ITEM_SPECS[id],updated=spec?specFromBytes(spec,data):data;await channels.createOrUpdateItem(updated)},getItemById:async function Client_getItemById(id){var spec=ITEM_SPECS[id],data=await channels.getItemById(id);return spec?specToBytes(spec,data):data},getAllItems:async function Client_getAllItems(){for(var items=await channels.getAllItems(),result=Object.create(null),_i2=0,_Object$keys=Object.keys(items);_i2<_Object$keys.length;_i2++){var key=_Object$keys[_i2],value=items[key],keys=ITEM_SPECS[key],deserializedValue=keys?specToBytes(keys,{value}).value:value;result[key]=deserializedValue}return result},updateConversation:function Client_updateConversation(data){updateConversationBatcher.add(data)},removeConversation:async function Client_removeConversation(id){var existing=await channels.getConversationById(id);existing&&(await channels.removeConversation(id),await async function deleteExternalFiles(conversation,_ref3){var deleteAttachmentData=_ref3.deleteAttachmentData;if(conversation){var avatar=conversation.avatar,profileAvatar=conversation.profileAvatar;avatar&&avatar.path&&await deleteAttachmentData(avatar.path),profileAvatar&&profileAvatar.path&&await deleteAttachmentData(profileAvatar.path)}}(existing,{deleteAttachmentData:window.Signal.Migrations.deleteAttachmentData}))},searchMessages:async function Client_searchMessages(query){var _ref7=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},limit=_ref7.limit,messages=await channels.searchMessages(query,{limit});return handleSearchMessageJSON(messages)},searchMessagesInConversation:async function Client_searchMessagesInConversation(query,conversationId){var _ref8=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},limit=_ref8.limit,messages=await channels.searchMessagesInConversation(query,conversationId,{limit});return handleSearchMessageJSON(messages)},getOlderMessagesByConversation:Client_getOlderMessagesByConversation,getConversationRangeCenteredOnMessage:async function Client_getConversationRangeCenteredOnMessage(options){var result=await channels.getConversationRangeCenteredOnMessage(options);return Object.assign({},result,{older:handleMessageJSON(result.older),newer:handleMessageJSON(result.newer)})},getNewerMessagesByConversation:async function Client_getNewerMessagesByConversation(options){var messages=await channels.getNewerMessagesByConversation(options);return handleMessageJSON(messages)},shutdown:async function shutdown(){logging_log.info("Client.shutdown"),await async function doShutdown(){if(logging_log.info(`data.shutdown: shutdown requested. ${activeJobCount} jobs outstanding`),shutdownPromise)return shutdownPromise;if(0===activeJobCount)return;var _explodePromise=(0,util_explodePromise.R)();shutdownPromise=_explodePromise.promise,resolveShutdown=_explodePromise.resolve;try{await shutdownPromise}finally{logging_log.info("data.shutdown: process complete")}}(),await channels.close()},removeAllMessagesInConversation:async function removeAllMessagesInConversation(conversationId,_ref9){var messages,logId=_ref9.logId;do{if(logging_log.info(`removeAllMessagesInConversation/${logId}: Fetching chunk of 20 messages`),!(messages=await Client_getOlderMessagesByConversation({conversationId,limit:20,includeStoryReplies:!0,storyId:void 0})).length)return;var ids=messages.map((function(message){return message.id}));logging_log.info(`removeAllMessagesInConversation/${logId}: Cleanup...`),await _cleanupMessages(messages),logging_log.info(`removeAllMessagesInConversation/${logId}: Deleting...`),await channels.removeMessages(ids)}while(messages.length>0)},removeOtherData:async function removeOtherData(){await Promise.all([invokeWithTimeout("erase-sql-key"),invokeWithTimeout("erase-attachments"),invokeWithTimeout("erase-stickers"),invokeWithTimeout("erase-temp"),invokeWithTimeout("erase-drafts")])},cleanupOrphanedAttachments:async function cleanupOrphanedAttachments(){try{await invokeWithTimeout("cleanup-orphaned-attachments")}catch(error){logging_log.warn("sql/Client: cleanupOrphanedAttachments failure",errors.G(error))}},ensureFilePermissions:async function ensureFilePermissions(){await invokeWithTimeout("ensure-file-permissions")},startInRendererProcess:async function startInRendererProcess(){var isTesting=arguments.length>0&&void 0!==arguments[0]&&arguments[0];(0,assert.Yj)(state===RendererState.InMain,`startInRendererProcess: expected ${state} to be ${RendererState.InMain}`),logging_log.info("data.startInRendererProcess: switching to renderer process"),state=RendererState.Opening,isTesting||await external_electron_.ipcRenderer.invoke("database-ready");var configDir=await getRealPath(external_electron_.ipcRenderer.sendSync("get-user-data-path")),key=external_electron_.ipcRenderer.sendSync("user-config-key");await Server.initializeRenderer({configDir,key}),logging_log.info("data.startInRendererProcess: switched to renderer process"),state=RendererState.InRenderer},goBackToMainProcess:async function goBackToMainProcess(){if(state!==RendererState.InMain){(0,assert.Yj)(state===RendererState.InRenderer,`goBackToMainProcess: expected ${state} to be ${RendererState.InRenderer}`),logging_log.info("data.goBackToMainProcess: switching to main process");var closePromise=channels.close();state=RendererState.Closing,await closePromise,state=RendererState.InMain;var entries=Array.from(startupQueries.entries());startupQueries.clear(),entries.sort((function(a,b){return b[1]-a[1]})).filter((function(_ref){var _ref2=Client_slicedToArray(_ref,2);_ref2[0];return _ref2[1]>10})).forEach((function(_ref3){var _ref4=Client_slicedToArray(_ref3,2),query=_ref4[0],duration=_ref4[1];logging_log.info(`startup query: ${query} ${duration}ms`)})),logging_log.info("data.goBackToMainProcess: switched to main process")}else logging_log.info("goBackToMainProcess: Already in the main process")}},Client_dataInterface=Object.assign({},channels,exclusiveInterface,{updateConversations:Client_updateConversations,saveMessage:async function Client_saveMessage(data,options){var id=await channels.saveMessage(_cleanMessageData(data),Object.assign({},options,{jobToInsert:options.jobToInsert&&(job=options.jobToInsert,{id:job.id,timestamp:job.timestamp,queueType:job.queueType,data:job.data})}));var job;return(0,assert.wN)((0,types_UUID.TP)(id),"saveMessage: messageId is not a UUID"),expiringMessagesDeletionService.update(),tapToViewMessagesDeletionService.update(),id},saveMessages:async function Client_saveMessages(arrayOfMessages,options){await channels.saveMessages(arrayOfMessages.map((function(message){return _cleanMessageData(message)})),options),expiringMessagesDeletionService.update(),tapToViewMessagesDeletionService.update()},removeMessage:async function Client_removeMessage(id){var message=await channels.getMessageById(id);message&&(await channels.removeMessage(id),await cleanupMessage(message))},removeMessages:async function Client_removeMessages(messageIds){var messages=await channels.getMessagesById(messageIds);await _cleanupMessages(messages),await channels.removeMessages(messageIds)},saveAttachmentDownloadJob:async function Client_saveAttachmentDownloadJob(job){await channels.saveAttachmentDownloadJob(_cleanData(job))}});const Client=Client_dataInterface;function _cleanData(data){var _cleanDataForIpc=cleanDataForIpc(data),cleaned=_cleanDataForIpc.cleaned,pathsChanged=_cleanDataForIpc.pathsChanged;return pathsChanged.length&&logging_log.info(`_cleanData cleaned the following paths: ${pathsChanged.join(", ")}`),cleaned}function _cleanMessageData(data){var result=Object.assign({},data);if(data.received_at||((0,assert.q8)(!1,"received_at was not set on the message"),result.received_at=function incrementMessageCounter(){return(0,assert.Yj)(void 0!==receivedAtCounter,"incrementMessageCounter: not initialized"),receivedAtCounter+=1,debouncedUpdateLastReceivedAt(),receivedAtCounter}()),data.attachments){var logId=function idForLogging_getMessageIdForLogging(message){return`${(0,helpers.Zw)(message)||(0,helpers.b5)(message)}.${(0,helpers.gD)(message)} ${message.sent_at}`}(data);result.attachments=data.attachments.map((function(attachment,index){return attachment.data&&!isTypedArray_default()(attachment.data)?(logging_log.warn(`_cleanMessageData/${logId}: Attachment ${index} had non-array \`data\` field; deleting.`),omit_default()(attachment,["data"])):attachment}))}return _cleanData(omit_default()(result,["dataMessage"]))}function specToBytes(spec,data){return mapObjectWithSpec(spec,data,(function(x){return ts_Bytes.Gh(x)}))}function specFromBytes(spec,data){return mapObjectWithSpec(spec,data,(function(x){return ts_Bytes.s3(x)}))}var IDENTITY_KEY_SPEC=["publicKey"];var PRE_KEY_SPEC=["privateKey","publicKey"];var ITEM_SPECS={identityKeyMap:{key:"value",valueSpec:{isMap:!0,valueSpec:["privKey","pubKey"]}},profileKey:["value"],senderCertificate:["value.serialized"],senderCertificateNoE164:["value.serialized"],subscriberId:["value"]};var updateConversationBatcher=function createBatcher(options){var batcher,timeout,items=[],queue=new p_queue_dist.Z({concurrency:1,timeout:30*durations.EB,throwOnTimeout:!0});function _kickBatchOff(){(0,clearTimeoutIfNecessary.S)(timeout),timeout=null;var itemsRef=items;items=[],queue.add((async function(){await options.processBatch(itemsRef)}))}function anyPending(){return queue.size>0||queue.pending>0||items.length>0}return batcher={add:function add(item){items.push(item),1===items.length?timeout=setTimeout(_kickBatchOff,options.wait):items.length>=options.maxSize&&_kickBatchOff()},removeAll:function removeAll(needle){items=items.filter((function(item){return item!==needle}))},anyPending,onIdle:async function onIdle(){for(;anyPending();)(queue.size>0||queue.pending>0)&&await queue.onIdle(),items.length>0&&await(0,sleep._)(2*options.wait)},flushAndWait:async function flushAndWait(){for(logging_log.info(`Flushing ${options.name} batcher items.length=${items.length}`);anyPending();)_kickBatchOff(),(queue.size>0||queue.pending>0)&&await queue.onIdle();logging_log.info(`Flushing complete ${options.name} for batcher`)},unregister:function unregister(){window.batchers=window.batchers.filter((function(item){return item!==batcher}))}},window.batchers.push(batcher),batcher}({name:"sql.Client.updateConversationBatcher",wait:500,maxSize:20,processBatch:async function(items){var byId=groupBy_default()(items,(function(item){return item.id})),mostRecent=Object.keys(byId).map((function(id){var maybeLast=last_default()(byId[id]);return(0,assert.q8)(void 0!==maybeLast,"Empty array in `groupBy` result"),maybeLast}));await Client_updateConversations(mostRecent)}});async function Client_updateConversations(array){var _cleanDataForIpc2=cleanDataForIpc(array),cleaned=_cleanDataForIpc2.cleaned,pathsChanged=_cleanDataForIpc2.pathsChanged;(0,assert.q8)(!pathsChanged.length,`Paths were cleaned: ${JSON.stringify(pathsChanged)}`),await channels.updateConversations(cleaned)}function handleSearchMessageJSON(messages){return messages.map((function(message){return Object.assign({json:message.json,bodyRanges:[]},JSON.parse(message.json),{snippet:message.snippet})}))}async function _cleanupMessages(messages){var queue=new p_queue_dist.Z({concurrency:3,timeout:30*durations.EB});queue.addAll(messages.map((function(message){return async function(){return cleanupMessage(message)}}))),await queue.onIdle()}function handleMessageJSON(messages){return messages.map((function(message){return JSON.parse(message.json)}))}async function Client_getOlderMessagesByConversation(options){return handleMessageJSON(await channels.getOlderMessagesByConversation(options))}async function invokeWithTimeout(name){return createTaskWithTimeout((function(){return external_electron_.ipcRenderer.invoke(name)}),`callChannel call to ${name}`)()}var protobuf=__webpack_require__("./ts/protobuf/index.ts");var BLESSED_PACKS={"9acc9e8aba563d26a4994e69263e3b25":{key:"Wm3/OUjCjvubeq+T7MN1xp/DFueAd+0mhnoU0QoPahI=",status:"downloaded"},fb535407d2f6497ec074df8b9c51dd1d:{key:"F+lxwTQDViJ4HS7iSeZHO3dFg3ULaMEbuCt1CcaLbf0=",status:"downloaded"},e61fa0867031597467ccc036cc65d403:{key:"E657GnQHMYKA6bOMEmHe044OcTi5+WSmzLtz5A9zeps=",status:"downloaded"},cca32f5b905208b7d0f1e17f23fdc185:{key:"i/jpX3pFver+DI9bAC7wGrlbjxtbqsQBnM1ra+Cxg3o=",status:"downloaded"},ccc89a05dc077856b57351e90697976c:{key:"RXMOYPCdVWYRUiN0RTemt9nqmc7qy3eh+9aAG5YH+88=",status:"downloaded"},cfc50156556893ef9838069d3890fe49:{key:"X1vqt9OCRDywCh5I65Upe2uMrf0GMeXQ2dyUnmmZ/0s=",status:"downloaded"}},STICKER_PACK_DEFAULTS={id:"",key:"",author:"",coverStickerId:0,createdAt:0,downloadAttempts:0,status:"ephemeral",stickerCount:0,stickers:{},title:"",storageNeedsSync:!1},VALID_PACK_ID_REGEXP=/^[0-9a-f]{32}$/i;new p_queue_dist.Z({concurrency:1,timeout:30*durations.EB});function getDataFromLink(link){var url=(0,util_url.FS)(link);if(url){var hash=url.hash;if(hash){var params;try{params=new URLSearchParams(hash.slice(1))}catch(err){return}var id=params.get("pack_id");if(function isPackIdValid(packId){return"string"==typeof packId&&VALID_PACK_ID_REGEXP.test(packId)}(id)){var key=params.get("pack_key");if(key)return{id,key}}}}}function redactPackId(packId){return`[REDACTED]${packId.slice(-3)}`}function getReduxStickerActions(){var actions=window.reduxActions;return(0,assert.Yj)(actions&&actions.stickers,"Redux not ready"),actions.stickers}function decryptSticker(packKey,ciphertext){var derivedKey=function deriveStickerPackKey(packKey){var _deriveSecrets2=Crypto_slicedToArray(deriveSecrets(packKey,getZeroes(32),ts_Bytes.mL("Sticker Pack")),2),part1=_deriveSecrets2[0],part2=_deriveSecrets2[1];return ts_Bytes.mV([part1,part2])}(ts_Bytes.Gh(packKey));return decryptAttachment(ciphertext,derivedKey)}async function downloadSticker(packId,packKey,proto){var _ref=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},ephemeral=_ref.ephemeral,id=proto.id,emoji=proto.emoji;(0,assert.Yj)(null!=id,"Sticker id can't be null");var messaging=window.textsecure.messaging;if(!messaging)throw new Error("messaging is not available!");var ciphertext=await messaging.getSticker(packId,id),plaintext=decryptSticker(packKey,ciphertext),sticker=ephemeral?await window.Signal.Migrations.processNewEphemeralSticker(plaintext):await window.Signal.Migrations.processNewSticker(plaintext);return Object.assign({id,emoji:dropNull_dropNull(emoji)},sticker,{packId})}function getStickerPack(packId){var packs=window.reduxStore.getState().stickers.packs;if(packs)return packs[packId]}function getStickerPackStatus(packId){var pack=getStickerPack(packId);if(pack)return pack.status}async function deletePackReference(messageId,packId){if(!Boolean(BLESSED_PACKS[packId])){var paths=await Client.deleteStickerPackReference(messageId,packId);if(paths)(0,getReduxStickerActions().removeStickerPack)(packId),await p_map_default()(paths,window.Signal.Migrations.deleteSticker,{concurrency:3})}}var VisualAttachment=__webpack_require__("./ts/types/VisualAttachment.ts"),js=(__webpack_require__("./node_modules/uuid-browser/index.js"),__webpack_require__("./node_modules/blueimp-load-image/js/index.js")),js_default=__webpack_require__.n(js),blurhash_dist=__webpack_require__("./node_modules/blurhash/dist/index.js"),imageToBlurHash_imageToBlurHash=async function(input){var _await$loadImageData=await async function(input){return new Promise((function(resolve,reject){js_default()(input,(function(canvasOrError){if(canvasOrError instanceof Event&&"error"===canvasOrError.type){var processError=new Error("imageToBlurHash: Failed to process image",{cause:canvasOrError});reject(processError)}else if(canvasOrError instanceof HTMLCanvasElement){var context=canvasOrError.getContext("2d");context?resolve(context.getImageData(0,0,canvasOrError.width,canvasOrError.height)):reject(new Error("imageToBlurHash: cannot get CanvasRenderingContext2D from canvas"))}else reject(new Error("imageToBlurHash: result is not a canvas"))}),{canvas:!0,orientation:!0,maxWidth:200,maxHeight:200})}))}(input),data=_await$loadImageData.data,width=_await$loadImageData.width,height=_await$loadImageData.height;return(0,blurhash_dist.encode)(data,width,height,4,3)},canvasToBlob=__webpack_require__("./ts/util/canvasToBlob.ts"),throttle=__webpack_require__("./node_modules/lodash/throttle.js"),throttle_default=__webpack_require__.n(throttle);__webpack_require__("./ts/types/PhoneNumber.ts");var config={},listeners={};throttle_default()((async function(server){var now=Date.now(),newConfig=await server.getConfig(),oldConfig=config;config=newConfig.reduce((function(acc,_ref){var name=_ref.name,enabled=_ref.enabled,value=_ref.value,previouslyEnabled=get_default()(oldConfig,[name,"enabled"],!1),previousValue=get_default()(oldConfig,[name,"value"],void 0),configValue={name,enabled,enabledAt:previouslyEnabled&&enabled?now:get_default()(oldConfig,[name,"enabledAt"]),value},hasChanged=previouslyEnabled!==enabled||previousValue!==configValue.value,currentListeners=listeners[name]||[];return hasChanged&&(logging_log.info(`Remote Config: Flag ${name} has changed`),currentListeners.forEach((function(listener){listener(configValue)}))),Object.assign({},acc,{[name]:configValue})}),{}),await window.storage.put("remoteConfig",config)}),72e5,{trailing:!1});function getValue(name){return get_default()(config,[name,"value"],void 0)}var MediaQualityLevels,libphonenumberInstance=__webpack_require__("./ts/util/libphonenumberInstance.ts");function scaleImageToLevel_slicedToArray(arr,i){return function scaleImageToLevel_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function scaleImageToLevel_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function scaleImageToLevel_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return scaleImageToLevel_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return scaleImageToLevel_arrayLikeToArray(o,minLen)}(arr,i)||function scaleImageToLevel_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function scaleImageToLevel_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}!function(MediaQualityLevels){MediaQualityLevels[MediaQualityLevels.One=1]="One",MediaQualityLevels[MediaQualityLevels.Two=2]="Two",MediaQualityLevels[MediaQualityLevels.Three=3]="Three"}(MediaQualityLevels||(MediaQualityLevels={}));var DEFAULT_LEVEL=MediaQualityLevels.One,MiB=1048576,DEFAULT_LEVEL_DATA={maxDimensions:1600,quality:.7,size:MiB,thresholdSize:.2*MiB},MEDIA_QUALITY_LEVEL_DATA=new Map([[MediaQualityLevels.One,DEFAULT_LEVEL_DATA],[MediaQualityLevels.Two,{maxDimensions:2048,quality:.75,size:1572864,thresholdSize:.3*MiB}],[MediaQualityLevels.Three,{maxDimensions:4096,quality:.75,size:3*MiB,thresholdSize:.4*MiB}]]),SCALABLE_DIMENSIONS=[3072,2048,1600,1024,768];function getMediaQualityLevel(){var values=getValue("desktop.mediaQuality.levels");if(!values)return DEFAULT_LEVEL;var e164=window.textsecure.storage.user.getNumber();if(!e164)return DEFAULT_LEVEL;var parsedPhoneNumber=function parseNumber(number,defaultRegionCode){try{var _parsedNumber$getCoun,parsedNumber=libphonenumberInstance.eE.parse(number,defaultRegionCode);return libphonenumberInstance.eE.isValidNumber(parsedNumber)?{isValidNumber:!0,regionCode:libphonenumberInstance.eE.getRegionCodeForNumber(parsedNumber),countryCode:null===(_parsedNumber$getCoun=parsedNumber.getCountryCode())||void 0===_parsedNumber$getCoun?void 0:_parsedNumber$getCoun.toString(),e164:libphonenumberInstance.eE.format(parsedNumber,libphonenumberInstance.M9.E164)}:{error:new Error("Invalid phone number"),isValidNumber:!1}}catch(error){return{error,isValidNumber:!1}}}(e164);if(!parsedPhoneNumber.isValidNumber)return DEFAULT_LEVEL;var countryValues=function parseCountryValues(values){var map=new Map;return values.split(",").forEach((function(value){var _value$split2=scaleImageToLevel_slicedToArray(value.split(":"),2),countryCode=_value$split2[0],level=_value$split2[1];map.set(countryCode,2===Number(level)?MediaQualityLevels.Two:MediaQualityLevels.One)})),map}(values),level=parsedPhoneNumber.countryCode?countryValues.get(parsedPhoneNumber.countryCode):void 0;return level||(countryValues.get("*")||DEFAULT_LEVEL)}async function getCanvasBlobAsJPEG(image,dimensions,quality){var canvas=js_default().scale(image,{canvas:!0,maxHeight:dimensions,maxWidth:dimensions});if(!(canvas instanceof HTMLCanvasElement))throw new Error("image not a canvas");return(0,canvasToBlob._)(canvas,MIME._l,quality)}async function autoScale(_ref2){var contentType=_ref2.contentType,file=_ref2.file,fileName=_ref2.fileName;if(!(0,Attachment.QF)({contentType}))return{contentType,file,fileName};var _await$scaleImageToLe=await async function scaleImageToLevel(fileOrBlobOrURL,contentType,sendAsHighQuality){var data;try{if(!((data=await js_default()(fileOrBlobOrURL,{canvas:!0,orientation:!0,meta:!0})).image instanceof HTMLCanvasElement))throw new Error("image not a canvas")}catch(cause){throw new Error("scaleImageToLevel: Failed to process image",{cause})}var level=sendAsHighQuality?MediaQualityLevels.Three:getMediaQualityLevel(),_ref=MEDIA_QUALITY_LEVEL_DATA.get(level)||DEFAULT_LEVEL_DATA,maxDimensions=_ref.maxDimensions,quality=_ref.quality,size=_ref.size,thresholdSize=_ref.thresholdSize;if(fileOrBlobOrURL.size<=thresholdSize)return{blob:await(0,canvasToBlob._)(data.image,contentType),contentType};for(var i=0;i<SCALABLE_DIMENSIONS.length;i+=1){var scalableDimensions=SCALABLE_DIMENSIONS[i];if(!(maxDimensions<scalableDimensions)){var _blob2=await getCanvasBlobAsJPEG(data.image,scalableDimensions,quality);if(_blob2.size<=size)return{blob:_blob2,contentType:MIME._l}}}return{blob:await getCanvasBlobAsJPEG(data.image,512,quality),contentType:MIME._l}}(file,contentType,!0),blob=_await$scaleImageToLe.blob;if(_await$scaleImageToLe.contentType!==MIME._l)return{contentType,file:blob,fileName};var name=path_default().parse(fileName).name;return{contentType:MIME._l,file:blob,fileName:`${name}.jpg`}}var currentlyMatchedLink,linkPreviewAbortController,linkPreviewResult,LINK_PREVIEW_TIMEOUT=60*durations.sh,disableLinkPreviews=!1,excludedPreviewUrls=[];debounce_default()((function _maybeGrabLinkPreview(message,source){var _ref=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},caretLocation=_ref.caretLocation,conversationId=_ref.conversationId,_ref$mode=_ref.mode,mode=void 0===_ref$mode?"conversation":_ref$mode;if(!window.Events.getLinkPreviewSetting()&&"conversation"===mode)return;var messaging=window.textsecure.messaging;if(!messaging)return;if(window.isBehindProxy())return;if(!message)return void LinkPreview_resetLinkPreview(conversationId);if(disableLinkPreviews)return;var links=types_LinkPreview.rq(message,caretLocation);if(currentlyMatchedLink&&links.includes(currentlyMatchedLink))return;currentlyMatchedLink=void 0,excludedPreviewUrls=excludedPreviewUrls||[];var link=links.find((function(item){return types_LinkPreview.go(item)&&!excludedPreviewUrls.includes(item)}));if(!link)return void removeLinkPreview(conversationId);addLinkPreview(link,source,{conversationId,disableFetch:!window.Events.getLinkPreviewSetting()})}),200);function LinkPreview_resetLinkPreview(conversationId){disableLinkPreviews=!1,excludedPreviewUrls=[],removeLinkPreview(conversationId)}function removeLinkPreview(conversationId){var _linkPreviewAbortCont;(linkPreviewResult||[]).forEach((function(item){item.url&&URL.revokeObjectURL(item.url)})),linkPreviewResult=void 0,currentlyMatchedLink=void 0,null===(_linkPreviewAbortCont=linkPreviewAbortController)||void 0===_linkPreviewAbortCont||_linkPreviewAbortCont.abort(),linkPreviewAbortController=void 0,window.reduxActions.linkPreviews.removeLinkPreview(conversationId)}async function addLinkPreview(url,source){var _ref2=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},conversationId=_ref2.conversationId,disableFetch=_ref2.disableFetch;if(currentlyMatchedLink!==url){(linkPreviewResult||[]).forEach((function(item){item.url&&URL.revokeObjectURL(item.url)})),window.reduxActions.linkPreviews.removeLinkPreview(conversationId),linkPreviewResult=void 0,linkPreviewAbortController&&(logging_log.info("addLinkPreview: canceling another in-flight link preview request"),linkPreviewAbortController.abort());var thisRequestAbortController=new AbortController;linkPreviewAbortController=thisRequestAbortController;var timeout=setTimeout((function(){thisRequestAbortController.abort()}),LINK_PREVIEW_TIMEOUT);currentlyMatchedLink=url,window.reduxActions.linkPreviews.addLinkPreview({url},source,conversationId);try{var result;if(!(result=disableFetch?{title:null,url,description:null,date:null}:await getPreview(url,thisRequestAbortController.signal))){logging_log.info("addLinkPreview: failed to load preview (not necessarily a problem)");var failedToFetch=currentlyMatchedLink===url;return void(failedToFetch&&(excludedPreviewUrls.push(url),removeLinkPreview(conversationId)))}if(result.image&&result.image.data){var blob=new Blob([result.image.data],{type:result.image.contentType});result.image.url=URL.createObjectURL(blob)}else if(!result.title&&!disableFetch)return void removeLinkPreview(conversationId);window.reduxActions.linkPreviews.addLinkPreview(Object.assign({},result,{title:dropNull_dropNull(result.title),description:dropNull_dropNull(result.description),date:dropNull_dropNull(result.date),domain:types_LinkPreview.ge(result.url),isStickerPack:types_LinkPreview.Df(result.url)}),source,conversationId),linkPreviewResult=[result]}catch(error){logging_log.error("Problem loading link preview, disabling.",errors.G(error)),disableLinkPreviews=!0,removeLinkPreview(conversationId)}finally{clearTimeout(timeout)}}else logging_log.warn("addLinkPreview should not be called with the same URL like this")}async function getPreview(url,abortSignal){var messaging=window.textsecure.messaging;if(!messaging)throw new Error("messaging is not available!");if(types_LinkPreview.Df(url))return async function getStickerPackPreview(url,abortSignal){var isPackDownloaded=function(pack){return!!pack&&("downloaded"===pack.status||"installed"===pack.status)},isPackValid=function(pack){return!!pack&&("ephemeral"===pack.status||"downloaded"===pack.status||"installed"===pack.status)},dataFromLink=getDataFromLink(url);if(!dataFromLink)return null;var id=dataFromLink.id,key=dataFromLink.key;try{var keyBytes=ts_Bytes.H_(key),keyBase64=ts_Bytes.s3(keyBytes);if(isPackDownloaded(getStickerPack(id))||await async function downloadEphemeralPack(packId,packKey){var _getReduxStickerActio3=getReduxStickerActions(),stickerAdded=_getReduxStickerActio3.stickerAdded,stickerPackAdded=_getReduxStickerActio3.stickerPackAdded,stickerPackUpdated=_getReduxStickerActio3.stickerPackUpdated,existingPack=getStickerPack(packId);if(!existingPack||"downloaded"!==existingPack.status&&"installed"!==existingPack.status&&"pending"!==existingPack.status)try{stickerPackAdded(Object.assign({},STICKER_PACK_DEFAULTS,{id:packId,key:packKey,status:"ephemeral"}));var messaging=window.textsecure.messaging;if(!messaging)throw new Error("messaging is not available!");var ciphertext=await messaging.getStickerPackManifest(packId),plaintext=decryptSticker(packKey,ciphertext),proto=protobuf.g.StickerPack.decode(plaintext),firstStickerProto=proto.stickers?proto.stickers[0]:null,stickerCount=proto.stickers.length,coverProto=proto.cover||firstStickerProto,coverStickerId=coverProto?coverProto.id:null;if(!coverProto||!isNumber_default()(coverStickerId))throw new Error(`Sticker pack ${redactPackId(packId)} is malformed - it has no cover, and no stickers`);var nonCoverStickers=reject_default()(proto.stickers,(function(sticker){return!isNumber_default()(sticker.id)||sticker.id===coverStickerId})),coverSticker=proto.stickers.filter((function(sticker){return isNumber_default()(sticker.id)&&sticker.id===coverStickerId}));coverSticker[0]&&!coverProto.emoji&&(coverProto.emoji=coverSticker[0].emoji);var coverIncludedInList=nonCoverStickers.length<stickerCount;stickerPackAdded(Object.assign({},STICKER_PACK_DEFAULTS,{id:packId,key:packKey,coverStickerId,stickerCount,status:"ephemeral"},pick_default()(proto,["title","author"])));var downloadStickerJob=async function(stickerProto){var stickerInfo;try{stickerInfo=await downloadSticker(packId,packKey,stickerProto,{ephemeral:!0})}catch(error){return logging_log.error(`downloadEphemeralPack/downloadStickerJob error: ${errors.G(error)}`),!1}var sticker=Object.assign({},stickerInfo,{isCoverOnly:!coverIncludedInList&&stickerInfo.id===coverStickerId}),statusCheck=getStickerPackStatus(packId);if("ephemeral"!==statusCheck)throw new Error(`Ephemeral download for pack ${redactPackId(packId)} interrupted by status change. Status is now ${statusCheck}.`);return stickerAdded(sticker),!0};if(await downloadStickerJob(coverProto),0===(await p_map_default()(nonCoverStickers,downloadStickerJob,{concurrency:3})).filter((function(item){return item})).length&&0!==nonCoverStickers.length)throw new Error("downloadEphemeralPack: All stickers failed to download")}catch(error){"ephemeral"===getStickerPackStatus(packId)&&stickerPackUpdated(packId,{attemptedStatus:"ephemeral",status:"error"}),logging_log.error(`Ephemeral download error for sticker pack ${redactPackId(packId)}:`,errors.G(error))}else logging_log.warn(`Ephemeral download for pack ${redactPackId(packId)} requested, we already know about it. Skipping.`)}(id,keyBase64),abortSignal.aborted)return null;var pack=getStickerPack(id);if(!isPackValid(pack))return null;if(pack.key!==keyBase64)return null;var contentType,title=pack.title,coverStickerId=pack.coverStickerId,sticker=pack.stickers[coverStickerId],data="ephemeral"===pack.status?await window.Signal.Migrations.readTempData(sticker.path):await window.Signal.Migrations.readStickerData(sticker.path);if(abortSignal.aborted)return null;var sniffedMimeType=function sniffImageMimeType_sniffImageMimeType(bytes){for(var i=0;i<TYPES.length;i+=1){var type=TYPES[i];if(matchesType(bytes,type))return type.mimeType}}(data);return sniffedMimeType?contentType=sniffedMimeType:(logging_log.warn("getStickerPackPreview: Unable to sniff sticker MIME type; falling back to WebP"),contentType=MIME.to),{date:null,description:null,image:Object.assign({},sticker,{data,size:data.byteLength,contentType}),title,url}}catch(error){return logging_log.error("getStickerPackPreview error:",errors.G(error)),null}finally{id&&await async function removeEphemeralPack(packId){var existing=getStickerPack(packId);if((0,assert.Yj)(existing,`No existing sticker pack with id: ${packId}`),"ephemeral"===existing.status||"error"===existing.status&&"ephemeral"===existing.attemptedStatus){(0,getReduxStickerActions().removeStickerPack)(packId);var paths=values_default()(existing.stickers).map((function(sticker){return sticker.path}));await p_map_default()(paths,window.Signal.Migrations.deleteTempFile,{concurrency:3}),await Client.deleteStickerPack(packId)}}(id)}}(url,abortSignal);if(types_LinkPreview.Hz(url))return async function getGroupPreview(url,abortSignal){var _result$memberCount,urlObject=(0,util_url.FS)(url);if(!urlObject)return null;var hash=urlObject.hash;if(!hash)return null;var groupData=hash.slice(1),_window$Signal$Groups=window.Signal.Groups.parseGroupLink(groupData),inviteLinkPassword=_window$Signal$Groups.inviteLinkPassword,masterKey=_window$Signal$Groups.masterKey,fields=window.Signal.Groups.deriveGroupFields(ts_Bytes.Gh(masterKey)),logId=`groupv2(${ts_Bytes.s3(fields.id)})`,secretParams=ts_Bytes.s3(fields.secretParams);logging_log.info(`getGroupPreview/${logId}: Fetching pre-join state`);var result=await window.Signal.Groups.getPreJoinGroupInfo(inviteLinkPassword,masterKey);if(abortSignal.aborted)return null;var image,title=window.Signal.Groups.decryptGroupTitle(result.title,secretParams)||window.i18n("icu:unknownGroup"),description=window.i18n("icu:GroupV2--join--group-metadata--full",{memberCount:null!==(_result$memberCount=null==result?void 0:result.memberCount)&&void 0!==_result$memberCount?_result$memberCount:0});if(result.avatar)try{var data=await window.Signal.Groups.decryptGroupAvatar(result.avatar,secretParams);image={data,size:data.byteLength,contentType:MIME._l,blurHash:await imageToBlurHash_imageToBlurHash(new Blob([data],{type:MIME._l}))}}catch(error){var errorString=errors.G(error);logging_log.error(`getGroupPreview/${logId}: Failed to fetch avatar ${errorString}`)}if(abortSignal.aborted)return null;return{date:null,description,image,title,url}}(url,abortSignal);if(!types_LinkPreview.go(url))return null;var linkPreviewMetadata=await messaging.fetchLinkPreviewMetadata(url,abortSignal);if(!linkPreviewMetadata||abortSignal.aborted)return null;var image,objectUrl,title=linkPreviewMetadata.title,imageHref=linkPreviewMetadata.imageHref,description=linkPreviewMetadata.description,date=linkPreviewMetadata.date;if(imageHref&&types_LinkPreview.go(imageHref))try{var fullSizeImage=await messaging.fetchLinkPreviewImage(imageHref,abortSignal);if(abortSignal.aborted)return null;if(!fullSizeImage)throw new Error("Failed to fetch link preview image");var withBlob=await autoScale({contentType:fullSizeImage.contentType,file:new Blob([fullSizeImage.data],{type:fullSizeImage.contentType}),fileName:title}),data=await function fileToBytes(file){return new Promise((function(resolve,rejectPromise){var FR=new FileReader;FR.onload=function(){FR.result&&"string"!=typeof FR.result?resolve(new Uint8Array(FR.result)):rejectPromise(new Error("bytesFromFile: No result!"))},FR.onerror=rejectPromise,FR.onabort=rejectPromise,FR.readAsArrayBuffer(file)}))}(withBlob.file);objectUrl=URL.createObjectURL(withBlob.file);var blurHash=await imageToBlurHash_imageToBlurHash(withBlob.file),dimensions=await VisualAttachment.pz({objectUrl,logger:logging_log});image=Object.assign({data,size:data.byteLength},dimensions,{contentType:(0,MIME.cJ)(withBlob.file.type),blurHash})}catch(error){logging_log.error("getPreview failed to get image for link preview:",error.message)}finally{objectUrl&&URL.revokeObjectURL(objectUrl)}return abortSignal.aborted?null:{date:date||null,description:description||null,image,title,url}}function isDraftForwardable(draft){var _draft$messageBody$le,_draft$messageBody,_draft$attachments$le,_draft$attachments2;return(null!==(_draft$messageBody$le=null===(_draft$messageBody=draft.messageBody)||void 0===_draft$messageBody?void 0:_draft$messageBody.length)&&void 0!==_draft$messageBody$le?_draft$messageBody$le:0)>0||(!!draft.isSticker||(!!draft.hasContact||(null!==(_draft$attachments$le=null===(_draft$attachments2=draft.attachments)||void 0===_draft$attachments2?void 0:_draft$attachments2.length)&&void 0!==_draft$attachments$le?_draft$attachments$le:0)>0))}var Toast=__webpack_require__("./ts/types/Toast.tsx"),BodyRange=__webpack_require__("./ts/types/BodyRange.ts"),UserText=__webpack_require__("./ts/components/UserText.tsx"),jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");function ForwardMessagesModal_toConsumableArray(arr){return function ForwardMessagesModal_arrayWithoutHoles(arr){if(Array.isArray(arr))return ForwardMessagesModal_arrayLikeToArray(arr)}(arr)||function ForwardMessagesModal_iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||ForwardMessagesModal_unsupportedIterableToArray(arr)||function ForwardMessagesModal_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ForwardMessagesModal_slicedToArray(arr,i){return function ForwardMessagesModal_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function ForwardMessagesModal_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||ForwardMessagesModal_unsupportedIterableToArray(arr,i)||function ForwardMessagesModal_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ForwardMessagesModal_unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return ForwardMessagesModal_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ForwardMessagesModal_arrayLikeToArray(o,minLen):void 0}}function ForwardMessagesModal_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function ForwardMessagesModal(_ref){var drafts=_ref.drafts,candidateConversations=_ref.candidateConversations,doForwardMessages=_ref.doForwardMessages,linkPreviewForSource=_ref.linkPreviewForSource,getPreferredBadge=_ref.getPreferredBadge,i18n=_ref.i18n,onClose=_ref.onClose,onChange=_ref.onChange,removeLinkPreview=_ref.removeLinkPreview,RenderCompositionTextArea=_ref.RenderCompositionTextArea,showToast=_ref.showToast,theme=_ref.theme,regionCode=_ref.regionCode,inputRef=(0,react.useRef)(null),_useState2=ForwardMessagesModal_slicedToArray((0,react.useState)([]),2),selectedContacts=_useState2[0],setSelectedContacts=_useState2[1],_useState4=ForwardMessagesModal_slicedToArray((0,react.useState)(""),2),searchTerm=_useState4[0],setSearchTerm=_useState4[1],_useState6=ForwardMessagesModal_slicedToArray((0,react.useState)((0,filterAndSortConversations.x)(candidateConversations,"",regionCode)),2),filteredConversations=_useState6[0],setFilteredConversations=_useState6[1],_useState8=ForwardMessagesModal_slicedToArray((0,react.useState)(!1),2),isEditingMessage=_useState8[0],setIsEditingMessage=_useState8[1],_useState10=ForwardMessagesModal_slicedToArray((0,react.useState)(!1),2),cannotMessage=_useState10[0],setCannotMessage=_useState10[1],isLonelyDraft=1===drafts.length,lonelyDraft=isLonelyDraft?drafts[0]:null,isLonelyDraftEditable=null!=lonelyDraft&&function isDraftEditable(draft){var _draft$attachments$so,_draft$attachments;return!(draft.isSticker||draft.hasContact||null!==(_draft$attachments$so=null===(_draft$attachments=draft.attachments)||void 0===_draft$attachments?void 0:_draft$attachments.some(Attachment.CZ))&&void 0!==_draft$attachments$so&&_draft$attachments$so)}(lonelyDraft),lonelyLinkPreview=isLonelyDraft?linkPreviewForSource(types_LinkPreview.hH.ForwardMessageModal):null,hasSelectedMaximumNumberOfContacts=selectedContacts.length>=5,selectedConversationIdsSet=(0,react.useMemo)((function(){return new Set(selectedContacts.map((function(contact){return contact.id})))}),[selectedContacts]),hasContactsSelected=Boolean(selectedContacts.length),canForwardMessages=hasContactsSelected&&drafts.every(isDraftForwardable),forwardMessages=react.useCallback((function(){if(canForwardMessages){var conversationIds=selectedContacts.map((function(contact){return contact.id}));if(null!=lonelyDraft){var previews=lonelyLinkPreview?[lonelyLinkPreview]:[];doForwardMessages(conversationIds,[Object.assign({},lonelyDraft,{previews})])}else doForwardMessages(conversationIds,drafts.map((function(draft){var _draft$bodyRanges;return Object.assign({},draft,{bodyRanges:null===(_draft$bodyRanges=draft.bodyRanges)||void 0===_draft$bodyRanges?void 0:_draft$bodyRanges.filter(BodyRange.OY.isFormatting)})})))}else showToast({toastType:Toast.p.CannotForwardEmptyMessage})}),[drafts,lonelyDraft,lonelyLinkPreview,doForwardMessages,selectedContacts,canForwardMessages,showToast]),normalizedSearchTerm=searchTerm.trim();(0,react.useEffect)((function(){var timeout=setTimeout((function(){setFilteredConversations((0,filterAndSortConversations.x)(candidateConversations,normalizedSearchTerm,regionCode))}),200);return function(){clearTimeout(timeout)}}),[candidateConversations,normalizedSearchTerm,setFilteredConversations,regionCode]);var contactLookup=(0,react.useMemo)((function(){var map=new Map;return candidateConversations.forEach((function(contact){map.set(contact.id,contact)})),map}),[candidateConversations]),toggleSelectedConversation=(0,react.useCallback)((function(conversationId){var removeContact=!1,nextSelectedContacts=selectedContacts.filter((function(contact){return contact.id!==conversationId||(removeContact=!0,!1)}));if(removeContact)setSelectedContacts(nextSelectedContacts);else{var selectedContact=contactLookup.get(conversationId);selectedContact&&(selectedContact.announcementsOnly&&!selectedContact.areWeAdmin?setCannotMessage(!0):setSelectedContacts([].concat(ForwardMessagesModal_toConsumableArray(nextSelectedContacts),[selectedContact])))}}),[contactLookup,selectedContacts,setSelectedContacts]),_useAnimated=(0,useAnimated.F)(onClose,{getFrom:function(){return{opacity:0,transform:"translateY(48px)"}},getTo:function(isOpen){return isOpen?{opacity:1,transform:"translateY(0px)"}:{opacity:0,transform:"translateY(48px)"}}}),close=_useAnimated.close,modalStyles=_useAnimated.modalStyles,overlayStyles=_useAnimated.overlayStyles,handleBackOrClose=(0,react.useCallback)((function(){isEditingMessage?setIsEditingMessage(!1):close()}),[isEditingMessage,close,setIsEditingMessage]),rowCount=filteredConversations.length,getRow=function(index){var contact=filteredConversations[index];if(contact){var disabledReason,isSelected=selectedConversationIdsSet.has(contact.id);return hasSelectedMaximumNumberOfContacts&&!isSelected&&(disabledReason=ContactCheckbox.B.MaximumContactsSelected),{type:ConversationList.aC.ContactCheckbox,contact,isChecked:isSelected,disabledReason}}};return(0,react.useEffect)((function(){var timeout=setTimeout((function(){var _inputRef$current;null===(_inputRef$current=inputRef.current)||void 0===_inputRef$current||_inputRef$current.focus()}),100);return function(){clearTimeout(timeout)}}),[]),(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[cannotMessage&&(0,jsx_runtime.jsx)(ConfirmationDialog.U,{dialogName:"ForwardMessageModal.confirm",cancelText:i18n("icu:Confirmation--confirm"),i18n,onClose:function(){return setCannotMessage(!1)},children:i18n("icu:GroupV2--cannot-send")}),(0,jsx_runtime.jsx)(ModalHost.l,{modalName:"ForwardMessageModal",noMouseClose:!0,onEscape:handleBackOrClose,onClose:close,overlayStyles,useFocusTrap:!1,children:(0,jsx_runtime.jsxs)(react_spring_web_esm.animated.div,{className:"module-ForwardMessageModal",style:modalStyles,children:[(0,jsx_runtime.jsxs)("div",{className:classnames_default()("module-ForwardMessageModal__header",{"module-ForwardMessageModal__header--edit":isEditingMessage}),children:[isEditingMessage?(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:back"),className:"module-ForwardMessageModal__header--back",onClick:function(){return setIsEditingMessage(!1)},type:"button",children:""}):(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:close"),className:"module-ForwardMessageModal__header--close",onClick:close,type:"button"}),(0,jsx_runtime.jsx)("h1",{children:i18n("icu:ForwardMessageModal__title")})]}),isEditingMessage&&null!=lonelyDraft?(0,jsx_runtime.jsx)(ForwardMessageEditor,{draft:lonelyDraft,linkPreview:lonelyLinkPreview,onChange:function(messageBody,bodyRanges){onChange([Object.assign({},lonelyDraft,{messageBody,bodyRanges})])},onChangeAttachments:function(attachments){onChange([Object.assign({},lonelyDraft,{attachments})])},removeLinkPreview,theme,i18n,RenderCompositionTextArea,onSubmit:forwardMessages}):(0,jsx_runtime.jsxs)("div",{className:"module-ForwardMessageModal__main-body",children:[(0,jsx_runtime.jsx)(SearchInput.M,{disabled:0===candidateConversations.length,i18n,placeholder:i18n("icu:contactSearchPlaceholder"),onChange:function(event){setSearchTerm(event.target.value)},ref:inputRef,value:searchTerm}),candidateConversations.length?(0,jsx_runtime.jsx)(index_esm.Z,{bounds:!0,children:function(_ref2){var contentRect=_ref2.contentRect,measureRef=_ref2.measureRef;return(0,jsx_runtime.jsx)("div",{className:"module-ForwardMessageModal__list-wrapper",ref:measureRef,children:(0,jsx_runtime.jsx)(ConversationList.p7,{dimensions:contentRect.bounds,getPreferredBadge,getRow,i18n,onClickArchiveButton:shouldNeverBeCalled.U,onClickContactCheckbox:function(conversationId,disabledReason){disabledReason!==ContactCheckbox.B.MaximumContactsSelected&&toggleSelectedConversation(conversationId)},lookupConversationWithoutUuid:shouldNeverBeCalled.q,showConversation:shouldNeverBeCalled.U,showUserNotFoundModal:shouldNeverBeCalled.U,setIsFetchingUUID:shouldNeverBeCalled.U,onSelectConversation:shouldNeverBeCalled.U,blockConversation:shouldNeverBeCalled.U,removeConversation:shouldNeverBeCalled.U,onOutgoingAudioCallInConversation:shouldNeverBeCalled.U,onOutgoingVideoCallInConversation:shouldNeverBeCalled.U,renderMessageSearchResult:function(){return(0,shouldNeverBeCalled.U)(),(0,jsx_runtime.jsx)("div",{})},rowCount,shouldRecomputeRowHeights:!1,showChooseGroupMembers:shouldNeverBeCalled.U,theme})})}}):(0,jsx_runtime.jsx)("div",{className:"module-ForwardMessageModal__no-candidate-contacts",children:i18n("icu:noContactsFound")})]}),(0,jsx_runtime.jsxs)("div",{className:"module-ForwardMessageModal__footer",children:[(0,jsx_runtime.jsx)("div",{children:selectedContacts.map((function(contact,index){return(0,jsx_runtime.jsxs)(react.Fragment,{children:[(0,jsx_runtime.jsx)(UserText.a,{text:contact.title}),index<selectedContacts.length-1?", ":""]},contact.id)}))}),(0,jsx_runtime.jsx)("div",{children:isEditingMessage||!isLonelyDraftEditable?(0,jsx_runtime.jsx)(Button.zx,{"aria-label":i18n("icu:ForwardMessageModal--continue"),className:"module-ForwardMessageModal__send-button module-ForwardMessageModal__send-button--forward","aria-disabled":!canForwardMessages,onClick:forwardMessages}):(0,jsx_runtime.jsx)(Button.zx,{"aria-label":i18n("icu:forwardMessage"),className:"module-ForwardMessageModal__send-button module-ForwardMessageModal__send-button--continue",disabled:!hasContactsSelected,onClick:function(){return setIsEditingMessage(!0)}})})]})]})})]})}function ForwardMessageEditor(_ref3){var _linkPreview$descript,_draft$messageBody,draft=_ref3.draft,linkPreview=_ref3.linkPreview,i18n=_ref3.i18n,RenderCompositionTextArea=_ref3.RenderCompositionTextArea,removeLinkPreview=_ref3.removeLinkPreview,onChange=_ref3.onChange,onChangeAttachments=_ref3.onChangeAttachments,onSubmit=_ref3.onSubmit,theme=_ref3.theme,attachments=draft.attachments;return(0,jsx_runtime.jsxs)("div",{className:"module-ForwardMessageModal__main-body",children:[linkPreview?(0,jsx_runtime.jsx)("div",{className:"module-ForwardMessageModal--link-preview",children:(0,jsx_runtime.jsx)(StagedLinkPreview.Q,{date:linkPreview.date,description:null!==(_linkPreview$descript=linkPreview.description)&&void 0!==_linkPreview$descript?_linkPreview$descript:"",domain:linkPreview.url,i18n,image:linkPreview.image,onClose:removeLinkPreview,title:linkPreview.title,url:linkPreview.url})}):null,null!=attachments&&attachments.length>0?(0,jsx_runtime.jsx)(AttachmentList.f,{attachments,i18n,onCloseAttachment:function(attachment){var newAttachments=attachments.filter((function(currentAttachment){return currentAttachment!==attachment}));onChangeAttachments(newAttachments)}}):null,(0,jsx_runtime.jsx)(RenderCompositionTextArea,{bodyRanges:draft.bodyRanges,draftText:null!==(_draft$messageBody=draft.messageBody)&&void 0!==_draft$messageBody?_draft$messageBody:"",onChange,onSubmit,theme})]})}ForwardMessageEditor.displayName="ForwardMessageEditor";var getDefaultConversation=__webpack_require__("./ts/test-both/helpers/getDefaultConversation.ts"),setupI18n=__webpack_require__("./ts/util/setupI18n.ts"),StorybookThemeContext=__webpack_require__("./.storybook/StorybookThemeContext.js"),CompositionTextArea=__webpack_require__("./ts/components/CompositionTextArea.tsx"),createAttachment=function(){var props=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{pending:!1,path:"fileName.jpg",contentType:(0,MIME.cJ)((0,dist.text)("attachment contentType",props.contentType||"")),fileName:(0,dist.text)("attachment fileName",props.fileName||""),screenshotPath:!1===props.pending?props.screenshotPath:void 0,url:(0,dist.text)("attachment url",!1===props.pending&&props.url||""),size:3433}};const ForwardMessagesModal_stories={title:"Components/ForwardMessageModal"};var i18n=(0,setupI18n.E5)("en",messages),candidateConversations=Array.from(Array(100),(function(){return(0,getDefaultConversation.E$)()})),useProps=function(){var _overrideProps$drafts,overrideProps=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{drafts:null!==(_overrideProps$drafts=overrideProps.drafts)&&void 0!==_overrideProps$drafts?_overrideProps$drafts:[],candidateConversations,doForwardMessages:(0,esm.action)("doForwardMessages"),getPreferredBadge:function(){},i18n,linkPreviewForSource:function(){},onClose:(0,esm.action)("onClose"),onChange:(0,esm.action)("onChange"),removeLinkPreview:(0,esm.action)("removeLinkPreview"),RenderCompositionTextArea:function(props){return(0,jsx_runtime.jsx)(CompositionTextArea.n,Object.assign({},props,{i18n,isFormattingSpoilersEnabled:!0,isFormattingEnabled:!0,onPickEmoji:(0,esm.action)("onPickEmoji"),skinTone:0,onSetSkinTone:(0,esm.action)("onSetSkinTone"),onTextTooLong:(0,esm.action)("onTextTooLong"),getPreferredBadge:function(){}}))},showToast:(0,esm.action)("showToast"),theme:react.useContext(StorybookThemeContext.x),regionCode:"US"}};function getMessageForwardDraft(overrideProps){var _overrideProps$previe;return{attachments:overrideProps.attachments,hasContact:Boolean(overrideProps.hasContact),isSticker:Boolean(overrideProps.isSticker),messageBody:(0,dist.text)("messageBody",overrideProps.messageBody||""),originalMessageId:"123",previews:null!==(_overrideProps$previe=overrideProps.previews)&&void 0!==_overrideProps$previe?_overrideProps$previe:[]}}function Modal(){return(0,jsx_runtime.jsx)(ForwardMessagesModal,Object.assign({},useProps()))}function WithText(){return(0,jsx_runtime.jsx)(ForwardMessagesModal,Object.assign({},useProps({drafts:[getMessageForwardDraft({messageBody:"sup"})]})))}function ASticker(){return(0,jsx_runtime.jsx)(ForwardMessagesModal,Object.assign({},useProps({drafts:[getMessageForwardDraft({isSticker:!0})]})))}function WithAContact(){return(0,jsx_runtime.jsx)(ForwardMessagesModal,Object.assign({},useProps({drafts:[getMessageForwardDraft({hasContact:!0})]})))}function ForwardMessagesModal_stories_LinkPreview(){return(0,jsx_runtime.jsx)(ForwardMessagesModal,Object.assign({},useProps({drafts:[getMessageForwardDraft({messageBody:"signal.org",previews:[{description:"You're gonna love this description. Not only does it have a lot of characters, but it will also be truncated in the UI. How cool is that??",date:Date.now(),domain:"https://www.signal.org",url:"signal.org",image:createAttachment({url:"/fixtures/kitten-4-112-112.jpg",contentType:MIME._l}),isStickerPack:!1,title:"This is a super-sweet site. And it's got some really amazing content in store for you if you just click that link. Can you click that link for me?"}]})]})))}function MediaAttachments(){return(0,jsx_runtime.jsx)(ForwardMessagesModal,Object.assign({},useProps({drafts:[getMessageForwardDraft({messageBody:"cats",attachments:[createAttachment({pending:!0}),createAttachment({contentType:MIME._l,fileName:"tina-rolf-269345-unsplash.jpg",url:"/fixtures/tina-rolf-269345-unsplash.jpg"}),createAttachment({contentType:MIME.ml,fileName:"pixabay-Soap-Bubble-7141.mp4",url:"/fixtures/pixabay-Soap-Bubble-7141.mp4",screenshotPath:"/fixtures/kitten-4-112-112.jpg"})]})]})))}function AnnouncementOnlyGroupsNonAdmin(){return(0,jsx_runtime.jsx)(ForwardMessagesModal,Object.assign({},useProps(),{candidateConversations:[(0,getDefaultConversation.E$)({announcementsOnly:!0,areWeAdmin:!1})]}))}Modal.displayName="Modal",WithText.displayName="WithText",WithText.story={name:"with text"},ASticker.displayName="ASticker",ASticker.story={name:"a sticker"},WithAContact.displayName="WithAContact",WithAContact.story={name:"with a contact"},ForwardMessagesModal_stories_LinkPreview.displayName="LinkPreview",ForwardMessagesModal_stories_LinkPreview.story={name:"link preview"},MediaAttachments.displayName="MediaAttachments",MediaAttachments.story={name:"media attachments"},AnnouncementOnlyGroupsNonAdmin.displayName="AnnouncementOnlyGroupsNonAdmin",AnnouncementOnlyGroupsNonAdmin.story={name:"announcement only groups non-admin"};var __namedExportsOrder=["Modal","WithText","ASticker","WithAContact","LinkPreview","MediaAttachments","AnnouncementOnlyGroupsNonAdmin"]},"./ts/components/InContactsIcon.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{C:()=>InContactsIcon});__webpack_require__("./node_modules/react/index.js");var classnames__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/classnames/index.js"),classnames__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(classnames__WEBPACK_IMPORTED_MODULE_1__),_Tooltip__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./ts/components/Tooltip.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/react/jsx-runtime.js");function InContactsIcon(props){var className=props.className,i18n=props.i18n,tooltipContainerRef=props.tooltipContainerRef;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)(_Tooltip__WEBPACK_IMPORTED_MODULE_2__.u,{content:i18n("icu:contactInAddressBook"),popperModifiers:[{name:"preventOverflow",options:{boundary:(null==tooltipContainerRef?void 0:tooltipContainerRef.current)||void 0}}],children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("span",{"aria-label":i18n("icu:contactInAddressBook"),className:classnames__WEBPACK_IMPORTED_MODULE_1___default()("module-in-contacts-icon__icon",className),role:"img",tabIndex:0})})}InContactsIcon.displayName="InContactsIcon"},"./ts/components/SafetyNumberChangeDialog.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{m:()=>SafetyNumberChangeDialog});var SafetyNumberChangeSource,DialogState,lodash_noop__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/lodash/noop.js"),lodash_noop__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(lodash_noop__WEBPACK_IMPORTED_MODULE_0__),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/index.js"),classnames__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/classnames/index.js"),classnames__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(classnames__WEBPACK_IMPORTED_MODULE_2__),_Avatar__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./ts/components/Avatar.tsx"),_ConfirmationDialog__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./ts/components/ConfirmationDialog.tsx"),_InContactsIcon__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./ts/components/InContactsIcon.tsx"),_Modal__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./ts/components/Modal.tsx"),_types_Util__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./ts/types/Util.ts"),_util_isInSystemContacts__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__("./ts/util/isInSystemContacts.ts"),_util_missingCaseError__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("./ts/util/missingCaseError.ts"),_ContextMenu__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./ts/components/ContextMenu.tsx"),_util_theme__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./ts/util/theme.ts"),_util_isNotNil__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__("./ts/util/isNotNil.ts"),_types_Stories__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("./ts/types/Stories.ts"),_UserText__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("./ts/components/UserText.tsx"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("./node_modules/react/jsx-runtime.js");function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function SafetyNumberChangeDialog(_ref){var confirmText=_ref.confirmText,contacts=_ref.contacts,getPreferredBadge=_ref.getPreferredBadge,i18n=_ref.i18n,onCancel=_ref.onCancel,onConfirm=_ref.onConfirm,removeFromStory=_ref.removeFromStory,renderSafetyNumber=_ref.renderSafetyNumber,theme=_ref.theme,totalCount=contacts.reduce((function(count,item){return count+item.contacts.length}),0),allVerified=contacts.every((function(item){return item.contacts.every((function(contact){return contact.isVerified}))})),_React$useState2=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_1__.useState(function getStartingDialogState(count){return 0===count?DialogState.ExplicitReviewComplete:function doesRequireExplicitReviewMode(count){return count>5}(count)?DialogState.ExplicitReviewNeeded:DialogState.StartingInReview}(totalCount)),2),dialogState=_React$useState2[0],setDialogState=_React$useState2[1],_React$useState4=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_1__.useState(void 0),2),selectedContact=_React$useState4[0],setSelectedContact=_React$useState4[1],cancelButtonRef=react__WEBPACK_IMPORTED_MODULE_1__.createRef();react__WEBPACK_IMPORTED_MODULE_1__.useEffect((function(){cancelButtonRef&&cancelButtonRef.current&&cancelButtonRef.current.focus()}),[cancelButtonRef,contacts]),react__WEBPACK_IMPORTED_MODULE_1__.useEffect((function(){dialogState!==DialogState.ExplicitReviewStep||0!==totalCount&&!allVerified||setDialogState(DialogState.ExplicitReviewComplete)}),[allVerified,dialogState,setDialogState,totalCount]);var _text,text,onClose=selectedContact?function(){setSelectedContact(void 0)}:onCancel;if(selectedContact)return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_Modal__WEBPACK_IMPORTED_MODULE_6__.u_,{modalName:"SafetyNumberChangeDialog",hasXButton:!0,i18n,onClose,children:renderSafetyNumber({contactID:selectedContact.id,onClose})});if(dialogState===DialogState.StartingInReview||dialogState===DialogState.ExplicitReviewStep)return _text=dialogState===DialogState.ExplicitReviewStep?i18n("icu:safetyNumberChangeDialog_done"):allVerified||0===totalCount?confirmText||i18n("icu:safetyNumberChangeDialog_send"):confirmText||i18n("icu:sendAnyway"),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(_ConfirmationDialog__WEBPACK_IMPORTED_MODULE_4__.U,{dialogName:"SafetyNumberChangeDialog.reviewing",actions:[{action:function(){dialogState===DialogState.ExplicitReviewStep?setDialogState(DialogState.ExplicitReviewComplete):onConfirm()},text:_text,style:"affirmative"}],hasXButton:!0,i18n,moduleClassName:"module-SafetyNumberChangeDialog__confirm-dialog",noMouseClose:!0,onCancel:onClose,onClose:lodash_noop__WEBPACK_IMPORTED_MODULE_0___default(),children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"module-SafetyNumberChangeDialog__shield-icon"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"module-SafetyNumberChangeDialog__title",children:i18n("icu:safetyNumberChanges")}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"module-SafetyNumberChangeDialog__message",children:i18n("icu:safetyNumberChangeDialog__message")}),contacts.map((function(section){var _section$story;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(ContactSection,{section,getPreferredBadge,i18n,removeFromStory,setSelectedContact,theme},(null===(_section$story=section.story)||void 0===_section$story?void 0:_section$story.name)||"default")}))]},"SafetyNumberChangeDialog.reviewing");if(dialogState===DialogState.ExplicitReviewNeeded)text=confirmText||i18n("icu:sendAnyway");else{if(dialogState!==DialogState.ExplicitReviewComplete)throw(0,_util_missingCaseError__WEBPACK_IMPORTED_MODULE_13__.b)(dialogState);text=confirmText||i18n("icu:safetyNumberChangeDialog_send")}var actions=[{action:onConfirm,text,style:"affirmative"}];return dialogState===DialogState.ExplicitReviewNeeded&&actions.unshift({action:function(){return setDialogState(DialogState.ExplicitReviewStep)},text:i18n("icu:safetyNumberChangeDialog__review")}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(_ConfirmationDialog__WEBPACK_IMPORTED_MODULE_4__.U,{dialogName:"SafetyNumberChangeDialog.manyContacts",actions,hasXButton:!0,i18n,moduleClassName:"module-SafetyNumberChangeDialog__confirm-dialog",noMouseClose:!0,noDefaultCancelButton:dialogState===DialogState.ExplicitReviewNeeded,onCancel:onClose,onClose:lodash_noop__WEBPACK_IMPORTED_MODULE_0___default(),children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"module-SafetyNumberChangeDialog__shield-icon"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"module-SafetyNumberChangeDialog__title",children:i18n("icu:safetyNumberChanges")}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:classnames__WEBPACK_IMPORTED_MODULE_2___default()("module-SafetyNumberChangeDialog__message",dialogState===DialogState.ExplicitReviewComplete?"module-SafetyNumberChangeDialog__message--narrow":void 0),children:dialogState===DialogState.ExplicitReviewNeeded?i18n("icu:safetyNumberChangeDialog__many-contacts",{count:totalCount}):i18n("icu:safetyNumberChangeDialog__post-review")})]},"SafetyNumberChangeDialog.manyContacts")}function ContactSection(_ref2){var section=_ref2.section,getPreferredBadge=_ref2.getPreferredBadge,i18n=_ref2.i18n,removeFromStory=_ref2.removeFromStory,setSelectedContact=_ref2.setSelectedContact,theme=_ref2.theme;if(0===section.contacts.length)return null;if(!section.story)return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("ul",{className:"module-SafetyNumberChangeDialog__contacts",children:section.contacts.map((function(contact){var shouldShowNumber=Boolean(contact.name||contact.profileName);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(ContactRow,{contact,getPreferredBadge,i18n,removeFromStory,setSelectedContact,shouldShowNumber,theme},contact.id)}))});var distributionId=section.story.distributionId,uuids=section.contacts.map((function(contact){return contact.uuid})).filter(_util_isNotNil__WEBPACK_IMPORTED_MODULE_14__.D),sectionName=distributionId===_types_Stories__WEBPACK_IMPORTED_MODULE_10__.qn?i18n("icu:Stories__mine"):section.story.name;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"module-SafetyNumberChangeDialog__section",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"module-SafetyNumberChangeDialog__row",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("div",{className:"module-SafetyNumberChangeDialog__row__story-name",children:sectionName}),distributionId&&removeFromStory&&uuids.length>1&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(SectionButtonWithMenu,{ariaLabel:i18n("icu:safetyNumberChangeDialog__actions-story",{story:sectionName}),i18n,memberCount:uuids.length,storyName:sectionName,theme,removeFromStory:function(){removeFromStory(distributionId,uuids)}})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("ul",{className:"module-SafetyNumberChangeDialog__contacts",children:section.contacts.map((function(contact){var shouldShowNumber=Boolean(contact.name||contact.profileName);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(ContactRow,{contact,distributionId,getPreferredBadge,i18n,removeFromStory,setSelectedContact,shouldShowNumber,theme},contact.id)}))})]})}function SectionButtonWithMenu(_ref3){var ariaLabel=_ref3.ariaLabel,i18n=_ref3.i18n,removeFromStory=_ref3.removeFromStory,storyName=_ref3.storyName,memberCount=_ref3.memberCount,theme=_ref3.theme,_React$useState6=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_1__.useState(!1),2),isConfirming=_React$useState6[0],setIsConfirming=_React$useState6[1];return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_ContextMenu__WEBPACK_IMPORTED_MODULE_8__.x,{ariaLabel,i18n,menuOptions:[{icon:"module-SafetyNumberChangeDialog__menu-icon--delete",label:i18n("icu:safetyNumberChangeDialog__remove-all"),onClick:function(){return setIsConfirming(!0)}}],moduleClassName:"module-SafetyNumberChangeDialog__row__chevron",theme:theme===_types_Util__WEBPACK_IMPORTED_MODULE_7__.f8.dark?_util_theme__WEBPACK_IMPORTED_MODULE_9__.Q.Dark:_util_theme__WEBPACK_IMPORTED_MODULE_9__.Q.Light}),isConfirming&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_ConfirmationDialog__WEBPACK_IMPORTED_MODULE_4__.U,{dialogName:"SafetyNumberChangeDialog.confirm-remove-all",actions:[{action:function(){removeFromStory(),setIsConfirming(!1)},text:i18n("icu:safetyNumberChangeDialog__remove-all"),style:"affirmative"}],i18n,noMouseClose:!0,onCancel:function(){return setIsConfirming(!1)},onClose:lodash_noop__WEBPACK_IMPORTED_MODULE_0___default(),children:i18n("icu:safetyNumberChangeDialog__confirm-remove-all",{story:storyName,count:memberCount})},"SafetyNumberChangeDialog.confirm-remove-all")]})}function ContactRow(_ref4){var contact=_ref4.contact,distributionId=_ref4.distributionId,getPreferredBadge=_ref4.getPreferredBadge,i18n=_ref4.i18n,removeFromStory=_ref4.removeFromStory,setSelectedContact=_ref4.setSelectedContact,shouldShowNumber=_ref4.shouldShowNumber,theme=_ref4.theme,uuid=contact.uuid;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("li",{className:"module-SafetyNumberChangeDialog__row",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_Avatar__WEBPACK_IMPORTED_MODULE_3__.qE,{acceptedMessageRequest:contact.acceptedMessageRequest,avatarPath:contact.avatarPath,badge:getPreferredBadge(contact.badges),color:contact.color,conversationType:"direct",i18n,isMe:contact.isMe,phoneNumber:contact.phoneNumber,profileName:contact.profileName,theme,title:contact.title,sharedGroupNames:contact.sharedGroupNames,size:_Avatar__WEBPACK_IMPORTED_MODULE_3__.DZ.THIRTY_TWO,unblurredAvatarPath:contact.unblurredAvatarPath}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"module-SafetyNumberChangeDialog__row--wrapper",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"module-SafetyNumberChangeDialog__row--name",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_UserText__WEBPACK_IMPORTED_MODULE_11__.a,{text:contact.title}),(0,_util_isInSystemContacts__WEBPACK_IMPORTED_MODULE_15__.H)(contact)&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("span",{children:[" ",(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_InContactsIcon__WEBPACK_IMPORTED_MODULE_5__.C,{i18n})]})]}),shouldShowNumber||contact.isVerified?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsxs)("div",{className:"module-SafetyNumberChangeDialog__row--subtitle",children:[shouldShowNumber&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("span",{className:"module-SafetyNumberChangeDialog__rtl-span",children:contact.phoneNumber}),shouldShowNumber&&contact.isVerified&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("span",{className:"module-SafetyNumberChangeDialog__rtl-span",children:""}),contact.isVerified&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("span",{className:"module-SafetyNumberChangeDialog__rtl-span",children:i18n("icu:verified")})]}):null]}),distributionId&&removeFromStory&&uuid?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(RowButtonWithMenu,{ariaLabel:i18n("icu:safetyNumberChangeDialog__actions-contact",{contact:contact.title}),i18n,theme,removeFromStory:function(){return removeFromStory(distributionId,[uuid])},verifyContact:function(){return setSelectedContact(contact)}}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)("button",{className:"module-SafetyNumberChangeDialog__row__view",onClick:function(){setSelectedContact(contact)},tabIndex:0,type:"button",children:i18n("icu:view")})]},contact.id)}function RowButtonWithMenu(_ref5){var ariaLabel=_ref5.ariaLabel,i18n=_ref5.i18n,removeFromStory=_ref5.removeFromStory,verifyContact=_ref5.verifyContact,theme=_ref5.theme;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_12__.jsx)(_ContextMenu__WEBPACK_IMPORTED_MODULE_8__.x,{ariaLabel,i18n,menuOptions:[{icon:"module-SafetyNumberChangeDialog__menu-icon--verify",label:i18n("icu:safetyNumberChangeDialog__verify-number"),onClick:verifyContact},{icon:"module-SafetyNumberChangeDialog__menu-icon--delete",label:i18n("icu:safetyNumberChangeDialog__remove"),onClick:removeFromStory}],moduleClassName:"module-SafetyNumberChangeDialog__row__chevron",theme:theme===_types_Util__WEBPACK_IMPORTED_MODULE_7__.f8.dark?_util_theme__WEBPACK_IMPORTED_MODULE_9__.Q.Dark:_util_theme__WEBPACK_IMPORTED_MODULE_9__.Q.Light})}!function(SafetyNumberChangeSource){SafetyNumberChangeSource.Calling="Calling",SafetyNumberChangeSource.MessageSend="MessageSend",SafetyNumberChangeSource.Story="Story"}(SafetyNumberChangeSource||(SafetyNumberChangeSource={})),function(DialogState){DialogState.StartingInReview="StartingInReview",DialogState.ExplicitReviewNeeded="ExplicitReviewNeeded",DialogState.ExplicitReviewStep="ExplicitReviewStep",DialogState.ExplicitReviewComplete="ExplicitReviewComplete"}(DialogState||(DialogState={})),SafetyNumberChangeDialog.displayName="SafetyNumberChangeDialog",ContactSection.displayName="ContactSection",ContactRow.displayName="ContactRow",RowButtonWithMenu.displayName="RowButtonWithMenu"},"./ts/components/SearchInput.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{M:()=>SearchInput});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),classnames__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/classnames/index.js"),classnames__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(classnames__WEBPACK_IMPORTED_MODULE_1__),_util_getClassNamesFor__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./ts/util/getClassNamesFor.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/react/jsx-runtime.js"),SearchInput=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)((function SearchInputInner(_ref,ref){var children=_ref.children,_ref$disabled=_ref.disabled,disabled=void 0!==_ref$disabled&&_ref$disabled,_ref$hasSearchIcon=_ref.hasSearchIcon,hasSearchIcon=void 0===_ref$hasSearchIcon||_ref$hasSearchIcon,i18n=_ref.i18n,label=_ref.label,moduleClassName=_ref.moduleClassName,onClear=_ref.onClear,onBlur=_ref.onBlur,onChange=_ref.onChange,onKeyDown=_ref.onKeyDown,placeholder=_ref.placeholder,value=_ref.value,getClassName=(0,_util_getClassNamesFor__WEBPACK_IMPORTED_MODULE_2__.h)("module-SearchInput",moduleClassName);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsxs)("div",{className:getClassName("__container"),children:[hasSearchIcon&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("i",{className:getClassName("__icon")}),children,(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("input",{"aria-label":label||i18n("icu:search"),className:classnames__WEBPACK_IMPORTED_MODULE_1___default()(getClassName("__input"),value&&getClassName("__input--with-text"),children&&getClassName("__input--with-children")),dir:"auto",disabled,onBlur,onChange,onKeyDown:function(event){var ctrlKey=event.ctrlKey,key=event.key;"linux"===window.platform&&ctrlKey&&"/"===key?(event.preventDefault(),event.stopPropagation()):"Escape"===key&&onClear&&(onClear(),event.preventDefault(),event.stopPropagation()),null==onKeyDown||onKeyDown(event)},placeholder,ref,type:"text",value}),value&&onClear&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("button",{"aria-label":i18n("icu:cancel"),className:getClassName("__cancel"),onClick:onClear,tabIndex:-1,type:"button"})]})}))},"./ts/components/Tooltip.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{T:()=>TooltipPlacement,u:()=>Tooltip});var lodash_noop__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/lodash/noop.js"),lodash_noop__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(lodash_noop__WEBPACK_IMPORTED_MODULE_0__),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/index.js"),classnames__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/classnames/index.js"),classnames__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(classnames__WEBPACK_IMPORTED_MODULE_2__),react_popper__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./node_modules/react-popper/lib/esm/Manager.js"),react_popper__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./node_modules/react-popper/lib/esm/Reference.js"),react_popper__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("./node_modules/react-popper/lib/esm/Popper.js"),_util_theme__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./ts/util/theme.ts"),_util_refMerger__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./ts/util/refMerger.ts"),_util_popperUtil__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./ts/util/popperUtil.ts"),_services_InteractionMode__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./ts/services/InteractionMode.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./node_modules/react/jsx-runtime.js");function _toConsumableArray(arr){return function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||_unsupportedIterableToArray(arr)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||_unsupportedIterableToArray(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var TooltipPlacement,TooltipEventWrapper=react__WEBPACK_IMPORTED_MODULE_1__.forwardRef((function TooltipEvent(_ref,ref){var onHoverChanged=_ref.onHoverChanged,children=_ref.children,wrapperRef=react__WEBPACK_IMPORTED_MODULE_1__.useRef(null),on=react__WEBPACK_IMPORTED_MODULE_1__.useCallback((function(){onHoverChanged(!0)}),[onHoverChanged]),off=react__WEBPACK_IMPORTED_MODULE_1__.useCallback((function(){onHoverChanged(!1)}),[onHoverChanged]),onFocus=react__WEBPACK_IMPORTED_MODULE_1__.useCallback((function(){"keyboard"===(0,_services_InteractionMode__WEBPACK_IMPORTED_MODULE_7__.G)()&&on()}),[on]);return react__WEBPACK_IMPORTED_MODULE_1__.useEffect((function(){var wrapperEl=wrapperRef.current;return wrapperEl?(wrapperEl.addEventListener("mouseenter",on),wrapperEl.addEventListener("mouseleave",off),function(){wrapperEl.removeEventListener("mouseenter",on),wrapperEl.removeEventListener("mouseleave",off)}):lodash_noop__WEBPACK_IMPORTED_MODULE_0___default()}),[on,off]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)("span",{onFocus,onBlur:off,ref:(0,_util_refMerger__WEBPACK_IMPORTED_MODULE_4__.M)(ref,wrapperRef),children})}));function Tooltip(_ref2){var children=_ref2.children,className=_ref2.className,content=_ref2.content,direction=_ref2.direction,sticky=_ref2.sticky,theme=_ref2.theme,_ref2$popperModifiers=_ref2.popperModifiers,popperModifiers=void 0===_ref2$popperModifiers?[]:_ref2$popperModifiers,_React$useState2=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_1__.useState(!1),2),isHovering=_React$useState2[0],setIsHovering=_React$useState2[1],showTooltip=isHovering||Boolean(sticky),tooltipThemeClassName=theme?`module-tooltip--${(0,_util_theme__WEBPACK_IMPORTED_MODULE_3__.j)(theme)}`:void 0;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsxs)(react_popper__WEBPACK_IMPORTED_MODULE_8__.dK,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(react_popper__WEBPACK_IMPORTED_MODULE_9__.s,{children:function(_ref3){var ref=_ref3.ref;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(TooltipEventWrapper,{ref,onHoverChanged:setIsHovering,children})}}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)(react_popper__WEBPACK_IMPORTED_MODULE_10__.r,{placement:direction,modifiers:[(0,_util_popperUtil__WEBPACK_IMPORTED_MODULE_5__.E)(12)].concat(_toConsumableArray(popperModifiers)),children:function(_ref4){var arrowProps=_ref4.arrowProps,placement=_ref4.placement,ref=_ref4.ref,style=_ref4.style;return showTooltip&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsxs)("div",{className:classnames__WEBPACK_IMPORTED_MODULE_2___default()("module-tooltip",tooltipThemeClassName,className),ref,style,"data-placement":placement,children:[content,(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_6__.jsx)("div",{className:"module-tooltip-arrow",ref:arrowProps.ref,style:arrowProps.style})]})}})]})}!function(TooltipPlacement){TooltipPlacement.Top="top",TooltipPlacement.Right="right",TooltipPlacement.Bottom="bottom",TooltipPlacement.Left="left"}(TooltipPlacement||(TooltipPlacement={})),Tooltip.displayName="Tooltip"},"./ts/components/conversation/AttachmentList.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{f:()=>AttachmentList});__webpack_require__("./node_modules/react/index.js");var _Image__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./ts/components/conversation/Image.tsx"),_StagedGenericAttachment__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./ts/components/conversation/StagedGenericAttachment.tsx"),_StagedPlaceholderAttachment__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./ts/components/conversation/StagedPlaceholderAttachment.tsx"),_types_Attachment__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./ts/types/Attachment.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./node_modules/react/jsx-runtime.js");function AttachmentList(_ref){var attachments=_ref.attachments,canEditImages=_ref.canEditImages,i18n=_ref.i18n,onAddAttachment=_ref.onAddAttachment,onClickAttachment=_ref.onClickAttachment,onCloseAttachment=_ref.onCloseAttachment,onClose=_ref.onClose;if(!attachments.length)return null;var allVisualAttachments=(0,_types_Attachment__WEBPACK_IMPORTED_MODULE_4__.pU)(attachments);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)("div",{className:"module-attachments",children:[onClose&&attachments.length>1?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-attachments__header",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("button",{type:"button",onClick:onClose,className:"module-attachments__close-button","aria-label":i18n("icu:close")})}):null,(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)("div",{className:"module-attachments__rail",children:[(attachments||[]).map((function(attachment,index){var url=function getUrl(attachment){var _attachment$screensho;if(!attachment.pending)return"screenshot"in attachment&&(null===(_attachment$screensho=attachment.screenshot)||void 0===_attachment$screensho?void 0:_attachment$screensho.url)||attachment.url}(attachment),key=url||attachment.path||attachment.fileName||index,isImage=(0,_types_Attachment__WEBPACK_IMPORTED_MODULE_4__.VV)(attachment),isVideo=(0,_types_Attachment__WEBPACK_IMPORTED_MODULE_4__.fr)(attachment),closeAttachment=function(){return onCloseAttachment(attachment)};if(isImage&&(0,_types_Attachment__WEBPACK_IMPORTED_MODULE_4__.cR)([attachment])||isVideo||attachment.pending){var isDownloaded=!attachment.pending,imageUrl=url||(isVideo?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQAAAAA3bvkkAAAACklEQVR42mNiAAAABgADm78GJQAAAABJRU5ErkJggg==":void 0),clickAttachment=onClickAttachment?function(){return onClickAttachment(attachment)}:void 0,imgElement=(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_Image__WEBPACK_IMPORTED_MODULE_1__.E,{alt:i18n("icu:stagedImageAttachment",{path:attachment.fileName||url||index.toString()}),className:"module-staged-attachment",i18n,attachment,isDownloaded,curveBottomLeft:_Image__WEBPACK_IMPORTED_MODULE_1__.v.Tiny,curveBottomRight:_Image__WEBPACK_IMPORTED_MODULE_1__.v.Tiny,curveTopLeft:_Image__WEBPACK_IMPORTED_MODULE_1__.v.Tiny,curveTopRight:_Image__WEBPACK_IMPORTED_MODULE_1__.v.Tiny,playIconOverlay:isVideo,height:120,width:120,url:imageUrl,closeButton:!0,onClick:clickAttachment,onClickClose:closeAttachment,onError:closeAttachment},key);return isImage&&canEditImages?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)("div",{className:"module-attachments--editable",children:[imgElement,(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-attachments__edit-icon"})]}):imgElement}return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_StagedGenericAttachment__WEBPACK_IMPORTED_MODULE_2__.S,{attachment,i18n,onClose:closeAttachment},key)})),allVisualAttachments&&onAddAttachment?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_StagedPlaceholderAttachment__WEBPACK_IMPORTED_MODULE_3__.D,{onClick:onAddAttachment,i18n}):null]})]})}AttachmentList.displayName="AttachmentList"},"./ts/components/conversation/Image.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{E:()=>Image,v:()=>CurveType});var CurveType,react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),classnames__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/classnames/index.js"),classnames__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(classnames__WEBPACK_IMPORTED_MODULE_1__),react_blurhash__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/react-blurhash/es/index.js"),_Spinner__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./ts/components/Spinner.tsx"),_types_Attachment__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./ts/types/Attachment.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./node_modules/react/jsx-runtime.js");function Image(_ref){var alt=_ref.alt,attachment=_ref.attachment,blurHash=_ref.blurHash,bottomOverlay=_ref.bottomOverlay,className=_ref.className,closeButton=_ref.closeButton,curveBottomLeft=_ref.curveBottomLeft,curveBottomRight=_ref.curveBottomRight,curveTopLeft=_ref.curveTopLeft,curveTopRight=_ref.curveTopRight,darkOverlay=_ref.darkOverlay,isDownloaded=_ref.isDownloaded,_ref$height=_ref.height,height=void 0===_ref$height?0:_ref$height,i18n=_ref.i18n,noBackground=_ref.noBackground,noBorder=_ref.noBorder,onClick=_ref.onClick,onClickClose=_ref.onClickClose,onError=_ref.onError,overlayText=_ref.overlayText,playIconOverlay=_ref.playIconOverlay,tabIndex=_ref.tabIndex,theme=_ref.theme,url=_ref.url,_ref$width=_ref.width,width=void 0===_ref$width?0:_ref$width,_ref$cropWidth=_ref.cropWidth,cropWidth=void 0===_ref$cropWidth?0:_ref$cropWidth,_ref$cropHeight=_ref.cropHeight,cropHeight=void 0===_ref$cropHeight?0:_ref$cropHeight,_ref2=attachment||{caption:null,pending:!0},caption=_ref2.caption,pending=_ref2.pending,imgNotDownloaded=!isDownloaded&&!(0,_types_Attachment__WEBPACK_IMPORTED_MODULE_4__.TG)(attachment),resolvedBlurHash=blurHash||(0,_types_Attachment__WEBPACK_IMPORTED_MODULE_4__.d0)(theme),curveStyles={borderTopLeftRadius:curveTopLeft||CurveType.None,borderTopRightRadius:curveTopRight||CurveType.None,borderBottomLeftRadius:curveBottomLeft||CurveType.None,borderBottomRightRadius:curveBottomRight||CurveType.None},canClick=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((function(){return null!=onClick&&!pending}),[pending,onClick]),handleClick=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((function(event){if(!canClick)return event.preventDefault(),void event.stopPropagation();onClick&&(event.preventDefault(),event.stopPropagation(),onClick(attachment))}),[attachment,canClick,onClick]),handleKeyDown=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((function(event){if(!canClick)return event.preventDefault(),void event.stopPropagation();!onClick||"Enter"!==event.key&&"Space"!==event.key||(event.preventDefault(),event.stopPropagation(),onClick(attachment))}),[attachment,canClick,onClick]);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)("div",{className:classnames__WEBPACK_IMPORTED_MODULE_1___default()("module-image",className,noBackground?null:"module-image--with-background",cropWidth||cropHeight?"module-image--cropped":null),style:Object.assign({width:width-cropWidth,height:height-cropHeight},curveStyles),children:[pending?blurHash?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsxs)("div",{className:"module-image__download-pending",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(react_blurhash__WEBPACK_IMPORTED_MODULE_2__.E,{hash:blurHash,width,height,style:{display:"block"}}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-image__download-pending--spinner-container",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-image__download-pending--spinner",title:i18n("icu:loading"),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_Spinner__WEBPACK_IMPORTED_MODULE_3__.$j,{moduleClassName:"module-image-spinner",svgSize:"small"})})})]}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-image__loading-placeholder",style:{height:`${height}px`,width:`${width}px`,lineHeight:`${height}px`,textAlign:"center"},title:i18n("icu:loading"),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(_Spinner__WEBPACK_IMPORTED_MODULE_3__.$j,{svgSize:"normal"})}):url?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("img",{onError,className:"module-image__image",alt,height,width,src:url}):resolvedBlurHash?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)(react_blurhash__WEBPACK_IMPORTED_MODULE_2__.E,{hash:resolvedBlurHash,width,height,style:{display:"block"}}):null,caption?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("img",{className:"module-image__caption-icon",src:"images/caption-shadow.svg",alt:i18n("icu:imageCaptionIconAlt")}):null,bottomOverlay?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-image__bottom-overlay",style:{borderBottomLeftRadius:curveBottomLeft||CurveType.None,borderBottomRightRadius:curveBottomRight||CurveType.None}}):null,pending||imgNotDownloaded||!playIconOverlay?null:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-image__play-overlay__circle",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-image__play-overlay__icon"})}),overlayText?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("div",{className:"module-image__text-container",style:{lineHeight:`${height}px`},children:overlayText}):null,canClick?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("button",{type:"button",className:classnames__WEBPACK_IMPORTED_MODULE_1___default()("module-image__border-overlay",{"module-image__border-overlay--with-border":!noBorder,"module-image__border-overlay--with-click-handler":canClick,"module-image__border-overlay--dark":darkOverlay,"module-image--not-downloaded":imgNotDownloaded}),style:curveStyles,onClick:handleClick,onKeyDown:handleKeyDown,tabIndex,children:imgNotDownloaded?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("span",{}):null}):null,closeButton?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_5__.jsx)("button",{type:"button",onClick:function(e){e.preventDefault(),e.stopPropagation(),onClickClose&&onClickClose(attachment)},className:"module-image__close-button",title:i18n("icu:remove-attachment"),"aria-label":i18n("icu:remove-attachment")}):null]})}!function(CurveType){CurveType[CurveType.None=0]="None",CurveType[CurveType.Tiny=4]="Tiny",CurveType[CurveType.Small=10]="Small",CurveType[CurveType.Normal=18]="Normal"}(CurveType||(CurveType={})),Image.displayName="Image"},"./ts/components/conversation/LinkPreviewDate.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{t:()=>LinkPreviewDate});__webpack_require__("./node_modules/react/index.js");var moment=__webpack_require__("./node_modules/moment/moment.js"),moment_default=__webpack_require__.n(moment);var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");function LinkPreviewDate(_ref){var date=_ref.date,_ref$className=_ref.className,className=void 0===_ref$className?"":_ref$className,dateMoment=function isLinkPreviewDateValid(value){var maximumLinkPreviewDate=Date.now()+864e5;return"number"==typeof value&&0!==value&&Number.isFinite(value)&&value<maximumLinkPreviewDate}(date)?moment_default()(date):null;return dateMoment?(0,jsx_runtime.jsx)("time",{className,dateTime:dateMoment.toISOString(),children:dateMoment.format("ll")}):null}},"./ts/components/conversation/StagedGenericAttachment.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{S:()=>StagedGenericAttachment});__webpack_require__("./node_modules/react/index.js");var _types_Attachment__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./ts/types/Attachment.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/react/jsx-runtime.js");function StagedGenericAttachment(_ref){var attachment=_ref.attachment,i18n=_ref.i18n,onClose=_ref.onClose,fileName=attachment.fileName,contentType=attachment.contentType,extension=(0,_types_Attachment__WEBPACK_IMPORTED_MODULE_1__.Gq)({contentType,fileName});return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsxs)("div",{className:"module-staged-attachment module-staged-generic-attachment",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)("button",{type:"button",className:"module-staged-generic-attachment__close-button","aria-label":i18n("icu:close"),onClick:function(){onClose&&onClose(attachment)}}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)("div",{className:"module-staged-generic-attachment__icon",children:extension?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)("div",{className:"module-staged-generic-attachment__icon__extension",children:extension}):null}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_2__.jsx)("div",{className:"module-staged-generic-attachment__filename",children:fileName})]})}StagedGenericAttachment.displayName="StagedGenericAttachment"},"./ts/components/conversation/StagedPlaceholderAttachment.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{D:()=>StagedPlaceholderAttachment});__webpack_require__("./node_modules/react/index.js");var react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/jsx-runtime.js");function StagedPlaceholderAttachment(_ref){var i18n=_ref.i18n,onClick=_ref.onClick;return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)("button",{type:"button",className:"module-staged-placeholder-attachment",onClick,title:i18n("icu:addImageOrVideoattachment"),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)("div",{className:"module-staged-placeholder-attachment__plus-icon"})})}StagedPlaceholderAttachment.displayName="StagedPlaceholderAttachment"},"./ts/messages/helpers.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Zw:()=>getSourceUuid,b5:()=>getSource,dc:()=>getPaymentEventNotificationText,gD:()=>getSourceDevice,rW:()=>getPaymentEventDescription,zK:()=>isStory});var _logging_log__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./ts/logging/log.ts"),_types_Payment__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./ts/types/Payment.ts"),_util_missingCaseError__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./ts/util/missingCaseError.ts");function isIncoming(message){return"incoming"===message.type}function isOutgoing(message){return"outgoing"===message.type}function isStory(message){return"story"===message.type}function getPaymentEventNotificationText(payment,senderTitle,conversationTitle,senderIsMe,i18n){return payment.kind===_types_Payment__WEBPACK_IMPORTED_MODULE_1__.s.Notification?i18n("icu:payment-event-notification-label"):getPaymentEventDescription(payment,senderTitle,conversationTitle,senderIsMe,i18n)}function getPaymentEventDescription(payment,senderTitle,conversationTitle,senderIsMe,i18n){var kind=payment.kind;if(kind===_types_Payment__WEBPACK_IMPORTED_MODULE_1__.s.Notification)return senderIsMe?null!=conversationTitle?i18n("icu:payment-event-notification-message-you-label",{receiver:conversationTitle}):i18n("icu:payment-event-notification-message-you-label-without-receiver"):i18n("icu:payment-event-notification-message-label",{sender:senderTitle});if(kind===_types_Payment__WEBPACK_IMPORTED_MODULE_1__.s.ActivationRequest)return senderIsMe?null!=conversationTitle?i18n("icu:payment-event-activation-request-you-label",{receiver:conversationTitle}):i18n("icu:payment-event-activation-request-you-label-without-receiver"):i18n("icu:payment-event-activation-request-label",{sender:senderTitle});if(kind===_types_Payment__WEBPACK_IMPORTED_MODULE_1__.s.Activation)return senderIsMe?i18n("icu:payment-event-activated-you-label"):i18n("icu:payment-event-activated-label",{sender:senderTitle});throw(0,_util_missingCaseError__WEBPACK_IMPORTED_MODULE_2__.b)(kind)}function getSource(message){return isIncoming(message)||isStory(message)?message.source:(isOutgoing(message)||_logging_log__WEBPACK_IMPORTED_MODULE_0__.warn("Message.getSource: Called for non-incoming/non-outgoing message"),window.textsecure.storage.user.getNumber())}function getSourceDevice(message){var sourceDevice=message.sourceDevice;return isIncoming(message)||isStory(message)?sourceDevice:(isOutgoing(message)||_logging_log__WEBPACK_IMPORTED_MODULE_0__.warn("Message.getSourceDevice: Called for non-incoming/non-outgoing message"),sourceDevice||window.textsecure.storage.user.getDeviceId())}function getSourceUuid(message){var _window$textsecure$st;return isIncoming(message)||isStory(message)?message.sourceUuid:(isOutgoing(message)||_logging_log__WEBPACK_IMPORTED_MODULE_0__.warn("Message.getSourceUuid: Called for non-incoming/non-outgoing message"),null===(_window$textsecure$st=window.textsecure.storage.user.getUuid())||void 0===_window$textsecure$st?void 0:_window$textsecure$st.toString())}},"./ts/services/InteractionMode.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{G:()=>getInteractionMode});var interactionMode="mouse";function getInteractionMode(){return interactionMode}},"./ts/types/Payment.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";var PaymentEventKind;__webpack_require__.d(__webpack_exports__,{s:()=>PaymentEventKind}),function(PaymentEventKind){PaymentEventKind[PaymentEventKind.Notification=1]="Notification",PaymentEventKind[PaymentEventKind.ActivationRequest=2]="ActivationRequest",PaymentEventKind[PaymentEventKind.Activation=3]="Activation"}(PaymentEventKind||(PaymentEventKind={}))},"./ts/types/PhoneNumber.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";var memoizee__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/memoizee/index.js"),memoizee__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(memoizee__WEBPACK_IMPORTED_MODULE_0__),_util_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./ts/util/libphonenumberInstance.ts");__webpack_require__("./ts/logging/log.ts"),__webpack_require__("./ts/types/errors.ts");memoizee__WEBPACK_IMPORTED_MODULE_0___default()((function _format(phoneNumber,options){try{var ourRegionCode=options.ourRegionCode,parsedNumber=_util_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_1__.eE.parse(phoneNumber),regionCode=_util_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_1__.eE.getRegionCodeForNumber(parsedNumber);return ourRegionCode&&regionCode===ourRegionCode?_util_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_1__.eE.format(parsedNumber,_util_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_1__.M9.NATIONAL):_util_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_1__.eE.format(parsedNumber,_util_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_1__.M9.INTERNATIONAL)}catch(error){return phoneNumber}}),{primitive:!0,normalizer:function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return JSON.stringify(args)},max:5e3})},"./ts/types/Toast.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";var ToastType;__webpack_require__.d(__webpack_exports__,{p:()=>ToastType}),function(ToastType){ToastType.AddingUserToGroup="AddingUserToGroup",ToastType.AlreadyGroupMember="AlreadyGroupMember",ToastType.AlreadyRequestedToJoin="AlreadyRequestedToJoin",ToastType.Blocked="Blocked",ToastType.BlockedGroup="BlockedGroup",ToastType.CannotEditMessage="CannotEditMessage",ToastType.CannotForwardEmptyMessage="CannotForwardEmptyMessage",ToastType.CannotMixMultiAndNonMultiAttachments="CannotMixMultiAndNonMultiAttachments",ToastType.CannotOpenGiftBadgeIncoming="CannotOpenGiftBadgeIncoming",ToastType.CannotOpenGiftBadgeOutgoing="CannotOpenGiftBadgeOutgoing",ToastType.CannotStartGroupCall="CannotStartGroupCall",ToastType.ConversationArchived="ConversationArchived",ToastType.ConversationMarkedUnread="ConversationMarkedUnread",ToastType.ConversationRemoved="ConversationRemoved",ToastType.ConversationUnarchived="ConversationUnarchived",ToastType.CopiedUsername="CopiedUsername",ToastType.CopiedUsernameLink="CopiedUsernameLink",ToastType.DangerousFileType="DangerousFileType",ToastType.DeleteForEveryoneFailed="DeleteForEveryoneFailed",ToastType.Error="Error",ToastType.Expired="Expired",ToastType.FailedToDeleteUsername="FailedToDeleteUsername",ToastType.FileSaved="FileSaved",ToastType.FileSize="FileSize",ToastType.InvalidConversation="InvalidConversation",ToastType.LeftGroup="LeftGroup",ToastType.MaxAttachments="MaxAttachments",ToastType.MessageBodyTooLong="MessageBodyTooLong",ToastType.OriginalMessageNotFound="OriginalMessageNotFound",ToastType.PinnedConversationsFull="PinnedConversationsFull",ToastType.ReactionFailed="ReactionFailed",ToastType.ReportedSpamAndBlocked="ReportedSpamAndBlocked",ToastType.StoryMuted="StoryMuted",ToastType.StoryReact="StoryReact",ToastType.StoryReply="StoryReply",ToastType.StoryVideoError="StoryVideoError",ToastType.StoryVideoUnsupported="StoryVideoUnsupported",ToastType.TapToViewExpiredIncoming="TapToViewExpiredIncoming",ToastType.TapToViewExpiredOutgoing="TapToViewExpiredOutgoing",ToastType.TooManyMessagesToDeleteForEveryone="TooManyMessagesToDeleteForEveryone",ToastType.TooManyMessagesToForward="TooManyMessagesToForward",ToastType.UnableToLoadAttachment="UnableToLoadAttachment",ToastType.UnsupportedMultiAttachment="UnsupportedMultiAttachment",ToastType.UnsupportedOS="UnsupportedOS",ToastType.UserAddedToGroup="UserAddedToGroup"}(ToastType||(ToastType={}))},"./ts/types/VisualAttachment.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{UR:()=>makeObjectUrl,pz:()=>getImageDimensions,qg:()=>revokeObjectUrl});__webpack_require__("./node_modules/blueimp-load-image/js/index.js");var _errors__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./ts/types/errors.ts");__webpack_require__("./ts/types/MIME.ts"),__webpack_require__("./ts/util/assert.ts"),__webpack_require__("./ts/util/canvasToBlob.ts");function getImageDimensions(_ref){var objectUrl=_ref.objectUrl,logger=_ref.logger;return new Promise((function(resolve,reject){var image=document.createElement("img");image.addEventListener("load",(function(){resolve({height:image.naturalHeight,width:image.naturalWidth})})),image.addEventListener("error",(function(error){logger.error("getImageDimensions error",(0,_errors__WEBPACK_IMPORTED_MODULE_1__.G)(error)),reject(error)})),image.src=objectUrl}))}function makeObjectUrl(data,contentType){var blob=new Blob([data],{type:contentType});return URL.createObjectURL(blob)}function revokeObjectUrl(objectUrl){URL.revokeObjectURL(objectUrl)}},"./ts/util/canvasToBlob.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{_:()=>canvasToBlob});var _types_MIME__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./ts/types/MIME.ts");async function canvasToBlob(canvas){var mimeType=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_types_MIME__WEBPACK_IMPORTED_MODULE_0__._l,quality=arguments.length>2?arguments[2]:void 0;return new Promise((function(resolve,reject){return canvas.toBlob((function(result){result?resolve(result):reject(new Error("Couldn't convert the canvas to a Blob"))}),mimeType,quality)}))}},"./ts/util/clearTimeoutIfNecessary.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function clearTimeoutIfNecessary(timeout){timeout&&clearTimeout(timeout)}__webpack_require__.d(__webpack_exports__,{S:()=>clearTimeoutIfNecessary})},"./ts/util/explodePromise.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function explodePromise(){var resolve,reject;return{promise:new Promise((function(innerResolve,innerReject){resolve=innerResolve,reject=innerReject})),resolve,reject}}__webpack_require__.d(__webpack_exports__,{R:()=>explodePromise})},"./ts/util/filterAndSortConversations.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{x:()=>filterAndSortConversationsByRecent});var fuse_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/fuse.js/dist/fuse.esm.js"),_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./ts/util/libphonenumberInstance.ts");function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var ACTIVE_AT_SCORE_FACTOR=1/__webpack_require__("./ts/util/durations/index.ts").ps*.01,FUSE_OPTIONS={threshold:.2,includeScore:!0,useExtendedSearch:!0,shouldSort:!0,distance:200,keys:[{name:"searchableTitle",weight:1},{name:"title",weight:1},{name:"name",weight:1},{name:"username",weight:1},{name:"e164",weight:.5}]},cachedIndices=new WeakMap,COMMANDS=new Map;function filterAndSortConversationsByRecent(conversations,searchTerm,regionCode){if(searchTerm.length){var now=Date.now();return function searchConversations(conversations,searchTerm,regionCode){var maybeCommand=searchTerm.match(/^!([^\s]+):(.*)$/);if(maybeCommand){var _maybeCommand=_slicedToArray(maybeCommand,3),commandName=_maybeCommand[1],_query=_maybeCommand[2],command=COMMANDS.get(commandName);if(command)return command(conversations,_query).map((function(item){return{item}}))}var phoneNumber=(0,_libphonenumberInstance__WEBPACK_IMPORTED_MODULE_0__.i9)(searchTerm,regionCode),extendedSearchTerm=searchTerm;phoneNumber&&(extendedSearchTerm+=` | ${phoneNumber.e164}`);var index=cachedIndices.get(conversations);return index||(index=new fuse_js__WEBPACK_IMPORTED_MODULE_2__.Z(conversations,FUSE_OPTIONS),cachedIndices.set(conversations,index)),index.search(extendedSearchTerm)}(conversations.filter((function(item){return item.titleNoDefault})),searchTerm,regionCode).slice().sort((function(a,b){var _a$score,_b$score,_a$item=a.item,_a$item$activeAt=_a$item.activeAt,aActiveAt=void 0===_a$item$activeAt?0:_a$item$activeAt,_a$item$left=_a$item.left,aLeft=void 0!==_a$item$left&&_a$item$left,_b$item=b.item,_b$item$activeAt=_b$item.activeAt,bActiveAt=void 0===_b$item$activeAt?0:_b$item$activeAt,_b$item$left=_b$item.left,bLeft=void 0!==_b$item$left&&_b$item$left;return(now-aActiveAt)*ACTIVE_AT_SCORE_FACTOR+(null!==(_a$score=a.score)&&void 0!==_a$score?_a$score:0)+(aLeft?1:0)-((now-bActiveAt)*ACTIVE_AT_SCORE_FACTOR+(null!==(_b$score=b.score)&&void 0!==_b$score?_b$score:0)+(bLeft?1:0))})).map((function(result){return result.item}))}return conversations.concat().sort((function(a,b){return a.activeAt&&b.activeAt?a.activeAt>b.activeAt?-1:1:a.activeAt&&!b.activeAt?-1:1}))}COMMANDS.set("uuidEndsWith",(function(conversations,query){return conversations.filter((function(convo){var _convo$uuid;return null===(_convo$uuid=convo.uuid)||void 0===_convo$uuid?void 0:_convo$uuid.endsWith(query)}))})),COMMANDS.set("idEndsWith",(function(conversations,query){return conversations.filter((function(convo){var _convo$id;return null===(_convo$id=convo.id)||void 0===_convo$id?void 0:_convo$id.endsWith(query)}))})),COMMANDS.set("e164EndsWith",(function(conversations,query){return conversations.filter((function(convo){var _convo$e;return null===(_convo$e=convo.e164)||void 0===_convo$e?void 0:_convo$e.endsWith(query)}))})),COMMANDS.set("groupIdEndsWith",(function(conversations,query){return conversations.filter((function(convo){var _convo$groupId;return null===(_convo$groupId=convo.groupId)||void 0===_convo$groupId?void 0:_convo$groupId.endsWith(query)}))}))},"./ts/util/grapheme.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{QX:()=>count,Rc:()=>truncateAndSize,i3:()=>isSingleGrapheme});var _iterables__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./ts/util/iterables.ts");function count(str){var segments=(new Intl.Segmenter).segment(str);return(0,_iterables__WEBPACK_IMPORTED_MODULE_0__.dp)(segments)}function truncateAndSize(str,toSize){var segments=(new Intl.Segmenter).segment(str),originalSize=(0,_iterables__WEBPACK_IMPORTED_MODULE_0__.dp)(segments);return void 0===toSize||originalSize<=toSize?[str,originalSize]:[(0,_iterables__WEBPACK_IMPORTED_MODULE_0__.v_)((0,_iterables__WEBPACK_IMPORTED_MODULE_0__.UI)((0,_iterables__WEBPACK_IMPORTED_MODULE_0__.qn)(segments,toSize),(function(s){return s.segment})),""),toSize]}function isSingleGrapheme(str){return""!==str&&(new Intl.Segmenter).segment(str).containing(0).segment===str}},"./ts/util/isNotNil.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function isNotNil(value){return null!=value}__webpack_require__.d(__webpack_exports__,{D:()=>isNotNil})},"./ts/util/libphonenumberInstance.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{M9:()=>PhoneNumberFormat,eE:()=>instance,i9:()=>parseAndFormatPhoneNumber});var google_libphonenumber__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/google-libphonenumber/dist/libphonenumber.js"),google_libphonenumber__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(google_libphonenumber__WEBPACK_IMPORTED_MODULE_0__),instance=google_libphonenumber__WEBPACK_IMPORTED_MODULE_0___default().PhoneNumberUtil.getInstance(),PhoneNumberFormat=google_libphonenumber__WEBPACK_IMPORTED_MODULE_0___default().PhoneNumberFormat;function parseAndFormatPhoneNumber(str,regionCode){var result,format=arguments.length>2&&void 0!==arguments[2]?arguments[2]:PhoneNumberFormat.E164;try{result=instance.parse(str,regionCode)}catch(err){return}return{isValid:instance.isValidNumber(result),userInput:str,e164:instance.format(result,format)}}},"./ts/util/parseIntOrThrow.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function parseIntOrThrow(value,message){var result;switch(typeof value){case"number":result=value;break;case"string":result=parseInt(value,10);break;default:result=NaN}if(!Number.isInteger(result))throw new Error(message);return result}__webpack_require__.d(__webpack_exports__,{Q:()=>parseIntOrThrow})},"./ts/util/shouldNeverBeCalled.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{U:()=>shouldNeverBeCalled,q:()=>asyncShouldNeverBeCalled});var _assert__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./ts/util/assert.ts");function shouldNeverBeCalled(){(0,_assert__WEBPACK_IMPORTED_MODULE_0__.q8)(!1,"This should never be called. Doing nothing")}async function asyncShouldNeverBeCalled(){shouldNeverBeCalled()}},"./ts/util/sleep.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function sleep(ms,abortSignal){return new Promise((function(resolve,reject){var timeout=setTimeout(resolve,ms);null==abortSignal||abortSignal.addEventListener("abort",(function(){void 0!==timeout&&(clearTimeout(timeout),timeout=void 0),reject(new Error("Aborted"))}))}))}__webpack_require__.d(__webpack_exports__,{_:()=>sleep})},"./ts/util/whatTypeOfConversation.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{C$:()=>isDirectConversation});var ConversationTypes;__webpack_require__("./ts/Bytes.ts"),__webpack_require__("./ts/logging/log.ts");function isDirectConversation(conversationAttrs){return"private"===conversationAttrs.type||"direct"===conversationAttrs.type}!function(ConversationTypes){ConversationTypes.Me="Me",ConversationTypes.Direct="Direct",ConversationTypes.GroupV1="GroupV1",ConversationTypes.GroupV2="GroupV2"}(ConversationTypes||(ConversationTypes={}))},"?0667":()=>{}}]);
//# sourceMappingURL=ForwardMessagesModal-stories.5e0a8dc4.iframe.bundle.js.map