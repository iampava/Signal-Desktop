"use strict";(globalThis.webpackChunksignal_desktop=globalThis.webpackChunksignal_desktop||[]).push([[2338],{"./ts/components/CompositionInput.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{D:()=>CompositionInput});var QuillFormattingStyle,react=__webpack_require__("./node_modules/react/index.js"),Delta=__webpack_require__("./node_modules/quill-delta/dist/Delta.js"),Delta_default=__webpack_require__.n(Delta),lib=__webpack_require__("./node_modules/react-quill/lib/index.js"),lib_default=__webpack_require__.n(lib),classnames=__webpack_require__("./node_modules/classnames/index.js"),classnames_default=__webpack_require__.n(classnames),Manager=__webpack_require__("./node_modules/react-popper/lib/esm/Manager.js"),Reference=__webpack_require__("./node_modules/react-popper/lib/esm/Reference.js"),quill=__webpack_require__("./node_modules/quill/dist/quill.js"),quill_default=__webpack_require__.n(quill),debounce=__webpack_require__("./node_modules/lodash/debounce.js"),debounce_default=__webpack_require__.n(debounce),Popper=__webpack_require__("./node_modules/react-popper/lib/esm/Popper.js"),react_dom=__webpack_require__("./node_modules/react-dom/index.js"),Avatar=__webpack_require__("./ts/components/Avatar.tsx"),emoji_regex=__webpack_require__("./node_modules/emoji-regex/index.js"),emoji_regex_default=__webpack_require__.n(emoji_regex),BodyRange=__webpack_require__("./ts/types/BodyRange.ts"),log=__webpack_require__("./ts/logging/log.ts"),errors=__webpack_require__("./ts/types/errors.ts"),handleOutsideClick=__webpack_require__("./ts/util/handleOutsideClick.ts"),jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}!function(QuillFormattingStyle){QuillFormattingStyle.bold="bold",QuillFormattingStyle.italic="italic",QuillFormattingStyle.monospace="monospace",QuillFormattingStyle.strike="strike",QuillFormattingStyle.spoiler="spoiler"}(QuillFormattingStyle||(QuillFormattingStyle={}));var FormattingMenu=function(){function FormattingMenu(quill,options){var _this=this;!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,FormattingMenu),this.quill=quill,this.options=options,this.root=document.body.appendChild(document.createElement("div")),this.quill.on("editor-change",this.onEditorChange.bind(this));var boldCharCode="B".charCodeAt(0);this.quill.keyboard.addBinding({key:"B",shortKey:!0},(function(){return _this.toggleForStyle(QuillFormattingStyle.bold)})),quill.keyboard.bindings[boldCharCode].unshift(quill.keyboard.bindings[boldCharCode].pop());var italicCharCode="I".charCodeAt(0);this.quill.keyboard.addBinding({key:"I",shortKey:!0},(function(){return _this.toggleForStyle(QuillFormattingStyle.italic)})),quill.keyboard.bindings[italicCharCode].unshift(quill.keyboard.bindings[italicCharCode].pop()),this.quill.keyboard.addBinding({key:"E",shortKey:!0},(function(){return _this.toggleForStyle(QuillFormattingStyle.monospace)})),this.quill.keyboard.addBinding({key:"X",shortKey:!0,shiftKey:!0},(function(){return _this.toggleForStyle(QuillFormattingStyle.strike)})),this.quill.keyboard.addBinding({key:"B",shortKey:!0,shiftKey:!0},(function(){return _this.toggleForStyle(QuillFormattingStyle.spoiler)}))}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(FormattingMenu,[{key:"destroy",value:function destroy(){this.root.remove()}},{key:"updateOptions",value:function updateOptions(options){this.options=Object.assign({},this.options,options),this.onEditorChange()}},{key:"onEditorChange",value:function onEditorChange(){if(!this.options.isEnabled)return this.lastSelection=void 0,this.referenceElement=void 0,void this.render();if(!this.quill.hasFocus())return this.lastSelection=void 0,this.referenceElement=void 0,void this.render();var previousSelection=this.lastSelection,quillSelection=this.quill.getSelection();if(this.lastSelection=quillSelection&&quillSelection.length>0?{start:quillSelection.index,end:quillSelection.index+quillSelection.length}:void 0,this.lastSelection){var noOverlapWithNewSelection=previousSelection&&(this.lastSelection.end<previousSelection.start||this.lastSelection.start>previousSelection.end),newSelectionStartsEarlier=previousSelection&&this.lastSelection.start<previousSelection.start;(noOverlapWithNewSelection||newSelectionStartsEarlier)&&(this.referenceElement=void 0),this.referenceElement=this.referenceElement||{getBoundingClientRect:function(){var selection=window.getSelection();if(null!=selection&&0!==selection.rangeCount){var _editorElement$getCli,range=selection.getRangeAt(0),activeElement=document.activeElement,editorElement=null==activeElement?void 0:activeElement.closest(".module-composition-input__input"),rect=range.getClientRects()[0],updatedY=Math.max(((null==editorElement||null===(_editorElement$getCli=editorElement.getClientRects()[0])||void 0===_editorElement$getCli?void 0:_editorElement$getCli.y)||0)-10,((null==rect?void 0:rect.y)||0)-10);return DOMRect.fromRect({x:rect.x,y:updatedY,height:rect.height,width:rect.width})}return log.warn("No selection range when formatting text"),new DOMRect}}}else this.referenceElement=void 0;this.render()}},{key:"isStyleEnabledInSelection",value:function isStyleEnabledInSelection(style){var selection=this.quill.getSelection();if(selection&&selection.length)return this.quill.getContents(selection.index,selection.length).ops.every((function(op){var _op$attributes;return null===(_op$attributes=op.attributes)||void 0===_op$attributes?void 0:_op$attributes[style]}))}},{key:"toggleForStyle",value:function toggleForStyle(style){try{var isEnabled=this.isStyleEnabledInSelection(style);if(void 0===isEnabled)return;this.quill.format(style,!isEnabled)}catch(error){log.error("toggleForStyle error:",errors.G(error))}}},{key:"render",value:function render(){var _this$outsideClickDes2,_this$outsideClickDes,_this2=this;if(!this.lastSelection)return null===(_this$outsideClickDes=this.outsideClickDestructor)||void 0===_this$outsideClickDes||_this$outsideClickDes.call(this),this.outsideClickDestructor=void 0,void this.options.setFormattingChooserElement(null);var _this$options=this.options,i18n=_this$options.i18n,isSpoilersEnabled=_this$options.isSpoilersEnabled,element=(0,react_dom.createPortal)((0,jsx_runtime.jsx)(Popper.r,{placement:"top-start",referenceElement:this.referenceElement,children:function(_ref){var ref=_ref.ref,style=_ref.style;return(0,jsx_runtime.jsxs)("div",{ref,className:"module-composition-input__format-menu",style,role:"menu",tabIndex:0,children:[(0,jsx_runtime.jsx)("button",{type:"button",className:"module-composition-input__format-menu__item","aria-label":i18n("icu:Keyboard--composer--bold"),onClick:function(event){event.preventDefault(),event.stopPropagation(),_this2.toggleForStyle(QuillFormattingStyle.bold)},children:(0,jsx_runtime.jsx)("div",{className:classnames_default()("module-composition-input__format-menu__item__icon","module-composition-input__format-menu__item__icon--bold",_this2.isStyleEnabledInSelection(QuillFormattingStyle.bold)?"module-composition-input__format-menu__item__icon--active":null)})}),(0,jsx_runtime.jsx)("button",{type:"button",className:"module-composition-input__format-menu__item","aria-label":i18n("icu:Keyboard--composer--italic"),onClick:function(event){event.preventDefault(),event.stopPropagation(),_this2.toggleForStyle(QuillFormattingStyle.italic)},children:(0,jsx_runtime.jsx)("div",{className:classnames_default()("module-composition-input__format-menu__item__icon","module-composition-input__format-menu__item__icon--italic",_this2.isStyleEnabledInSelection(QuillFormattingStyle.italic)?"module-composition-input__format-menu__item__icon--active":null)})}),(0,jsx_runtime.jsx)("button",{type:"button",className:"module-composition-input__format-menu__item","aria-label":i18n("icu:Keyboard--composer--strikethrough"),onClick:function(event){event.preventDefault(),event.stopPropagation(),_this2.toggleForStyle(QuillFormattingStyle.strike)},children:(0,jsx_runtime.jsx)("div",{className:classnames_default()("module-composition-input__format-menu__item__icon","module-composition-input__format-menu__item__icon--strikethrough",_this2.isStyleEnabledInSelection(QuillFormattingStyle.strike)?"module-composition-input__format-menu__item__icon--active":null)})}),(0,jsx_runtime.jsx)("button",{type:"button",className:"module-composition-input__format-menu__item","aria-label":i18n("icu:Keyboard--composer--monospace"),onClick:function(event){event.preventDefault(),event.stopPropagation(),_this2.toggleForStyle(QuillFormattingStyle.monospace)},children:(0,jsx_runtime.jsx)("div",{className:classnames_default()("module-composition-input__format-menu__item__icon","module-composition-input__format-menu__item__icon--monospace",_this2.isStyleEnabledInSelection(QuillFormattingStyle.monospace)?"module-composition-input__format-menu__item__icon--active":null)})}),isSpoilersEnabled?(0,jsx_runtime.jsx)("button",{type:"button",className:"module-composition-input__format-menu__item","aria-label":i18n("icu:Keyboard--composer--spoiler"),onClick:function(event){event.preventDefault(),event.stopPropagation(),_this2.toggleForStyle(QuillFormattingStyle.spoiler)},children:(0,jsx_runtime.jsx)("div",{className:classnames_default()("module-composition-input__format-menu__item__icon","module-composition-input__format-menu__item__icon--spoiler",_this2.isStyleEnabledInSelection(QuillFormattingStyle.spoiler)?"module-composition-input__format-menu__item__icon--active":null)})}):null]})}}),this.root);null===(_this$outsideClickDes2=this.outsideClickDestructor)||void 0===_this$outsideClickDes2||_this$outsideClickDes2.call(this),this.outsideClickDestructor=(0,handleOutsideClick.p)((function(){return!0}),{name:"quill.emoji.completion",containerElements:[this.root]}),this.options.setFormattingChooserElement(element)}}]),FormattingMenu}();function _toConsumableArray(arr){return function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||_unsupportedIterableToArray(arr)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||_unsupportedIterableToArray(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var isSpecificInsertOp=function(op,type){return void 0!==op.insert&&"object"==typeof op.insert&&Object.hasOwnProperty.call(op.insert,type)},isInsertEmojiOp=function(op){return isSpecificInsertOp(op,"emoji")},isInsertMentionOp=function(op){return isSpecificInsertOp(op,"mention")},getTextFromOps=function(ops){return ops.reduce((function(acc,op){return"string"==typeof op.insert?acc+op.insert:isInsertEmojiOp(op)?acc+op.insert.emoji:isInsertMentionOp(op)?`${acc}@${op.insert.mention.title}`:acc}),"").trim()},_BodyRange$Style=BodyRange.OY.Style,BOLD=_BodyRange$Style.BOLD,ITALIC=_BodyRange$Style.ITALIC,MONOSPACE=_BodyRange$Style.MONOSPACE,SPOILER=_BodyRange$Style.SPOILER,STRIKETHROUGH=_BodyRange$Style.STRIKETHROUGH,NONE=_BodyRange$Style.NONE;function extractFormatRange(_ref){var bodyRanges=_ref.bodyRanges,index=_ref.index,previousData=_ref.previousData,hasStyle=_ref.hasStyle,style=_ref.style;if(hasStyle&&!previousData)return{start:index};if(hasStyle||!previousData)return previousData;var start=previousData.start;bodyRanges.push({length:index-start,start,style})}function extractAllFormats(bodyRanges,formats,index,op){var _op$attributes,_op$attributes2,_op$attributes3,_op$attributes4,_op$attributes5,result=Object.assign({},formats),params={bodyRanges,index};return result[BOLD]=extractFormatRange(Object.assign({},params,{style:BOLD,previousData:result[BOLD],hasStyle:null==op||null===(_op$attributes=op.attributes)||void 0===_op$attributes?void 0:_op$attributes[QuillFormattingStyle.bold]})),result[ITALIC]=extractFormatRange(Object.assign({},params,{style:ITALIC,previousData:result[ITALIC],hasStyle:null==op||null===(_op$attributes2=op.attributes)||void 0===_op$attributes2?void 0:_op$attributes2[QuillFormattingStyle.italic]})),result[MONOSPACE]=extractFormatRange(Object.assign({},params,{style:MONOSPACE,previousData:result[MONOSPACE],hasStyle:null==op||null===(_op$attributes3=op.attributes)||void 0===_op$attributes3?void 0:_op$attributes3[QuillFormattingStyle.monospace]})),result[SPOILER]=extractFormatRange(Object.assign({},params,{style:SPOILER,previousData:result[SPOILER],hasStyle:null==op||null===(_op$attributes4=op.attributes)||void 0===_op$attributes4?void 0:_op$attributes4[QuillFormattingStyle.spoiler]})),result[STRIKETHROUGH]=extractFormatRange(Object.assign({},params,{style:STRIKETHROUGH,previousData:result[STRIKETHROUGH],hasStyle:null==op||null===(_op$attributes5=op.attributes)||void 0===_op$attributes5?void 0:_op$attributes5[QuillFormattingStyle.strike]})),result}var getBlotTextPartitions=function(blotText,index){var lowerCaseBlotText=(blotText||"").toLowerCase();return[lowerCaseBlotText.substr(0,index),lowerCaseBlotText.substr(index)]},matchBlotTextPartitions=function(blot,index,leftRegExp,rightRegExp){var _getBlotTextPartition2=_slicedToArray(getBlotTextPartitions(blot.text,index),2),leftText=_getBlotTextPartition2[0],rightText=_getBlotTextPartition2[1],leftMatch=leftRegExp.exec(leftText),rightMatch=null;return rightRegExp&&(rightMatch=rightRegExp.exec(rightText)),[leftMatch,rightMatch]},insertMentionOps=function(incomingOps,bodyRanges){var ops=_toConsumableArray(incomingOps);return bodyRanges.slice().sort((function(a,b){return b.start-a.start})).forEach((function(bodyRange){if(BodyRange.OY.isMention(bodyRange)){var start=bodyRange.start,length=bodyRange.length,mentionUuid=bodyRange.mentionUuid,replacementText=bodyRange.replacementText,op=ops.shift();if(op){var insert=op.insert,attributes=op.attributes;if("string"==typeof insert){var left=insert.slice(0,start),right=insert.slice(start+length),mention={uuid:mentionUuid,title:replacementText};ops.unshift({insert:right,attributes}),ops.unshift({insert:{mention},attributes}),ops.unshift({insert:left,attributes})}else ops.unshift(op)}}})),ops},insertEmojiOps=function(incomingOps){return incomingOps.reduce((function(ops,op){if("string"==typeof op.insert){for(var match,text=op.insert,attributes=op.attributes,re=emoji_regex_default()(),index=0;match=re.exec(text);){var emoji=_slicedToArray(match,1)[0];ops.push({insert:text.slice(index,match.index),attributes}),ops.push({insert:{emoji},attributes}),index=match.index+emoji.length}ops.push({insert:text.slice(index,text.length),attributes})}else ops.push(op);return ops}),[])},popperUtil=__webpack_require__("./ts/util/popperUtil.ts"),UserText=__webpack_require__("./ts/components/UserText.tsx");function completion_slicedToArray(arr,i){return function completion_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function completion_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function completion_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return completion_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return completion_arrayLikeToArray(o,minLen)}(arr,i)||function completion_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function completion_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function completion_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var MENTION_REGEX=/(?:^|\W)@([-+\w]*)$/,MentionCompletion=function(){function MentionCompletion(quill,options){var _this=this;!function completion_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,MentionCompletion),this.results=[],this.index=0,this.options=options,this.root=document.body.appendChild(document.createElement("div")),this.quill=quill,this.suggestionListRef=react.createRef();var clearResults=function(){return _this.results.length&&_this.clearResults(),!0},changeIndex=function(by){return function(){return!_this.results.length||(_this.changeIndex(by),!1)}};this.quill.keyboard.addBinding({key:37},clearResults),this.quill.keyboard.addBinding({key:38},changeIndex(-1)),this.quill.keyboard.addBinding({key:39},clearResults),this.quill.keyboard.addBinding({key:40},changeIndex(1)),this.quill.on("text-change",debounce_default()(this.onTextChange.bind(this),0)),this.quill.on("selection-change",this.onSelectionChange.bind(this))}return function completion_createClass(Constructor,protoProps,staticProps){return protoProps&&completion_defineProperties(Constructor.prototype,protoProps),staticProps&&completion_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(MentionCompletion,[{key:"destroy",value:function destroy(){var _this$outsideClickDes;null===(_this$outsideClickDes=this.outsideClickDestructor)||void 0===_this$outsideClickDes||_this$outsideClickDes.call(this),this.outsideClickDestructor=void 0,this.root.remove()}},{key:"changeIndex",value:function changeIndex(by){this.index=(this.index+by+this.results.length)%this.results.length,this.render();var suggestionList=this.suggestionListRef.current;if(suggestionList){var selectedElement=suggestionList.querySelector('[aria-selected="true"]');selectedElement&&selectedElement.scrollIntoViewIfNeeded(!1)}}},{key:"onSelectionChange",value:function onSelectionChange(){this.clearResults()}},{key:"possiblyShowMemberResults",value:function possiblyShowMemberResults(){var range=this.quill.getSelection();if(range){var _this$quill$getLeaf2=completion_slicedToArray(this.quill.getLeaf(range.index),2),blot=_this$quill$getLeaf2[0],index=_this$quill$getLeaf2[1],leftTokenTextMatch=completion_slicedToArray(matchBlotTextPartitions(blot,index,MENTION_REGEX),1)[0];if(leftTokenTextMatch){var leftTokenText=completion_slicedToArray(leftTokenTextMatch,2)[1],results=[],memberRepository=this.options.memberRepositoryRef.current;if(memberRepository)if(""===leftTokenText)results=memberRepository.getMembers(this.options.me);else{var fullMentionText=leftTokenText;results=memberRepository.search(fullMentionText,this.options.me)}return results}}return[]}},{key:"onTextChange",value:function onTextChange(){var showMemberResults=this.possiblyShowMemberResults();showMemberResults.length>0?(this.results=showMemberResults,this.index=0,this.render()):0!==this.results.length&&this.clearResults()}},{key:"completeMention",value:function completeMention(resultIndexArg){var resultIndex=resultIndexArg||this.index,range=this.quill.getSelection();if(null!=range){var member=this.results[resultIndex],_this$quill$getLeaf4=completion_slicedToArray(this.quill.getLeaf(range.index),2),blot=_this$quill$getLeaf4[0],index=_this$quill$getLeaf4[1],leftTokenTextMatch=completion_slicedToArray(matchBlotTextPartitions(blot,index,MENTION_REGEX),1)[0];if(leftTokenTextMatch){var leftTokenText=completion_slicedToArray(leftTokenTextMatch,2)[1];this.insertMention(member,range.index-leftTokenText.length-1,leftTokenText.length+1,!0)}}}},{key:"insertMention",value:function insertMention(mention,index,range){var withTrailingSpace=arguments.length>3&&void 0!==arguments[3]&&arguments[3],delta=(new(Delta_default())).retain(index).delete(range).insert({mention});withTrailingSpace?(this.quill.updateContents(delta.insert(" "),"user"),this.quill.setSelection(index+2,0,"user")):(this.quill.updateContents(delta,"user"),this.quill.setSelection(index+1,0,"user")),this.clearResults()}},{key:"clearResults",value:function clearResults(){this.results=[],this.index=0,this.render()}},{key:"onUnmount",value:function onUnmount(){var _this$outsideClickDes2;null===(_this$outsideClickDes2=this.outsideClickDestructor)||void 0===_this$outsideClickDes2||_this$outsideClickDes2.call(this),this.outsideClickDestructor=void 0,this.options.setMentionPickerElement(null)}},{key:"render",value:function render(){var _this$outsideClickDes3,_this2=this,memberResults=this.results,memberResultsIndex=this.index,_this$options=this.options,getPreferredBadge=_this$options.getPreferredBadge,theme=_this$options.theme;if(0!==memberResults.length){var element=(0,react_dom.createPortal)((0,jsx_runtime.jsx)(Popper.r,{placement:"top-start",modifiers:[popperUtil.W],children:function(_ref){var ref=_ref.ref,style=_ref.style;return(0,jsx_runtime.jsx)("div",{ref,className:"module-composition-input__suggestions",style,role:"listbox","aria-expanded":!0,"aria-activedescendant":`mention-result--${memberResults.length?memberResults[memberResultsIndex].name:""}`,tabIndex:0,children:(0,jsx_runtime.jsx)("div",{ref:_this2.suggestionListRef,className:"module-composition-input__suggestions--scroller",children:memberResults.map((function(member,index){return(0,jsx_runtime.jsxs)("button",{type:"button",id:`mention-result--${member.name}`,role:"option button","aria-selected":memberResultsIndex===index,onClick:function(){_this2.completeMention(index)},className:classnames_default()("module-composition-input__suggestions__row","module-composition-input__suggestions__row--mention",memberResultsIndex===index?"module-composition-input__suggestions__row--selected":null),children:[(0,jsx_runtime.jsx)(Avatar.qE,{acceptedMessageRequest:member.acceptedMessageRequest,avatarPath:member.avatarPath,badge:getPreferredBadge(member.badges),conversationType:"direct",i18n:_this2.options.i18n,isMe:member.isMe,sharedGroupNames:member.sharedGroupNames,size:Avatar.DZ.TWENTY_EIGHT,theme,title:member.title,unblurredAvatarPath:member.unblurredAvatarPath}),(0,jsx_runtime.jsx)("div",{className:"module-composition-input__suggestions__title",children:(0,jsx_runtime.jsx)(UserText.a,{text:member.title})})]},member.uuid)}))})})}}),this.root);null===(_this$outsideClickDes3=this.outsideClickDestructor)||void 0===_this$outsideClickDes3||_this$outsideClickDes3.call(this),this.outsideClickDestructor=(0,handleOutsideClick.p)((function(){return _this2.onUnmount(),!0}),{name:"quill.mentions.completion",containerElements:[this.root]}),this.options.setMentionPickerElement(element)}else this.onUnmount()}}]),MentionCompletion}();function monospaceBlot_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function monospaceBlot_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(target,property,receiver){var base=_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},_get.apply(this,arguments)}function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"==typeof call||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}var Inline=quill_default().import("blots/inline"),MonospaceBlot=function(_Inline){!function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}(MonospaceBlot,_Inline);var _super=_createSuper(MonospaceBlot);function MonospaceBlot(){return monospaceBlot_classCallCheck(this,MonospaceBlot),_super.apply(this,arguments)}return function monospaceBlot_createClass(Constructor,protoProps,staticProps){return protoProps&&monospaceBlot_defineProperties(Constructor.prototype,protoProps),staticProps&&monospaceBlot_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(MonospaceBlot,[{key:"optimize",value:function optimize(context){_get(_getPrototypeOf(MonospaceBlot.prototype),"optimize",this).call(this,context),this.domNode.classList.contains(this.statics.className)||this.domNode.classList.add(this.statics.className)}}],[{key:"formats",value:function formats(){return!0}}]),MonospaceBlot}(Inline);function spoilerBlot_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function spoilerBlot_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function spoilerBlot_get(){return spoilerBlot_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(target,property,receiver){var base=spoilerBlot_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},spoilerBlot_get.apply(this,arguments)}function spoilerBlot_superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=spoilerBlot_getPrototypeOf(object)););return object}function spoilerBlot_setPrototypeOf(o,p){return spoilerBlot_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){return o.__proto__=p,o},spoilerBlot_setPrototypeOf(o,p)}function spoilerBlot_createSuper(Derived){var hasNativeReflectConstruct=function spoilerBlot_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var result,Super=spoilerBlot_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=spoilerBlot_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return spoilerBlot_possibleConstructorReturn(this,result)}}function spoilerBlot_possibleConstructorReturn(self,call){if(call&&("object"==typeof call||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function spoilerBlot_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function spoilerBlot_getPrototypeOf(o){return spoilerBlot_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)},spoilerBlot_getPrototypeOf(o)}MonospaceBlot.blotName="monospace",MonospaceBlot.className="quill--monospace",Inline.order.splice(Inline.order.indexOf("bold"),0,MonospaceBlot.blotName);var spoilerBlot_Inline=quill_default().import("blots/inline"),SpoilerBlot=function(_Inline){!function spoilerBlot_inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&spoilerBlot_setPrototypeOf(subClass,superClass)}(SpoilerBlot,_Inline);var _super=spoilerBlot_createSuper(SpoilerBlot);function SpoilerBlot(){return spoilerBlot_classCallCheck(this,SpoilerBlot),_super.apply(this,arguments)}return function spoilerBlot_createClass(Constructor,protoProps,staticProps){return protoProps&&spoilerBlot_defineProperties(Constructor.prototype,protoProps),staticProps&&spoilerBlot_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(SpoilerBlot,[{key:"optimize",value:function optimize(context){spoilerBlot_get(spoilerBlot_getPrototypeOf(SpoilerBlot.prototype),"optimize",this).call(this,context),this.domNode.classList.contains(this.statics.className)||this.domNode.classList.add(this.statics.className)}}],[{key:"formats",value:function formats(){return!0}}]),SpoilerBlot}(spoilerBlot_Inline);SpoilerBlot.blotName="spoiler",SpoilerBlot.className="quill--spoiler",spoilerBlot_Inline.order.splice(spoilerBlot_Inline.order.indexOf("bold"),0,SpoilerBlot.blotName);var emoji_lib=__webpack_require__("./ts/components/emoji/lib.ts");function blot_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function blot_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function blot_get(){return blot_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(target,property,receiver){var base=blot_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},blot_get.apply(this,arguments)}function blot_superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=blot_getPrototypeOf(object)););return object}function blot_setPrototypeOf(o,p){return blot_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){return o.__proto__=p,o},blot_setPrototypeOf(o,p)}function blot_createSuper(Derived){var hasNativeReflectConstruct=function blot_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var result,Super=blot_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=blot_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return blot_possibleConstructorReturn(this,result)}}function blot_possibleConstructorReturn(self,call){if(call&&("object"==typeof call||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function blot_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function blot_getPrototypeOf(o){return blot_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)},blot_getPrototypeOf(o)}var EmojiBlot=function(_Embed){!function blot_inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&blot_setPrototypeOf(subClass,superClass)}(EmojiBlot,_Embed);var _super=blot_createSuper(EmojiBlot);function EmojiBlot(){return blot_classCallCheck(this,EmojiBlot),_super.apply(this,arguments)}return function blot_createClass(Constructor,protoProps,staticProps){return protoProps&&blot_defineProperties(Constructor.prototype,protoProps),staticProps&&blot_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(EmojiBlot,null,[{key:"create",value:function create(emoji){var node=blot_get(blot_getPrototypeOf(EmojiBlot),"create",this).call(this,void 0);node.dataset.emoji=emoji;var image=(0,emoji_lib.rl)(emoji);return node.setAttribute("src",image||""),node.setAttribute("data-emoji",emoji),node.setAttribute("title",emoji),node.setAttribute("aria-label",emoji),node}},{key:"value",value:function value(node){return node.dataset.emoji}}]),EmojiBlot}(quill_default().import("blots/embed"));EmojiBlot.blotName="emoji",EmojiBlot.tagName="img",EmojiBlot.className="emoji-blot";var isNumber=__webpack_require__("./node_modules/lodash/isNumber.js"),isNumber_default=__webpack_require__.n(isNumber),Emoji=__webpack_require__("./ts/components/emoji/Emoji.tsx");function emoji_completion_slicedToArray(arr,i){return function emoji_completion_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function emoji_completion_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function emoji_completion_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return emoji_completion_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return emoji_completion_arrayLikeToArray(o,minLen)}(arr,i)||function emoji_completion_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function emoji_completion_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function emoji_completion_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var Keyboard=quill_default().import("modules/keyboard"),EmojiCompletion=function(){function EmojiCompletion(quill,options){var _this=this;!function emoji_completion_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,EmojiCompletion),this.results=[],this.index=0,this.options=options,this.root=document.body.appendChild(document.createElement("div")),this.quill=quill;var clearResults=function(){return _this.results.length&&_this.reset(),!0},changeIndex=function(by){return function(){return!_this.results.length||(_this.changeIndex(by),!1)}};this.quill.keyboard.addBinding({key:Keyboard.keys.UP},changeIndex(-1)),this.quill.keyboard.addBinding({key:Keyboard.keys.RIGHT},clearResults),this.quill.keyboard.addBinding({key:Keyboard.keys.DOWN},changeIndex(1)),this.quill.keyboard.addBinding({key:Keyboard.keys.LEFT},clearResults),this.quill.keyboard.addBinding({key:186,shiftKey:!0},(function(){return _this.onTextChange(!0)})),this.quill.keyboard.addBinding({key:58},(function(){return _this.onTextChange(!0)})),this.quill.on("text-change",debounce_default()((function(){return _this.onTextChange()}),100)),this.quill.on("selection-change",this.onSelectionChange.bind(this))}return function emoji_completion_createClass(Constructor,protoProps,staticProps){return protoProps&&emoji_completion_defineProperties(Constructor.prototype,protoProps),staticProps&&emoji_completion_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(EmojiCompletion,[{key:"destroy",value:function destroy(){var _this$outsideClickDes;null===(_this$outsideClickDes=this.outsideClickDestructor)||void 0===_this$outsideClickDes||_this$outsideClickDes.call(this),this.outsideClickDestructor=void 0,this.root.remove()}},{key:"changeIndex",value:function changeIndex(by){this.index=(this.index+by+this.results.length)%this.results.length,this.render()}},{key:"getCurrentLeafTextPartitions",value:function getCurrentLeafTextPartitions(){var range=this.quill.getSelection(),_this$quill$getLeaf2=emoji_completion_slicedToArray(this.quill.getLeaf(range?range.index:-1),2),blot=_this$quill$getLeaf2[0],index=_this$quill$getLeaf2[1];return getBlotTextPartitions(blot.text,index)}},{key:"onSelectionChange",value:function onSelectionChange(){this.reset()}},{key:"onTextChange",value:function onTextChange(){var justPressedColon=arguments.length>0&&void 0!==arguments[0]&&arguments[0],PASS_THROUGH=!0,INTERCEPT=!1,range=this.quill.getSelection();if(!range)return PASS_THROUGH;var _this$quill$getLeaf3=this.quill.getLeaf(range.index),_this$quill$getLeaf4=emoji_completion_slicedToArray(_this$quill$getLeaf3,2),blot=_this$quill$getLeaf4[0],index=_this$quill$getLeaf4[1],_matchBlotTextPartiti=matchBlotTextPartitions(blot,index,/(?<=^|\s):([-+0-9a-zA-Z_]*)(:?)$/,/^([-+0-9a-zA-Z_]*):/),_matchBlotTextPartiti2=emoji_completion_slicedToArray(_matchBlotTextPartiti,2),leftTokenTextMatch=_matchBlotTextPartiti2[0],rightTokenTextMatch=_matchBlotTextPartiti2[1];if(leftTokenTextMatch){var _leftTokenTextMatch=emoji_completion_slicedToArray(leftTokenTextMatch,3),leftTokenText=_leftTokenTextMatch[1],isSelfClosing=_leftTokenTextMatch[2];if(isSelfClosing||justPressedColon){if(!(0,emoji_lib.qg)(leftTokenText))return this.reset(),PASS_THROUGH;var emojiData=(0,emoji_lib.rz)(leftTokenText,this.options.skinTone),numberOfColons=isSelfClosing?2:1;if(emojiData)return this.insertEmoji(emojiData,range.index-leftTokenText.length-numberOfColons,leftTokenText.length+numberOfColons),INTERCEPT}if(rightTokenTextMatch){var _rightTokenTextMatch=emoji_completion_slicedToArray(rightTokenTextMatch,2),rightTokenText=_rightTokenTextMatch[1],tokenText=leftTokenText+rightTokenText;if((0,emoji_lib.qg)(tokenText)){var _emojiData=(0,emoji_lib.rz)(tokenText,this.options.skinTone);if(_emojiData)return this.insertEmoji(_emojiData,range.index-leftTokenText.length-1,tokenText.length+2),INTERCEPT}}if(leftTokenText.length<2)return this.reset(),PASS_THROUGH;var showEmojiResults=(0,emoji_lib.yC)(leftTokenText,10);showEmojiResults.length>0?(this.results=showEmojiResults,this.index=Math.min(this.results.length-1,this.index),this.render()):0!==this.results.length&&this.reset()}else 0!==this.results.length&&this.reset();return PASS_THROUGH}},{key:"completeEmoji",value:function completeEmoji(){var range=this.quill.getSelection();if(null!=range){var emoji=this.results[this.index],leafText=emoji_completion_slicedToArray(this.getCurrentLeafTextPartitions(),1)[0],tokenTextMatch=/:([-+0-9a-z_]*)(:?)$/.exec(leafText);if(null!=tokenTextMatch){var tokenText=emoji_completion_slicedToArray(tokenTextMatch,2)[1];this.insertEmoji(emoji,range.index-tokenText.length-1,tokenText.length+1,!0)}}}},{key:"insertEmoji",value:function insertEmoji(emojiData,index,range){var withTrailingSpace=arguments.length>3&&void 0!==arguments[3]&&arguments[3],emoji=(0,emoji_lib.nS)(emojiData.short_name,this.options.skinTone),delta=(new(Delta_default())).retain(index).delete(range).insert({emoji});withTrailingSpace?(this.quill.updateContents(delta.insert(" "),"user"),this.quill.setSelection(index+2,0,"user")):(this.quill.updateContents(delta,"user"),this.quill.setSelection(index+1,0,"user")),this.options.onPickEmoji({shortName:emojiData.short_name,skinTone:this.options.skinTone}),this.reset()}},{key:"reset",value:function reset(){this.results.length&&(this.results=[],this.index=0,this.render())}},{key:"onUnmount",value:function onUnmount(){var _this$outsideClickDes2;null===(_this$outsideClickDes2=this.outsideClickDestructor)||void 0===_this$outsideClickDes2||_this$outsideClickDes2.call(this),this.outsideClickDestructor=void 0,this.options.setEmojiPickerElement(null)}},{key:"render",value:function render(){var _this$outsideClickDes3,_this2=this,emojiResults=this.results,emojiResultsIndex=this.index;if(0!==emojiResults.length){var reference={getBoundingClientRect:function(){var selection=window.getSelection();if(null!=selection&&0!==selection.rangeCount){var _range$endContainer$t,range=selection.getRangeAt(0).cloneRange();range.collapse(!0);var textBeforeCursor=null===(_range$endContainer$t=range.endContainer.textContent)||void 0===_range$endContainer$t?void 0:_range$endContainer$t.slice(0,range.startOffset),startOfEmojiText=null==textBeforeCursor?void 0:textBeforeCursor.lastIndexOf(":");return textBeforeCursor&&isNumber_default()(startOfEmojiText)&&-1!==startOfEmojiText?range.setStart(range.endContainer,startOfEmojiText):log.warn(`Could not find the beginning of the emoji word to be completed. startOfEmojiText=${startOfEmojiText}, textBeforeCursor.length=${null==textBeforeCursor?void 0:textBeforeCursor.length}, range.offsets=${range.startOffset}-${range.endOffset}`),range.getClientRects()[0]}return log.warn("No selection range when auto-completing emoji"),new DOMRect}},element=(0,react_dom.createPortal)((0,jsx_runtime.jsx)(Popper.r,{placement:"top-start",referenceElement:reference,children:function(_ref){var ref=_ref.ref,style=_ref.style;return(0,jsx_runtime.jsx)("div",{ref,className:"module-composition-input__suggestions",style,role:"listbox","aria-expanded":!0,"aria-activedescendant":`emoji-result--${emojiResults.length?emojiResults[emojiResultsIndex].short_name:""}`,tabIndex:0,children:emojiResults.map((function(emoji,index){return(0,jsx_runtime.jsxs)("button",{type:"button",id:`emoji-result--${emoji.short_name}`,role:"option button","aria-selected":emojiResultsIndex===index,onClick:function(){_this2.index=index,_this2.completeEmoji()},className:classnames_default()("module-composition-input__suggestions__row",emojiResultsIndex===index?"module-composition-input__suggestions__row--selected":null),children:[(0,jsx_runtime.jsx)(Emoji.d,{shortName:emoji.short_name,size:16,skinTone:_this2.options.skinTone}),(0,jsx_runtime.jsxs)("div",{className:"module-composition-input__suggestions__row__short-name",children:[":",emoji.short_name,":"]})]},emoji.short_name)}))})}}),this.root);null===(_this$outsideClickDes3=this.outsideClickDestructor)||void 0===_this$outsideClickDes3||_this$outsideClickDes3.call(this),this.outsideClickDestructor=(0,handleOutsideClick.p)((function(){return _this2.onUnmount(),!0}),{name:"quill.emoji.completion",containerElements:[this.root]}),this.options.setEmojiPickerElement(element)}else this.onUnmount()}}]),EmojiCompletion}(),UUID=__webpack_require__("./ts/types/UUID.ts"),Emojify=(__webpack_require__("./node_modules/parchment/dist/parchment.js"),__webpack_require__("./ts/components/conversation/Emojify.tsx"));function mentions_blot_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function mentions_blot_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function mentions_blot_get(){return mentions_blot_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(target,property,receiver){var base=mentions_blot_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},mentions_blot_get.apply(this,arguments)}function mentions_blot_superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=mentions_blot_getPrototypeOf(object)););return object}function mentions_blot_setPrototypeOf(o,p){return mentions_blot_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){return o.__proto__=p,o},mentions_blot_setPrototypeOf(o,p)}function mentions_blot_createSuper(Derived){var hasNativeReflectConstruct=function mentions_blot_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var result,Super=mentions_blot_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=mentions_blot_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return mentions_blot_possibleConstructorReturn(this,result)}}function mentions_blot_possibleConstructorReturn(self,call){if(call&&("object"==typeof call||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function mentions_blot_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function mentions_blot_getPrototypeOf(o){return mentions_blot_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)},mentions_blot_getPrototypeOf(o)}var MentionBlot=function(_Embed){!function mentions_blot_inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&mentions_blot_setPrototypeOf(subClass,superClass)}(MentionBlot,_Embed);var _super=mentions_blot_createSuper(MentionBlot);function MentionBlot(){return mentions_blot_classCallCheck(this,MentionBlot),_super.apply(this,arguments)}return function mentions_blot_createClass(Constructor,protoProps,staticProps){return protoProps&&mentions_blot_defineProperties(Constructor.prototype,protoProps),staticProps&&mentions_blot_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(MentionBlot,null,[{key:"create",value:function create(value){var node=mentions_blot_get(mentions_blot_getPrototypeOf(MentionBlot),"create",this).call(this,void 0);return MentionBlot.buildSpan(value,node),node}},{key:"value",value:function value(node){var _node$dataset=node.dataset,uuid=_node$dataset.uuid,title=_node$dataset.title;if(void 0===uuid||void 0===title)throw new Error(`Failed to make MentionBlot with uuid: ${uuid}, title: ${title}`);return{uuid,title}}},{key:"buildSpan",value:function buildSpan(mention,node){node.setAttribute("data-uuid",mention.uuid||""),node.setAttribute("data-title",mention.title||""),node.setAttribute("contenteditable","false");var mentionSpan=document.createElement("span");(0,react_dom.render)((0,jsx_runtime.jsx)("span",{className:"module-composition-input__at-mention",children:(0,jsx_runtime.jsxs)("bdi",{children:["@",(0,jsx_runtime.jsx)(Emojify.u,{text:mention.title})]})}),mentionSpan),node.appendChild(mentionSpan)}}]),MentionBlot}(quill_default().import("blots/embed"));MentionBlot.blotName="mention",MentionBlot.className="mention-blot",MentionBlot.tagName="span";var matchEmojiImage=function(node){if(node.classList.contains("emoji")){var emoji=node.getAttribute("title");return(new(Delta_default())).insert({emoji})}return new(Delta_default())},matchEmojiBlot=function(node,delta){if(node.classList.contains("emoji-blot")){var emoji=node.dataset.emoji;return(new(Delta_default())).insert({emoji})}return delta},matchReactEmoji=function(node,delta){if(node.classList.contains("module-emoji")){var emoji=node.innerText.trim();return(new(Delta_default())).insert({emoji})}return delta},matchEmojiText=function(node){var nodeAsInsert={insert:node.data};return new(Delta_default())(insertEmojiOps([nodeAsInsert]))},matchMention=function(memberRepositoryRef){return function(node,delta){var memberRepository=memberRepositoryRef.current;if(memberRepository){var title=node.dataset.title;if(node.classList.contains("MessageBody__at-mention")){var id=node.dataset.id,conversation=memberRepository.getMemberById(id);return conversation&&conversation.uuid?(new(Delta_default())).insert({mention:{title,uuid:conversation.uuid}}):(new(Delta_default())).insert(`@${title}`)}if(node.classList.contains("mention-blot")){var uuid=node.dataset.uuid,_conversation=memberRepository.getMemberByUuid(uuid);return _conversation&&_conversation.uuid?(new(Delta_default())).insert({mention:{title:title||_conversation.title,uuid:_conversation.uuid}}):(new(Delta_default())).insert(`@${title}`)}}return delta}},get=__webpack_require__("./node_modules/lodash/get.js"),get_default=__webpack_require__.n(get),fuse_esm=__webpack_require__("./node_modules/fuse.js/dist/fuse.esm.js"),iterables=__webpack_require__("./ts/util/iterables.ts");function memberRepository_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function memberRepository_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var FUSE_OPTIONS={location:0,shouldSort:!0,threshold:0,maxPatternLength:32,minMatchCharLength:1,keys:["name","firstName","profileName","title"],getFn:function(conversation,path){var rawValue=get_default()(conversation,path);if("string"!=typeof rawValue)return"";var segments=new Intl.Segmenter(void 0,{granularity:"word"}).segment(rawValue),wordlikeSegments=(0,iterables.hX)(segments,(function(segment){return segment.isWordLike})),wordlikes=(0,iterables.UI)(wordlikeSegments,(function(segment){return segment.segment}));return Array.from(wordlikes)}},MemberRepository=function(){function MemberRepository(){var members=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];memberRepository_classCallCheck(this,MemberRepository),this.isFuseReady=!1,this.fuse=new fuse_esm.Z([],FUSE_OPTIONS),this.members=members}return function memberRepository_createClass(Constructor,protoProps,staticProps){return protoProps&&memberRepository_defineProperties(Constructor.prototype,protoProps),staticProps&&memberRepository_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(MemberRepository,[{key:"updateMembers",value:function updateMembers(members){this.members=members,this.isFuseReady=!1}},{key:"getMembers",value:function getMembers(omit){return omit?this.members.filter((function(_ref){return _ref.id!==omit.id})):this.members}},{key:"getMemberById",value:function getMemberById(id){return id?this.members.find((function(_ref2){return _ref2.id===id})):void 0}},{key:"getMemberByUuid",value:function getMemberByUuid(uuid){return uuid?this.members.find((function(_ref3){return _ref3.uuid===uuid})):void 0}},{key:"search",value:function search(pattern,omit){this.isFuseReady||(this.fuse.setCollection(this.members),this.isFuseReady=!0);var results=this.fuse.search(pattern).map((function(result){return result.item}));return omit?results.filter((function(_ref4){return _ref4.id!==omit.id})):results}}]),MemberRepository}();function signal_clipboard_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function signal_clipboard_slicedToArray(arr,i){return function signal_clipboard_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function signal_clipboard_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function signal_clipboard_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return signal_clipboard_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return signal_clipboard_arrayLikeToArray(o,minLen)}(arr,i)||function signal_clipboard_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function signal_clipboard_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var getSelectionHTML=function(){var selection=window.getSelection();if(null==selection)return"";var contents=selection.getRangeAt(0).cloneContents(),div=document.createElement("div");return div.appendChild(contents),div.innerHTML},SignalClipboard=function(){function SignalClipboard(quill){var _this=this;!function signal_clipboard_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,SignalClipboard),this.quill=quill,this.quill.root.addEventListener("copy",(function(e){return _this.onCaptureCopy(e,!1)})),this.quill.root.addEventListener("cut",(function(e){return _this.onCaptureCopy(e,!0)})),this.quill.root.addEventListener("paste",(function(e){return _this.onCapturePaste(e)}))}return function signal_clipboard_createClass(Constructor,protoProps,staticProps){return protoProps&&signal_clipboard_defineProperties(Constructor.prototype,protoProps),staticProps&&signal_clipboard_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(SignalClipboard,[{key:"onCaptureCopy",value:function onCaptureCopy(event){var isCut=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(event.preventDefault(),null!=event.clipboardData){var range=this.quill.getSelection();if(null!=range){var contents=this.quill.getContents(range.index,range.length);if(null!=contents){var ops=contents.ops;if(ops&&ops.length){var text=getTextFromOps(ops),html=getSelectionHTML();event.clipboardData.setData("text/plain",text),event.clipboardData.setData("text/signal",html),isCut&&this.quill.deleteText(range.index,range.length,"user")}}}}}},{key:"onCapturePaste",value:function onCapturePaste(event){var _this2=this;if(null!=event.clipboardData){this.quill.focus();var clipboard=this.quill.getModule("clipboard"),selection=this.quill.getSelection();if(null!=selection){var text=event.clipboardData.getData("text/plain"),html=event.clipboardData.getData("text/signal"),clipboardDelta=html?clipboard.convert(html):clipboard.convert(function(text){return[[/&/g,"&amp;"],[/</g,"&lt;"],[/>/g,"&gt;"]].reduce((function(acc,_ref){var _ref2=signal_clipboard_slicedToArray(_ref,2),re=_ref2[0],replaceValue=_ref2[1];return acc.replace(re,replaceValue)}),text)}(text)),scrollTop=this.quill.scrollingContainer.scrollTop;this.quill.selection.update("silent"),selection&&setTimeout((function(){var delta=(new(Delta_default())).retain(selection.index).concat(clipboardDelta);_this2.quill.updateContents(delta,"user"),_this2.quill.setSelection(delta.length(),0,"silent"),_this2.quill.scrollingContainer.scrollTop=scrollTop}),1),event.preventDefault()}}}}]),SignalClipboard}();function block_blot_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function block_blot_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function block_blot_get(){return block_blot_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(target,property,receiver){var base=block_blot_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},block_blot_get.apply(this,arguments)}function block_blot_superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=block_blot_getPrototypeOf(object)););return object}function block_blot_setPrototypeOf(o,p){return block_blot_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){return o.__proto__=p,o},block_blot_setPrototypeOf(o,p)}function block_blot_createSuper(Derived){var hasNativeReflectConstruct=function block_blot_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var result,Super=block_blot_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=block_blot_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return block_blot_possibleConstructorReturn(this,result)}}function block_blot_possibleConstructorReturn(self,call){if(call&&("object"==typeof call||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function block_blot_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function block_blot_getPrototypeOf(o){return block_blot_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)},block_blot_getPrototypeOf(o)}var DirectionalBlot=function(_Block){!function block_blot_inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&block_blot_setPrototypeOf(subClass,superClass)}(DirectionalBlot,_Block);var _super=block_blot_createSuper(DirectionalBlot);function DirectionalBlot(){return block_blot_classCallCheck(this,DirectionalBlot),_super.apply(this,arguments)}return function block_blot_createClass(Constructor,protoProps,staticProps){return protoProps&&block_blot_defineProperties(Constructor.prototype,protoProps),staticProps&&block_blot_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(DirectionalBlot,null,[{key:"create",value:function create(value){var node=block_blot_get(block_blot_getPrototypeOf(DirectionalBlot),"create",this).call(this,value);return node.setAttribute("dir","auto"),node}}]),DirectionalBlot}(quill_default().import("blots/block"));DirectionalBlot.tagName="div";var getClassNamesFor=__webpack_require__("./ts/util/getClassNamesFor.ts"),useRefMerger=__webpack_require__("./ts/hooks/useRefMerger.ts"),StagedLinkPreview=__webpack_require__("./ts/components/conversation/StagedLinkPreview.tsx"),usePrevious=__webpack_require__("./ts/hooks/usePrevious.ts");function CompositionInput_toConsumableArray(arr){return function CompositionInput_arrayWithoutHoles(arr){if(Array.isArray(arr))return CompositionInput_arrayLikeToArray(arr)}(arr)||function CompositionInput_iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||CompositionInput_unsupportedIterableToArray(arr)||function CompositionInput_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function CompositionInput_slicedToArray(arr,i){return function CompositionInput_arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function CompositionInput_iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||CompositionInput_unsupportedIterableToArray(arr,i)||function CompositionInput_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function CompositionInput_unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return CompositionInput_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?CompositionInput_arrayLikeToArray(o,minLen):void 0}}function CompositionInput_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}quill_default().register("formats/emoji",EmojiBlot),quill_default().register("formats/mention",MentionBlot),quill_default().register("formats/block",DirectionalBlot),quill_default().register("formats/monospace",MonospaceBlot),quill_default().register("formats/spoiler",SpoilerBlot),quill_default().register("modules/emojiCompletion",EmojiCompletion),quill_default().register("modules/mentionCompletion",MentionCompletion),quill_default().register("modules/formattingMenu",FormattingMenu),quill_default().register("modules/signalClipboard",SignalClipboard);function CompositionInput(props){var children=props.children,clearQuotedMessage=props.clearQuotedMessage,conversationId=props.conversationId,disabled=props.disabled,draftBodyRanges=props.draftBodyRanges,draftEditMessage=props.draftEditMessage,draftText=props.draftText,getPreferredBadge=props.getPreferredBadge,getQuotedMessage=props.getQuotedMessage,i18n=props.i18n,inputApi=props.inputApi,isFormattingEnabled=props.isFormattingEnabled,isFormattingSpoilersEnabled=props.isFormattingSpoilersEnabled,large=props.large,linkPreviewLoading=props.linkPreviewLoading,linkPreviewResult=props.linkPreviewResult,moduleClassName=props.moduleClassName,onCloseLinkPreview=props.onCloseLinkPreview,onPickEmoji=props.onPickEmoji,onScroll=props.onScroll,onSubmit=props.onSubmit,placeholder=props.placeholder,skinTone=props.skinTone,sendCounter=props.sendCounter,sortedGroupMembers=props.sortedGroupMembers,theme=props.theme,refMerger=(0,useRefMerger.T)(),_React$useState2=CompositionInput_slicedToArray(react.useState(),2),emojiCompletionElement=_React$useState2[0],setEmojiCompletionElement=_React$useState2[1],_React$useState4=CompositionInput_slicedToArray(react.useState(),2),formattingChooserElement=_React$useState4[0],setFormattingChooserElement=_React$useState4[1],_React$useState6=CompositionInput_slicedToArray(react.useState(null),2),lastSelectionRange=_React$useState6[0],setLastSelectionRange=_React$useState6[1],_React$useState8=CompositionInput_slicedToArray(react.useState(),2),mentionCompletionElement=_React$useState8[0],setMentionCompletionElement=_React$useState8[1],emojiCompletionRef=react.useRef(),mentionCompletionRef=react.useRef(),quillRef=react.useRef(),scrollerRefInner=react.useRef(null),propsRef=react.useRef(props),canSendRef=react.useRef(!1),memberRepositoryRef=react.useRef(new MemberRepository),generateDelta=function(text,bodyRanges){var textLength=text.length,tree=bodyRanges.reduce((function(acc,range){return range.start<textLength?(0,BodyRange.GO)(range,acc):acc}),[]),opsWithFormattingAndMentions=function(nodes){var ops=[];return nodes.forEach((function(node){var startingOp={insert:node.text,attributes:{[QuillFormattingStyle.bold]:node.isBold,[QuillFormattingStyle.italic]:node.isItalic,[QuillFormattingStyle.monospace]:node.isMonospace,[QuillFormattingStyle.spoiler]:node.isSpoiler,[QuillFormattingStyle.strike]:node.isStrikethrough}};ops=ops.concat(insertMentionOps([startingOp],node.mentions))})),ops}((0,BodyRange.E5)({tree,text})),opsWithEmojis=insertEmojiOps(opsWithFormattingAndMentions);return new(Delta_default())(opsWithEmojis)},getTextAndRanges=function(){var quill=quillRef.current;if(void 0===quill)return{text:"",bodyRanges:[]};var contents=quill.getContents();if(void 0===contents)return{text:"",bodyRanges:[]};var ops=contents.ops;return void 0===ops?{text:"",bodyRanges:[]}:function(ops){var bodyRanges=[],formats={[BOLD]:void 0,[ITALIC]:void 0,[MONOSPACE]:void 0,[SPOILER]:void 0,[STRIKETHROUGH]:void 0,[NONE]:void 0},text=ops.reduce((function(acc,op,index){return formats=extractAllFormats(bodyRanges,formats,acc.length,op),"string"==typeof op.insert?acc+(0===index?op.insert.trimStart():op.insert):isInsertEmojiOp(op)?acc+op.insert.emoji:isInsertMentionOp(op)?(bodyRanges.push({length:1,mentionUuid:op.insert.mention.uuid,replacementText:op.insert.mention.title,start:acc.length}),`${acc}`):acc}),"").trimEnd();return extractAllFormats(bodyRanges,formats,text.length),{text,bodyRanges}}(ops)},focus=function(){var quill=quillRef.current;void 0!==quill&&quill.focus()},submit=function(){var timestamp=Date.now();if(void 0!==quillRef.current)if(canSendRef.current){var _getTextAndRanges=getTextAndRanges(),text=_getTextAndRanges.text,bodyRanges=_getTextAndRanges.bodyRanges;log.info(`CompositionInput: Submitting message ${timestamp} with ${bodyRanges.length} ranges`),canSendRef.current=!1,onSubmit(text,bodyRanges,timestamp)}else log.warn("CompositionInput: Not submitting message - cannot send right now")};inputApi&&(inputApi.current={focus,insertEmoji:function(e){var quill=quillRef.current;if(void 0!==quill){var insertionRange=quill.getSelection()||lastSelectionRange;if(null!=insertionRange){var emoji=(0,emoji_lib.nS)(e.shortName,e.skinTone),delta=(new(Delta_default())).retain(insertionRange.index).delete(insertionRange.length).insert({emoji});quill.updateContents(delta,"user"),quill.setSelection(insertionRange.index+1,0,"user")}}},setContents:function(text,bodyRanges,cursorToEnd){var quill=quillRef.current;if(void 0!==quill){var delta=generateDelta(text||"",bodyRanges||[]);canSendRef.current=!0,quill.setContents(delta),cursorToEnd&&quill.setSelection(quill.getLength(),0)}},reset:function(){var quill=quillRef.current;if(void 0!==quill){canSendRef.current=!0,quill.setText("");var historyModule=quill.getModule("history");void 0!==historyModule&&historyModule.clear()}},submit}),react.useEffect((function(){propsRef.current=props}),[props]),react.useEffect((function(){canSendRef.current=!disabled}),[disabled]);var previousFormattingEnabled=(0,usePrevious.D)(isFormattingEnabled,isFormattingEnabled),previousFormattingSpoilersEnabled=(0,usePrevious.D)(isFormattingSpoilersEnabled,isFormattingSpoilersEnabled);react.useEffect((function(){var formattingChanged="boolean"==typeof previousFormattingEnabled&&previousFormattingEnabled!==isFormattingEnabled,spoilersChanged="boolean"==typeof previousFormattingSpoilersEnabled&&previousFormattingSpoilersEnabled!==isFormattingSpoilersEnabled,quill=quillRef.current;quill&&(formattingChanged||spoilersChanged)&&quill.getModule("formattingMenu").updateOptions({isEnabled:isFormattingEnabled,isSpoilersEnabled:isFormattingSpoilersEnabled})}),[isFormattingEnabled,isFormattingSpoilersEnabled,previousFormattingEnabled,previousFormattingSpoilersEnabled,quillRef]);react.useEffect((function(){var quill=quillRef.current;void 0!==quill&&(quill.enable(!disabled),quill.focus())}),[disabled]),react.useEffect((function(){var emojiCompletion=emojiCompletionRef.current;void 0!==emojiCompletion&&void 0!==skinTone&&(emojiCompletion.options.skinTone=skinTone)}),[skinTone]),react.useEffect((function(){return function(){var emojiCompletion=emojiCompletionRef.current,mentionCompletion=mentionCompletionRef.current;void 0!==emojiCompletion&&emojiCompletion.destroy(),void 0!==mentionCompletion&&mentionCompletion.destroy()}}),[]);var removeStaleMentions=function(currentMembers){var quill=quillRef.current;if(void 0!==quill){var ops=quill.getContents().ops;if(void 0!==ops){var newDelta=function(ops,memberUuids){var newOps=ops.reduce((function(memo,op){if(op.insert){if(isInsertMentionOp(op)&&!memberUuids.includes(op.insert.mention.uuid)){var textOp={insert:`@${op.insert.mention.title}`};return[].concat(_toConsumableArray(memo),[{delete:1},textOp])}if("string"==typeof op.insert){var retainStringOp={retain:op.insert.length};return[].concat(_toConsumableArray(memo),[retainStringOp])}return[].concat(_toConsumableArray(memo),[{retain:1}])}return[].concat(_toConsumableArray(memo),[op])}),Array());return new(Delta_default())(newOps)}(ops,currentMembers.map((function(m){return m.uuid})).filter(UUID.TP));quill.updateContents(newDelta)}}},memberIds=sortedGroupMembers?sortedGroupMembers.map((function(m){return m.id})):[];react.useEffect((function(){memberRepositoryRef.current.updateMembers(sortedGroupMembers||[]),removeStaleMentions(sortedGroupMembers||[])}),[JSON.stringify(memberIds)]);var unstaleCallbacks={onBackspace:function(){var quill=quillRef.current;if(void 0===quill)return!0;var selection=quill.getSelection();if(!selection||selection.length>0)return!0;var blot,blotToDelete=CompositionInput_slicedToArray(quill.getLeaf(selection.index),1)[0];if(!(blot=blotToDelete).value()||!blot.value().mention)return!0;var ops,changes,contents=quill.getContents(0,selection.index-1),restartDelta=(ops=contents.ops,(changes=ops.reduce((function(acc,op){return op.insert&&"string"==typeof op.insert?acc.push({retain:op.insert.length}):acc.push({retain:1}),acc}),Array())).push({delete:1}),changes.push({insert:"@"}),new(Delta_default())(changes));return quill.updateContents(restartDelta),quill.setSelection(selection.index,0),!1},onChange:function(){var quill=quillRef.current,_getTextAndRanges2=getTextAndRanges(),text=_getTextAndRanges2.text,bodyRanges=_getTextAndRanges2.bodyRanges;if(void 0!==quill){var historyModule=quill.getModule("history");if(text.length>65536)return historyModule.undo(),void propsRef.current.onTextTooLong();var _onEditorStateChange=propsRef.current.onEditorStateChange;_onEditorStateChange&&setTimeout((function(){var selection=quill.getSelection();_onEditorStateChange({bodyRanges,caretLocation:selection?selection.index:void 0,conversationId,messageText:text,sendCounter})}),0)}propsRef.current.onDirtyChange&&propsRef.current.onDirtyChange(text.length>0)},onEnter:function(){var quill=quillRef.current,emojiCompletion=emojiCompletionRef.current,mentionCompletion=mentionCompletionRef.current;return void 0!==quill&&(void 0!==emojiCompletion&&void 0!==mentionCompletion&&(emojiCompletion.results.length?(emojiCompletion.completeEmoji(),!1):mentionCompletion.results.length?(mentionCompletion.completeMention(),!1):!!propsRef.current.large||(submit(),!1)))},onEscape:function(){if(void 0===quillRef.current)return!1;var emojiCompletion=emojiCompletionRef.current,mentionCompletion=mentionCompletionRef.current;return emojiCompletion&&emojiCompletion.results.length?(emojiCompletion.reset(),!1):mentionCompletion&&mentionCompletion.results.length?(mentionCompletion.clearResults(),!1):null==getQuotedMessage||!getQuotedMessage()||(null==clearQuotedMessage||clearQuotedMessage(),!1)},onPickEmoji,onShortKeyEnter:function(){return submit(),!1},onTab:function(){var quill=quillRef.current,emojiCompletion=emojiCompletionRef.current,mentionCompletion=mentionCompletionRef.current;return void 0!==quill&&(void 0!==emojiCompletion&&void 0!==mentionCompletion&&(emojiCompletion.results.length?(emojiCompletion.completeEmoji(),!1):!mentionCompletion.results.length||(mentionCompletion.completeMention(),!1)))}},callbacksRef=react.useRef(unstaleCallbacks);callbacksRef.current=unstaleCallbacks;var reactQuill=react.useMemo((function(){var delta=generateDelta(draftText||"",draftBodyRanges||[]);return(0,jsx_runtime.jsx)(lib_default(),{className:"module-composition-input__quill",onChange:function(){return callbacksRef.current.onChange()},defaultValue:delta,modules:{toolbar:!1,signalClipboard:!0,clipboard:{matchers:[["IMG",matchEmojiImage],["IMG",matchEmojiBlot],["SPAN",matchReactEmoji],[Node.TEXT_NODE,matchEmojiText],["SPAN",matchMention(memberRepositoryRef)]]},keyboard:{bindings:{onEnter:{key:13,handler:function(){return callbacksRef.current.onEnter()}},onShortKeyEnter:{key:13,shortKey:!0,handler:function(){return callbacksRef.current.onShortKeyEnter()}},onEscape:{key:27,handler:function(){return callbacksRef.current.onEscape()}},onBackspace:{key:8,handler:function(){return callbacksRef.current.onBackspace()}}}},emojiCompletion:{setEmojiPickerElement:setEmojiCompletionElement,onPickEmoji:function(emoji){return callbacksRef.current.onPickEmoji(emoji)},skinTone},formattingMenu:{i18n,isEnabled:isFormattingEnabled,isSpoilersEnabled:isFormattingSpoilersEnabled,setFormattingChooserElement},mentionCompletion:{getPreferredBadge,me:sortedGroupMembers?sortedGroupMembers.find((function(foo){return foo.isMe})):void 0,memberRepositoryRef,setMentionPickerElement:setMentionCompletionElement,i18n,theme}},formats:["emoji","mention"].concat(CompositionInput_toConsumableArray(isFormattingEnabled?[].concat(CompositionInput_toConsumableArray(isFormattingSpoilersEnabled?[QuillFormattingStyle.spoiler]:[]),[QuillFormattingStyle.monospace,QuillFormattingStyle.bold,QuillFormattingStyle.italic,QuillFormattingStyle.strike]):[])),placeholder:placeholder||i18n("icu:sendMessage"),readOnly:disabled,ref:function(element){if(element){var quill=element.getEditor(),keyboard=quill.getModule("keyboard");keyboard.bindings[9].unshift({key:9,handler:function(){return callbacksRef.current.onTab()}}),keyboard.bindings[9].pop(),quill.once("editor-change",(function(){var scroller=scrollerRefInner.current;null!=scroller&&(quill.scrollingContainer=scroller),setTimeout((function(){quill.setSelection(quill.getLength(),0),quill.root.classList.add("ql-editor--loaded")}),0)})),quill.on("selection-change",(function(newRange,oldRange){null==newRange&&setLastSelectionRange(oldRange)})),quillRef.current=quill,emojiCompletionRef.current=quill.getModule("emojiCompletion"),mentionCompletionRef.current=quill.getModule("mentionCompletion")}}})}),[]),getClassName=(0,getClassNamesFor.h)("module-composition-input",moduleClassName);return(0,jsx_runtime.jsx)(Manager.dK,{children:(0,jsx_runtime.jsx)(Reference.s,{children:function(_ref){var ref=_ref.ref;return(0,jsx_runtime.jsxs)("div",{className:getClassName("__input"),ref,"data-testid":"CompositionInput","data-enabled":disabled?"false":"true",children:[draftEditMessage&&(0,jsx_runtime.jsx)("div",{className:getClassName("__editing-message"),children:i18n("icu:CompositionInput__editing-message")}),(null==draftEditMessage?void 0:draftEditMessage.attachmentThumbnail)&&(0,jsx_runtime.jsx)("div",{className:getClassName("__editing-message__attachment"),children:(0,jsx_runtime.jsx)("img",{alt:i18n("icu:stagedImageAttachment",{path:draftEditMessage.attachmentThumbnail}),src:draftEditMessage.attachmentThumbnail})}),conversationId&&linkPreviewLoading&&linkPreviewResult&&(0,jsx_runtime.jsx)(StagedLinkPreview.Q,Object.assign({},linkPreviewResult,{moduleClassName:"CompositionInput__link-preview",i18n,onClose:function(){return null==onCloseLinkPreview?void 0:onCloseLinkPreview(conversationId)}})),children,(0,jsx_runtime.jsxs)("div",{ref:props.scrollerRef?refMerger(scrollerRefInner,props.scrollerRef):scrollerRefInner,onClick:focus,onScroll,className:classnames_default()(getClassName("__input__scroller"),!large&&linkPreviewResult?getClassName("__input__scroller--link-preview"):null,large?getClassName("__input__scroller--large"):null,children?getClassName("__input--with-children"):null),children:[reactQuill,emojiCompletionElement,formattingChooserElement,mentionCompletionElement]})]})}})})}CompositionInput.displayName="CompositionInput"},"./ts/components/conversation/StagedLinkPreview.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Q:()=>StagedLinkPreview});var lodash_unescape__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/lodash/unescape.js"),lodash_unescape__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(lodash_unescape__WEBPACK_IMPORTED_MODULE_0__),classnames__WEBPACK_IMPORTED_MODULE_2__=(__webpack_require__("./node_modules/react/index.js"),__webpack_require__("./node_modules/classnames/index.js")),classnames__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(classnames__WEBPACK_IMPORTED_MODULE_2__),_Image__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./ts/components/conversation/Image.tsx"),_LinkPreviewDate__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./ts/components/conversation/LinkPreviewDate.tsx"),_util_getClassNamesFor__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./ts/util/getClassNamesFor.ts"),_types_Attachment__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./ts/types/Attachment.ts"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./node_modules/react/jsx-runtime.js");function StagedLinkPreview(_ref){var maybeContent,date=_ref.date,description=_ref.description,domain=_ref.domain,i18n=_ref.i18n,image=_ref.image,imageSize=_ref.imageSize,moduleClassName=_ref.moduleClassName,onClose=_ref.onClose,title=_ref.title,isImage=(0,_types_Attachment__WEBPACK_IMPORTED_MODULE_6__.VV)(image),isLoaded=Boolean(domain),getClassName=(0,_util_getClassNamesFor__WEBPACK_IMPORTED_MODULE_5__.h)("module-staged-link-preview",moduleClassName);return isLoaded&&(maybeContent=title||description?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:getClassName("__content"),children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:getClassName("__title"),children:title}),description&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:getClassName("__description"),children:lodash_unescape__WEBPACK_IMPORTED_MODULE_0___default()(description)}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:getClassName("__footer"),children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:getClassName("__location"),children:domain}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_LinkPreviewDate__WEBPACK_IMPORTED_MODULE_4__.t,{date,className:getClassName("__date")})]})]}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:classnames__WEBPACK_IMPORTED_MODULE_2___default()(getClassName("__content"),getClassName("__content--only-url")),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:getClassName("__title"),children:domain})})),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsxs)("div",{className:classnames__WEBPACK_IMPORTED_MODULE_2___default()(getClassName(""),isLoaded?null:getClassName("--is-loading")),children:[isLoaded?null:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:getClassName("__loading"),children:i18n("icu:loadingPreview")}),isLoaded&&image&&isImage&&domain?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:getClassName("__icon-container"),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)(_Image__WEBPACK_IMPORTED_MODULE_3__.E,{alt:i18n("icu:stagedPreviewThumbnail",{domain}),attachment:image,curveBottomLeft:_Image__WEBPACK_IMPORTED_MODULE_3__.v.Tiny,curveBottomRight:_Image__WEBPACK_IMPORTED_MODULE_3__.v.Tiny,curveTopLeft:_Image__WEBPACK_IMPORTED_MODULE_3__.v.Tiny,curveTopRight:_Image__WEBPACK_IMPORTED_MODULE_3__.v.Tiny,height:imageSize||72,i18n,url:image.url,width:imageSize||72})}):null,isLoaded&&!image&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("div",{className:getClassName("__no-image")}),maybeContent,onClose&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_7__.jsx)("button",{"aria-label":i18n("icu:close"),className:getClassName("__close-button"),onClick:onClose,type:"button"})]})}StagedLinkPreview.displayName="StagedLinkPreview"},"./ts/util/popperUtil.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{E:()=>offsetDistanceModifier,W:()=>sameWidthModifier});var offsetDistanceModifier=function(distance){return{name:"offset",options:{offset:[void 0,distance]}}},sameWidthModifier={name:"sameWidth",enabled:!0,phase:"write",fn:function(_ref){var state=_ref.state;state.elements.popper.style.width=`${state.rects.reference.width}px`}}}}]);