"use strict";(globalThis.webpackChunksignal_desktop=globalThis.webpackChunksignal_desktop||[]).push([[728],{"./ts/components/Lightbox.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{e:()=>Lightbox});var noop=__webpack_require__("./node_modules/lodash/noop.js"),noop_default=__webpack_require__.n(noop),react=__webpack_require__("./node_modules/react/index.js"),classnames=__webpack_require__("./node_modules/classnames/index.js"),classnames_default=__webpack_require__.n(classnames),react_dom=__webpack_require__("./node_modules/react-dom/index.js"),react_spring_web_esm=__webpack_require__("./node_modules/@react-spring/web/dist/react-spring-web.esm.js"),GoogleChrome=__webpack_require__("./ts/util/GoogleChrome.ts"),log=__webpack_require__("./ts/logging/log.ts"),Avatar=__webpack_require__("./ts/components/Avatar.tsx"),MIME=__webpack_require__("./ts/types/MIME.ts"),timestamp=__webpack_require__("./ts/util/timestamp.ts"),moment=__webpack_require__("./node_modules/moment/moment.js"),moment_default=__webpack_require__.n(moment);var Attachment=__webpack_require__("./ts/types/Attachment.ts"),useRestoreFocus=__webpack_require__("./ts/hooks/useRestoreFocus.ts"),usePrevious=__webpack_require__("./ts/hooks/usePrevious.ts"),keyboard=__webpack_require__("./ts/util/keyboard.ts"),jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var INITIAL_IMAGE_TRANSFORM={scale:1,translateX:0,translateY:0,config:{clamp:!0,friction:20,mass:.5,tension:350}},THUMBNAIL_SPRING_CONFIG={mass:1,tension:986,friction:64,velocity:0};function Lightbox(_ref){var _media$at,children=_ref.children,closeLightbox=_ref.closeLightbox,getConversation=_ref.getConversation,media=_ref.media,i18n=_ref.i18n,_ref$isViewOnce=_ref.isViewOnce,isViewOnce=void 0!==_ref$isViewOnce&&_ref$isViewOnce,saveAttachment=_ref.saveAttachment,selectedIndex=_ref.selectedIndex,toggleForwardMessagesModal=_ref.toggleForwardMessagesModal,onMediaPlaybackStart=_ref.onMediaPlaybackStart,onNextAttachment=_ref.onNextAttachment,onPrevAttachment=_ref.onPrevAttachment,onSelectAttachment=_ref.onSelectAttachment,hasNextMessage=_ref.hasNextMessage,hasPrevMessage=_ref.hasPrevMessage,hasThumbnails=media.length>1,messageId=null===(_media$at=media.at(0))||void 0===_media$at?void 0:_media$at.message.id,needsAnimation=messageId!==(0,usePrevious.D)(messageId,messageId),_React$useState2=_slicedToArray(react.useState(),2),root=_React$useState2[0],setRoot=_React$useState2[1],_useState2=_slicedToArray((0,react.useState)(null),2),videoElement=_useState2[0],setVideoElement=_useState2[1],_useState4=_slicedToArray((0,react.useState)(),2),videoTime=_useState4[0],setVideoTime=_useState4[1],_useState6=_slicedToArray((0,react.useState)(!1),2),isZoomed=_useState6[0],setIsZoomed=_useState6[1],containerRef=(0,react.useRef)(null),focusRef=_slicedToArray((0,useRestoreFocus.H)(),1)[0],animateRef=(0,react.useRef)(null),dragCacheRef=(0,react.useRef)(),imageRef=(0,react.useRef)(null),zoomCacheRef=(0,react.useRef)(),onPrevious=(0,react.useCallback)((function(event){event.preventDefault(),event.stopPropagation(),isZoomed||onPrevAttachment()}),[isZoomed,onPrevAttachment]),onNext=(0,react.useCallback)((function(event){event.preventDefault(),event.stopPropagation(),isZoomed||onNextAttachment()}),[isZoomed,onNextAttachment]),onTimeUpdate=(0,react.useCallback)((function(){videoElement&&setVideoTime(videoElement.currentTime)}),[setVideoTime,videoElement]),onKeyDown=(0,react.useCallback)((function(event){switch(event.key){case"Escape":closeLightbox(),event.preventDefault(),event.stopPropagation();break;case(0,keyboard.x)("start"):onPrevious(event);break;case(0,keyboard.x)("end"):onNext(event)}}),[closeLightbox,onNext,onPrevious]),onClose=function(event){event.stopPropagation(),event.preventDefault(),closeLightbox()},playVideo=(0,react.useCallback)((function(){videoElement&&(videoElement.paused?(onMediaPlaybackStart(),videoElement.play()):videoElement.pause())}),[videoElement,onMediaPlaybackStart]);(0,react.useEffect)((function(){var div=document.createElement("div");return document.body.appendChild(div),setRoot(div),function(){document.body.removeChild(div),setRoot(void 0)}}),[]),(0,react.useEffect)((function(){return document.addEventListener("keydown",onKeyDown,true),function(){document.removeEventListener("keydown",onKeyDown,true)}}),[onKeyDown]);var _ref2=media[selectedIndex]||{},attachment=_ref2.attachment,contentType=_ref2.contentType,_ref2$loop=_ref2.loop,loop=void 0!==_ref2$loop&&_ref2$loop,objectURL=_ref2.objectURL,message=_ref2.message,isAttachmentGIF=(0,Attachment.DQ)(attachment?[attachment]:void 0);(0,react.useEffect)((function(){return playVideo(),videoElement&&isViewOnce?isAttachmentGIF?noop_default():(videoElement.addEventListener("timeupdate",onTimeUpdate),function(){videoElement.removeEventListener("timeupdate",onTimeUpdate)}):noop_default()}),[isViewOnce,isAttachmentGIF,onTimeUpdate,playVideo,videoElement]);var _useSpring2=_slicedToArray((0,react_spring_web_esm.useSpring)((function(){return INITIAL_IMAGE_TRANSFORM})),2),_useSpring2$=_useSpring2[0],scale=_useSpring2$.scale,translateX=_useSpring2$.translateX,translateY=_useSpring2$.translateY,springApi=_useSpring2[1],thumbnailsMarginInlineStart=0-(52*selectedIndex+22),_useSpring4=_slicedToArray((0,react_spring_web_esm.useSpring)({config:THUMBNAIL_SPRING_CONFIG,to:{marginInlineStart:thumbnailsMarginInlineStart,opacity:hasThumbnails?1:0}},[selectedIndex,hasThumbnails]),2),thumbnailsStyle=_useSpring4[0],thumbnailsAnimation=_useSpring4[1];(0,react.useEffect)((function(){needsAnimation&&(thumbnailsAnimation.stop(),thumbnailsAnimation.set({marginInlineStart:thumbnailsMarginInlineStart+52*(0===selectedIndex?1:-1),opacity:0}),thumbnailsAnimation.start({marginInlineStart:thumbnailsMarginInlineStart,opacity:1}))}),[needsAnimation,selectedIndex,thumbnailsMarginInlineStart,thumbnailsAnimation]);var maxBoundsLimiter=(0,react.useCallback)((function(x,y){var zoomCache=zoomCacheRef.current;if(!zoomCache)return[0,0];var maxX=zoomCache.maxX,maxY=zoomCache.maxY;return[Math.min(maxX,Math.max(-maxX,x)),Math.min(maxY,Math.max(-maxY,y))]}),[]),positionImage=(0,react.useCallback)((function(ev){var zoomCache=zoomCacheRef.current;if(zoomCache){var maxX=zoomCache.maxX,maxY=zoomCache.maxY,screenWidth=zoomCache.screenWidth,screenHeight=zoomCache.screenHeight,shouldTranslateX=3*maxX>screenWidth,shouldTranslateY=3*maxY>screenHeight,offsetX=screenWidth/2-ev.clientX,offsetY=screenHeight/2-ev.clientY,_maxBoundsLimiter2=_slicedToArray(maxBoundsLimiter(3*offsetX,3*offsetY),2),x=_maxBoundsLimiter2[0],y=_maxBoundsLimiter2[1];springApi.start({scale:3,translateX:shouldTranslateX?x:void 0,translateY:shouldTranslateY?y:void 0})}}),[maxBoundsLimiter,springApi]),handleTouchStart=(0,react.useCallback)((function(ev){var touch=_slicedToArray(ev.touches,1)[0];dragCacheRef.current={startX:touch.clientX,startY:touch.clientY,translateX:translateX.get(),translateY:translateY.get()}}),[translateY,translateX]),handleTouchMove=(0,react.useCallback)((function(ev){var dragCache=dragCacheRef.current;if(dragCache){var touch=_slicedToArray(ev.touches,1)[0],deltaX=touch.clientX-dragCache.startX,deltaY=touch.clientY-dragCache.startY,x=dragCache.translateX+deltaX,y=dragCache.translateY+deltaY;springApi.start({scale:3,translateX:x,translateY:y})}}),[springApi]),zoomButtonHandler=(0,react.useCallback)((function(ev){ev.preventDefault(),ev.stopPropagation();var imageNode=imageRef.current,animateNode=animateRef.current;if(imageNode&&animateNode)if(isZoomed)springApi.start(INITIAL_IMAGE_TRANSFORM),setIsZoomed(!1);else{var maxX=imageNode.offsetWidth,maxY=imageNode.offsetHeight,screenHeight=window.innerHeight,screenWidth=window.innerWidth;zoomCacheRef.current={maxX,maxY,screenHeight,screenWidth};var shouldTranslateX=3*maxX>screenWidth,shouldTranslateY=3*maxY>screenHeight,_animateNode$getBound=animateNode.getBoundingClientRect(),height=_animateNode$getBound.height,left=_animateNode$getBound.left,top=_animateNode$getBound.top,width=_animateNode$getBound.width,offsetX=ev.clientX-left-width/2,offsetY=ev.clientY-top-height/2,posX=3*-offsetX+translateX.get(),posY=3*-offsetY+translateY.get(),_maxBoundsLimiter4=_slicedToArray(maxBoundsLimiter(posX,posY),2),x=_maxBoundsLimiter4[0],y=_maxBoundsLimiter4[1];springApi.start({scale:3,translateX:shouldTranslateX?x:void 0,translateY:shouldTranslateY?y:void 0}),setIsZoomed(!0)}}),[isZoomed,maxBoundsLimiter,translateX,translateY,springApi]);(0,react.useEffect)((function(){var animateNode=animateRef.current,hasListener=!1;return animateNode&&isZoomed&&(hasListener=!0,document.addEventListener("mousemove",positionImage),document.addEventListener("touchmove",handleTouchMove),document.addEventListener("touchstart",handleTouchStart)),function(){hasListener&&(document.removeEventListener("mousemove",positionImage),document.removeEventListener("touchmove",handleTouchMove),document.removeEventListener("touchstart",handleTouchStart))}}),[handleTouchMove,handleTouchStart,isZoomed,positionImage]);var content,caption=null==attachment?void 0:attachment.caption,hasControls=!1;if(contentType){var isImageTypeSupported=GoogleChrome.T(contentType),isVideoTypeSupported=GoogleChrome.eq(contentType),isUnsupportedImageType=!isImageTypeSupported&&(0,MIME.Or)(contentType),isUnsupportedVideoType=!isVideoTypeSupported&&(0,MIME.Wv)(contentType);if(isImageTypeSupported)content=objectURL?(0,jsx_runtime.jsx)("div",{className:"Lightbox__zoomable-container",children:(0,jsx_runtime.jsx)("button",{className:"Lightbox__zoom-button",onClick:zoomButtonHandler,type:"button",children:(0,jsx_runtime.jsx)("img",{alt:i18n("icu:lightboxImageAlt"),className:"Lightbox__object",onContextMenu:function(ev){ev&&contentType!==MIME.Ih&&!/image\/jpe?g/g.test(contentType)&&ev.preventDefault()},src:objectURL,ref:imageRef})})}):(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:lightboxImageAlt"),className:classnames_default()({Lightbox__object:!0,Lightbox__unsupported:!0,"Lightbox__unsupported--missing":!0}),onClick:onClose,type:"button"});else if(isVideoTypeSupported){var shouldLoop=loop||isAttachmentGIF||isViewOnce;content=(0,jsx_runtime.jsx)("video",{className:"Lightbox__object Lightbox__object--video",controls:!shouldLoop,loop:shouldLoop,ref:setVideoElement,children:(0,jsx_runtime.jsx)("source",{src:objectURL})},objectURL),hasControls=!0}else isUnsupportedImageType||isUnsupportedVideoType?content=(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:unsupportedAttachment"),className:classnames_default()({Lightbox__object:!0,Lightbox__unsupported:!0,"Lightbox__unsupported--image":isUnsupportedImageType,"Lightbox__unsupported--video":isUnsupportedVideoType}),onClick:onClose,type:"button"}):(log.info("Lightbox: Unexpected content type",{contentType}),content=(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:unsupportedAttachment"),className:"Lightbox__object Lightbox__unsupported Lightbox__unsupported--file",onClick:onClose,type:"button"}))}else content=(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children});var seconds,time,hasNext=!isZoomed&&(selectedIndex<media.length-1||hasNextMessage),hasPrevious=!isZoomed&&(selectedIndex>0||hasPrevMessage);return root?(0,react_dom.createPortal)((0,jsx_runtime.jsx)("div",{className:classnames_default()("Lightbox Lightbox__container",{"Lightbox__container--zoom":isZoomed,"Lightbox__container--has-controls":hasControls}),onClick:function(event){event.stopPropagation(),event.preventDefault(),closeLightbox()},onKeyUp:function(event){containerRef&&event.target!==containerRef.current||27!==event.keyCode||closeLightbox()},ref:containerRef,role:"presentation",children:(0,jsx_runtime.jsxs)("div",{className:"Lightbox__animated",children:[(0,jsx_runtime.jsxs)("div",{className:"Lightbox__main-container",tabIndex:-1,ref:focusRef,children:[(0,jsx_runtime.jsxs)("div",{className:"Lightbox__header",children:[getConversation?(0,jsx_runtime.jsx)(LightboxHeader,{getConversation,i18n,message}):(0,jsx_runtime.jsx)("div",{}),(0,jsx_runtime.jsxs)("div",{className:"Lightbox__controls",children:[isViewOnce?null:(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:forwardMessage"),className:"Lightbox__button Lightbox__button--forward",onClick:function(event){if(!isViewOnce){event.preventDefault(),event.stopPropagation(),closeLightbox();var mediaItem=media[selectedIndex];toggleForwardMessagesModal([mediaItem.message.id])}},type:"button"}),isViewOnce?null:(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:save"),className:"Lightbox__button Lightbox__button--save",onClick:function(event){if(!isViewOnce){event.stopPropagation(),event.preventDefault();var mediaItem=media[selectedIndex],attachment=mediaItem.attachment,message=mediaItem.message,index=mediaItem.index;saveAttachment(attachment,message.sent_at,index+1)}},type:"button"}),(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:close"),className:"Lightbox__button Lightbox__button--close",onClick:closeLightbox,type:"button"})]})]}),(0,jsx_runtime.jsxs)(react_spring_web_esm.animated.div,{className:classnames_default()("Lightbox__object--container",{"Lightbox__object--container--zoom":isZoomed}),ref:animateRef,style:{transform:(0,react_spring_web_esm.to)([scale,translateX,translateY],(function(s,x,y){return`translate(${x}px, ${y}px) scale(${s})`}))},children:[content,hasPrevious&&(0,jsx_runtime.jsx)("div",{className:"Lightbox__nav-prev",children:(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:previous"),className:"Lightbox__button Lightbox__button--previous",onClick:onPrevious,type:"button"})}),hasNext&&(0,jsx_runtime.jsx)("div",{className:"Lightbox__nav-next",children:(0,jsx_runtime.jsx)("button",{"aria-label":i18n("icu:next"),className:"Lightbox__button Lightbox__button--next",onClick:onNext,type:"button"})})]})]}),(0,jsx_runtime.jsxs)("div",{className:"Lightbox__footer",children:[isViewOnce&&videoTime?(0,jsx_runtime.jsx)("div",{className:"Lightbox__timestamp",children:(seconds=videoTime,time=moment_default().utc(1e3*seconds),seconds>36e5?time.format("H:mm:ss"):time.format("m:ss"))}):null,caption?(0,jsx_runtime.jsx)("div",{className:"Lightbox__caption",children:caption}):null,(0,jsx_runtime.jsx)("div",{className:"Lightbox__thumbnails--container",children:(0,jsx_runtime.jsx)(react_spring_web_esm.animated.div,{className:"Lightbox__thumbnails",style:thumbnailsStyle,children:hasThumbnails?media.map((function(item,index){return(0,jsx_runtime.jsx)("button",{className:classnames_default()({Lightbox__thumbnail:!0,"Lightbox__thumbnail--selected":index===selectedIndex}),type:"button",onClick:function(event){event.stopPropagation(),event.preventDefault(),onSelectAttachment(index)},children:item.thumbnailObjectUrl?(0,jsx_runtime.jsx)("img",{alt:i18n("icu:lightboxImageAlt"),src:item.thumbnailObjectUrl}):(0,jsx_runtime.jsx)("div",{className:"Lightbox__thumbnail--unavailable"})},item.thumbnailObjectUrl)})):void 0})})]})]})}),root):null}function LightboxHeader(_ref3){var _message$received_at_,getConversation=_ref3.getConversation,i18n=_ref3.i18n,message=_ref3.message,conversation=getConversation(message.conversationId),now=Date.now();return(0,jsx_runtime.jsxs)("div",{className:"Lightbox__header--container",children:[(0,jsx_runtime.jsx)("div",{className:"Lightbox__header--avatar",children:(0,jsx_runtime.jsx)(Avatar.qE,{acceptedMessageRequest:conversation.acceptedMessageRequest,avatarPath:conversation.avatarPath,badge:void 0,color:conversation.color,conversationType:conversation.type,i18n,isMe:conversation.isMe,phoneNumber:conversation.e164,profileName:conversation.profileName,sharedGroupNames:conversation.sharedGroupNames,size:Avatar.DZ.THIRTY_TWO,title:conversation.title,unblurredAvatarPath:conversation.unblurredAvatarPath})}),(0,jsx_runtime.jsxs)("div",{className:"Lightbox__header--content",children:[(0,jsx_runtime.jsx)("div",{className:"Lightbox__header--name",children:conversation.title}),(0,jsx_runtime.jsx)("div",{className:"Lightbox__header--timestamp",children:(0,timestamp.Wl)(i18n,null!==(_message$received_at_=message.received_at_ms)&&void 0!==_message$received_at_?_message$received_at_:now)})]})]})}LightboxHeader.displayName="LightboxHeader"},"./ts/hooks/useRestoreFocus.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{H:()=>useRestoreFocus,e:()=>useDelayedRestoreFocus});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),useRestoreFocus=function(){var toFocusRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),lastFocusedRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),setFocusRef=react__WEBPACK_IMPORTED_MODULE_0__.useCallback((function(toFocus){toFocus&&(toFocusRef.current||(toFocusRef.current=toFocus,lastFocusedRef.current=document.activeElement,toFocus.focus()))}),[]);return react__WEBPACK_IMPORTED_MODULE_0__.useEffect((function(){return function(){setTimeout((function(){lastFocusedRef.current&&lastFocusedRef.current.focus&&lastFocusedRef.current.focus()}))}}),[]),[setFocusRef]},useDelayedRestoreFocus=function(){var toFocusRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),lastFocusedRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),setFocusRef=react__WEBPACK_IMPORTED_MODULE_0__.useCallback((function(toFocus){var timeout=setTimeout((function setFocus(){toFocus&&(toFocusRef.current||(toFocusRef.current=toFocus,lastFocusedRef.current=document.activeElement,toFocus.focus()))}),250);return function(){clearTimeout(timeout)}}),[]);return react__WEBPACK_IMPORTED_MODULE_0__.useEffect((function(){return function(){setTimeout((function(){lastFocusedRef.current&&lastFocusedRef.current.focus&&lastFocusedRef.current.focus()}))}}),[]),[setFocusRef]}},"./ts/util/keyboard.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{x:()=>arrow});var logicalArrows={start:{ltr:"ArrowLeft",rtl:"ArrowRight"},end:{ltr:"ArrowRight",rtl:"ArrowLeft"}};function arrow(logicalDirection){var localeDirection=window.getResolvedMessagesLocaleDirection();return logicalArrows[logicalDirection][localeDirection]}}}]);